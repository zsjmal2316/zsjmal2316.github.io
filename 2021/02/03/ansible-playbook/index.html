<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ansible-playbook(剧本)"><meta name="keywords" content="ansible"><meta name="author" content="Inaction"><meta name="copyright" content="Inaction"><title>ansible-playbook(剧本) | Inaction's Blog</title><link rel="shortcut icon" href="/imdadul-hussain-u_oLPS_ZYSc-unsplash.jpg"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?12b421fdad87d1edf2305ccb7229d2c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'G-8RMJ1F8ETC', 'auto');
ga('send', 'pageview');</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.3.0'
} </script><meta name="generator" content="Hexo 5.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ansible-playbook"><span class="toc-number">1.</span> <span class="toc-text">ansible-playbook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%A7%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">剧本介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%89%A7%E6%9C%AC%E7%9A%84%E6%96%B9%E6%B3%95%E5%92%8C%E8%A7%84%E8%8C%83"><span class="toc-number">1.2.</span> <span class="toc-text">编写剧本的方法和规范</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%89%A7%E6%9C%AC%E7%9A%84%E8%A7%84%E8%8C%83"><span class="toc-number">1.2.1.</span> <span class="toc-text">编写剧本的规范</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ad-hoc%E9%83%A8%E7%BD%B2rsync%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.2.2.</span> <span class="toc-text">Ad-hoc部署rsync服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%89%A7%E6%9C%AC%E5%89%8D%E5%A5%8F"><span class="toc-number">1.2.3.</span> <span class="toc-text">编写剧本前奏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#playbook%E2%80%93rsync%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.4.</span> <span class="toc-text">playbook–rsync自动部署</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%89%A7%E6%9C%AC%E7%9A%84%E9%87%8D%E8%A6%81%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.</span> <span class="toc-text">编写剧本的重要功能介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%A7%E6%9C%AC%E4%B8%AD%E8%AE%BE%E7%BD%AE%E5%8F%98%E9%87%8F%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.1.</span> <span class="toc-text">剧本中设置变量信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%A7%E6%9C%AC%E4%B8%AD%E8%AE%BE%E7%BD%AE%E6%B3%A8%E5%86%8C%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.2.</span> <span class="toc-text">剧本中设置注册信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%A7%E6%9C%AC%E4%B8%AD%E8%AE%BE%E7%BD%AE%E5%88%A4%E6%96%AD%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.3.</span> <span class="toc-text">剧本中设置判断信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%A7%E6%9C%AC%E4%B8%AD%E8%AE%BE%E7%BD%AE%E5%BE%AA%E7%8E%AF%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.4.</span> <span class="toc-text">剧本中设置循环信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%A7%E6%9C%AC%E4%B8%AD%E8%AE%BE%E7%BD%AE%E5%BF%BD%E7%95%A5%E9%94%99%E8%AF%AF"><span class="toc-number">1.3.5.</span> <span class="toc-text">剧本中设置忽略错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%A7%E6%9C%AC%E4%B8%AD%E8%AE%BE%E7%BD%AE%E6%A0%87%E7%AD%BE%E5%8A%9F%E8%83%BD"><span class="toc-number">1.3.6.</span> <span class="toc-text">剧本中设置标签功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%A7%E6%9C%AC%E5%8A%9F%E8%83%BD%E8%AE%BE%E7%BD%AE%E8%A7%A6%E5%8F%91%E5%8A%9F%E8%83%BD"><span class="toc-number">1.3.7.</span> <span class="toc-text">剧本功能设置触发功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E5%A4%9A%E4%B8%AA%E5%89%A7%E6%9C%AC%E8%BF%9B%E8%A1%8C%E6%95%B4%E5%90%88"><span class="toc-number">1.4.</span> <span class="toc-text">将多个剧本进行整合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A"><span class="toc-number">1.4.1.</span> <span class="toc-text">方法一：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A"><span class="toc-number">1.4.2.</span> <span class="toc-text">方法二：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89"><span class="toc-number">1.4.3.</span> <span class="toc-text">方法三</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99NFS%E6%9C%8D%E5%8A%A1%E5%89%A7%E6%9C%AC"><span class="toc-number">1.5.</span> <span class="toc-text">编写NFS服务剧本</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/imdadul-hussain-u_oLPS_ZYSc-unsplash.jpg"></div><div class="author-info__name text-center">Inaction</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">42</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">18</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">12</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friend Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://www.ji4n.cn/">Jen</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(img/beijing2.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Inaction's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">ansible-playbook(剧本)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-02-03</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/">Linux</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/ansible/">ansible</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="ansible-playbook"><a href="#ansible-playbook" class="headerlink" title="ansible-playbook"></a>ansible-playbook</h1><h2 id="剧本介绍"><a href="#剧本介绍" class="headerlink" title="剧本介绍"></a>剧本介绍</h2><p>playbook（也成为剧本） 是一个不同于ad-hoc命令行执行方式的模型，其功能更为强大灵活。它是一个非常简单的配置管理和多主机部署系统。playbook是由一个或多个<code>“play”</code>组成的列表。play的主要功能是将事先归一组的主机装扮成通过ansible中的task事先定义好的角色。从根本上来讲，所谓的task就是调用ansible的一个module将多个play组织一个playbook中，将通过连通起来，完整整个演员剧本。</p>
<h2 id="编写剧本的方法和规范"><a href="#编写剧本的方法和规范" class="headerlink" title="编写剧本的方法和规范"></a>编写剧本的方法和规范</h2><h3 id="编写剧本的规范"><a href="#编写剧本的规范" class="headerlink" title="编写剧本的规范"></a>编写剧本的规范</h3><p><strong>剧本编写规范:</strong></p>
<blockquote>
<ol>
<li><p>合理的信息缩进  两个空格表示一个缩进关系</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">标题一</span><br><span class="line">    标题二</span><br><span class="line">        标题三</span><br></pre></td></tr></table></figure>

<p>#PS: 在ansible中一定不能用tab进行缩进</p>
</li>
<li><p>冒号的使用方法</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">hosts</span>: 172.16.1.41</span><br><span class="line"><span class="selector-tag">tasks</span>:</span><br><span class="line">yum: name=xx</span><br></pre></td></tr></table></figure>

<p>#PS: 使用冒号时后面要有空格信息,以冒号结尾，冒号信息出现在注释说明中，后面不需要加上空格</p>
</li>
<li><p>短横线应用 -(列表功能)</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">-</span> 张三</span><br><span class="line">  男</span><br><span class="line">    <span class="selector-tag">-</span> 打游戏</span><br><span class="line">   <span class="selector-tag">-</span> 运动</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> 李四</span><br><span class="line">  女</span><br><span class="line">    学习</span><br><span class="line">       湖南</span><br><span class="line"><span class="selector-tag">-</span> 王五</span><br><span class="line">  男</span><br><span class="line">    运动</span><br><span class="line">       深圳</span><br></pre></td></tr></table></figure>

<p>#PS: 使用短横线构成列表信息，短横线后面需要有空格 </p>
</li>
</ol>
</blockquote>
<h3 id="Ad-hoc部署rsync服务"><a href="#Ad-hoc部署rsync服务" class="headerlink" title="Ad-hoc部署rsync服务"></a>Ad-hoc部署rsync服务</h3><p><strong>服务端</strong></p>
<blockquote>
<ol>
<li><p>第一个历程：安装软件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 172.16.1.41 -m yum -a &quot;name=rsync state=installed&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二个历程：编写配置文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 172.16.1.41 -m copy -a &quot;src=/etc/rsyncd.conf dest=/etc/&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三个历程：创建虚拟用户：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 172.16.1.41 -m user -a &quot;name=rsync create_home=no shell=/sbin/nologin&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第四个历程：创建目录</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 172.16.1.41 -m file -a &quot;dest=/bakcup state=directory owner=rsync group=rsync&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第五个历程：创建密码文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 172.16.1.41 -m copy -a &quot;content=rsync_backup:123456 dest=/etc/rsync.password mode=600&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第六个历程：启动服务</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 172.16.1.41 -m service -a &quot;name=rsync state=started enbaled=yes&quot;</span><br></pre></td></tr></table></figure>

</li>
</ol>
</blockquote>
<p><strong>客户端</strong></p>
<blockquote>
<ol>
<li><p>第一个历程：安装软件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 172.16.1.31 -m yum -a &quot;name=rsync state=installed&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二个历程：创建验证服务端的密码文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 172.16.1.31 -m copy -a &quot;content=123456 dest=/etc/rsync.password mode=600&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三个历程：创建一个文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 172.16.1.31 -m file -a &quot;dest=/tmp/test.txt state=touch&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将文件备份到服务端</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 172.16.1.31 -m shell -a &quot;rsync -az /tmp/test.txt rsync_backup@10.0.0.212::backup --password-filel=/etc/rsync.password&quot;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<h3 id="编写剧本前奏"><a href="#编写剧本前奏" class="headerlink" title="编写剧本前奏"></a>编写剧本前奏</h3><blockquote>
<ol>
<li><p>创建剧本文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /etc/ansible/ansible-playbook</span><br><span class="line">$ cd /etc/ansible/ansible-playbook</span><br><span class="line">$ vim rsync_service.yaml</span><br></pre></td></tr></table></figure>

<p>#PS：剧本扩展名尽量写为yaml</p>
</li>
<li><p>如何执行剧本：</p>
<p>第一个步骤：检查剧本的语法格式</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ansible-playbook</span> <span class="selector-tag">--syntax-check</span> <span class="selector-tag">rsync_service</span><span class="selector-class">.yaml</span></span><br></pre></td></tr></table></figure>

<p>第二个步骤：模拟执行剧本</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ansible-playbook</span> <span class="selector-tag">-C</span> <span class="selector-tag">rsync_service</span><span class="selector-class">.yaml</span></span><br></pre></td></tr></table></figure>

<p>第三个步骤：直接执行剧本</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ansible-playbook</span> <span class="selector-tag">rsync_service</span><span class="selector-class">.yaml</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<h3 id="playbook–rsync自动部署"><a href="#playbook–rsync自动部署" class="headerlink" title="playbook–rsync自动部署"></a>playbook–rsync自动部署</h3><p>通过playbook设置多个定制好的tasks，可以执行一键自动化部署，但是还有许多重复的设置，这些重复的设置或多于的设置是没有必要的，所以我们可以简化这段自动部署代码（比如：可以使用变量、循环、判断、标签等功能进行优化）</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/etc/ansible/ansible-playbook</span><br><span class="line">$ cat rsync_service<span class="selector-class">.yaml</span></span><br><span class="line">- hosts: rsync_server</span><br><span class="line">  tasks:</span><br><span class="line">    - name: <span class="number">01</span>-install rsync service</span><br><span class="line">      yum: name=rsync state=installed</span><br><span class="line">    - name: <span class="number">02</span>-push config file</span><br><span class="line">      copy: src=/etc/ansible/rsync_dir/rsync_server/rsyncd.conf dest=/etc/</span><br><span class="line">    - name: <span class="number">03</span>-create user rsync</span><br><span class="line">      user: name=rsync create_home=no shell=/sbin/nologin</span><br><span class="line">    - name: <span class="number">04</span>-create dir backup</span><br><span class="line">      file: name=/backup state=directory owner=rsync group=rsync</span><br><span class="line">    - name: <span class="number">05</span>-create password file info</span><br><span class="line">      copy: content=rsync_backup:<span class="number">123456</span> dest=/etc/rsync.password mode=<span class="number">600</span></span><br><span class="line">    - name: <span class="number">06</span>-start rsync service</span><br><span class="line">      service: name=rsyncd state=started enabled=yes</span><br><span class="line"></span><br><span class="line">- hosts: rsync_client</span><br><span class="line">  tasks:</span><br><span class="line">    - name: <span class="number">01</span>-install rsync service</span><br><span class="line">      yum: name=rsync state=installed</span><br><span class="line">    - name: <span class="number">02</span>-create password file</span><br><span class="line">      copy: content=<span class="number">123456</span> dest=/etc/rsync.password mode=<span class="number">600</span></span><br><span class="line">    - name: <span class="number">03</span>-create test file</span><br><span class="line">      file: dest=/tmp/test.txt state=touch</span><br><span class="line">    - name: <span class="number">04</span>-check test</span><br><span class="line">      shell: rsync -az /tmp/test.txt rsync_backup@<span class="number">10.0</span>.<span class="number">0.212</span>::backup --password-file=/etc/rsync.password</span><br></pre></td></tr></table></figure>
<h2 id="编写剧本的重要功能介绍"><a href="#编写剧本的重要功能介绍" class="headerlink" title="编写剧本的重要功能介绍"></a>编写剧本的重要功能介绍</h2><h3 id="剧本中设置变量信息"><a href="#剧本中设置变量信息" class="headerlink" title="剧本中设置变量信息"></a>剧本中设置变量信息</h3><p><strong>方法一：直接在剧本文件编写</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vars:</span><br><span class="line">  wuwei01: data01</span><br><span class="line">  wuwei02: data02</span><br></pre></td></tr></table></figure>
<p><strong>方法二：在命令行进行制定</strong></p>
<blockquote>
<p>-e：简写，在命令行添加变量只是临时操作</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook --extra-vars=wuwei01=data01</span><br><span class="line">$ ansible-playbook Backup=/data -e Passfile=rsync.password rsync_variable.yaml</span><br></pre></td></tr></table></figure>
<p><strong>方法三：在主机清单文件编写</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[rsync_server]</span></span><br><span class="line">10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.211</span></span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[rsync_server:vars]</span></span><br><span class="line">Backup=/backup</span><br><span class="line">Passfile=rsync.password</span><br></pre></td></tr></table></figure>
<p><strong>三种方式的优先级</strong></p>
<blockquote>
<ul>
<li><p>最优先：命令行变量设置</p>
</li>
<li><p>次优先：剧本编写的变量设置</p>
</li>
<li><p>最后：主机清单配置的变量设置</p>
</li>
</ul>
</blockquote>
<h3 id="剧本中设置注册信息"><a href="#剧本中设置注册信息" class="headerlink" title="剧本中设置注册信息"></a>剧本中设置注册信息</h3><p><strong>编辑剧本</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vim rsync_service<span class="selector-class">.yaml</span></span><br><span class="line">- name: <span class="number">07</span>-check port info</span><br><span class="line">  shell: netstat -lntup|grep <span class="number">873</span>                 //端口信息</span><br><span class="line">  register: result                               //注册端口信息,名称可以自己起</span><br><span class="line">- name: display port info</span><br><span class="line">  debug: var=result.stdout verbosity=<span class="number">0</span>           //调用注册信息（stdout_lines以标准的方式输出）</span><br></pre></td></tr></table></figure>
<p><strong>操作显示结果</strong></p>
<blockquote>
<p>显示进程信息,便是服务已经正常启动</p>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">TASK</span> <span class="selector-attr">[display port info]</span> ***************************************************************************************************</span><br><span class="line">ok: [172.16.1.41] =&gt; &#123;</span><br><span class="line">&quot;msg&quot;: [</span><br><span class="line">    &quot;<span class="selector-tag">tcp</span>        0      0 0.0.0.0<span class="selector-pseudo">:873</span>             0.0.0.0:*               <span class="selector-tag">LISTEN</span>      24042/<span class="selector-tag">rsync</span>         &quot;, </span><br><span class="line">    &quot;<span class="selector-tag">tcp6</span>       0      0 :<span class="selector-pseudo">::873</span>                  :::*                    <span class="selector-tag">LISTEN</span>      24042/<span class="selector-tag">rsync</span>         &quot;</span><br><span class="line"> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="剧本中设置判断信息"><a href="#剧本中设置判断信息" class="headerlink" title="剧本中设置判断信息"></a>剧本中设置判断信息</h3><p><strong>setup模块中显示被管理主机系统的详细信息</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible rsync_server -m setup</span><br></pre></td></tr></table></figure>
<p><strong>剧本信息</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/etc/ansible/ansible-playbook</span><br><span class="line">$ cat rsync_service<span class="selector-class">.yaml</span></span><br><span class="line"></span><br><span class="line">- hosts: rsync_server</span><br><span class="line">  tasks:</span><br><span class="line">    - name: <span class="number">01</span>-install rsync service</span><br><span class="line">      yum: name=rsync state=installed</span><br><span class="line">.......................省略........................</span><br><span class="line"></span><br><span class="line">- hosts: rsync_client</span><br><span class="line">  tasks:</span><br><span class="line">.......................省略........................</span><br><span class="line">    - name: <span class="number">04</span>-check test</span><br><span class="line">      shell: rsync -az /tmp/test.txt rsync_backup@<span class="number">10.0</span>.<span class="number">0.212</span>::backup --password-file=/etc/rsync.password</span><br><span class="line">      when: (ansible_hostname == <span class="string">&quot;nfs&quot;</span>)    //判断，如果是nfs主机，才push(推送）文件</span><br><span class="line">    - name: <span class="number">05</span>-check test</span><br><span class="line">      shell: rsync -az /tmp/test.txt rsync_backup@<span class="number">10.0</span>.<span class="number">0.212</span>::web --password-file=/etc/rsync.password</span><br><span class="line">      when: (ansible_hostname == <span class="string">&quot;web01&quot;</span>)  //判断，如果是web01主机，才push（推送）文件</span><br></pre></td></tr></table></figure>
<blockquote>
<p>//获取内置变量方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible rsync_server -m setup -a &quot;filter=ansible_hostname&quot;</span><br></pre></td></tr></table></figure>

<p>//获取子信息方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible rsync_server -m setup -a &quot;filter=ansible_eth0[Ipv4]&quot;</span><br></pre></td></tr></table></figure>

</blockquote>
<p><strong>常见主机信息</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ansible_all_ipv4_address   		        <span class="comment">//仅显示Ipv4的信息</span></span><br><span class="line">ansible_derices				<span class="comment">//仅显示磁盘设备信息</span></span><br><span class="line">ansible_distribution 				<span class="comment">//显示是什么系统.例：centos ,sues等.</span></span><br><span class="line">ansible_distribution_major_version		<span class="comment">//显示是系统主版本</span></span><br><span class="line">ansible_distribution_version		        <span class="comment">//仅显示系统版本</span></span><br><span class="line">ansible_machine				<span class="comment">//显示系统类型.例：32位,还是64位</span></span><br><span class="line">ansible_eth0					<span class="comment">//仅显示eth0的信息</span></span><br><span class="line">ansible_hostname				<span class="comment">//仅显示主机名</span></span><br><span class="line">ansible_kernel					<span class="comment">//仅显示内核版本</span></span><br><span class="line">ansible_lvm					<span class="comment">//显示lvm相关信息</span></span><br><span class="line">ansible_memtotal_mb			        <span class="comment">//显示系统总内存</span></span><br><span class="line">ansible_memfreee_mb				<span class="comment">//显示可用系统内存</span></span><br><span class="line">ansible_memory_mb				<span class="comment">//详细显示内存情况</span></span><br><span class="line">ansible_swaptotal_mb				<span class="comment">//显示总的swap内存</span></span><br><span class="line">ansible_swapfree_mb				<span class="comment">//显示swap内存大可用内存</span></span><br><span class="line">ansible_mounts					<span class="comment">//显示系统磁盘挂载情况</span></span><br><span class="line">ansible_processor				<span class="comment">//显示CPU个数（具体显示每个CPU的型号）</span></span><br><span class="line">ansible_processor_vcpus			<span class="comment">//显示CPU个数（只显示总的个数）</span></span><br></pre></td></tr></table></figure>
<h3 id="剧本中设置循环信息"><a href="#剧本中设置循环信息" class="headerlink" title="剧本中设置循环信息"></a>剧本中设置循环信息</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ cat rsync_service_循环信息<span class="selector-class">.yaml</span></span><br><span class="line">- hosts: rsync_server</span><br><span class="line">  tasks:</span><br><span class="line">    - name: <span class="number">01</span>-install rsync service</span><br><span class="line">      yum: name=rsync state=installed</span><br><span class="line">    - name: <span class="number">02</span>-create user rsync</span><br><span class="line">      user: name=rsync create_home=no shell=/sbin/nologin</span><br><span class="line">    - name: <span class="number">03</span>-create dir backup</span><br><span class="line">      file: name=/backup state=directory owner=rsync group=rsync</span><br><span class="line">    - name: <span class="number">04</span>-start rsync service</span><br><span class="line">      service: name=rsyncd state=restarted enabled=yes</span><br><span class="line">    - name: <span class="number">05</span>-push file info to remote</span><br><span class="line">      copy: src=/etc/ansible/rsync_dir/rsync_server/&#123;&#123; item.src &#125;&#125; dest=&#123;&#123; item.dest &#125;&#125; mode=&#123;&#123; item.mode &#125;&#125;</span><br><span class="line">      with_items:</span><br><span class="line">        - &#123; src: <span class="string">&#x27;rsyncd.conf&#x27;</span>, dest: <span class="string">&#x27;/etc/&#x27;</span>, mode: <span class="string">&#x27;644&#x27;</span> &#125;</span><br><span class="line">        - &#123; src: <span class="string">&#x27;rsync.password&#x27;</span>, dest: <span class="string">&#x27;/etc/&#x27;</span>, mode: <span class="string">&#x27;600&#x27;</span>&#125;  </span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>#PS：通过循环只使用了一条copy即可</strong></p>
</blockquote>
<h3 id="剧本中设置忽略错误"><a href="#剧本中设置忽略错误" class="headerlink" title="剧本中设置忽略错误"></a>剧本中设置忽略错误</h3><p><strong>默认playbook会检查命令和模块的返回状态，如遇到错误的终端playbook执行，可以加入ignore_errors:yes忽略错误</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: <span class="number">03</span>-create user rsync</span><br><span class="line">  user: ame=rsync create_home=no shell=/sbin/nologin</span><br><span class="line">  ignore_errors: yes</span><br><span class="line"></span><br><span class="line"> TASK [<span class="number">03</span>-create user rsync] ************************************************************************************************</span><br><span class="line"> fatal: [<span class="number">172.16</span>.<span class="number">1.41</span>]: FAILED! =&gt; &#123;<span class="string">&quot;changed&quot;</span>: false, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Unsupported parameters for (user) module: ame Supported parameters include: append, authorization, comment, create_home, expires, force, generate_ssh_key, group, groups, hidden, home, local, login_class, move_home, name, non_unique, password, password_lock, profile, remove, role, seuser, shell, skeleton, ssh_key_bits, ssh_key_comment, ssh_key_file, ssh_key_passphrase, ssh_key_type, state, system, uid, update_password&quot;</span>&#125;</span><br><span class="line"> ...ignoring</span><br></pre></td></tr></table></figure>
<h3 id="剧本中设置标签功能"><a href="#剧本中设置标签功能" class="headerlink" title="剧本中设置标签功能"></a>剧本中设置标签功能</h3><blockquote>
<p>指定执行那个标签任务：ansible-playbook –tags=t2 test05.yaml</p>
<p>跳过指定标签任务：ansible-playbook –skip-tags=t2 test05.yaml</p>
</blockquote>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- name: <span class="number">05</span>-create password file info</span><br><span class="line">  copy: content=rsync_backup:<span class="number">123456</span> dest=/etc/rsync.password mode=<span class="number">600</span></span><br><span class="line">  tags: <span class="number">05in</span>fo</span><br></pre></td></tr></table></figure>
<h3 id="剧本功能设置触发功能"><a href="#剧本功能设置触发功能" class="headerlink" title="剧本功能设置触发功能"></a>剧本功能设置触发功能</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cat rsync_service_触发<span class="selector-class">.yaml</span></span><br><span class="line">- hosts: rsync_server</span><br><span class="line">  tasks:</span><br><span class="line">..............省略.....................</span><br><span class="line">    - name: <span class="number">02</span>-push config file</span><br><span class="line">      copy: src=/etc/ansible/rsync_dir/rsync_server/rsyncd.conf dest=/etc/</span><br><span class="line">      notify: restart rsync server              //通知</span><br><span class="line">..............省略.....................</span><br><span class="line">  </span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart rsync server               //触发</span><br><span class="line">      service: name=rsyncd state=restarted</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>#PS：如果步骤2出现改动，则触发重启</strong></p>
</blockquote>
<h2 id="将多个剧本进行整合"><a href="#将多个剧本进行整合" class="headerlink" title="将多个剧本进行整合"></a>将多个剧本进行整合</h2><h3 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">include_tasks: f1.yml  </span><br><span class="line">     - hosts: all</span><br><span class="line">       remote_user: root</span><br><span class="line">       tasks:</span><br><span class="line">         - include_tasks: f1.yml</span><br><span class="line">         - include_tasks: f2.yml</span><br></pre></td></tr></table></figure>
<h3 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">include: f1.yml</span><br><span class="line">      - include：f1.yml	</span><br><span class="line">      - include：f2.yml</span><br></pre></td></tr></table></figure>
<h3 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/etc/ansible/ansible-playbook</span><br><span class="line">$ cat main<span class="selector-class">.yml</span> </span><br><span class="line">  - import_playbook: base.yml     </span><br><span class="line">  - import_playbook: rsync.yml    </span><br><span class="line">  - import_playbook: nfs.yml      </span><br><span class="line">  - import_playbook: oxxx.yml</span><br><span class="line">  - import_playbook: rsync.yml</span><br><span class="line">  - import_playbook: nfs.yml</span><br></pre></td></tr></table></figure>
<h2 id="编写NFS服务剧本"><a href="#编写NFS服务剧本" class="headerlink" title="编写NFS服务剧本"></a>编写NFS服务剧本</h2><p><strong>1. 创建几个目录</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p nfs_dir/&#123;nfs_client,nfs_server&#125;</span><br><span class="line">$ tree nfs_dir/</span><br><span class="line">nfs_dir/</span><br><span class="line">├── nfs_client</span><br><span class="line">└── nfs_server</span><br></pre></td></tr></table></figure>
<p><strong>2. 编写hosts文件</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ awk &#x27;NR==28,NR==32&#x27; /etc/ansible/hosts </span><br><span class="line"><span class="selector-attr">[nfs_client]</span></span><br><span class="line">10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.213</span></span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[nfs_server]</span></span><br><span class="line">10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.211</span></span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[nfs:children]</span></span><br><span class="line">nfs_client</span><br><span class="line">nfs_server</span><br></pre></td></tr></table></figure>
<p><strong>3. 编写配置文件</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ pwd /etc/ansible/nfs_dir/nfs_server</span><br><span class="line">$ cat nfs_deploy<span class="selector-class">.yaml</span></span><br><span class="line">---</span><br><span class="line">- hosts: nfs:children                          //客户端和服务端都要操作的步骤</span><br><span class="line">  tasks:</span><br><span class="line">    - name: install nfs software package       //第一种yum写法（saltstark写法，另一个自动化工具）</span><br><span class="line">      yum:</span><br><span class="line">        name: [<span class="string">&#x27;nfs-utils&#x27;</span>,<span class="string">&#x27;rpcbind&#x27;</span>]</span><br><span class="line">        state: installed</span><br><span class="line">      </span><br><span class="line">  # - name: install nfs software package      //第二种yum写法（ansible写法）</span><br><span class="line">  #    yum: name=nfs-utils state=installed</span><br><span class="line">  #    yum: name=rpcbind state=installed</span><br></pre></td></tr></table></figure>
<p><strong>服务端</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">-</span> <span class="selector-tag">hosts</span>: <span class="selector-tag">nfs_server</span>                     </span><br><span class="line">  <span class="selector-tag">vars</span>:</span><br><span class="line">    <span class="selector-tag">Data_dir</span>: /<span class="selector-tag">data</span></span><br><span class="line">    <span class="selector-tag">Mount_info</span>: /<span class="selector-tag">data</span> 10.0.0.0/24 (<span class="selector-tag">rw</span>,<span class="selector-tag">sync</span>)</span><br><span class="line">  <span class="selector-tag">tasks</span>:</span><br><span class="line">    <span class="selector-tag">-</span> <span class="selector-tag">name</span>: 01<span class="selector-tag">-write</span> <span class="selector-tag">nfs</span> <span class="selector-tag">mount</span> <span class="selector-tag">file</span> <span class="selector-tag">info</span></span><br><span class="line">      copy: content=&#123;&#123; Mount_info &#125;&#125; dest=/etc/exports</span><br><span class="line">    <span class="selector-tag">-</span> <span class="selector-tag">name</span>: 02<span class="selector-tag">-push</span> <span class="selector-tag">file</span> <span class="selector-tag">to</span> <span class="selector-tag">nfs</span> <span class="selector-tag">server</span></span><br><span class="line">      copy: src=/etc/ansible/nfs_dir/nfs_server/exports dest=/etc/</span><br><span class="line">      <span class="selector-tag">notify</span>: <span class="selector-tag">restart</span> <span class="selector-tag">nfs</span> <span class="selector-tag">service</span></span><br><span class="line">    <span class="selector-tag">-</span> <span class="selector-tag">name</span>: 03<span class="selector-tag">-create</span> <span class="selector-tag">nfs</span> <span class="selector-tag">server</span> <span class="selector-tag">username</span></span><br><span class="line">      user: name=nfsnobody create_home=no shell=/sbin/nologin</span><br><span class="line">    <span class="selector-tag">-</span> <span class="selector-tag">name</span>: 04<span class="selector-tag">-create</span> <span class="selector-tag">data</span> <span class="selector-tag">directory</span></span><br><span class="line">      file: path=&#123;&#123; Data_dir &#125;&#125; state=directory owner=nfsnobody group=nfsnobody</span><br><span class="line">    <span class="selector-tag">-</span> <span class="selector-tag">name</span>: 05<span class="selector-tag">-boot</span> <span class="selector-tag">server</span></span><br><span class="line">      service: name=&#123;&#123; item &#125;&#125; state=started enabled=yes</span><br><span class="line">      <span class="selector-tag">with_items</span>:</span><br><span class="line">        <span class="selector-tag">-</span> <span class="selector-tag">rpcbind</span></span><br><span class="line">        <span class="selector-tag">-</span> <span class="selector-tag">nfs</span></span><br><span class="line">  <span class="selector-tag">handlers</span>:</span><br><span class="line">    <span class="selector-tag">-</span> <span class="selector-tag">name</span>: 06<span class="selector-tag">-trigger</span> <span class="selector-tag">restart</span> <span class="selector-tag">nfs</span> <span class="selector-tag">service</span></span><br><span class="line">      service: name=nfs state=restarted</span><br></pre></td></tr></table></figure>
<p><strong>客户端</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">-</span> <span class="selector-tag">hosts</span>: <span class="selector-tag">nfs_client</span>                         </span><br><span class="line">  <span class="selector-tag">vars</span>:</span><br><span class="line">    <span class="selector-tag">Data_dir</span>: /<span class="selector-tag">data</span></span><br><span class="line">  <span class="selector-tag">tasks</span>:</span><br><span class="line">    <span class="selector-tag">-</span> <span class="selector-tag">name</span>: 01<span class="selector-tag">-create</span> <span class="selector-tag">mount</span> <span class="selector-tag">directory</span></span><br><span class="line">      file: name=/www state=directory </span><br><span class="line">    <span class="selector-tag">-</span> <span class="selector-tag">name</span>: 02<span class="selector-tag">-mount</span> <span class="selector-tag">nfs</span> <span class="selector-tag">file</span> <span class="selector-tag">system</span></span><br><span class="line">      mount: src=10.0.0.211:&#123;&#123; Data_dir &#125;&#125; path=/www fstype=nfs state=mounted</span><br><span class="line">    <span class="selector-tag">-</span> <span class="selector-tag">name</span>: 03<span class="selector-tag">-check</span> <span class="selector-tag">mount</span> <span class="selector-tag">info</span></span><br><span class="line">      shell: df -h |grep /data</span><br><span class="line">      <span class="selector-tag">register</span>: <span class="selector-tag">result</span> </span><br><span class="line">    <span class="selector-tag">-</span> <span class="selector-tag">name</span>: 04<span class="selector-tag">-display</span> <span class="selector-tag">mount</span> <span class="selector-tag">info</span></span><br><span class="line">      debug: var=result.stdout verbosity=0</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Inaction</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://myboke.ink/2021/02/03/ansible-playbook/">https://myboke.ink/2021/02/03/ansible-playbook/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ansible/">ansible</a></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/02/03/ansible-roles/"><i class="fa fa-chevron-left">  </i><span>ansible-roles(角色)</span></a></div><div class="next-post pull-right"><a href="/2021/02/03/ansible%E5%85%A5%E9%97%A8/"><span>ansible入门</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '6cea6a646bff1a0d5f5b',
  clientSecret: '6e9ef08f31f505d416bc0afe2d304808e9063627',
  repo: 'zsjmal2316.github.io',
  owner: 'zsjmal2316',
  admin: 'zsjmal2316',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(img/beijing2.png)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2021 By Inaction</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="120" alpha="0.3" zIndex="-1" data-click="false"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>