<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="MySQL存储引擎-5"><meta name="keywords" content="MySQL"><meta name="author" content="Inaction"><meta name="copyright" content="Inaction"><title>MySQL存储引擎-5 | Inaction's Blog</title><link rel="shortcut icon" href="/imdadul-hussain-u_oLPS_ZYSc-unsplash.jpg"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?12b421fdad87d1edf2305ccb7229d2c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'G-8RMJ1F8ETC', 'auto');
ga('send', 'pageview');</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.3.0'
} </script><meta name="generator" content="Hexo 5.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-number">1.</span> <span class="toc-text">存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">存储引擎介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">InnoDB体系结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8BInnoDB%E7%8A%B6%E6%80%81%E7%9A%84%E5%B0%8F%E6%8A%80%E5%B7%A7"><span class="toc-number">1.3.</span> <span class="toc-text">查看InnoDB状态的小技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8Bshow-engine-innodb-status%E4%BF%9D%E7%95%99%E4%B8%8B%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-number">1.3.1.</span> <span class="toc-text">如何查看show engine innodb status保留下的内容</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%8A%80%E6%9C%AF"><span class="toc-number">1.4.</span> <span class="toc-text">InnoDB的多线程技术</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB%E7%9A%84%E7%BC%93%E5%AD%98%E6%B1%A0%E7%AE%A1%E7%90%86%E6%8A%80%E6%9C%AF"><span class="toc-number">1.5.</span> <span class="toc-text">InnoDB的缓存池管理技术</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB%E4%B8%AD%E7%9A%84%E8%84%8F%E9%A1%B5%E7%AE%A1%E7%90%86"><span class="toc-number">1.6.</span> <span class="toc-text">InnoDB中的脏页管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB%E7%9A%84%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86"><span class="toc-number">1.7.</span> <span class="toc-text">InnoDB的日志管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB%E4%B8%AD%E7%9A%84%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6"><span class="toc-number">1.8.</span> <span class="toc-text">InnoDB中的检查机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7%E8%AF%B4%E6%98%8E"><span class="toc-number">1.9.</span> <span class="toc-text">InnoDB存储引擎核心特性说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#InnoDB%E9%87%8D%E8%A6%81%E7%9A%84%E7%89%B9%E6%80%A7"><span class="toc-number">1.9.1.</span> <span class="toc-text">InnoDB重要的特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="toc-number">1.10.</span> <span class="toc-text">InnoDB存储引擎的修改</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%9B%BF%E6%8D%A2%E5%A4%9A%E5%BC%A0-innoDB%E4%B8%BAtokudb"><span class="toc-number">1.10.1.</span> <span class="toc-text">批量替换多张 innoDB为tokudb</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDb%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%89%A9%E7%90%86%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84%EF%BC%88%E8%A1%A8%E7%A9%BA%E9%97%B4%EF%BC%89"><span class="toc-number">1.11.</span> <span class="toc-text">InnoDb存储引擎物理存储结构（表空间）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%9B%B4%E8%A7%82%E7%9A%84%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F%EF%BC%88-data-mysql-data"><span class="toc-number">1.11.1.</span> <span class="toc-text">最直观的存储方式（&#x2F;data&#x2F;mysql&#x2F;data)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E8%A1%A8%E7%A9%BA%E9%97%B4"><span class="toc-number">1.11.2.</span> <span class="toc-text">共享表空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E8%A1%A8%E7%A9%BA%E9%97%B4%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.11.3.</span> <span class="toc-text">共享表空间设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E8%A1%A8%E7%A9%BA%E9%97%B4"><span class="toc-number">1.11.4.</span> <span class="toc-text">独立表空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7%E7%9A%84%E7%8B%AC%E7%AB%8B%E8%A1%A8%E7%A9%BA%E9%97%B4%E7%BB%93%E6%9E%84"><span class="toc-number">1.11.5.</span> <span class="toc-text">5.7的独立表空间结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E8%A1%A8%E7%A9%BA%E9%97%B4%E8%AE%BE%E7%BD%AE%E9%97%AE%E9%A2%98"><span class="toc-number">1.11.6.</span> <span class="toc-text">独立表空间设置问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E8%A1%A8%E7%A9%BA%E9%97%B4%E8%BF%81%E7%A7%BB"><span class="toc-number">1.11.7.</span> <span class="toc-text">独立表空间迁移</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7"><span class="toc-number">1.12.</span> <span class="toc-text">InnoDB核心特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84ACID%E7%89%B9%E6%80%A7"><span class="toc-number">1.12.1.</span> <span class="toc-text">事务的ACID特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E5%87%86%E7%9A%84%E4%BA%8B%E5%8A%A1%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.12.2.</span> <span class="toc-text">标准的事务语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%BA%BF%E4%BF%AE%E6%94%B9%E5%8F%82%E6%95%B0"><span class="toc-number">1.12.3.</span> <span class="toc-text">在线修改参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%90%E5%BC%8F%E6%8F%90%E4%BA%A4%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-number">1.12.4.</span> <span class="toc-text">隐式提交的情况（重要）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84ACID%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81"><span class="toc-number">1.12.5.</span> <span class="toc-text">事务的ACID如何保证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97%E2%80%93redo-%E9%87%8D%E5%81%9A%E6%97%A5%E5%BF%97"><span class="toc-number">1.12.6.</span> <span class="toc-text">事务日志–redo(重做日志)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97%E2%80%93undo%EF%BC%88%E5%9B%9E%E6%BB%9A%E6%97%A5%E5%BF%97%EF%BC%89"><span class="toc-number">1.12.7.</span> <span class="toc-text">事务日志–undo（回滚日志）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81"><span class="toc-number">1.12.8.</span> <span class="toc-text">锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%EF%BC%88transaction-isolation%EF%BC%89"><span class="toc-number">1.12.9.</span> <span class="toc-text">隔离级别（transaction_isolation）</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/imdadul-hussain-u_oLPS_ZYSc-unsplash.jpg"></div><div class="author-info__name text-center">Inaction</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">47</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">19</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">13</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friend Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://www.ji4n.cn/">Jen</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(img/beijing2.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Inaction's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">MySQL存储引擎-5</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-03-02</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/">Linux</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/MySQL/">MySQL</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h1><h2 id="存储引擎介绍"><a href="#存储引擎介绍" class="headerlink" title="存储引擎介绍"></a>存储引擎介绍</h2><p>存储引擎相当于Linux文件系统，只不过比文件系统强大，存储引擎是MySQL核心组件之一，在MySQL中是以插件的形式来提供的，InnoDB是MySQL最流行的存储引擎，XtraDB是Percona分支的默认存储引擎，可以理解是InnoDB的定制透明版本，TokuDB适合密集型写入的存储引擎，压缩比较高。我们可以在不同的业务场景下选择合适的存储引擎</p>
<p><strong>查看MySQL支持的存储引擎</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">engines</span>;</span><br><span class="line">+<span class="selector-tag">--------------------</span>+<span class="selector-tag">---------</span>+<span class="selector-tag">----------------------------------------------------------------</span>+<span class="selector-tag">--------------</span>+<span class="selector-tag">------</span>+<span class="selector-tag">------------</span>+</span><br><span class="line">| Engine             | Support | Comment                                                        | Transactions | XA   | Savepoints |</span><br><span class="line">+<span class="selector-tag">--------------------</span>+<span class="selector-tag">---------</span>+<span class="selector-tag">----------------------------------------------------------------</span>+<span class="selector-tag">--------------</span>+<span class="selector-tag">------</span>+<span class="selector-tag">------------</span>+</span><br><span class="line">| CSV                | YES     | CSV storage engine                                             | NO           | NO   | NO         |</span><br><span class="line">| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                          | NO           | NO   | NO         |</span><br><span class="line">| MyISAM             | YES     | MyISAM storage engine                                          | NO           | NO   | NO         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears) | NO           | NO   | NO         |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                             | NO           | NO   | NO         |</span><br><span class="line">| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables      | NO           | NO   | NO         |</span><br><span class="line">| ARCHIVE            | YES     | Archive storage engine                                         | NO           | NO   | NO         |</span><br><span class="line">| InnoDB             | DEFAULT | Supports transactions, row-level locking, and foreign keys     | YES          | YES  | YES        |</span><br><span class="line">| FEDERATED          | NO      | Federated MySQL storage engine                                 | NULL         | NULL | NULL       |</span><br><span class="line">+<span class="selector-tag">--------------------</span>+<span class="selector-tag">---------</span>+<span class="selector-tag">----------------------------------------------------------------</span>+<span class="selector-tag">--------------</span>+<span class="selector-tag">------</span>+<span class="selector-tag">------------</span>+</span><br></pre></td></tr></table></figure>
<p><strong>查看MySQL默认使用的存储引擎</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">select</span> @<span class="keyword">@default_storage_engine</span>;</span><br><span class="line">+<span class="selector-tag">--------------------------</span>+</span><br><span class="line">| @@default_storage_engine |</span><br><span class="line">+<span class="selector-tag">--------------------------</span>+</span><br><span class="line">| InnoDB                   |</span><br><span class="line">+<span class="selector-tag">--------------------------</span>+</span><br></pre></td></tr></table></figure>
<p><strong>查看world库中所有表使用的存储引擎</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; SELECT table_schema,table_name,ENGINE FROM information_schema.tables WHERE table_schema IN (&#x27;world&#x27;);</span><br><span class="line">+<span class="selector-tag">--------------</span>+<span class="selector-tag">-----------------</span>+<span class="selector-tag">--------</span>+</span><br><span class="line">| table_schema | table_name      | ENGINE |</span><br><span class="line">+<span class="selector-tag">--------------</span>+<span class="selector-tag">-----------------</span>+<span class="selector-tag">--------</span>+</span><br><span class="line">| world        | city            | InnoDB |</span><br><span class="line">| world        | country         | InnoDB |</span><br><span class="line">| world        | countrylanguage | InnoDB |</span><br><span class="line">+<span class="selector-tag">--------------</span>+<span class="selector-tag">-----------------</span>+<span class="selector-tag">--------</span>+</span><br></pre></td></tr></table></figure>
<p><strong>配置MySQL存储引擎</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/my.cnf</span><br><span class="line">default_storage_engine=InnoDB</span><br></pre></td></tr></table></figure>
<h2 id="InnoDB体系结构"><a href="#InnoDB体系结构" class="headerlink" title="InnoDB体系结构"></a>InnoDB体系结构</h2><p>三个部分，上面的是缓存层，中间是线程层，下面是系统文件层，在每个层里面又会不断地细分，在MySQL里面存储的单位是页，大小是16K</p>
<p>缓存层包含buffer和cache，其中buffer对应缓存修改的数据（比如insert buffer），cache对应缓存读取的舒适（比如page cache），通过缓存可以提高MySQL读写数据的效率</p>
<p>系统文件层是相应的数据字典、数据文件和日志文件，其中binlog是MySQL Server层</p>
<p>多线程设计是InnoDB的一大亮点，通过多线程的方式可以把缓存层与系统文件层的操作高效组织起来，使得Innodb可以提供完整的数据服务</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210301113303766.png"></p>
<h2 id="查看InnoDB状态的小技巧"><a href="#查看InnoDB状态的小技巧" class="headerlink" title="查看InnoDB状态的小技巧"></a>查看InnoDB状态的小技巧</h2><p>MySQL中如果要查看InnoDB的状态，推荐的方式是使用命令<code>show engine innodb status</code>.</p>
<p>头部内容信息显示当前的日期和时间，以及自上次输出依赖经过的时长，从时间和描述可看到这个命令的输出不是实时的结果</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">engine</span> <span class="selector-tag">innodb</span> <span class="selector-tag">status</span>\<span class="selector-tag">G</span>:</span><br><span class="line">*************************** 1. <span class="selector-tag">row</span> ***************************</span><br><span class="line">  <span class="selector-tag">Type</span>: <span class="selector-tag">InnoDB</span></span><br><span class="line">  <span class="selector-tag">Name</span>: </span><br><span class="line"><span class="selector-tag">Status</span>: </span><br><span class="line">=====================================</span><br><span class="line">2021<span class="selector-tag">-02-18</span> 22<span class="selector-pseudo">:30</span><span class="selector-pseudo">:51</span> 0<span class="selector-tag">x7fe3880f4700</span> <span class="selector-tag">INNODB</span> <span class="selector-tag">MONITOR</span> <span class="selector-tag">OUTPUT</span></span><br><span class="line">=====================================</span><br><span class="line"><span class="selector-tag">Per</span> <span class="selector-tag">second</span> <span class="selector-tag">averages</span> <span class="selector-tag">calculated</span> <span class="selector-tag">from</span> <span class="selector-tag">the</span> <span class="selector-tag">last</span> 5 <span class="selector-tag">seconds</span></span><br></pre></td></tr></table></figure>
<h3 id="如何查看show-engine-innodb-status保留下的内容"><a href="#如何查看show-engine-innodb-status保留下的内容" class="headerlink" title="如何查看show engine innodb status保留下的内容"></a>如何查看show engine innodb status保留下的内容</h3><p><strong>1. 首先查看mysqld的进程号</strong></p>
<blockquote>
<p>可以看到要找的进程号是：9315</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ps -ef|grep mysqld|grep -v grep</span><br><span class="line">mysql      2846      1  0 Feb16 ?        00:03:04 /application/mysql/bin/mysqld --defaults-file=/data/3309/my.cnf</span><br><span class="line">mysql      2880      1  0 Feb16 ?        00:03:14 /application/mysql/bin/mysqld --defaults-file=/data/3308/my.cnf</span><br><span class="line">mysql      2914      1  0 Feb16 ?        00:03:12 /application/mysql/bin/mysqld --defaults-file=/data/3307/my.cnf</span><br><span class="line">root       9138      1  0 01:46 ?        00:00:00 /bin/sh /application/mysql/bin/mysqld_safe --datadir=/data/mysql/data --pid-file=/data/mysql/data/mysql.pid</span><br><span class="line">mysql      9315   9138  0 01:46 ?        00:02:00 /application/mysql/bin/mysqld --basedir=/application/mysql --datadir=/data/mysql/data --plugin-dir=/application/mysql/lib/plugin --user=mysql --log-error=mysql.err --pid-file=/data/mysql/data/mysql.pid --socket=/tmp/mysql.sock</span><br></pre></td></tr></table></figure>
<p><strong>2. 在操作系统层面查看上述MySQL的句柄，显示如下</strong></p>
<blockquote>
<p>但是这么多文件，无法判定那个文件是要我们找的</p>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$  ll /proc/9315/fd|grep deleted</span><br><span class="line"><span class="selector-tag">lrwx------</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 64 <span class="selector-tag">Feb</span> 18 22<span class="selector-pseudo">:25</span> 12 <span class="selector-tag">-</span>&gt; /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibC9Z4PI</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">lrwx------</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 64 <span class="selector-tag">Feb</span> 18 22<span class="selector-pseudo">:25</span> 27 <span class="selector-tag">-</span>&gt; /<span class="selector-tag">data</span>/<span class="selector-tag">mysql</span>/<span class="selector-tag">data</span>/<span class="selector-tag">world</span>/<span class="selector-tag">test</span><span class="selector-class">.ibd</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">lrwx------</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 64 <span class="selector-tag">Feb</span> 18 22<span class="selector-pseudo">:25</span> 28 <span class="selector-tag">-</span>&gt; /<span class="selector-tag">data</span>/<span class="selector-tag">mysql</span>/<span class="selector-tag">data</span>/<span class="selector-tag">world</span>/<span class="selector-tag">test1</span><span class="selector-class">.ibd</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">lrwx------</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 64 <span class="selector-tag">Feb</span> 18 22<span class="selector-pseudo">:25</span> 29 <span class="selector-tag">-</span>&gt; /<span class="selector-tag">data</span>/<span class="selector-tag">mysql</span>/<span class="selector-tag">data</span>/<span class="selector-tag">binlog</span>/<span class="selector-tag">t1</span><span class="selector-class">.ibd</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">lrwx------</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 64 <span class="selector-tag">Feb</span> 18 22<span class="selector-pseudo">:25</span> 5 <span class="selector-tag">-</span>&gt; /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibRoyuZC</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">lrwx------</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 64 <span class="selector-tag">Feb</span> 18 22<span class="selector-pseudo">:25</span> 6 <span class="selector-tag">-</span>&gt; /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibdDJsjf</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">lrwx------</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 64 <span class="selector-tag">Feb</span> 18 22<span class="selector-pseudo">:25</span> 7 <span class="selector-tag">-</span>&gt; /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibkyUxDR</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">lrwx------</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 64 <span class="selector-tag">Feb</span> 18 22<span class="selector-pseudo">:25</span> 8 <span class="selector-tag">-</span>&gt; /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibIk2Dm6</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">lrwx------</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 64 <span class="selector-tag">Feb</span> 18 22<span class="selector-pseudo">:25</span> 90 <span class="selector-tag">-</span>&gt; /<span class="selector-tag">data</span>/<span class="selector-tag">mysql</span>/<span class="selector-tag">data</span>/<span class="selector-tag">world</span>/<span class="selector-tag">pp</span><span class="selector-class">.ibd</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">lrwx------</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 64 <span class="selector-tag">Feb</span> 18 22<span class="selector-pseudo">:25</span> 91 <span class="selector-tag">-</span>&gt; /<span class="selector-tag">data</span>/<span class="selector-tag">mysql</span>/<span class="selector-tag">data</span>/<span class="selector-tag">world</span>/<span class="selector-tag">t100</span><span class="selector-class">.ibd</span> (<span class="selector-tag">deleted</span>)</span><br></pre></td></tr></table></figure>
<p><strong>3. 可以根据lsof命令来输出句柄信息，显示如下</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ lsof -c mysqld|grep deleted</span><br><span class="line"><span class="selector-tag">mysqld</span>    2914 <span class="selector-tag">mysql</span>   12<span class="selector-tag">u</span>   <span class="selector-tag">REG</span>              253,0         0 17215061 /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibYlTgqJ</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">mysqld_sa</span> 9138  <span class="selector-tag">root</span>    2<span class="selector-tag">u</span>   <span class="selector-tag">CHR</span>              136,3       0<span class="selector-tag">t0</span>        6 /<span class="selector-tag">dev</span>/<span class="selector-tag">pts</span>/3 (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">mysqld</span>    9315 <span class="selector-tag">mysql</span>    5<span class="selector-tag">u</span>   <span class="selector-tag">REG</span>              253,0      4363 16777294 /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibRoyuZC</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">mysqld</span>    9315 <span class="selector-tag">mysql</span>    6<span class="selector-tag">u</span>   <span class="selector-tag">REG</span>              253,0        97 16778321 /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibdDJsjf</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">mysqld</span>    9315 <span class="selector-tag">mysql</span>    7<span class="selector-tag">u</span>   <span class="selector-tag">REG</span>              253,0         0 16785261 /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibkyUxDR</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">mysqld</span>    9315 <span class="selector-tag">mysql</span>    8<span class="selector-tag">u</span>   <span class="selector-tag">REG</span>              253,0         0 17458882 /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibIk2Dm6</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">mysqld</span>    9315 <span class="selector-tag">mysql</span>   12<span class="selector-tag">u</span>   <span class="selector-tag">REG</span>              253,0         0 17458885 /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibC9Z4PI</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">mysqld</span>    9315 <span class="selector-tag">mysql</span>   27<span class="selector-tag">uW</span>  <span class="selector-tag">REG</span>               8,16     98304  8416762 /<span class="selector-tag">data</span>/<span class="selector-tag">mysql</span>/<span class="selector-tag">data</span>/<span class="selector-tag">world</span>/<span class="selector-tag">test</span><span class="selector-class">.ibd</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">mysqld</span>    9315 <span class="selector-tag">mysql</span>   28<span class="selector-tag">uW</span>  <span class="selector-tag">REG</span>               8,16     98304  8416764 /<span class="selector-tag">data</span>/<span class="selector-tag">mysql</span>/<span class="selector-tag">data</span>/<span class="selector-tag">world</span>/<span class="selector-tag">test1</span><span class="selector-class">.ibd</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">mysqld</span>    9315 <span class="selector-tag">mysql</span>   29<span class="selector-tag">uW</span>  <span class="selector-tag">REG</span>               8,16     98304  8416768 /<span class="selector-tag">data</span>/<span class="selector-tag">mysql</span>/<span class="selector-tag">data</span>/<span class="selector-tag">binlog</span>/<span class="selector-tag">t1</span><span class="selector-class">.ibd</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">mysqld</span>    9315 <span class="selector-tag">mysql</span>   90<span class="selector-tag">uW</span>  <span class="selector-tag">REG</span>               8,16     98304  8416760 /<span class="selector-tag">data</span>/<span class="selector-tag">mysql</span>/<span class="selector-tag">data</span>/<span class="selector-tag">world</span>/<span class="selector-tag">pp</span><span class="selector-class">.ibd</span> (<span class="selector-tag">deleted</span>)</span><br><span class="line"><span class="selector-tag">mysqld</span>    9315 <span class="selector-tag">mysql</span>   91<span class="selector-tag">uW</span>  <span class="selector-tag">REG</span>               8,16  79691776  8416757 /<span class="selector-tag">data</span>/<span class="selector-tag">mysql</span>/<span class="selector-tag">data</span>/<span class="selector-tag">world</span>/<span class="selector-tag">t100</span><span class="selector-class">.ibd</span> (<span class="selector-tag">deleted</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果没有该命令，则使用该命令下载：yum install -y lsof</p>
<p>需要注意第7列，可以看到只有两个是有数据的，分别查看一下就得到show engine innodb status的输出结果，即文件/tmp/ibRoyuZC，而映射的是5号文件</p>
</blockquote>
<p><strong>4. 查看5号文件，得到信息</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/<span class="selector-tag">proc</span>/9315/<span class="selector-tag">fd</span></span><br><span class="line">$ cat 5</span><br><span class="line"></span><br><span class="line">=====================================</span><br><span class="line">2021<span class="selector-tag">-02-18</span> 22<span class="selector-pseudo">:30</span><span class="selector-pseudo">:51</span> 0<span class="selector-tag">x7fe3880f4700</span> <span class="selector-tag">INNODB</span> <span class="selector-tag">MONITOR</span> <span class="selector-tag">OUTPUT</span></span><br><span class="line">=====================================</span><br><span class="line"><span class="selector-tag">Per</span> <span class="selector-tag">second</span> <span class="selector-tag">averages</span> <span class="selector-tag">calculated</span> <span class="selector-tag">from</span> <span class="selector-tag">the</span> <span class="selector-tag">last</span> 5 <span class="selector-tag">seconds</span></span><br></pre></td></tr></table></figure>
<h2 id="InnoDB的多线程技术"><a href="#InnoDB的多线程技术" class="headerlink" title="InnoDB的多线程技术"></a>InnoDB的多线程技术</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210301123223470.png" alt="."></p>
<p>InnoDB的线程主要分为4类：Master Thread、IO Thread、Purge Thread和Page Cleaner Thread</p>
<p>Master Thread是InnoDB的核心线程，早期的很多事情都是由它来做，算是一个全栈线程。自MySQL 5.5版开始引入了purge thread，将purge任务从master中独立出来，值MySQL 5.6.2版开始引入了Page cleaner thread</p>
<table>
<thead>
<tr>
<th>线程</th>
<th>功能描述</th>
<th>相关数据库参数</th>
</tr>
</thead>
<tbody><tr>
<td>Master Thread</td>
<td>是核心的后台线程，主要负责异步刷新和数据－致性处理</td>
<td></td>
</tr>
<tr>
<td>IO Thread</td>
<td>使用了异步IO模型，负责处理不同类型的IO请求回调</td>
<td>innodb_read_io_threads、innodb_write_io_threads</td>
</tr>
<tr>
<td>Purge Thread</td>
<td>事务提交后回收已经使用并分配的undo页，线程数从1提高到4，加快标记为废弃undo页的回收速度</td>
<td>innodb_purge_threads</td>
</tr>
<tr>
<td>Page Cleaner Thread</td>
<td>执行buffer pool里面脏页刷新操作，可以进行调整，默认为1，最大为64</td>
<td>innodb_page_cleaners</td>
</tr>
</tbody></table>
<p>其中Master Thread在输出如下：测试环境下，没有什么负载，其中srv_master_thread loops是Master线程的循环次数，每次循环时会选择一种状态（atcive、shutdown、idle）执行，其中Active数量增加与数据变化有关，与查询无关，可以通过srv_active和srv_idle的差异看出</p>
<p>通过对比active和idle的值，来获取系统整体负载情况，如果Active的值越大，证明服务越繁忙。这里是测试环境，所以idle多余active</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">BACKGROUND</span> <span class="selector-tag">THREAD</span></span><br><span class="line"><span class="selector-tag">-----------------</span></span><br><span class="line"><span class="selector-tag">srv_master_thread</span> <span class="selector-tag">loops</span>: 70 <span class="selector-tag">srv_active</span>, 0 <span class="selector-tag">srv_shutdown</span>, 75924 <span class="selector-tag">srv_idle</span></span><br><span class="line"><span class="selector-tag">srv_master_thread</span> <span class="selector-tag">log</span> <span class="selector-tag">flush</span> <span class="selector-tag">and</span> <span class="selector-tag">writes</span>: 75994</span><br></pre></td></tr></table></figure>
<p>IO thread都是异步请求，其中read thread默认为4个，write thread默认为4个，log thread和insert buffer thread各1个，read和write都可以通过上述表格参数调整</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">--------</span></span><br><span class="line"><span class="selector-tag">FILE</span> <span class="selector-tag">I</span>/<span class="selector-tag">O</span></span><br><span class="line"><span class="selector-tag">--------</span></span><br><span class="line"><span class="selector-tag">I</span>/<span class="selector-tag">O</span> <span class="selector-tag">thread</span> 0 <span class="selector-tag">state</span>: <span class="selector-tag">waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">completed</span> <span class="selector-tag">aio</span> <span class="selector-tag">requests</span> (<span class="selector-tag">insert</span> <span class="selector-tag">buffer</span> <span class="selector-tag">thread</span>)</span><br><span class="line"><span class="selector-tag">I</span>/<span class="selector-tag">O</span> <span class="selector-tag">thread</span> 1 <span class="selector-tag">state</span>: <span class="selector-tag">waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">completed</span> <span class="selector-tag">aio</span> <span class="selector-tag">requests</span> (<span class="selector-tag">log</span> <span class="selector-tag">thread</span>)</span><br><span class="line"><span class="selector-tag">I</span>/<span class="selector-tag">O</span> <span class="selector-tag">thread</span> 2 <span class="selector-tag">state</span>: <span class="selector-tag">waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">completed</span> <span class="selector-tag">aio</span> <span class="selector-tag">requests</span> (<span class="selector-tag">read</span> <span class="selector-tag">thread</span>)</span><br><span class="line"><span class="selector-tag">I</span>/<span class="selector-tag">O</span> <span class="selector-tag">thread</span> 3 <span class="selector-tag">state</span>: <span class="selector-tag">waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">completed</span> <span class="selector-tag">aio</span> <span class="selector-tag">requests</span> (<span class="selector-tag">read</span> <span class="selector-tag">thread</span>)</span><br><span class="line"><span class="selector-tag">I</span>/<span class="selector-tag">O</span> <span class="selector-tag">thread</span> 4 <span class="selector-tag">state</span>: <span class="selector-tag">waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">completed</span> <span class="selector-tag">aio</span> <span class="selector-tag">requests</span> (<span class="selector-tag">read</span> <span class="selector-tag">thread</span>)</span><br><span class="line"><span class="selector-tag">I</span>/<span class="selector-tag">O</span> <span class="selector-tag">thread</span> 5 <span class="selector-tag">state</span>: <span class="selector-tag">waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">completed</span> <span class="selector-tag">aio</span> <span class="selector-tag">requests</span> (<span class="selector-tag">read</span> <span class="selector-tag">thread</span>)</span><br><span class="line"><span class="selector-tag">I</span>/<span class="selector-tag">O</span> <span class="selector-tag">thread</span> 6 <span class="selector-tag">state</span>: <span class="selector-tag">waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">completed</span> <span class="selector-tag">aio</span> <span class="selector-tag">requests</span> (<span class="selector-tag">write</span> <span class="selector-tag">thread</span>)</span><br><span class="line"><span class="selector-tag">I</span>/<span class="selector-tag">O</span> <span class="selector-tag">thread</span> 7 <span class="selector-tag">state</span>: <span class="selector-tag">waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">completed</span> <span class="selector-tag">aio</span> <span class="selector-tag">requests</span> (<span class="selector-tag">write</span> <span class="selector-tag">thread</span>)</span><br><span class="line"><span class="selector-tag">I</span>/<span class="selector-tag">O</span> <span class="selector-tag">thread</span> 8 <span class="selector-tag">state</span>: <span class="selector-tag">waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">completed</span> <span class="selector-tag">aio</span> <span class="selector-tag">requests</span> (<span class="selector-tag">write</span> <span class="selector-tag">thread</span>)</span><br><span class="line"><span class="selector-tag">I</span>/<span class="selector-tag">O</span> <span class="selector-tag">thread</span> 9 <span class="selector-tag">state</span>: <span class="selector-tag">waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">completed</span> <span class="selector-tag">aio</span> <span class="selector-tag">requests</span> (<span class="selector-tag">write</span> <span class="selector-tag">thread</span>)</span><br></pre></td></tr></table></figure>
<p>Purge thread默认会开启4个线程，提高回收效率，但是也会带来一些副作用，MySQL如果执行了truncate和drop操作，因为开启了多个purge thread去回收空间，随着时间的推移会使得数据恢复难打加大</p>
<p>Page Cleaner thread默认值为1，如果在MySQL日志中看到如下的信息，说明我们需要调整一下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2019 <span class="selector-tag">-</span> 02 <span class="selector-tag">-</span> 14<span class="selector-tag">T23</span> : 50 : 00 . 501209<span class="selector-tag">Z</span> 0 <span class="selector-attr">[Note]</span> <span class="selector-tag">InnoDB</span>: <span class="selector-tag">page_cleaner</span> : <span class="selector-tag">lOOOms</span> <span class="selector-tag">intended</span></span><br><span class="line">loop took 28469710ms . The settings m工ght not be optimal . (flushed=O and</span><br><span class="line">evicted=O , during the time.)</span><br></pre></td></tr></table></figure>
<h2 id="InnoDB的缓存池管理技术"><a href="#InnoDB的缓存池管理技术" class="headerlink" title="InnoDB的缓存池管理技术"></a>InnoDB的缓存池管理技术</h2><p>Buffer的意识缓冲，cache是缓存，计算机术语里面有buffer cache和page cache，通数据库的含义是相似的</p>
<p>计算机领域汇总处理磁盘IO读写时候，基于CPU、Memory和Disk，如图</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210301133510778.png"></p>
<p>page cache是文件系统层面的缓存，数据库层面最直观就是首次查询数据的时候会慢一些，之后就会使用缓存会快速很多，整个过程是把磁盘里的数据里的一部分数据加载到缓存中</p>
<p>buffer cache，是在写入磁盘时给与的缓冲，加快写入，是一个异步过程，而且为了防止断电丢失数据库，会按照一定的策略把数据刷新到磁盘</p>
<p>理解MySQL里面的缓存池管理，使用show engine innodb status看一下缓冲池和内存输出内容，通过关键字“BUFFER POOL AND MEMORY”到该位置</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">----------------------</span></span><br><span class="line"><span class="selector-tag">BUFFER</span> <span class="selector-tag">POOL</span> <span class="selector-tag">AND</span> <span class="selector-tag">MEMORY</span></span><br><span class="line"><span class="selector-tag">----------------------</span></span><br><span class="line"><span class="selector-tag">Total</span> <span class="selector-tag">large</span> <span class="selector-tag">memory</span> <span class="selector-tag">allocated</span> 137428992              //由<span class="selector-tag">innodb</span>分配的总内存为12<span class="selector-tag">G</span></span><br><span class="line"><span class="selector-tag">Dictionary</span> <span class="selector-tag">memory</span> <span class="selector-tag">allocated</span> 221523                  //由<span class="selector-tag">innodb</span>分配的字典内容</span><br><span class="line"><span class="selector-tag">Buffer</span> <span class="selector-tag">pool</span> <span class="selector-tag">size</span>   8191                             //缓冲池分配的页数</span><br><span class="line"><span class="selector-tag">Free</span> <span class="selector-tag">buffers</span>       1455                             //缓冲空闲页数</span><br><span class="line"><span class="selector-tag">Database</span> <span class="selector-tag">pages</span>     6736                             //<span class="selector-tag">LRU</span>列表中分配的数据页数，包含<span class="selector-tag">young</span> <span class="selector-tag">sublist</span>和<span class="selector-tag">old</span> <span class="selector-tag">sublist</span></span><br><span class="line"><span class="selector-tag">Old</span> <span class="selector-tag">database</span> <span class="selector-tag">pages</span> 2500                             //<span class="selector-tag">LRU</span>中的<span class="selector-tag">old</span> <span class="selector-tag">sublist</span>部分页的数量</span><br><span class="line"><span class="selector-tag">Modified</span> <span class="selector-tag">db</span> <span class="selector-tag">pages</span>  0                                //脏页的数量</span><br><span class="line"><span class="selector-tag">Pending</span> <span class="selector-tag">reads</span>      0                                //挂起读的数量</span><br><span class="line"><span class="selector-tag">Pending</span> <span class="selector-tag">writes</span>: <span class="selector-tag">LRU</span> 0, <span class="selector-tag">flush</span> <span class="selector-tag">list</span> 0, <span class="selector-tag">single</span> <span class="selector-tag">page</span> 0  //挂起写的数量</span><br><span class="line"><span class="selector-tag">Pages</span> <span class="selector-tag">made</span> <span class="selector-tag">young</span> 0, <span class="selector-tag">not</span> <span class="selector-tag">young</span> 0                     //<span class="selector-tag">LRU</span>列表中页移动到<span class="selector-tag">LRU</span>首部的次数，因为该服务器运行阶段没有达到<span class="selector-tag">innodb</span> <span class="selector-tag">old</span> <span class="selector-tag">blocks</span> <span class="selector-tag">time</span>阈值的值，因此<span class="selector-tag">not</span> <span class="selector-tag">young</span>为0</span><br><span class="line">0.00 <span class="selector-tag">youngs</span>/<span class="selector-tag">s</span>, 0.00 <span class="selector-tag">non-youngs</span>/<span class="selector-tag">s</span>                    //表示每秒<span class="selector-tag">young</span>和<span class="selector-tag">non-young</span>操作次数</span><br><span class="line"><span class="selector-tag">Pages</span> <span class="selector-tag">read</span> 6676, <span class="selector-tag">created</span> 60, <span class="selector-tag">written</span> 328            //读取、创建、写入的页</span><br><span class="line">0.00 <span class="selector-tag">reads</span>/<span class="selector-tag">s</span>, 0.00 <span class="selector-tag">creates</span>/<span class="selector-tag">s</span>, 0.00 <span class="selector-tag">writes</span>/<span class="selector-tag">s</span></span><br><span class="line"><span class="selector-tag">No</span> <span class="selector-tag">buffer</span> <span class="selector-tag">pool</span> <span class="selector-tag">page</span> <span class="selector-tag">gets</span> <span class="selector-tag">since</span> <span class="selector-tag">the</span> <span class="selector-tag">last</span> <span class="selector-tag">printout</span></span><br><span class="line"><span class="selector-tag">Pages</span> <span class="selector-tag">read</span> <span class="selector-tag">ahead</span> 0.00/<span class="selector-tag">s</span>, <span class="selector-tag">evicted</span> <span class="selector-tag">without</span> <span class="selector-tag">access</span> 0.00/<span class="selector-tag">s</span>, <span class="selector-tag">Random</span> <span class="selector-tag">read</span> <span class="selector-tag">ahead</span> 0.00/<span class="selector-tag">s</span></span><br><span class="line"><span class="selector-tag">LRU</span> <span class="selector-tag">len</span>: 6736, <span class="selector-tag">unzip_LRU</span> <span class="selector-tag">len</span>: 0</span><br></pre></td></tr></table></figure>
<p>LRU本质是尽可能让数据页在缓存中长时间保留，提高访问效率，但是缓存是有限的，如何减少重复的页加载频率。</p>
<p>InnoDB的LRU是一种定制化的算法，首先它会有一个列表，我们叫 LRU LIST，上面存放了一些数据页，这里就是 Database pages<br>6736，除此之外可用的页为 ： Free buffers 1455，演示的是测试环境，所以对于生产环境会有所不同（如果你比较细心比较，会发现 Free buffers +Database pages 的值和 Buffer pool size 的大小是不相等的 ， 其实还有一些其他缓冲池的页被分配利用，比如自适应哈希索引、 Lock信息等，它们的管理不是基于LRU 的） </p>
<p>回到 LRU 算法， InnoDB 在 LRU 列表中加入了参考点，也叫midpoint。 传统的 LRU 算法中 ， 当访问到的<strong>页不在缓冲区</strong>会直接将<strong>磁盘页数据</strong>调到<strong>缓冲区队列</strong>；而 InnoDB 并不是直接插入到缓冲区队列的队头，而是插入 LRU 列表的<strong>midpoint位置</strong>。 这个算法称之为 midpoint insertion stategy（中点插入策略）。默认配置插入到列表长度的 5/8 处 ，和数学中的黄金分割（ 0.618 ）很接近，midpoint 由参数 innodb_old_blocks_pct 控制，简单验算验证一下 ，可以看到是很接近的值   </p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">select</span> 5/8 , 1<span class="selector-tag">-</span> 120340/326446 , 100 <span class="selector-tag">-</span> @<span class="keyword">@innodb_old_blocks_pct</span>;</span><br><span class="line">+<span class="selector-tag">--------</span>+<span class="selector-tag">------------------</span>+<span class="selector-tag">-------------------------------</span>+</span><br><span class="line">| 5/8    | 1- 120340/326446 | 100 - @@innodb_old_blocks_pct |</span><br><span class="line">+<span class="selector-tag">--------</span>+<span class="selector-tag">------------------</span>+<span class="selector-tag">-------------------------------</span>+</span><br><span class="line">| 0.6250 |           0.6314 |                            63 |</span><br><span class="line">+<span class="selector-tag">--------</span>+<span class="selector-tag">------------------</span>+<span class="selector-tag">-------------------------------</span>+</span><br></pre></td></tr></table></figure>
<p>midpoint 之前的列表称之为 new 列 表， 也叫 young sublist 或者 sublist of new block 区域 ，里面的数据可以理解为热数据，之后的列表称之为 old 列表 ，也叫 old sublist 或者 sublist of old block 区域</p>
<p><strong>关系图如下</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210218235156463.png"></p>
<p>一些全表扫描的表如果进入 sublist of new block 区域 ，整个 LRU 就会是性能瓶颈了，而且 mid 位置的页也不是永久的，这种情况也叫缓存污染。为了解决这个问题 ， InnoDB 存储引 擎引入 了 innodb old blocks time 来表示页读取到 mid 位置之后需要等待多久才会被加入到 LRU 列表的热端。可以通过设置该参数来保证热点数据不轻易被刷出 ，这个参数值默认为 1000 （毫秒）。</p>
<p>如果出现了多个BUFFER POOL的输出，BUFFER POOL会从0开始；通过该参数进行调整：innodb_buffer_pool_instances开启多个缓存池，把需要的数据页可以通过hash算法指向不同的缓存池里面，可以并行的内存读写，在高IO负载的情况下性能提升明显</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">select</span> @<span class="keyword">@innodb_buffer_pool_instances</span>;</span><br><span class="line">+<span class="selector-tag">--------------------------------</span>+</span><br><span class="line">| @@innodb_buffer_pool_instances |</span><br><span class="line">+<span class="selector-tag">--------------------------------</span>+</span><br><span class="line">|                              1 |</span><br><span class="line">+<span class="selector-tag">--------------------------------</span>+</span><br></pre></td></tr></table></figure>
<h2 id="InnoDB中的脏页管理"><a href="#InnoDB中的脏页管理" class="headerlink" title="InnoDB中的脏页管理"></a>InnoDB中的脏页管理</h2><p>上述说明了InnoDB对于LRU的管理方式，还有FLUSH LIST和FREE LIST，它们和LUR LIST有什么关系呢？</p>
<p><strong>在InnoDB status里面输出的内容,这个free buffers是由FREE LIST来维护的</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Free</span> <span class="selector-tag">buffers</span>       1455</span><br></pre></td></tr></table></figure>
<p>对于脏页的管理，InnoDB有一个专门的列表FLUSH LIST，它的大小不是无限大或者动态的，在MySQL5.6版本中引入了新参数innodb_lru_scan_depth来控制LRU列表中可用页数量，默认值为1000，即16M，它会影响现成Page Cleaner 刷新脏页的数量，从使用率和性能来说，不是越大越好</p>
<p>为什么FLUSH LIST俩维护脏页的和数量，主要目的是让InnoDB尽可能保持一个较新的状态，在系统崩溃之后能够快速地恢复，这个在数据状态的记录汇总是通过Checkpoint LSN来维护的、</p>
<p>而对于脏页的刷新比例，是由参数 innodb_max_dirty_pages_pct 来控制的（默认是75 ，而根据谷歌压测推荐是80 ）</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">select</span> @<span class="keyword">@innodb_max_dirty_pages_pct</span>;</span><br><span class="line">+<span class="selector-tag">------------------------------</span>+</span><br><span class="line">| @@innodb_max_dirty_pages_pct |</span><br><span class="line">+<span class="selector-tag">------------------------------</span>+</span><br><span class="line">|                    75.000000 |</span><br><span class="line">+<span class="selector-tag">------------------------------</span>+</span><br></pre></td></tr></table></figure>
<p><strong>LIST之间的关系图</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210219161723158.png"></p>
<p><strong>其中buffer pool中的最小单位是页，分为三种类型</strong></p>
<blockquote>
<ul>
<li>free page：此page未被使用，此种类型page位于FREE LIST中</li>
<li>clean page：此page被使用，对应数据文件中的一个页面，但是页面没有被修改，此种类型page位于LRU LIST中</li>
<li>dirty page：此page被使用，对应数据文件中的一个页面，但是页面被修改过，此种类型page位于LRU LIST和FLUSH LIST中</li>
</ul>
</blockquote>
<p><strong>可以通过下述方法查看page的状态数据</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; show global status like &#x27;%buffer_pool_pages%&#x27;;</span><br><span class="line">+<span class="selector-tag">----------------------------------</span>+<span class="selector-tag">-------</span>+</span><br><span class="line">| Variable_name                    | Value |</span><br><span class="line">+<span class="selector-tag">----------------------------------</span>+<span class="selector-tag">-------</span>+</span><br><span class="line">| Innodb_buffer_pool_pages_data    | 6736  |</span><br><span class="line">| Innodb_buffer_pool_pages_dirty   | 0     |</span><br><span class="line">| Innodb_buffer_pool_pages_flushed | 328   |</span><br><span class="line">| Innodb_buffer_pool_pages_free    | 1455  |</span><br><span class="line">| Innodb_buffer_pool_pages_misc    | 0     |</span><br><span class="line">| Innodb_buffer_pool_pages_total   | 8191  |</span><br><span class="line">+<span class="selector-tag">----------------------------------</span>+<span class="selector-tag">-------</span>+</span><br></pre></td></tr></table></figure>
<p><strong>其中，脏页的比率计算可以参考如下：</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(100*<span class="selector-tag">Innodb_buffer_pool_pages_dirty</span>)/(1+<span class="selector-tag">Innodb_buffer_pool_pages_data</span>+<span class="selector-tag">Innodb_buffer_pool_pages_free</span>)</span><br></pre></td></tr></table></figure>
<p>缓存池中的页就是在这种状态中变换和调整：总体来说，FLUSH LIST是一种定量的管理方式，追求多块好省，而FREE LIST和LRU LIST是一种动态平衡的状态，大小要远远高于FLUSH LIST</p>
<h2 id="InnoDB的日志管理"><a href="#InnoDB的日志管理" class="headerlink" title="InnoDB的日志管理"></a>InnoDB的日志管理</h2><p>InnoDB里面的数据变化都会有相应的页来存储，通过FLUSH LIST来刷新脏页以完成数据落盘，这个过程还需要注意，为了提高吞吐量和性能，刷新脏页的过程是异步的，而一旦数据库崩溃，如何保证数据的完整性，首选得有记录数据变化过程的日志</p>
<blockquote>
<ul>
<li>REDO日志：Innodb的事务日志，保存在日志文件ib_logfile*中</li>
<li>UNDO lOG日志：存放在共享表空间里面（ibdata*文件），从MySQL5.7版本开始，undo开始有了新的变化</li>
</ul>
</blockquote>
<p>假设我们有如下一条SQL语句</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update test set id=100;</span><br></pre></td></tr></table></figure>
<p>在InnoDB处理的时候，会把相应的页加载到Buffer Pool里面，数据的变化会写入redo log buffer，而事务提交的时候会通过Redo Log Buffer把数据变化写入Redo Log里面</p>
<p><strong>为什么Binlog和Redo会并存</strong></p>
<blockquote>
<ul>
<li>Redo是Innodb引擎的范畴，记录物理页的修改，做崩溃恢复时所用</li>
<li>Binlog是MySQL Server范畴，记录的是数据的变更操作，支持多种存储引擎，也就是无论是MyISAM和Innodb等存储引擎，Binlog都会记录，所以数据恢复和搭建Slave经常会用来</li>
</ul>
</blockquote>
<p><strong>一次数据变更，产生了Binlog和Redo，它们是否需要同步</strong></p>
<blockquote>
<p>需要两个重量级参数innodb_flush_log_at_trx_commit和sync_binlog，其中innodb_flush_log_at_trx_commit是将事务日志从innodb log buffer写入到redo log中，sync_binlog是将二进制日志文件刷新到磁盘上，它们就是行业里著名的双“1”参数，其中以innodb_flush_log_at_trx_commit更为出名</p>
</blockquote>
<p><strong>下表是innodb_flush_log_at_trx_commit=x的参数</strong></p>
<table>
<thead>
<tr>
<th>参数选项</th>
<th>日志写入模式</th>
<th>刷盘模式</th>
<th>小结</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>延时写日志</td>
<td></td>
<td>log buffer每个1秒写日志，数据刷盘</td>
<td>最快，存在数据丢失风险</td>
</tr>
<tr>
<td>1</td>
<td>实时写日志</td>
<td>实时刷盘</td>
<td>log buffer实时写日志，数据刷盘</td>
<td>最大安全性</td>
</tr>
<tr>
<td>2</td>
<td>实时写日志</td>
<td>延迟刷盘</td>
<td>log buffer实时写日志，每隔1秒刷盘</td>
<td>较快，存在数据丢失风险</td>
</tr>
</tbody></table>
<blockquote>
<p>注：在数据导入中，为了提高性能，可以考虑临时调整参数值innodb_flush_log_at_trx_commit为0，数据导入后，恢复为1</p>
</blockquote>
<p>下图可以对双 1 参数做一各更为细致地解读，可以看到一各较为完整的生命周期</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210301163433167.png"></p>
<p>undo记录了数据修改的前镜像。存放在ibdata中，它就好比是一个摄像机，记录了过去的美好时光</p>
<h2 id="InnoDB中的检查机制"><a href="#InnoDB中的检查机制" class="headerlink" title="InnoDB中的检查机制"></a>InnoDB中的检查机制</h2><p>如果数据库宕机，可以借助redo来完成崩溃恢复，如何使用恢复的过程高效可行，就需要考虑检查点机制（checkpoint)，检查点机制就跟我们使用word编辑文件一样，建议大家使用过程中边编辑边保存，否则电脑突然断电，可能照成数据丢失</p>
<p>对于InnoDB存储引擎而言，是通过LSN（Log Sequence Number）来标记版本的。LSN是8字节的数字，每个页有LSN，重做日志中也有LSN，Checkpoint也有LSN。可以看下InnoDB status的输出内容</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">---</span></span><br><span class="line"><span class="selector-tag">LOG</span></span><br><span class="line"><span class="selector-tag">---</span></span><br><span class="line"><span class="selector-tag">Log</span> <span class="selector-tag">sequence</span> <span class="selector-tag">number</span> 167362280                 //<span class="selector-tag">LSN1</span>，当前系统<span class="selector-tag">LSN</span>最大值，新的事务日志，<span class="selector-tag">LSN</span>将在此基础上生成（<span class="selector-tag">LSN1</span>+新日志的大小）</span><br><span class="line"><span class="selector-tag">Log</span> <span class="selector-tag">flushed</span> <span class="selector-tag">up</span> <span class="selector-tag">to</span>   167362280                 //<span class="selector-tag">LSN2</span>，当前已经写入日志文件的<span class="selector-tag">LSN</span></span><br><span class="line"><span class="selector-tag">Pages</span> <span class="selector-tag">flushed</span> <span class="selector-tag">up</span> <span class="selector-tag">to</span> 167362280                 //<span class="selector-tag">LSN3</span>，当前最旧的脏页数据对应的<span class="selector-tag">LSN</span>，写<span class="selector-tag">Checkpoint</span>的时候直接将此<span class="selector-tag">LSN</span>写入到日志文件</span><br><span class="line"><span class="selector-tag">Last</span> <span class="selector-tag">checkpoint</span> <span class="selector-tag">at</span>  167362271                 //<span class="selector-tag">LSN4</span>，当前已经写入<span class="selector-tag">Checkpoint</span>的<span class="selector-tag">LSN</span></span><br><span class="line">0 <span class="selector-tag">pending</span> <span class="selector-tag">log</span> <span class="selector-tag">flushes</span>, 0 <span class="selector-tag">pending</span> <span class="selector-tag">chkp</span> <span class="selector-tag">writes</span></span><br><span class="line">53 log i/o&#x27;s done, 0.00 log i/o&#x27;s/second</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上4个LSN是递减的，即：LSN1&gt;=LSN2&gt;=LSN3&gt;=LSN4</p>
</blockquote>
<p>InnoDB的检查点技术很丰富，主要分为Sharp Checkpoint和Fuzzy Checkpoint两类。</p>
<blockquote>
<ul>
<li><p>Sharp Checkpoint是全量检查点，在数据库关闭时将所有的脏页都刷新回磁盘，可以通过参数innodb_fast_shutdown=1来设置。</p>
</li>
<li><p>Fuzzy Checkpoint是模糊检查点，总体来说是部分页刷新，刷新的场景会有一些复杂，包含如下4类Checkpoint策略：</p>
<p>Master Thread Checkpoint</p>
<p>FLUSH_LRU_LIST Checkpoint</p>
<p>Async/Sync Flush Checkpoint</p>
<p>Dirty Page too much Checkpoint</p>
</li>
</ul>
</blockquote>
<table>
<thead>
<tr>
<th>Fuzzy Checkpoint策略</th>
<th>触发条件</th>
<th>描述</th>
<th>相关参数</th>
</tr>
</thead>
<tbody><tr>
<td>Master Thread Checkpoint</td>
<td>主动周期性触发</td>
<td>每秒或每10秒的速度从缓冲池的脏页列表刷新一定比例的页回磁盘</td>
<td>innodb_io_capacity</td>
</tr>
<tr>
<td>FLUSH_LRU_LIST Checkpoint</td>
<td>LRU空闲也不足</td>
<td>Page Cleaner线程中进行，用户可以通过参数innod_lru_scan_depth控制LRU列表中可用页的数量</td>
<td>innod_lru_scan_depth</td>
</tr>
<tr>
<td>Async/Sync Flush Checkpoint</td>
<td>重做日志不可用</td>
<td>重做日志文件不可用的情况，这时需要强制将一些页刷新回磁盘，而此时脏页是从FLUSH LIST中选取的</td>
<td></td>
</tr>
<tr>
<td>Dirty Page too much</td>
<td>脏页数量太多</td>
<td>脏页的数量太多，导致InnoDB存储引擎强制进行Checkpoint，其目的总的来说还是为了保证缓冲池中有足够可用的页</td>
<td>innodb_max_dirty_pages_pct</td>
</tr>
</tbody></table>
<p>其中Async/Sync Flush Checkpoint会略微复杂一些，“sync”的位置大于是redo日志的7/8，“async”位置大约是redo日志的3/4，如下图</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210219171658427.png"></p>
<h2 id="InnoDB存储引擎核心特性说明"><a href="#InnoDB存储引擎核心特性说明" class="headerlink" title="InnoDB存储引擎核心特性说明"></a>InnoDB存储引擎核心特性说明</h2><table>
<thead>
<tr>
<th>功能</th>
<th>支持</th>
<th>功能</th>
<th>支持</th>
</tr>
</thead>
<tbody><tr>
<td>存储限制</td>
<td>64TB</td>
<td>索引高速缓存</td>
<td>是</td>
</tr>
<tr>
<td>MVCC (Multi Version Concurrency Control)多版本并发控制</td>
<td>是</td>
<td>数据高速缓存</td>
<td>是</td>
</tr>
<tr>
<td>B 树索引</td>
<td>是</td>
<td>自适应数列索引</td>
<td>是</td>
</tr>
<tr>
<td>群集索引</td>
<td>是</td>
<td>复制 (多线程，GTID，MTS)</td>
<td>是</td>
</tr>
<tr>
<td>压缩数据</td>
<td>是</td>
<td>更新数据字典</td>
<td>是</td>
</tr>
<tr>
<td>加密数据</td>
<td>是</td>
<td>地理空间数据类型</td>
<td>是</td>
</tr>
<tr>
<td>事务</td>
<td>是</td>
<td>查询高速缓存</td>
<td>是</td>
</tr>
<tr>
<td>行锁</td>
<td>是</td>
<td>群集数据库</td>
<td>否</td>
</tr>
<tr>
<td>外键</td>
<td>是</td>
<td>地理空间索引</td>
<td>否</td>
</tr>
<tr>
<td>备份与恢复</td>
<td>是</td>
<td>快速索引创建</td>
<td>是</td>
</tr>
<tr>
<td>文件格式管理</td>
<td>是</td>
<td>PEFRORMANCE_SCHEMA</td>
<td>是</td>
</tr>
<tr>
<td>更改缓冲</td>
<td>是</td>
<td>自动故障恢复（ACSR）</td>
<td>是</td>
</tr>
<tr>
<td>全文搜索扫描</td>
<td>是</td>
<td>多个缓冲池</td>
<td>是</td>
</tr>
</tbody></table>
<h3 id="InnoDB重要的特性"><a href="#InnoDB重要的特性" class="headerlink" title="InnoDB重要的特性"></a>InnoDB重要的特性</h3><blockquote>
<ul>
<li>事务</li>
<li>行锁</li>
<li>MVCC(多版本并发控制)</li>
<li>外键</li>
<li>ACSR(自动故障恢复)</li>
<li>热备</li>
<li>复制(多线程,GTID,MTS)</li>
</ul>
</blockquote>
<h2 id="InnoDB存储引擎的修改"><a href="#InnoDB存储引擎的修改" class="headerlink" title="InnoDB存储引擎的修改"></a>InnoDB存储引擎的修改</h2><p><strong>1. 修改存储引擎</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; alter table city engine=innodb;</span><br></pre></td></tr></table></figure>
<p><strong>2. 整理碎片</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; alter table city engine=innodb;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这条命令可以当做整理碎片，每次使用delect删除行，都会产生碎片，从而增加数据，可以使用这条命令来解决一些碎片，当然也可以选择导出，然后删除不要的数据，在导入进MySQL，但是风险比较高</p>
</blockquote>
<h3 id="批量替换多张-innoDB为tokudb"><a href="#批量替换多张-innoDB为tokudb" class="headerlink" title="批量替换多张 innoDB为tokudb"></a>批量替换多张 innoDB为tokudb</h3><p><strong>单个替换</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; alter table zabbix.a engine=tokudb;</span><br></pre></td></tr></table></figure>
<p><strong>批量替换</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; select concat(&quot;alter table &quot;,table_schema,&quot;.&quot;,table_name,&quot; &quot;,&quot;engine=toukudb&quot;) from informatiion_schema.tables where table_schema=&#x27;world&#x27;;</span><br><span class="line">+<span class="selector-tag">-------------------------------------------------------------------------</span>+</span><br><span class="line">| concat(&quot;alter table &quot;,table_schema,&quot;.&quot;,table_name,&quot; &quot;,&quot;engine=toukudb&quot;) |</span><br><span class="line">+<span class="selector-tag">-------------------------------------------------------------------------</span>+</span><br><span class="line">| alter table world.city engine=toukudb                                   |</span><br><span class="line">| alter table world.country engine=toukudb                                |</span><br><span class="line">| alter table world.countrylanguage engine=toukudb                        |</span><br><span class="line">+<span class="selector-tag">-------------------------------------------------------------------------</span>+</span><br></pre></td></tr></table></figure>
<h2 id="InnoDb存储引擎物理存储结构（表空间）"><a href="#InnoDb存储引擎物理存储结构（表空间）" class="headerlink" title="InnoDb存储引擎物理存储结构（表空间）"></a>InnoDb存储引擎物理存储结构（表空间）</h2><h3 id="最直观的存储方式（-data-mysql-data"><a href="#最直观的存储方式（-data-mysql-data" class="headerlink" title="最直观的存储方式（/data/mysql/data)"></a>最直观的存储方式（/data/mysql/data)</h3><blockquote>
<ul>
<li>ibdata1：系统数据字典信息（统计信息），UNDO表空间等数据</li>
<li>ib_logfile0~ib_logfile1：REDO日志文件，事务日志文件</li>
<li>ibtmp1：临时表空间磁盘位置，存储临时表</li>
<li>frm：存储表的列信息</li>
<li>ibd：表的数据行和索引</li>
</ul>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ll  | grep &quot;^-&quot;</span><br><span class="line"><span class="selector-tag">-rw-r-----</span> 1 <span class="selector-tag">mysql</span> <span class="selector-tag">mysql</span>      620 <span class="selector-tag">Aug</span> 30 17<span class="selector-pseudo">:28</span> <span class="selector-tag">ib_buffer_pool</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> 1 <span class="selector-tag">mysql</span> <span class="selector-tag">mysql</span> 12582912 <span class="selector-tag">Sep</span>  3 00<span class="selector-pseudo">:34</span> <span class="selector-tag">ibdata1</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> 1 <span class="selector-tag">mysql</span> <span class="selector-tag">mysql</span> 50331648 <span class="selector-tag">Sep</span>  3 00<span class="selector-pseudo">:34</span> <span class="selector-tag">ib_logfile0</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> 1 <span class="selector-tag">mysql</span> <span class="selector-tag">mysql</span> 50331648 <span class="selector-tag">Sep</span>  3 00<span class="selector-pseudo">:34</span> <span class="selector-tag">ib_logfile1</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> 1 <span class="selector-tag">mysql</span> <span class="selector-tag">mysql</span> 12582912 <span class="selector-tag">Sep</span>  2 23<span class="selector-pseudo">:27</span> <span class="selector-tag">ibtmp1</span></span><br><span class="line"></span><br><span class="line">$ cd world/  </span><br><span class="line">$ ll</span><br><span class="line"><span class="selector-tag">-rw-r-----</span> 1 <span class="selector-tag">mysql</span> <span class="selector-tag">mysql</span>     8710 <span class="selector-tag">Sep</span>  1 15<span class="selector-pseudo">:04</span> <span class="selector-tag">city</span><span class="selector-class">.frm</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> 1 <span class="selector-tag">mysql</span> <span class="selector-tag">mysql</span>   933888 <span class="selector-tag">Sep</span>  1 15<span class="selector-pseudo">:04</span> <span class="selector-tag">city</span><span class="selector-class">.ibd</span></span><br></pre></td></tr></table></figure>
<h3 id="共享表空间"><a href="#共享表空间" class="headerlink" title="共享表空间"></a>共享表空间</h3><blockquote>
<ul>
<li><p>5.5版本的默认模式，5.6中转换为了独立表空间</p>
<p>#共享表空间，是将所有数据存储到同一个表空间(ibdata1)中，管理比较混乱</p>
</li>
<li><p>5.6版本以后，共享表空间保留，只用来存储：数据字典信息(idbdata1),undo，临时表</p>
</li>
<li><p>5.7版本，临时表被独立出去了</p>
</li>
<li><p>8.0版本，undo也被独立出去了</p>
</li>
</ul>
</blockquote>
<blockquote>
<p> 具体变化参考官方文档:</p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.6/en/innodb-architecture.html">https://dev.mysql.com/doc/refman/5.6/en/innodb-architecture.html</a><br><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-architecture.html">https://dev.mysql.com/doc/refman/5.7/en/innodb-architecture.html</a><br><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.8/en/innodb-architecture.html">https://dev.mysql.com/doc/refman/5.8/en/innodb-architecture.html</a></p>
</blockquote>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210208232415216.png"></p>
<h3 id="共享表空间设置"><a href="#共享表空间设置" class="headerlink" title="共享表空间设置"></a>共享表空间设置</h3><p><strong>搭建MySQL时，初始化数据之前设置到参数文件中</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">select</span> @<span class="keyword">@innodb_data_file_path</span>;</span><br><span class="line">+<span class="selector-tag">-------------------------</span>+</span><br><span class="line">| @@innodb_data_file_path |</span><br><span class="line">+<span class="selector-tag">-------------------------</span>+</span><br><span class="line">| ibdata1:12M:autoextend  |  //共享表空间的ibdata1</span><br><span class="line">+<span class="selector-tag">-------------------------</span>+</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; show variables like &#x27;%autoextend%&#x27;;</span><br><span class="line">+<span class="selector-tag">-----------------------------</span>+<span class="selector-tag">-------</span>+</span><br><span class="line">| Variable_name               | Value |</span><br><span class="line">+<span class="selector-tag">-----------------------------</span>+<span class="selector-tag">-------</span>+</span><br><span class="line">| innodb_autoextend_increment | 64    |</span><br><span class="line">+<span class="selector-tag">-----------------------------</span>+<span class="selector-tag">-------</span>+</span><br></pre></td></tr></table></figure>
<p><strong>初始化的时候添加这两条命令，可以扩展共享表空间的两个参数</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">innodb_data_file_path=ibdata1:512M:ibdata2:512M:autoextend</span><br><span class="line">innodb_autoextend_increment=64</span><br></pre></td></tr></table></figure>
<p><strong>例如</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysqld --initialize-insecure --user=mysql --basedir=xxxxxx...... innodb_data_file_path=ibdata1:512M:ibdata2:512M:autoextend</span><br></pre></td></tr></table></figure>
<h3 id="独立表空间"><a href="#独立表空间" class="headerlink" title="独立表空间"></a>独立表空间</h3><blockquote>
<ul>
<li><p>从5.6起默认表空间不再使用共享表空间，替换为独立表空间</p>
</li>
<li><p>要存储的是用户数据</p>
</li>
<li><p>存储特点为：一个表一个ibd文件，存储数据行和索引信息，frm存储表的列信息</p>
</li>
</ul>
</blockquote>
<h3 id="5-7的独立表空间结构"><a href="#5-7的独立表空间结构" class="headerlink" title="5.7的独立表空间结构"></a>5.7的独立表空间结构</h3><blockquote>
<ul>
<li>一张InnoDB表 = frm+idb+ibdata1</li>
</ul>
<ul>
<li><p>MySQL的存储引擎日志：</p>
<p>Redo log：ib_logfile0 ib_logfile1，重做日志</p>
<p>Undo log: ibdata1 ibdata2（存储在共享表空间中），回滚日志</p>
</li>
<li><p>临时表：ibtmp1，在做join union操作产生临时数据，用完就自动清理</p>
</li>
</ul>
</blockquote>
<h3 id="独立表空间设置问题"><a href="#独立表空间设置问题" class="headerlink" title="独立表空间设置问题"></a>独立表空间设置问题</h3><p><strong>如果是1等于开启了独立表空间，如果是0表示没有开启</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">select</span> @<span class="keyword">@innodb_file_per_table</span>;</span><br><span class="line">+<span class="selector-tag">-------------------------</span>+</span><br><span class="line">| @@innodb_file_per_table |</span><br><span class="line">+<span class="selector-tag">-------------------------</span>+</span><br><span class="line">|                       1 |</span><br><span class="line">+<span class="selector-tag">-------------------------</span>+</span><br></pre></td></tr></table></figure>
<p><strong>修改成共享表空间</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; set global innodb_file_per_table=0;</span><br></pre></td></tr></table></figure>
<h3 id="独立表空间迁移"><a href="#独立表空间迁移" class="headerlink" title="独立表空间迁移"></a>独立表空间迁移</h3><p><strong>1. 创建和原表结构一致的空表</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; create database test charset=utf8mb4;   </span><br><span class="line"><span class="selector-tag">CREATE</span> <span class="selector-tag">TABLE</span> <span class="selector-tag">t100</span> (                           </span><br><span class="line"><span class="selector-tag">id</span> <span class="selector-tag">int</span>(11) <span class="selector-tag">DEFAULT</span> <span class="selector-tag">NULL</span>,</span><br><span class="line"><span class="selector-tag">num</span> <span class="selector-tag">int</span>(11) <span class="selector-tag">DEFAULT</span> <span class="selector-tag">NULL</span>,</span><br><span class="line"><span class="selector-tag">k1</span> <span class="selector-tag">char</span>(2) <span class="selector-tag">COLLATE</span> <span class="selector-tag">utf8mb4_bin</span> <span class="selector-tag">DEFAULT</span> <span class="selector-tag">NULL</span>,</span><br><span class="line"><span class="selector-tag">k2</span> <span class="selector-tag">char</span>(4) <span class="selector-tag">COLLATE</span> <span class="selector-tag">utf8mb4_bin</span> <span class="selector-tag">DEFAULT</span> <span class="selector-tag">NULL</span>,</span><br><span class="line"><span class="selector-tag">dt</span> <span class="selector-tag">timestamp</span> <span class="selector-tag">NOT</span> <span class="selector-tag">NULL</span> <span class="selector-tag">DEFAULT</span> <span class="selector-tag">CURRENT_TIMESTAMP</span>,</span><br><span class="line"><span class="selector-tag">KEY</span> <span class="selector-tag">id_k</span> (<span class="selector-tag">k2</span>)</span><br><span class="line">)ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;</span><br></pre></td></tr></table></figure>
<p><strong>2. 将空表的ibd文件移动</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">alter</span> <span class="selector-tag">table</span> <span class="selector-tag">t100</span> <span class="selector-tag">discard</span> <span class="selector-tag">tablespace</span>;</span><br></pre></td></tr></table></figure>
<p><strong>3. 将原表的idb拷贝过来</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp -a test/t100w.ibd world/t100.ibd</span><br></pre></td></tr></table></figure>
<p><strong>4. 将原表ibd进行导入</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">alter</span> <span class="selector-tag">table</span> <span class="selector-tag">t100</span> <span class="selector-tag">import</span> <span class="selector-tag">tablespace</span>;</span><br></pre></td></tr></table></figure>
<p><strong>5. 总结：核心命令</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">alter</span> <span class="selector-tag">table</span> <span class="selector-tag">t100</span> <span class="selector-tag">discard</span> <span class="selector-tag">tablespace</span>;  //将创建表的空<span class="selector-tag">idb</span>丢弃</span><br><span class="line">&gt; <span class="selector-tag">alter</span> <span class="selector-tag">table</span> <span class="selector-tag">t100</span> <span class="selector-tag">import</span> <span class="selector-tag">tablespace</span>;   //将原表的<span class="selector-tag">idb</span>文件导入</span><br></pre></td></tr></table></figure>
<h2 id="InnoDB核心特性"><a href="#InnoDB核心特性" class="headerlink" title="InnoDB核心特性"></a>InnoDB核心特性</h2><h3 id="事务的ACID特性"><a href="#事务的ACID特性" class="headerlink" title="事务的ACID特性"></a>事务的ACID特性</h3><blockquote>
<ul>
<li><p>Atomit（原子性）</p>
<p>所有语句作为一个单元全部成功执行或全部权限，不能出现中间状态</p>
</li>
<li><p>Consistent（一致性）</p>
<p>如果数库在事务开启时处于一致状态，则在执行该事务期间将保留一致状态</p>
</li>
<li><p>Isolated（隔离性）</p>
<p>事务之间不互相影响</p>
</li>
<li><p>Durable（持久性）</p>
<p>事务成功完成后，所做的所有更改都会准确地记录在数据库中，所做的更改不会丢失    </p>
</li>
</ul>
</blockquote>
<h3 id="标准的事务语句"><a href="#标准的事务语句" class="headerlink" title="标准的事务语句"></a>标准的事务语句</h3><p><strong>DML（操作语句）：insert、update、delect</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; update city set countrycode=&#x27;CHN&#x27; where id=&#x27;1&#x27;;</span><br><span class="line">&gt; update city set countrycode=&#x27;CHN&#x27; where id=&#x27;2&#x27;;</span><br><span class="line">&gt; update city set countrycode=&#x27;CHN&#x27; where id=&#x27;3&#x27;;</span><br></pre></td></tr></table></figure>
<p><strong>事务的结束</strong></p>
<blockquote>
<p>提交：commit</p>
<p>回滚：rollback</p>
</blockquote>
<p><strong>自动提交机制（autocommit）：默认开启</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">select</span> @<span class="keyword">@autocommit</span>;</span><br><span class="line">+<span class="selector-tag">--------------</span>+</span><br><span class="line">| @@autocommit |</span><br><span class="line">+<span class="selector-tag">--------------</span>+</span><br><span class="line">|            1 |</span><br><span class="line">+<span class="selector-tag">--------------</span>+</span><br></pre></td></tr></table></figure>
<h3 id="在线修改参数"><a href="#在线修改参数" class="headerlink" title="在线修改参数"></a>在线修改参数</h3><p><strong>1. 会话级别：及时生效，只影响当前登录会话</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; set autocommit=0</span><br><span class="line">&gt; <span class="selector-tag">select</span> @<span class="keyword">@autocommit</span>;</span><br><span class="line">+<span class="selector-tag">--------------</span>+</span><br><span class="line">| @@autocommit |</span><br><span class="line">+<span class="selector-tag">--------------</span>+</span><br><span class="line">+<span class="selector-tag">--------------</span>+</span><br></pre></td></tr></table></figure>
<p><strong>2. 全局级别：断开窗口重连后生效，影响到所有新开的会话</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; set global autocommit=0</span><br></pre></td></tr></table></figure>
<p><strong>3. 永久修改（重启服务生效或者重启）</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/my.cnf </span><br><span class="line">autocommit=0</span><br></pre></td></tr></table></figure>
<h3 id="隐式提交的情况（重要）"><a href="#隐式提交的情况（重要）" class="headerlink" title="隐式提交的情况（重要）"></a>隐式提交的情况（重要）</h3><p><strong>触发隐式提交的语句</strong></p>
<blockquote>
<ul>
<li>事务默认开启（begin），不能同时打开多个窗口，否则，在打开一个窗口的时候，会自动提交（commit)</li>
</ul>
<ul>
<li>在一个窗口执行完，再打开新的窗口</li>
</ul>
</blockquote>
<p><strong>导致提交的非事务语句：</strong></p>
<blockquote>
<p>DDL语句：（ALTER，CREATE和DROP）</p>
<p>DCL语句：（GRANT，REVOKE和SET PASSWORD）</p>
<p>锁定语句：（LOCK TABLES和UNLOCK TABLES）</p>
</blockquote>
<p><strong>导致隐式提交的语句示例：</strong></p>
<blockquote>
<p>TRUNCATE TABLE</p>
<p>LOAD DATA IN FILE</p>
<p>SELECT FOR UPDATE</p>
</blockquote>
<h3 id="事务的ACID如何保证"><a href="#事务的ACID如何保证" class="headerlink" title="事务的ACID如何保证"></a>事务的ACID如何保证</h3><table>
<thead>
<tr>
<th>保证功能</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>redo log</td>
<td>重做日志</td>
</tr>
<tr>
<td>ib_logfile0-1</td>
<td>默认50M，轮询使用</td>
</tr>
<tr>
<td>redo log buffer</td>
<td>redo内存区域</td>
</tr>
<tr>
<td>data buufer pool</td>
<td>缓冲区池，数据和索引的缓冲</td>
</tr>
<tr>
<td>LSN（日志序列号）</td>
<td>MySQL每次数据库启动，都会比较磁盘数据页和redolog的LSN，必须要求LSN一致数据库才能正常启动</td>
</tr>
<tr>
<td>write adhead log</td>
<td>日志优先的方式实现持久化</td>
</tr>
<tr>
<td>脏页</td>
<td>内存脏页，内存中发生了修改，没写入到磁盘之前，内存页称之为脏页</td>
</tr>
<tr>
<td>CKPT（Checkpoint）</td>
<td>检查点，就是将脏页刷鞋到磁盘的动作</td>
</tr>
<tr>
<td>TXID（事务号）</td>
<td>InnoDB会为每一个事务生成一个事务号，伴随着整个事务</td>
</tr>
</tbody></table>
<h3 id="事务日志–redo-重做日志"><a href="#事务日志–redo-重做日志" class="headerlink" title="事务日志–redo(重做日志)"></a>事务日志–redo(重做日志)</h3><blockquote>
<p>作用：主要保证事务A(原子性)、C(一致性)、D(持久性)</p>
<ul>
<li>记录了内存数据页的变化</li>
<li>提供快速的持久化功能（WAL）</li>
<li>ACSR过程中实现前滚的操作（磁盘数据页和redo日志LSN一致）</li>
</ul>
</blockquote>
<p><strong>redo日志位置</strong></p>
<blockquote>
<p>redo的日志文件：iblogfile0 iblogfile1</p>
</blockquote>
<p><strong>redo buffer：</strong></p>
<blockquote>
<p>redo的buffer：数据页的变化信息+数据页当时的LSN号</p>
</blockquote>
<p><strong>redo的刷写策略</strong></p>
<blockquote>
<ul>
<li>commit;</li>
<li>刷新当前事务的redo buffer到磁盘</li>
<li>还会顺便将一部分redo buffer中没有提交的事务日志也刷新到磁盘</li>
<li>MySQL：在启动时，必须保证redo日志文件和数据文件LSN必须一致，如果不一致就会触发ACSR(自动故障恢复)，最终保证一致    </li>
</ul>
</blockquote>
<p><strong>事务开始到事务提交，以断电后磁盘和内存是如何恢复的</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210302101841199.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210302101857768.png"></p>
<p><strong>语言描述情况：我们做一个事务，begin;update;commit</strong></p>
<blockquote>
<ol>
<li><p>begin，立即分配一个TXID=tx_01.</p>
</li>
<li><p>update时，会将需要修改的数据也（dp_01,LSN=101),加载到data buffer中</p>
</li>
<li><p>DBWR线程，会进行dp_01数据也修改更新，并更新LSN=102</p>
</li>
<li><p>LOGBWR日志写线程，会将dp_01数据页的变化+LSN+TXID存储到redo buffer</p>
</li>
<li><p>执行commit时，LGWR日志写线程会将redobuffer信息写入redolog日志文件，基于WAL原则,</p>
<p> 在日志完全写入磁盘后，commit命令才执行成功,（会将此日志打上commit标记）</p>
</li>
<li><p>加入此时宕机，内存脏页没有来得及写入磁盘，内存数据全部丢失</p>
</li>
<li><p>MySQL再次重启时，必须要redolog和磁盘数据页的LSN是一致的，但是，此时dp_01，TXID=tx_01磁盘是LSN=101，dp_01,TXID=tx_01,redolog中LSN=102，MySQL此时无法正常启动，MySQL触发CSR（自动故障恢复），在内存追平LSN号，<br> 触发ckpt，将内存数据页更新到磁盘，从而保证磁盘数据页和redolog LSN一致，MySQL才能正常启动<br> //以上的工作过程，我们把它称之为基于REDO的“前滚操作”</p>
</li>
</ol>
</blockquote>
<h3 id="事务日志–undo（回滚日志）"><a href="#事务日志–undo（回滚日志）" class="headerlink" title="事务日志–undo（回滚日志）"></a>事务日志–undo（回滚日志）</h3><p><strong>作用</strong></p>
<p>在ACID特性中，主要保证A的特性，同时对CI也有一定功效</p>
<blockquote>
<ul>
<li>记录了数据修改之前的状态</li>
<li>rollback将内存的数据修改恢复到修改之前</li>
<li>在CSR中实现未提交数据的回滚操作</li>
<li>实现一致性快照，配置隔离级别保证MVCC（多版本并发控制），读和写的操作不会互相伤害</li>
</ul>
</blockquote>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210302101959088.png"></p>
<h3 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h3><p>“锁”顾名思义就是锁定的意思。</p>
<p><strong>锁的作用是什么</strong></p>
<p>在事务ACID过程中，“锁”和“隔离级别”一起来实现“I”隔离性和”C” 一致性 </p>
<blockquote>
<ul>
<li>悲观锁:行级锁定(行锁)：谁先操作某个数据行,就会持有&lt;这行&gt;的(X)锁.</li>
<li>乐观锁: 没有锁</li>
<li>gap：间隙锁</li>
<li>next-lock：下键锁</li>
</ul>
</blockquote>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210209210439849.png"></p>
<h3 id="隔离级别（transaction-isolation）"><a href="#隔离级别（transaction-isolation）" class="headerlink" title="隔离级别（transaction_isolation）"></a>隔离级别（transaction_isolation）</h3><blockquote>
<ul>
<li><p>RU：读未提交，可脏读，一般不易出现</p>
</li>
<li><p>RC：读已提交，可能出现幻读，可以防止脏读</p>
</li>
<li><p> RR：可重复读，功能是防止“幻读”现象，利用的是undo的快照技术+GAP（间隙锁）+ NextLock（下键锁）</p>
</li>
<li><p>SR：可串行化，可以防止死锁，但是并发事务性能较差</p>
<p>#补充：在RC级别下，可以减轻GAP+NextLock锁的问题，但是会出现幻读，一般在为了读一致性会正常select后添加for update语句。但是请记住执行完一定要commit否则容易出现锁等待比较严重。</p>
</li>
</ul>
</blockquote>
<p><strong>查看系统使用默认隔离</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">select</span> @<span class="keyword">@transaction_isolation</span>;</span><br><span class="line">+<span class="selector-tag">-------------------------</span>+</span><br><span class="line">| @@transaction_isolation |</span><br><span class="line">+<span class="selector-tag">-------------------------</span>+</span><br><span class="line">| REPEATABLE-READ         |</span><br><span class="line">+<span class="selector-tag">-------------------------</span>+</span><br></pre></td></tr></table></figure>
<p><strong>设置隔离级别</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vi /etc/my.cnf </span><br><span class="line">transaction_isolation=read-uncommitted</span><br><span class="line">#transaction_isolation=read-committed</span><br><span class="line">#transaction_isolation=REPEATABLE-READ</span><br></pre></td></tr></table></figure>
<p>transaction_isolation=read-uncommitted：读未提交，可脏读，一般不易出现</p>
<blockquote>
<ul>
<li><p>操作之前，需要查看自己是否开启自动提交</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">select</span> @<span class="keyword">@autocommit</span>;</span><br><span class="line">  +<span class="selector-tag">--------------</span>+</span><br><span class="line">  | @@autocommit |</span><br><span class="line">  +<span class="selector-tag">--------------</span>+</span><br><span class="line">  |            0 |</span><br><span class="line">  +<span class="selector-tag">--------------</span>+</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果是自动提交，则修改为不自动提交</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; set autocommit=0</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210209211215566.png"></p>
</li>
</ul>
</blockquote>
<p>transaction_isolation=read-committed：读已提交,可能出现幻读,可以防止脏读</p>
<blockquote>
<ul>
<li><p>RC方式如何解决幻读</p>
<p>创建表的时候建一个主键，主键会创建GAP+NextLock锁，阻止幻读</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">table</span> <span class="selector-tag">pp</span>(<span class="selector-tag">id</span> <span class="selector-tag">int</span> <span class="selector-tag">primary</span> <span class="selector-tag">key</span> <span class="selector-tag">not</span> <span class="selector-tag">null</span>,<span class="selector-tag">name</span> <span class="selector-tag">varchar</span>(10));</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210209221501258.png"></p>
</li>
</ul>
</blockquote>
<p>transaction_isolation=REPEATABLE-READ：可重复读，功能是防止“幻读”现象，利用的是undo的快照技术+GAP（间隙锁）+ NextLock（下键锁）</p>
<blockquote>
<ul>
<li><p>RR模式可能出现的幻读</p>
<ol>
<li><p>左边创建一个表，插入几行数据，然后提交</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">table</span> <span class="selector-tag">tt</span>(<span class="selector-tag">id</span> <span class="selector-tag">int</span> <span class="selector-tag">primary</span> <span class="selector-tag">key</span> <span class="selector-tag">not</span> <span class="selector-tag">null</span>, <span class="selector-tag">name</span> <span class="selector-tag">vaarchar</span>(10));</span><br><span class="line"> &gt; insert into tt values(1,&#x27;pp&#x27;),(2,&#x27;cc&#x27;),(3,&#x27;tt&#x27;);</span><br><span class="line"> &gt; <span class="selector-tag">commit</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>右边也提交（不然看不到数据）</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">commit</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>左边继续插入一行数据,然后提交(右边是看不见数据的)</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; insert into tt values(4,&#x27;bb&#x27;);</span><br><span class="line"> &gt; <span class="selector-tag">commit</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>右边发现第四行可以插入，然后它也插入数据(发现报错)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; insert into tt values(4,&#x27;oo&#x27;);</span><br><span class="line"> ERROR 1062 (23000): Duplicate entry &#x27;4&#x27; for key &#x27;PRIMARY&#x27;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>测试</p>
</li>
</ul>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210209221843541.png"></p>
</blockquote>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Inaction</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://myboke.ink/2021/03/02/MySQL存储引擎-5/">https://myboke.ink/2021/03/02/MySQL存储引擎-5/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/04/29/hexo-admin-web%E7%BC%96%E8%BE%91%E5%99%A8%EF%BC%89/"><i class="fa fa-chevron-left">  </i><span>hexo-admin(web管理界面编辑器)</span></a></div><div class="next-post pull-right"><a href="/2021/03/02/MySQL%E7%B4%A2%E5%BC%95%E4%B8%8E%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92-4/"><span>MySQL索引与执行计划-4</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '6cea6a646bff1a0d5f5b',
  clientSecret: '6e9ef08f31f505d416bc0afe2d304808e9063627',
  repo: 'zsjmal2316.github.io',
  owner: 'zsjmal2316',
  admin: 'zsjmal2316',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(img/beijing2.png)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2021 By Inaction</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="120" alpha="0.3" zIndex="-1" data-click="false"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>