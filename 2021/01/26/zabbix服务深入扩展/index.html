<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="zabbix服务深入扩展"><meta name="keywords" content="zabbix"><meta name="author" content="Inaction"><meta name="copyright" content="Inaction"><title>zabbix服务深入扩展 | Inaction's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?12b421fdad87d1edf2305ccb7229d2c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'G-8RMJ1F8ETC', 'auto');
ga('send', 'pageview');</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.3.0'
} </script><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="Inaction's Blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#zabbix%E6%9C%8D%E5%8A%A1%E6%B7%B1%E5%85%A5%E6%89%A9%E5%B1%95"><span class="toc-number">1.</span> <span class="toc-text">zabbix服务深入扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Grafana"><span class="toc-number">1.1.</span> <span class="toc-text">Grafana</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Grafana%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.1.</span> <span class="toc-text">Grafana介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Grafana"><span class="toc-number">1.1.2.</span> <span class="toc-text">安装Grafana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%B9%B6%E6%BF%80%E6%B4%BBzabbix%E6%8F%92%E4%BB%B6"><span class="toc-number">1.1.3.</span> <span class="toc-text">安装并激活zabbix插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%B1%95%E7%A4%BA"><span class="toc-number">1.1.4.</span> <span class="toc-text">数据展示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#percona%E5%AF%BC%E5%85%A5mysql%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.2.</span> <span class="toc-text">percona导入mysql模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Percona%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text">Percona介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85PHP%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.2.</span> <span class="toc-text">安装PHP环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E8%BD%AF%E4%BB%B6%E4%BD%8D%E7%BD%AE"><span class="toc-number">1.2.3.</span> <span class="toc-text">下载软件位置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%9B%AE%E5%BD%95"><span class="toc-number">1.2.4.</span> <span class="toc-text">查看目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9get-mysql-stats-warpper-sh%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.5.</span> <span class="toc-text">修改get_mysql_stats_warpper.sh文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%BE%91ss-get-mysql-stats-php"><span class="toc-number">1.2.6.</span> <span class="toc-text">编辑ss_get_mysql_stats.php</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E9%A1%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%88%B0zabbix%E7%9B%AE%E5%BD%95"><span class="toc-number">1.2.7.</span> <span class="toc-text">复制自定义监控项配置文件到zabbix目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%90%AFzabbix-agent"><span class="toc-number">1.2.8.</span> <span class="toc-text">重启zabbix-agent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95key"><span class="toc-number">1.2.9.</span> <span class="toc-text">测试key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.2.10.</span> <span class="toc-text">导入模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E9%93%BE%E6%8E%A5%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.2.11.</span> <span class="toc-text">主机链接模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3"><span class="toc-number">1.2.12.</span> <span class="toc-text">报错解决</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E5%92%8C%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%86%8C"><span class="toc-number">1.3.</span> <span class="toc-text">自动发现和自动注册</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0"><span class="toc-number">1.3.1.</span> <span class="toc-text">自动发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%86%8C"><span class="toc-number">1.3.2.</span> <span class="toc-text">自动注册</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E5%8A%A8%E6%A8%A1%E5%BC%8F%E5%92%8C%E8%A2%AB%E5%8A%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">主动模式和被动模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%8B%E9%9A%86%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.4.1.</span> <span class="toc-text">克隆模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%85%8B%E9%9A%86%E5%90%8E%E7%9A%84%E6%A8%A1%E6%9D%BF%E4%B8%BA%E4%B8%BB%E5%8A%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.2.</span> <span class="toc-text">修改克隆后的模板为主动模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%9B%91%E6%8E%A7%E4%B8%BB%E6%9C%BA%E5%85%B3%E8%81%94%E7%9A%84%E6%A8%A1%E6%9D%BF%E4%B8%BA%E4%B8%BB%E5%8A%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.3.</span> <span class="toc-text">修改监控主机关联的模板为主动模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%80%E6%96%B0%E6%95%B0%E6%8D%AE"><span class="toc-number">1.4.4.</span> <span class="toc-text">查看最新数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%8E%E7%BA%A7%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0"><span class="toc-number">1.5.</span> <span class="toc-text">低级自动发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E8%87%AA%E5%B8%A6%E5%88%86%E5%8C%BA%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0"><span class="toc-number">1.5.1.</span> <span class="toc-text">查看系统自带分区自动发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E8%87%AA%E5%B8%A6%E7%9A%84%E7%BD%91%E5%8D%A1%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0"><span class="toc-number">1.5.2.</span> <span class="toc-text">查看系统自带的网卡自动发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7mysql%E5%A4%9A%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.5.3.</span> <span class="toc-text">监控mysql多实例</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/melody-favicon.ico"></div><div class="author-info__name text-center">Inaction</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">32</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">15</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">5</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friend Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://www.ji4n.cn/">Jen</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(img/beijing2.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Inaction's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">zabbix服务深入扩展</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-01-26</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/">Linux</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="zabbix服务深入扩展"><a href="#zabbix服务深入扩展" class="headerlink" title="zabbix服务深入扩展"></a>zabbix服务深入扩展</h1><h2 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h2><h3 id="Grafana介绍"><a href="#Grafana介绍" class="headerlink" title="Grafana介绍"></a>Grafana介绍</h3><p>Grafana是一个跨平台的开源的度量分析和可视化工具，可以通过将采集的数据查询然后可视化的展示，并及时通知。它主要有以下六大特点</p>
<blockquote>
<ol>
<li><p>展示方式：快速灵活的客户端图表，面板插件有许多不同方式的可视化指标和日志，官方库中具有丰富的仪表盘插件，比如热图、折线图、图表等多种展示方式；</p>
</li>
<li><p>数据源：Graphite，InfluxDB，OpenTSDB，Prometheus，Elasticsearch，CloudWatch和KairosDB等；</p>
</li>
<li><p>通知提醒：以可视方式定义最重要指标的警报规则，Grafana将不断计算并发送通知，在数据达到阈值时通过Slack、PagerDuty等获得通知；</p>
</li>
<li><p>混合展示：在同一图表中混合使用不同的数据源，可以基于每个查询指定数据源，甚至自定义数据源；</p>
</li>
<li><p>注释：使用来自不同数据源的丰富事件注释图表，将鼠标悬停在事件上会显示完整的事件元数据和标记；</p>
</li>
<li><p>过滤器：Ad-hoc过滤器允许动态创建新的键/值过滤器，这些过滤器会自动应用于使用该数据源的所有查询。</p>
</li>
</ol>
</blockquote>
<h3 id="安装Grafana"><a href="#安装Grafana" class="headerlink" title="安装Grafana"></a>安装Grafana</h3><blockquote>
<p>官方下载地址：<a target="_blank" rel="noopener" href="https://grafana.com/grafana/download">https://grafana.com/grafana/download</a></p>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://dl.grafana.com/oss/release/grafana-7.1.5-1.x86_64.rpm</span><br><span class="line">$ yum localinstall grafana-6.3.2-1.x86_64.rpm -y</span><br><span class="line">$ systemctl start grafana-server.service   </span><br><span class="line">$ systemctl enable grafana-server.service</span><br><span class="line">$ netstat -lntup|grep 3000</span><br><span class="line"><span class="selector-tag">tcp6</span>       0      0 :<span class="selector-pseudo">::3000</span>                 :::*                    <span class="selector-tag">LISTEN</span>      67196/<span class="selector-tag">grafana-serve</span></span><br></pre></td></tr></table></figure>
<p><strong>浏览访问gragana:http//10.0.0.61:3000，账号密码:admin admin</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181830.png"></p>
<h3 id="安装并激活zabbix插件"><a href="#安装并激活zabbix插件" class="headerlink" title="安装并激活zabbix插件"></a>安装并激活zabbix插件</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ grafana-cli plugins list-remote|grep zabbix</span><br><span class="line"><span class="selector-tag">id</span>: <span class="selector-tag">alexanderzobnin-zabbix-app</span> <span class="selector-tag">version</span>: 3.10.4</span><br><span class="line">$ grafana-cli plugins install alexanderzobnin-zabbix-app</span><br><span class="line"></span><br><span class="line">$ systemctl restart grafana-server.service</span><br></pre></td></tr></table></figure>
<p><strong>web操作-激活zabbix插件</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181831.png"></p>
<p><strong>web操作-添加zabbix数据源</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181832.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181833.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181834.png"></p>
<p><strong>web操作-导入模板</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181835.png"></p>
<h3 id="数据展示"><a href="#数据展示" class="headerlink" title="数据展示"></a>数据展示</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181836.png"></p>
<h2 id="percona导入mysql模板"><a href="#percona导入mysql模板" class="headerlink" title="percona导入mysql模板"></a>percona导入mysql模板</h2><h3 id="Percona介绍"><a href="#Percona介绍" class="headerlink" title="Percona介绍"></a>Percona介绍</h3><p>Percona Server由领先的MySQL咨询公司Percona发布。 Percona Server是一款独立的数据库产品，其可以完全与MySQL兼容，可以在不更改代码的情况了下将存储引擎更换成XtraDB</p>
<p>Percona团队的最终声明是“Percona Server是由Oracle发布的最接近官方MySQL Enterprise发行版的版本”，因此与其他更改了大量基本核心MySQL代码的分支有所区别。 Percona Server的一个缺点是他们自己管理代码，不接受外部开发人员的贡献，以这种方式确保他们对产品中所包含功能的控制</p>
<p>Percona提供了高性能XtraDB引擎，还提供PXC高可用解决方案，并且附带了perconatoolkit等DBA管理工具箱</p>
<h3 id="安装PHP环境"><a href="#安装PHP环境" class="headerlink" title="安装PHP环境"></a>安装PHP环境</h3><p><strong>Percona需要PHP环境</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install php php-mysql -y     //如果有安装则不需要此步骤</span><br></pre></td></tr></table></figure>
<h3 id="下载软件位置"><a href="#下载软件位置" class="headerlink" title="下载软件位置"></a>下载软件位置</h3><blockquote>
<p>官方下载地址：<a target="_blank" rel="noopener" href="https://www.percona.com/downloads/percona-monitoring-plugins/">https://www.percona.com/downloads/percona-monitoring-plugins/</a></p>
</blockquote>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181837.png">    </p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181838.png"></p>
<blockquote>
<p><strong>注意：安装完成后会有提示模板的路径位置</strong></p>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cd /opt/soft/</span><br><span class="line">$ wget https://www.percona.com/downloads/percona-monitoring-plugins/percona-monitoring-plugins-1.1.8/binary/redhat/7/x86_64/percona-zabbix-templates-1.1.8-1.noarch.rpm</span><br><span class="line">$ rpm -ivh percona-zabbix-templates-1.1.8-1.noarch.rpm </span><br><span class="line">警告：<span class="selector-tag">percona-zabbix-templates-1</span>.1.8<span class="selector-tag">-1</span><span class="selector-class">.noarch</span><span class="selector-class">.rpm</span>: 头<span class="selector-tag">V4</span> <span class="selector-tag">DSA</span>/<span class="selector-tag">SHA1</span> <span class="selector-tag">Signature</span>, 密钥 <span class="selector-tag">ID</span> <span class="selector-tag">cd2efd2a</span>: <span class="selector-tag">NOKEY</span></span><br><span class="line">准备中...                          ################################# <span class="selector-attr">[100%]</span></span><br><span class="line">正在升级/安装...</span><br><span class="line">  1<span class="selector-pseudo">:percona-zabbix-templates-1.1.8-1</span> ################################# <span class="selector-attr">[100%]</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">Scripts</span> <span class="selector-tag">are</span> <span class="selector-tag">installed</span> <span class="selector-tag">to</span> /<span class="selector-tag">var</span>/<span class="selector-tag">lib</span>/<span class="selector-tag">zabbix</span>/<span class="selector-tag">percona</span>/<span class="selector-tag">scripts</span>                              //文件的脚本位置</span><br><span class="line"><span class="selector-tag">Templates</span> <span class="selector-tag">are</span> <span class="selector-tag">installed</span> <span class="selector-tag">to</span> /<span class="selector-tag">var</span>/<span class="selector-tag">lib</span>/<span class="selector-tag">zabbix</span>/<span class="selector-tag">percona</span>/<span class="selector-tag">templates</span>                          //文件的<span class="selector-tag">MySQL</span>模板位置</span><br></pre></td></tr></table></figure>
<h3 id="查看目录"><a href="#查看目录" class="headerlink" title="查看目录"></a>查看目录</h3><p><strong>进入安装目录会发现有2个目录，一个是脚本目录，一个是模板目录</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cd /var/lib/zabbix/percona</span><br><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">├── <span class="selector-tag">scripts</span></span><br><span class="line">│   ├── <span class="selector-tag">get_mysql_stats_wrapper</span><span class="selector-class">.sh</span></span><br><span class="line">│   └── <span class="selector-tag">ss_get_mysql_stats</span><span class="selector-class">.php</span></span><br><span class="line">└── <span class="selector-tag">templates</span></span><br><span class="line">    ├── <span class="selector-tag">userparameter_percona_mysql</span><span class="selector-class">.conf</span></span><br><span class="line">    └── <span class="selector-tag">zabbix_agent_template_percona_mysql_server_ht_2</span>.0.9<span class="selector-tag">-sver1</span>.1.8<span class="selector-class">.xml</span></span><br></pre></td></tr></table></figure>
<p><strong>其中脚本目录里有2个脚本，用来获取数据信息</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd scripts/</span><br><span class="line">$ ls</span><br><span class="line">get_mysql_stats_wrapper<span class="selector-class">.sh</span>  ss_get_mysql_stats<span class="selector-class">.php</span></span><br></pre></td></tr></table></figure>
<h3 id="修改get-mysql-stats-warpper-sh文件"><a href="#修改get-mysql-stats-warpper-sh文件" class="headerlink" title="修改get_mysql_stats_warpper.sh文件"></a>修改get_mysql_stats_warpper.sh文件</h3><p><strong>编辑get_mysql_stats_warpper.sh增加用户和密码</strong></p>
<blockquote>
<p>mysql -e xxx  变成 mysql -uroot -p123456 -e xxx</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ grep &quot;RES&quot; get_mysql_stats_wrapper.sh </span><br><span class="line">    RES=`HOME=~zabbix mysql -uroot -p123456 -e &#x27;SHOW SLAVE STATUS\G&#x27; | egrep &#x27;(Slave_IO_Running|Slave_SQL_Running):&#x27; | awk -F: &#x27;&#123;print $2&#125;&#x27; | tr &#x27;\n&#x27; &#x27;,&#x27;`</span><br></pre></td></tr></table></figure>
<h3 id="编辑ss-get-mysql-stats-php"><a href="#编辑ss-get-mysql-stats-php" class="headerlink" title="编辑ss_get_mysql_stats.php"></a>编辑ss_get_mysql_stats.php</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ grep -E &quot;mysql_user|mysql_pass&quot; ss_get_mysql_stats.php </span><br><span class="line">  $mysql_user = &#x27;root&#x27;;</span><br><span class="line">  $mysql_pass = &#x27;123456&#x27;;</span><br></pre></td></tr></table></figure>
<h3 id="复制自定义监控项配置文件到zabbix目录"><a href="#复制自定义监控项配置文件到zabbix目录" class="headerlink" title="复制自定义监控项配置文件到zabbix目录"></a>复制自定义监控项配置文件到zabbix目录</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/<span class="selector-tag">var</span>/<span class="selector-tag">lib</span>/<span class="selector-tag">zabbix</span>/<span class="selector-tag">percona</span>/<span class="selector-tag">templates</span></span><br><span class="line">$ cp -a userparameter_percona_mysql.conf /etc/zabbix/zabbix_agentd.d/</span><br></pre></td></tr></table></figure>
<p><strong>查看文件</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd /etc/zabbix/zabbix_agentd.d/</span><br><span class="line">$ ls</span><br><span class="line">userparameter_mysql<span class="selector-class">.conf</span>  userparameter_percona_mysql<span class="selector-class">.conf</span></span><br></pre></td></tr></table></figure>
<h3 id="重启zabbix-agent"><a href="#重启zabbix-agent" class="headerlink" title="重启zabbix-agent"></a>重启zabbix-agent</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart zabbix-agent</span><br></pre></td></tr></table></figure>
<h3 id="测试key"><a href="#测试key" class="headerlink" title="测试key"></a>测试key</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ zabbix_get -s 127.0.0.1 -k MySQL.rows-read</span><br><span class="line">18825</span><br><span class="line">$ zabbix_get -s 127.0.0.1 -k MySQL.lock-system-memory</span><br><span class="line">337760</span><br></pre></td></tr></table></figure>
<h3 id="导入模板"><a href="#导入模板" class="headerlink" title="导入模板"></a>导入模板</h3><blockquote>
<p><strong>官方自带的模板有点问题,需要先装在2.x版本然后导出来，只好使用网友修改好的模板:<a target="_blank" rel="noopener" href="http://pan.baidu.com/s/1pL1wDYj">http://pan.baidu.com/s/1pL1wDYj</a></strong></p>
</blockquote>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181839.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181840.png" alt="    "></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181841.png"></p>
<h3 id="主机链接模板"><a href="#主机链接模板" class="headerlink" title="主机链接模板"></a>主机链接模板</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181842.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181843.png"></p>
<h3 id="报错解决"><a href="#报错解决" class="headerlink" title="报错解决"></a>报错解决</h3><p>查看监控发现没有数据，显示不支持类型，再查看zabbix-server发现因为tmp的文件没有权限，因为刚才手动执行了脚本，所以文件属性是root，将文件删除后由zabbix自己创建解决问题</p>
<p><strong>报错日志如下：</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2846<span class="selector-pseudo">:20190811</span><span class="selector-pseudo">:202708.785</span> <span class="selector-tag">item</span> &quot;<span class="selector-tag">Zabbix</span> <span class="selector-tag">server</span><span class="selector-pseudo">:MySQL.State-init&quot;</span> <span class="selector-tag">became</span> <span class="selector-tag">not</span> <span class="selector-tag">supported</span>: <span class="selector-tag">Value</span> &quot;<span class="selector-tag">rm</span>: 无法删除&quot;/<span class="selector-tag">tmp</span>/<span class="selector-tag">localhost-mysql_cacti_stats</span><span class="selector-class">.txt</span>&quot;: 不允许的操作</span><br><span class="line">0&quot; <span class="selector-tag">of</span> <span class="selector-tag">type</span> &quot;<span class="selector-tag">string</span>&quot; <span class="selector-tag">is</span> <span class="selector-tag">not</span> <span class="selector-tag">suitable</span> <span class="selector-tag">for</span> <span class="selector-tag">value</span> <span class="selector-tag">type</span> &quot;<span class="selector-tag">Numeric</span> (<span class="selector-tag">float</span>)&quot;</span><br><span class="line">2843<span class="selector-pseudo">:20190811</span><span class="selector-pseudo">:202709.787</span> <span class="selector-tag">item</span> &quot;<span class="selector-tag">Zabbix</span> <span class="selector-tag">server</span><span class="selector-pseudo">:MySQL.State-locked&quot;</span> <span class="selector-tag">became</span> <span class="selector-tag">not</span> <span class="selector-tag">supported</span>: <span class="selector-tag">Value</span> &quot;<span class="selector-tag">rm</span>: 无法删除&quot;/<span class="selector-tag">tmp</span>/<span class="selector-tag">localhost-mysql_cacti_stats</span><span class="selector-class">.txt</span>&quot;: 不允许的操作</span><br><span class="line">0&quot; <span class="selector-tag">of</span> <span class="selector-tag">type</span> &quot;<span class="selector-tag">string</span>&quot; <span class="selector-tag">is</span> <span class="selector-tag">not</span> <span class="selector-tag">suitable</span> <span class="selector-tag">for</span> <span class="selector-tag">value</span> <span class="selector-tag">type</span> &quot;<span class="selector-tag">Numeric</span> (<span class="selector-tag">float</span>)&quot;</span><br><span class="line">2844<span class="selector-pseudo">:20190811</span><span class="selector-pseudo">:202710.788</span> <span class="selector-tag">item</span> &quot;<span class="selector-tag">Zabbix</span> <span class="selector-tag">server</span><span class="selector-pseudo">:MySQL.State-login&quot;</span> <span class="selector-tag">became</span> <span class="selector-tag">not</span> <span class="selector-tag">supported</span>: <span class="selector-tag">Value</span> &quot;<span class="selector-tag">rm</span>: 无法删除&quot;/<span class="selector-tag">tmp</span>/<span class="selector-tag">localhost-mysql_cacti_stats</span><span class="selector-class">.txt</span>&quot;: 不允许的操作</span><br><span class="line">0&quot; <span class="selector-tag">of</span> <span class="selector-tag">type</span> &quot;<span class="selector-tag">string</span>&quot; <span class="selector-tag">is</span> <span class="selector-tag">not</span> <span class="selector-tag">suitable</span> <span class="selector-tag">for</span> <span class="selector-tag">value</span> <span class="selector-tag">type</span> &quot;<span class="selector-tag">Numeric</span> (<span class="selector-tag">float</span>)&quot;</span><br></pre></td></tr></table></figure>
<h2 id="自动发现和自动注册"><a href="#自动发现和自动注册" class="headerlink" title="自动发现和自动注册"></a>自动发现和自动注册</h2><h3 id="自动发现"><a href="#自动发现" class="headerlink" title="自动发现"></a>自动发现</h3><p><strong>web页面操作</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181844.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181845.png"></p>
<p><strong>动作中开启自动发现</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181846.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181847.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181848.png"></p>
<p><strong>配置web主机agent配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.conf</span><br><span class="line">PidFile&#x3D;&#x2F;var&#x2F;run&#x2F;zabbix&#x2F;zabbix_agentd.pid</span><br><span class="line">LogFile&#x3D;&#x2F;var&#x2F;log&#x2F;zabbix&#x2F;zabbix_agentd.log</span><br><span class="line">LogFileSize&#x3D;0</span><br><span class="line">Server&#x3D;10.0.0.71</span><br><span class="line">ServerActive&#x3D;10.0.0.71</span><br><span class="line">Hostname&#x3D;web01</span><br><span class="line">Include&#x3D;&#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.d&#x2F;*.conf</span><br></pre></td></tr></table></figure>
<p><strong>设置web主机的/etc/hosts文件,对IP地址进行解析</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ vi /etc/hosts</span><br><span class="line">10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.71</span>       zabbix</span><br><span class="line">10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.7</span>        web01</span><br><span class="line">10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.8</span>        web02</span><br><span class="line"></span><br><span class="line">$ vi /etc/hosts</span><br><span class="line">10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.71</span>       zabbix</span><br><span class="line">10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.7</span>        web01</span><br><span class="line">10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.8</span>        web02</span><br></pre></td></tr></table></figure>
<p><strong>最后刷新页面查看</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181849.png"></p>
<h3 id="自动注册"><a href="#自动注册" class="headerlink" title="自动注册"></a>自动注册</h3><p><strong>web页面操作</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181850.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181851.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181852.png"></p>
<p><strong>刷新页面看到的结果</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181853.png"></p>
<h2 id="主动模式和被动模式"><a href="#主动模式和被动模式" class="headerlink" title="主动模式和被动模式"></a>主动模式和被动模式</h2><blockquote>
<ol>
<li><p>默认为被动模式：100个监控项要100来回，客户端执行一个返回一个</p>
</li>
<li><p>主动模式：100个监控项1个回合，将所有需要的100个打包，然后一次发过去给客户端，客户端全部执行完再一次返回给服务端</p>
</li>
</ol>
</blockquote>
<h3 id="克隆模板"><a href="#克隆模板" class="headerlink" title="克隆模板"></a>克隆模板</h3><p><strong>完全克隆原来被动模式的模板为主动模式</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181854.png"></p>
<h3 id="修改克隆后的模板为主动模式"><a href="#修改克隆后的模板为主动模式" class="headerlink" title="修改克隆后的模板为主动模式"></a>修改克隆后的模板为主动模式</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181855.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181856.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181857.png"></p>
<h3 id="修改监控主机关联的模板为主动模式"><a href="#修改监控主机关联的模板为主动模式" class="headerlink" title="修改监控主机关联的模板为主动模式"></a>修改监控主机关联的模板为主动模式</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181858.png"></p>
<h3 id="查看最新数据"><a href="#查看最新数据" class="headerlink" title="查看最新数据"></a>查看最新数据</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181859.png"></p>
<h2 id="低级自动发现"><a href="#低级自动发现" class="headerlink" title="低级自动发现"></a>低级自动发现</h2><blockquote>
<p>应用于</p>
<ul>
<li>mysql多实例 3307 3308</li>
<li>磁盘多个分区  /  /swap</li>
<li>网卡 eth0  eth1 有几块网卡我就监控几块网卡的流量</li>
<li>端口 80 3306</li>
</ul>
</blockquote>
<h3 id="查看系统自带分区自动发现"><a href="#查看系统自带分区自动发现" class="headerlink" title="查看系统自带分区自动发现"></a>查看系统自带分区自动发现</h3><p><strong>1. 系统知道的自动发现会显示红字，比如自带的磁盘分区发现规则</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Free disk space on &#123;#FSNAME&#125;</span><br><span class="line">	<span class="selector-tag">Mounted</span> <span class="selector-tag">filesystem</span> <span class="selector-tag">discovery</span>: <span class="selector-tag">Free</span> <span class="selector-tag">disk</span> <span class="selector-tag">space</span> <span class="selector-tag">on</span> /</span><br><span class="line">	<span class="selector-tag">Mounted</span> <span class="selector-tag">filesystem</span> <span class="selector-tag">discovery</span>: <span class="selector-tag">Free</span> <span class="selector-tag">disk</span> <span class="selector-tag">space</span> <span class="selector-tag">on</span> /<span class="selector-tag">boot</span></span><br><span class="line">	<span class="selector-tag">Mounted</span> <span class="selector-tag">filesystem</span> <span class="selector-tag">discovery</span>: <span class="selector-tag">Free</span> <span class="selector-tag">disk</span> <span class="selector-tag">space</span> <span class="selector-tag">on</span> /<span class="selector-tag">mount01</span></span><br><span class="line">	<span class="selector-tag">Mounted</span> <span class="selector-tag">filesystem</span> <span class="selector-tag">discovery</span>: <span class="selector-tag">Free</span> <span class="selector-tag">disk</span> <span class="selector-tag">space</span> <span class="selector-tag">on</span> /<span class="selector-tag">mount02</span></span><br></pre></td></tr></table></figure>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181900.png"></p>
<p><strong>2. 点击红色字符</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181901.png"></p>
<p><strong>3. 查看文件系统的过滤器</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181902.png"></p>
<p><strong>4. 查看到zabbix使用正则表达式过滤的文件系统只有这些类型</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^(btrfs|ext2|ext3|ext4|reiser|xfs|ffs|usf|jfs|jfs2|vxfs|hfs|apfs|refs|ntfs|fat32|zfs)$</span><br></pre></td></tr></table></figure>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126182924.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181904.png"></p>
<p><strong>5. 查看系统mount命令下的所有挂载的文件系统</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ mount |awk &#x27;&#123;print $5,$3&#125;&#x27;</span><br><span class="line"><span class="selector-tag">sysfs</span> /<span class="selector-tag">sys</span></span><br><span class="line"><span class="selector-tag">proc</span> /<span class="selector-tag">proc</span></span><br><span class="line"><span class="selector-tag">devtmpfs</span> /<span class="selector-tag">dev</span></span><br><span class="line"><span class="selector-tag">securityfs</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">kernel</span>/<span class="selector-tag">security</span></span><br><span class="line"><span class="selector-tag">tmpfs</span> /<span class="selector-tag">dev</span>/<span class="selector-tag">shm</span></span><br><span class="line"><span class="selector-tag">devpts</span> /<span class="selector-tag">dev</span>/<span class="selector-tag">pts</span></span><br><span class="line"><span class="selector-tag">tmpfs</span> /<span class="selector-tag">run</span></span><br><span class="line"><span class="selector-tag">tmpfs</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">cgroup</span></span><br><span class="line"><span class="selector-tag">cgroup</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">cgroup</span>/<span class="selector-tag">systemd</span></span><br><span class="line"><span class="selector-tag">pstore</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">pstore</span></span><br><span class="line"><span class="selector-tag">cgroup</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">cgroup</span>/<span class="selector-tag">blkio</span></span><br><span class="line"><span class="selector-tag">cgroup</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">cgroup</span>/<span class="selector-tag">memory</span></span><br><span class="line"><span class="selector-tag">cgroup</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">cgroup</span>/<span class="selector-tag">net_cls</span>,<span class="selector-tag">net_prio</span></span><br><span class="line"><span class="selector-tag">cgroup</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">cgroup</span>/<span class="selector-tag">cpu</span>,<span class="selector-tag">cpuacct</span></span><br><span class="line"><span class="selector-tag">cgroup</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">cgroup</span>/<span class="selector-tag">perf_event</span></span><br><span class="line"><span class="selector-tag">cgroup</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">cgroup</span>/<span class="selector-tag">freezer</span></span><br><span class="line"><span class="selector-tag">cgroup</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">cgroup</span>/<span class="selector-tag">devices</span></span><br><span class="line"><span class="selector-tag">cgroup</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">cgroup</span>/<span class="selector-tag">cpuset</span></span><br><span class="line"><span class="selector-tag">cgroup</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">cgroup</span>/<span class="selector-tag">pids</span></span><br><span class="line"><span class="selector-tag">cgroup</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">cgroup</span>/<span class="selector-tag">hugetlb</span></span><br><span class="line"><span class="selector-tag">configfs</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">kernel</span>/<span class="selector-tag">config</span></span><br><span class="line"><span class="selector-tag">xfs</span> /</span><br><span class="line"><span class="selector-tag">autofs</span> /<span class="selector-tag">proc</span>/<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">binfmt_misc</span></span><br><span class="line"><span class="selector-tag">hugetlbfs</span> /<span class="selector-tag">dev</span>/<span class="selector-tag">hugepages</span></span><br><span class="line"><span class="selector-tag">mqueue</span> /<span class="selector-tag">dev</span>/<span class="selector-tag">mqueue</span></span><br><span class="line"><span class="selector-tag">debugfs</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">kernel</span>/<span class="selector-tag">debug</span></span><br><span class="line"><span class="selector-tag">iso9660</span> /<span class="selector-tag">media</span>/<span class="selector-tag">cdrom</span></span><br><span class="line"><span class="selector-tag">xfs</span> /<span class="selector-tag">boot</span></span><br><span class="line"><span class="selector-tag">rpc_pipefs</span> /<span class="selector-tag">var</span>/<span class="selector-tag">lib</span>/<span class="selector-tag">nfs</span>/<span class="selector-tag">rpc_pipefs</span></span><br><span class="line"><span class="selector-tag">tmpfs</span> /<span class="selector-tag">run</span>/<span class="selector-tag">user</span>/0</span><br><span class="line"><span class="selector-tag">binfmt_misc</span> /<span class="selector-tag">proc</span>/<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">binfmt_misc</span></span><br></pre></td></tr></table></figure>
<p><strong>6. 说明:在zabbix显示的并没有那么多，原因是使用正则表达式过滤了</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^(btrfs|ext2|ext3|ext4|reiser|xfs|ffs|usf|jfs|jfs2|vxfs|hfs|apfs|refs|ntfs|fat32|zfs)$</span><br></pre></td></tr></table></figure>
<p> <strong>7. zabbix低自动发现分区过程</strong></p>
<blockquote>
<ol>
<li>自动发现客户端上的所有分区</li>
<li>根据条件过滤掉不需要的分区类型</li>
<li>将剩下的符合条件的分区类型自动添加到监控项</li>
<li>使用宏变量替换不同的地址</li>
</ol>
</blockquote>
<p><strong>8. 查看zabbix所有的key过滤后展示</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ zabbix_agentd -p|grep vfs.fs.discovery</span><br><span class="line"><span class="selector-tag">vfs</span><span class="selector-class">.fs</span><span class="selector-class">.discovery</span>                              <span class="selector-attr">[s|&#123;<span class="string">&quot;data&quot;</span>:[&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;rootfs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;sysfs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/proc&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;proc&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/dev&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;devtmpfs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/kernel/security&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;securityfs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/dev/shm&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;tmpfs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/dev/pts&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;devpts&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/run&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;tmpfs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/fs/cgroup&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;tmpfs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/fs/cgroup/systemd&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;cgroup&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/fs/pstore&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;pstore&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/fs/cgroup/blkio&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;cgroup&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/fs/cgroup/memory&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;cgroup&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/fs/cgroup/net_cls,net_prio&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;cgroup&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/fs/cgroup/cpu,cpuacct&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;cgroup&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/fs/cgroup/perf_event&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;cgroup&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/fs/cgroup/freezer&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;cgroup&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/fs/cgroup/devices&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;cgroup&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/fs/cgroup/cpuset&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;cgroup&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/fs/cgroup/pids&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;cgroup&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/fs/cgroup/hugetlb&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;cgroup&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/kernel/config&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;configfs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;xfs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/proc/sys/fs/binfmt_misc&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;autofs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/dev/hugepages&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;hugetlbfs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/dev/mqueue&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;mqueue&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/sys/kernel/debug&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;debugfs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/media/cdrom&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;iso9660&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/boot&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;xfs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/var/lib/nfs/rpc_pipefs&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;rpc_pipefs&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#FSNAME&#125;&quot;</span>:<span class="string">&quot;/run/user/0&quot;</span>,<span class="string">&quot;&#123;#FSTYPE&#125;&quot;</span>:<span class="string">&quot;tmpfs&quot;</span>&#125;]</span>&#125;]</span><br></pre></td></tr></table></figure>
<p><strong>9. 解析成json后的格式:<a target="_blank" rel="noopener" href="https://www.sojson.com/">https://www.sojson.com/</a></strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;data&quot;: [&#123;</span><br><span class="line">		&quot;&#123;#FSNAME&#125;&quot;: &quot;/&quot;,</span><br><span class="line">		&quot;&#123;#FSTYPE&#125;&quot;: &quot;rootfs&quot;</span><br><span class="line">	&#125;, &#123;</span><br><span class="line">		&quot;&#123;#FSNAME&#125;&quot;: &quot;/sys&quot;,</span><br><span class="line">		&quot;&#123;#FSTYPE&#125;&quot;: &quot;sysfs&quot;</span><br><span class="line">	&#125;, &#123;</span><br><span class="line">		&quot;&#123;#FSNAME&#125;&quot;: &quot;/proc&quot;,</span><br><span class="line">		&quot;&#123;#FSTYPE&#125;&quot;: &quot;proc&quot;</span><br><span class="line">	&#125;</span><br><span class="line">    .......................省略</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p><strong>10. 使用zabbix_get获取key</strong></p>
<p> 因为根据过滤规则，只发现了一个xfs的key，使用zabbix_get可以查看到这个key</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ zabbix_agentd -p|grep vfs.fs.size</span><br><span class="line"><span class="selector-tag">vfs</span><span class="selector-class">.fs</span><span class="selector-class">.size</span><span class="selector-attr">[/,free]</span>                           <span class="selector-attr">[u|3967389696]</span></span><br><span class="line">$ zabbix_get -s 10.0.0.8 -k vfs.fs.size[/,free]  </span><br><span class="line">3500814336</span><br></pre></td></tr></table></figure>
<h3 id="查看系统自带的网卡自动发现"><a href="#查看系统自带的网卡自动发现" class="headerlink" title="查看系统自带的网卡自动发现"></a>查看系统自带的网卡自动发现</h3><p><strong>1. 查看网络自动发现规则</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181905.png"></p>
<p><strong>2. 过滤规则</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181906.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181907.png"></p>
<p><strong>3. 命令行过滤</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ zabbix_agentd -p|grep net.if.discovery</span><br><span class="line"><span class="selector-tag">net</span><span class="selector-class">.if</span><span class="selector-class">.discovery</span>                              <span class="selector-attr">[s|&#123;<span class="string">&quot;data&quot;</span>:[&#123;<span class="string">&quot;&#123;#IFNAME&#125;&quot;</span>:<span class="string">&quot;eth0&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#IFNAME&#125;&quot;</span>:<span class="string">&quot;eth1&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#IFNAME&#125;&quot;</span>:<span class="string">&quot;lo&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#IFNAME&#125;&quot;</span>:<span class="string">&quot;virbr0-nic&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#IFNAME&#125;&quot;</span>:<span class="string">&quot;virbr0&quot;</span>&#125;]</span>&#125;]</span><br><span class="line">^Czabbix_agentd [56290]: Warning: Got signal [signal:2(SIGINT),sender_pid:0,sender_uid:0,reason:128</span><br></pre></td></tr></table></figure>
<p><strong>4. 查看自动添加的监控项</strong></p>
<blockquote>
<p>2个eth0<br>2个eth1</p>
</blockquote>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181908.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181909.png"></p>
<p><strong>5. 查看key的值</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ zabbix_get -s 10.0.0.8 -k net.if.in[eth0]</span><br><span class="line">5767491</span><br><span class="line">$ zabbix_get -s 10.0.0.8 -k net.if.in[eth1]</span><br><span class="line">3120</span><br></pre></td></tr></table></figure>
<h3 id="监控mysql多实例"><a href="#监控mysql多实例" class="headerlink" title="监控mysql多实例"></a>监控mysql多实例</h3><p><strong>1. 复制并修改数据库配置文件(3307 3308）</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ cp /etc/my.cnf /etc/my3307.cnf</span><br><span class="line">$ vim /etc/my3307.cnf</span><br><span class="line">$ cat /etc/my3307.cnf                                              //编写配置文件</span><br><span class="line"><span class="selector-attr">[mysqld]</span></span><br><span class="line">datadir=/data/3307/</span><br><span class="line">socket=/data/3307/mysql.sock</span><br><span class="line">port=3307</span><br><span class="line">user=mysql</span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="selector-attr">[mysqld_safe]</span></span><br><span class="line">log-error=/data/3307/mysqld.log</span><br><span class="line">pid-file=/data/3307/mysqld.pid</span><br><span class="line"></span><br><span class="line">$ cp /etc/my3307.cnf /etc/my3308.cnf </span><br><span class="line">$sed -i &#x27;s#3307#3308#g&#x27; /etc/my3308.cnf</span><br></pre></td></tr></table></figure>
<p><strong>2. 创建数据目录并初始化</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /data/&#123;3307,3308&#125; -p</span><br><span class="line">$ chown -R mysql:mysql /data/330*                                   //修改权限</span><br><span class="line">$ mysql_install_db --user=mysql --defaults-file=/etc/my3307.cnf     //初始化，指定用户和默认配置文件位置</span><br><span class="line">$ mysql_install_db --user=mysql --defaults-file=/etc/my3308.cnf</span><br></pre></td></tr></table></figure>
<p><strong>3. 启动多实例</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mysqld_safe --defaults-file=/etc/my3307.cnf &amp;</span><br><span class="line">$ mysqld_safe --defaults-file=/etc/my3308.cnf &amp;</span><br></pre></td></tr></table></figure>
<p><strong>4. 检查端口</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ netstat -lntup|grep mysql</span><br><span class="line"><span class="selector-tag">tcp</span>        0      0 0.0.0.0<span class="selector-pseudo">:3306</span>            0.0.0.0:*               <span class="selector-tag">LISTEN</span>      69432/<span class="selector-tag">mysqld</span>        </span><br><span class="line"><span class="selector-tag">tcp</span>        0      0 0.0.0.0<span class="selector-pseudo">:3307</span>            0.0.0.0:*               <span class="selector-tag">LISTEN</span>      73414/<span class="selector-tag">mysqld</span>        </span><br><span class="line"><span class="selector-tag">tcp</span>        0      0 0.0.0.0<span class="selector-pseudo">:3308</span>            0.0.0.0:*               <span class="selector-tag">LISTEN</span>      73809/<span class="selector-tag">mysqld</span>  </span><br></pre></td></tr></table></figure>
<p><strong>5. 创建自动发现多实例脚本</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ cat /server/scritps/mysql_discovery.sh </span><br><span class="line">#!/bin/bash </span><br><span class="line"><span class="selector-id">#mysql</span> low-level discovery </span><br><span class="line">res=$(netstat -lntp|awk -F &quot;[ :\t]+&quot; &#x27;/mysqld/&#123;print$5&#125;&#x27;)</span><br><span class="line">port=($res) </span><br><span class="line">printf &#x27;&#123;&#x27; </span><br><span class="line">printf &#x27;&quot;data&quot;:[&#x27; </span><br><span class="line">for key in $&#123;!port<span class="selector-attr">[@]</span>&#125; </span><br><span class="line">do </span><br><span class="line">        if <span class="selector-attr">[[ &quot;$&#123;#port[@]</span>&#125;&quot; -gt 1 &amp;&amp; &quot;$&#123;key&#125;&quot; -ne &quot;$(($&#123;<span class="selector-id">#port</span><span class="selector-attr">[@]</span>&#125;-1))&quot; ]];then </span><br><span class="line">                printf &#x27;&#123;&#x27; </span><br><span class="line">                printf &quot;\&quot;&#123;<span class="selector-id">#MYSQLPORT</span>&#125;\&quot;:\<span class="string">&quot;$&#123;port[$&#123;key&#125;]&#125;\&quot;&#125;,&quot;</span> </span><br><span class="line">        else [[ <span class="string">&quot;$&#123;key&#125;&quot;</span> -eq <span class="string">&quot;(($&#123;#port[@]&#125;-1))&quot;</span> ]] </span><br><span class="line">                printf <span class="string">&#x27;&#123;&#x27;</span> </span><br><span class="line">                printf <span class="string">&quot;\&quot;&#123;#MYSQLPORT&#125;\&quot;:\&quot;$&#123;port[$&#123;key&#125;]&#125;\&quot;&#125;&quot;</span> </span><br><span class="line">        fi </span><br><span class="line">done </span><br><span class="line">printf <span class="string">&#x27;]&#x27;</span> </span><br><span class="line">printf <span class="string">&#x27;&#125;\n&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>6. 创建自动发现配置文件</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/zabbix/zabbix_agentd.d/mysql_discovery.conf</span><br><span class="line">UserParameter=mysql.discovery,/bin/bash /server/scripts/mysql_discovery.sh</span><br></pre></td></tr></table></figure>
<p><strong>7. 测试自动发现脚本</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ bash /server/scritps/mysql_discovery.sh </span><br><span class="line">&#123;&quot;data&quot;:[&#123;&quot;&#123;#MYSQLPORT&#125;&quot;:&quot;3306&quot;&#125;,&#123;&quot;&#123;#MYSQLPORT&#125;&quot;:&quot;3307&quot;&#125;,&#123;&quot;&#123;#MYSQLPORT&#125;&quot;:&quot;3308&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure>
<p><strong>8. 重启zabbix-agent</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart zabbix-agent.service </span><br></pre></td></tr></table></figure>
<p><strong>9. zabbix_get测试取key</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ zabbix_get -s 127.0.0.1 -k mysql.discovery</span><br><span class="line">(<span class="selector-tag">Not</span> <span class="selector-tag">all</span> <span class="selector-tag">processes</span> <span class="selector-tag">could</span> <span class="selector-tag">be</span> <span class="selector-tag">identified</span>, <span class="selector-tag">non-owned</span> <span class="selector-tag">process</span> <span class="selector-tag">info</span></span><br><span class="line"><span class="selector-tag">will</span> <span class="selector-tag">not</span> <span class="selector-tag">be</span> <span class="selector-tag">shown</span>, <span class="selector-tag">you</span> <span class="selector-tag">would</span> <span class="selector-tag">have</span> <span class="selector-tag">to</span> <span class="selector-tag">be</span> <span class="selector-tag">root</span> <span class="selector-tag">to</span> <span class="selector-tag">see</span> <span class="selector-tag">it</span> <span class="selector-tag">all</span>.)</span><br><span class="line">&#123;&quot;data&quot;:[]&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><p>发现问题:原因是zabbix用户不能使用netstat的-p参数</p>
</li>
<li><p>解决方法为给netstat命令添加权限</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ which netstat</span><br><span class="line">/usr/bin/netstat</span><br><span class="line">$ chmod u+s /usr/bin/netstat</span><br><span class="line">$ ll /usr/bin/netstat</span><br><span class="line">-rwsr-xr-x. 1 root root 155008 Aug  9  2019 /usr/bin/netstat</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新测试</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ zabbix_get -s 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span> -k mysql<span class="selector-class">.discovery</span></span><br><span class="line">&#123;&quot;data&quot;:[&#123;<span class="string">&quot;&#123;#MYSQLPORT&#125;&quot;</span>:<span class="string">&quot;3306&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#MYSQLPORT&#125;&quot;</span>:<span class="string">&quot;3307&quot;</span>&#125;,&#123;<span class="string">&quot;&#123;#MYSQLPORT&#125;&quot;</span>:<span class="string">&quot;3308&quot;</span>&#125;]&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>10. web页面创建自动发现规则模板</strong></p>
</blockquote>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181910.png">    </p>
<p><strong>11. 创建自动发现</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181911.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181912.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181913.png"></p>
<p><strong>12. 创建正则表达式</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181914.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181915.png"></p>
<p><strong>13. 模仿zabbix自带的mysql监控配置修改监控项</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf    </span><br><span class="line">UserParameter=mysql.status[*],echo &quot;show global status where Variable_name=&#x27;$1&#x27;;&quot; | HOME=/var/lib/zabbix mysql -uroot -p123456 -P $2 -N | awk &#x27;&#123;print $$2&#125;&#x27;</span><br><span class="line"></span><br><span class="line">$systemctl restart zabbix-agent.service</span><br></pre></td></tr></table></figure>
<p><strong>14. 测试访问监控项</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ zabbix_get -s 127.0.0.1 -k mysql.status[Uptime,3307]</span><br><span class="line">15180</span><br><span class="line">$ zabbix_get -s 127.0.0.1 -k mysql.status[Uptime,3308]</span><br><span class="line">15184</span><br><span class="line">$ zabbix_get -s 127.0.0.1 -k mysql.status[Uptime,3306]</span><br><span class="line">15189</span><br></pre></td></tr></table></figure>
<p><strong>15. web页面添加监控项原型</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181916.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181917.png"></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181918.png"></p>
<p><strong>16. web页面设置主机关联模板</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181919.png"></p>
<p><strong>17. 查看是否已经自动添加成功</strong></p>
<blockquote>
<p>PS：注意自己搭建的数据库服务器的主机，不要添加错了</p>
</blockquote>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210126181920.png"></p>
<p><strong>18. 整体步骤</strong></p>
<blockquote>
<ol>
<li>创建mysql多实例3307,3308，并启动</li>
<li>创建自动发现多实例脚本 </li>
<li>创建自动发现配置文件                                                 //这个配置文件是调用自动发现多实例脚本</li>
<li>测试自动发现脚本是否能够获取key                                //这个测试是测试上述创建的多实例脚本，使用bash执行</li>
<li>重启zabbix-agent</li>
<li>zabbix-get测试取key                                                 //这个是服务端测试客户端自动发现配置文件</li>
<li>web页面创建自动发现规则模板</li>
<li>web页面创建自动发现规则</li>
<li>将zabbix自带的mysql监控配置修改成监控项                    //这个主要是添加mysql的账户和密码，以及端口</li>
<li>服务端测试访问客户端监控项</li>
<li>web页面添加监控项原型                                              //不要添加监控项，而是添加监控项原型，因为是自动检测</li>
<li>web页面设置主机关联模板                                          //这个主机是创建mysql多实例，不要关联错主机，否则没有效果</li>
<li>web页面查看是否已经自动添加成功</li>
</ol>
</blockquote>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Inaction</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://myboke.ink/2021/01/26/zabbix服务深入扩展/">https://myboke.ink/2021/01/26/zabbix服务深入扩展/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/zabbix/">zabbix</a></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="next-post pull-right"><a href="/2021/01/26/zabbix%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"><span>zabbix故障处理</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '6cea6a646bff1a0d5f5b',
  clientSecret: '6e9ef08f31f505d416bc0afe2d304808e9063627',
  repo: 'zsjmal2316.github.io',
  owner: 'zsjmal2316',
  admin: 'zsjmal2316',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(img/beijing2.png)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2021 By Inaction</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" data-click="false"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>