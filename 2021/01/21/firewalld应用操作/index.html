<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="firewalld应用操作"><meta name="keywords" content="firewalld"><meta name="author" content="Inaction"><meta name="copyright" content="Inaction"><title>firewalld应用操作 | Inaction's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.3.0'
} </script><meta name="generator" content="Hexo 5.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Firewalld%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">1.</span> <span class="toc-text">Firewalld防火墙</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Firewalld%E5%9F%BA%E6%9C%AC%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">Firewalld基本概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Firewalld%E4%B8%8EIptables%E7%9A%84%E4%B8%8D%E5%90%8C%E7%82%B9"><span class="toc-number">1.2.</span> <span class="toc-text">Firewalld与Iptables的不同点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Firewalld%E5%8C%BA%E5%9F%9F%E6%A6%82%E8%BF%B0"><span class="toc-number">1.3.</span> <span class="toc-text">Firewalld区域概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Firewalld%E7%9A%84%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.</span> <span class="toc-text">Firewalld的命令参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Firewalld-cmd%E5%91%BD%E4%BB%A4%E5%88%86%E7%B1%BB"><span class="toc-number">1.4.1.</span> <span class="toc-text">Firewalld-cmd命令分类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E5%8C%BA%E5%9F%9F%E9%85%8D%E7%BD%AE%E7%AD%96%E7%95%A5"><span class="toc-number">1.5.</span> <span class="toc-text">防火墙区域配置策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#zone%E5%8C%BA%E5%9F%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.1.</span> <span class="toc-text">zone区域配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%BB%98%E8%AE%A4%E5%8C%BA%E5%9F%9F%E5%B9%B6%E8%AE%BE%E7%BD%AE%E7%99%BD%E5%90%8D%E5%8D%95"><span class="toc-number">1.5.2.</span> <span class="toc-text">配置默认区域并设置白名单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%81%E8%AE%B8IP%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AEhttp%E3%80%81ssh%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.3.</span> <span class="toc-text">允许IP地址访问http、ssh服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E7%AB%AF%E5%8F%A3%E8%AE%BF%E9%97%AE%E7%AD%96%E7%95%A5"><span class="toc-number">1.5.4.</span> <span class="toc-text">防火墙端口访问策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Firewalld%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E7%AD%96%E7%95%A5"><span class="toc-number">1.6.</span> <span class="toc-text">Firewalld端口转发策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Firewalld%E5%AF%8C%E8%A7%84%E5%88%99%E7%AD%96%E7%95%A5"><span class="toc-number">1.7.</span> <span class="toc-text">Firewalld富规则策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.7.1.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Firewalld%E5%AE%9E%E7%8E%B0%E5%85%B1%E4%BA%AB%E4%B8%8A%E7%BD%91"><span class="toc-number">1.8.</span> <span class="toc-text">Firewalld实现共享上网</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/melody-favicon.ico"></div><div class="author-info__name text-center">Inaction</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">29</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">13</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friend Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://www.ji4n.cn/">Jen</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(http://img.xjh.me/desktop/bg/nature/64988447_p0.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Inaction's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">firewalld应用操作</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-01-21</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/">Linux</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="Firewalld防火墙"><a href="#Firewalld防火墙" class="headerlink" title="Firewalld防火墙"></a>Firewalld防火墙</h1><h2 id="Firewalld基本概述"><a href="#Firewalld基本概述" class="headerlink" title="Firewalld基本概述"></a>Firewalld基本概述</h2><p>RHEL/CentOS系统中继承了多款防火墙管理工具，其中Firewalld（Dynamic Firewall Manager of Linux systems, Linux系统的动态防护墙管理器）服务是默认的防火墙配置管理工具，它拥有基于CLI（命令行界面）和基于GUI（图形界面）的两种管理方式</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210121155052.png"></p>
<h2 id="Firewalld与Iptables的不同点"><a href="#Firewalld与Iptables的不同点" class="headerlink" title="Firewalld与Iptables的不同点"></a>Firewalld与Iptables的不同点</h2><blockquote>
<ol>
<li>Firewalld可以动态修改单挑规则，而不需要想iptables那样，在修改了规则必须得全部刷新才可以生效</li>
<li>Firewalld在使用上要比iptables人性化很多，即使不明白“四表五链”，且对TCP/IP协议不理解的也可以实现大部分功能</li>
<li>Firewalld跟iptables比起来，每个服务器都需要去设置才能放行，因为默认是拒绝，而iptables里默认是每个服务是允许，需要拒绝的才去限制</li>
<li>Firewalld加入了区域（zone）的概念</li>
</ol>
</blockquote>
<h2 id="Firewalld区域概述"><a href="#Firewalld区域概述" class="headerlink" title="Firewalld区域概述"></a>Firewalld区域概述</h2><p>简单说，区域就是Firewalld预先准备了几套防火墙策略集合（策略模板），用户可以根据生产场景不同而选择适合的策略集合，从而实现防火墙策略之间的快速切换</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210121155707.png"></p>
<p><strong>区域默认规则策略表</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210121164357.png"></p>
<blockquote>
<p><strong>注意</strong></p>
<ul>
<li>一个zone区域仅能绑定一个网卡，设定不同的匹配规则</li>
<li>一个zone区域又可以针对不同的源地址设定不同的规则</li>
</ul>
</blockquote>
<h2 id="Firewalld的命令参数"><a href="#Firewalld的命令参数" class="headerlink" title="Firewalld的命令参数"></a>Firewalld的命令参数</h2><p><strong>1. 查看firewalld的有哪些配置文件</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -qc firewalld</span><br><span class="line">/etc/dbus-1/system.d/FirewallD.conf</span><br><span class="line">/etc/firewalld/firewalld.conf</span><br><span class="line">/etc/firewalld/lockdown-whitelist.xml</span><br><span class="line">/etc/sysconfig/firewalld</span><br></pre></td></tr></table></figure>
<p><strong>2. firewalld区域模板文件</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/lib/firewalld/zones/</span><br><span class="line">$ ls</span><br><span class="line">block<span class="selector-class">.xml</span>  drop<span class="selector-class">.xml</span>      home<span class="selector-class">.xml</span>      public<span class="selector-class">.xml</span>   work<span class="selector-class">.xml</span></span><br><span class="line">dmz<span class="selector-class">.xml</span>    external<span class="selector-class">.xml</span>  internal<span class="selector-class">.xml</span>  trusted<span class="selector-class">.xml</span></span><br></pre></td></tr></table></figure>
<p><strong>3. firewalld的规则分两种状态</strong></p>
<blockquote>
<ol>
<li>runtime（运行是）：修改规则马上生效，但是临时生效（不建议）</li>
<li>permanent（持久配置）：修改后需要reload重载才会生效（推荐）</li>
</ol>
</blockquote>
<h3 id="Firewalld-cmd命令分类"><a href="#Firewalld-cmd命令分类" class="headerlink" title="Firewalld-cmd命令分类"></a>Firewalld-cmd命令分类</h3><p><strong>zone区域相关指令</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>–get-default-zone</td>
<td>查询默认的区域名称</td>
</tr>
<tr>
<td>–set-default-zone=&lt;区域名称&gt;</td>
<td>设置默认的区域，使其永久生效</td>
</tr>
<tr>
<td>–get-active-zones</td>
<td>显示当前正在使用的区域与网卡名称</td>
</tr>
<tr>
<td>–get-zones</td>
<td>显示总共可用的区域</td>
</tr>
<tr>
<td>–new-zone=&lt;区域名称&gt;</td>
<td>新增区域</td>
</tr>
</tbody></table>
<p><strong>services服务相关指令</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>–get-services</td>
<td>显示预先定义的服务</td>
</tr>
<tr>
<td>–add-service=&lt;服务名&gt;</td>
<td>设置默认区域允许该服务的流量</td>
</tr>
<tr>
<td>–remove-service=&lt;服务名&gt;</td>
<td>设置默认区域不在允许该服务的流量</td>
</tr>
</tbody></table>
<p><strong>POST端口相关命令</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>–add-port=&lt;端口号/协议&gt;</td>
<td>设置默认区域允许端口的流量</td>
</tr>
<tr>
<td>–remove-port=&lt;端口/协议&gt;</td>
<td>设置默认区域不再允许端口的流量</td>
</tr>
</tbody></table>
<p><strong>Interface网卡相关指令</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>–add-interface=&lt;网卡名称&gt;</td>
<td>将源自该网卡的所有流量都导向某个指定区域</td>
</tr>
<tr>
<td>–change-interface=&lt;网卡名称&gt;</td>
<td>将某个网卡与区域进行关联</td>
</tr>
</tbody></table>
<p><strong>其他相关指令</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>–list-all</td>
<td>显示当前区域的网卡配置参数，资源，端口以及服务</td>
</tr>
<tr>
<td>–reload</td>
<td>让”持久生效”的配置规则立即生效，并覆盖当前的配置规则</td>
</tr>
</tbody></table>
<h2 id="防火墙区域配置策略"><a href="#防火墙区域配置策略" class="headerlink" title="防火墙区域配置策略"></a>防火墙区域配置策略</h2><p>为了能正常使用Firewalld服务和相关工具去管理防护墙，必须启动Firewalld服务，同时关闭以前旧防火墙相关服务</p>
<p><strong>1. 禁止传统防火墙服务</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl <span class="attribute">mask</span> iptables                  <span class="comment">//禁止iptables</span></span><br><span class="line">Created symlink from /etc/systemd/system/iptables.service to /dev/null.</span><br><span class="line">$ systemctl <span class="attribute">mask</span> ip6tables                 <span class="comment">//禁止ip6tables</span></span><br><span class="line">Created symlink from /etc/systemd/system/ip6tables.service to /dev/null.</span><br><span class="line">$ systemctl <span class="attribute">mask</span> ebtables                  <span class="comment">//禁止ebtables</span></span><br><span class="line">Created symlink from /etc/systemd/system/ebtables.service to /dev/null.</span><br></pre></td></tr></table></figure>
<p><strong>2. 启动Firewalld防火墙，并加入开机自启动服务</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl start firewalld</span><br><span class="line">$ systemctl enable firewalld</span><br></pre></td></tr></table></figure>
<p><strong>3. 备份Firewalld相关配置文件（重要）</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp -a /etc/firewalld/ /etc/firewalld_backup</span><br></pre></td></tr></table></figure>
<h3 id="zone区域配置"><a href="#zone区域配置" class="headerlink" title="zone区域配置"></a>zone区域配置</h3><p><strong>1. 查看当前默认区域</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --get-default-zone</span><br><span class="line">public</span><br></pre></td></tr></table></figure>
<p><strong>2. 查看当前活跃的区域</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --get-active-zone</span><br><span class="line">public</span><br><span class="line">  interfaces: eth0 eth1</span><br></pre></td></tr></table></figure>
<h3 id="配置默认区域并设置白名单"><a href="#配置默认区域并设置白名单" class="headerlink" title="配置默认区域并设置白名单"></a>配置默认区域并设置白名单</h3><blockquote>
<ol>
<li>设定默认区域为drop（拒绝所有）</li>
<li>设置白名单IP访问，将源10.0.0.0/24网段加入trusted区域</li>
</ol>
</blockquote>
<p><strong>1. 将当前默认区域修改drop</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --set-default-zone=drop </span><br><span class="line">$ firewall-cmd –reload</span><br><span class="line"><span class="comment">//设置默认区域不需要加--permanent参数，重载之后就可以永久生效</span></span><br></pre></td></tr></table></figure>
<p><strong>2. 将网络接口关联至drop区域</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注意：不指定区域，则默认会加入到public区域</span></span><br><span class="line">$ firewall-cmd --add-interface=eth0 --add-interface=eth1 --zone=drop  --permanent</span><br><span class="line"></span><br><span class="line"><span class="comment">//当然如果指定错误，可以使用--change-interface参数指定回其他区域</span></span><br><span class="line">$ firewall-cmd --change-interface=eth0 --zone=drop  --permanent</span><br><span class="line"></span><br><span class="line"><span class="comment">//重新加载才能永久生效</span></span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p><strong>3. 将10.0.0.0/24网段加入trusted白名单</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --add-source=10.0.0.0/24 --zone=trusted  --permanent</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p><strong>4. 查看当前处于活动的区域</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --get-active-zone</span><br><span class="line">drop</span><br><span class="line">  interfaces: eth0 eth1</span><br><span class="line">trusted</span><br><span class="line">  sources: <span class="number">10.0</span>.<span class="number">0.0</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>
<h3 id="允许IP地址访问http、ssh服务"><a href="#允许IP地址访问http、ssh服务" class="headerlink" title="允许IP地址访问http、ssh服务"></a>允许IP地址访问http、ssh服务</h3><blockquote>
<ol>
<li>设定来源IP，172.16.1.0/24网段允许访问http</li>
<li>设定来源IP，10.0.0.0/24仅允许访问ssh服务</li>
<li>其他网段走默认区域</li>
</ol>
</blockquote>
<p><strong>1. 允许10.0.0.0/24的IP地址访问ssh</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --add-source=10.0.0.0/24 --permanent --zone=public</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p><strong>2. 将172.16.1.0/24网段加入白名单</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --add-source=172.16.1.0/24 --permanent --zone=trusted</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p><strong>3. 查看活动的区域</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --get-active-zone</span><br><span class="line">public</span><br><span class="line">  sources: <span class="number">10.0</span>.<span class="number">0.1</span>/<span class="number">24</span></span><br><span class="line">trusted</span><br><span class="line">  sources: <span class="number">172.16</span>.<span class="number">1.0</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>
<p><strong><code>PS：设置到了trusted区域是可以访问HTTP的，但是trusted区域还能访问所有的服务，所以设定在trusted区域是可以解决问题，但是安全性却不高了</code></strong></p>
<blockquote>
<p>如何实现172.16.1.0/24网段只能访问HTTP</p>
<ul>
<li><p>方法一：新建区域（不建议）</p>
</li>
<li><p>方法二：使用富规则（推荐，下述章节有讲解）</p>
</li>
</ul>
</blockquote>
<h3 id="防火墙端口访问策略"><a href="#防火墙端口访问策略" class="headerlink" title="防火墙端口访问策略"></a>防火墙端口访问策略</h3><p><strong>1. 配置防火墙，访问80/tcp(http)，并立即生效</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --add-port=80/tcp --zone=public --permanent</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p><strong>2. 访问80/tcp(http)，161/upd(snmp)端口的流量策略，并立即生效</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --add-port=80/tcp --add-port=161/udp --permanent</span><br><span class="line">$ firewall-cmd --reload</span><br><span class="line">$ firewall-cmd --list-ports       <span class="comment">//查看端口</span></span><br><span class="line">80/tcp 161/udp</span><br><span class="line"></span><br><span class="line">$ firewall-cmd --list-all         <span class="comment">//查看默认区域的全部配置</span></span><br><span class="line">public (active)</span><br><span class="line">  target: default</span><br><span class="line">  icmp-block-inversion: no</span><br><span class="line">  interfaces: </span><br><span class="line">  sources: <span class="number">10.0</span>.<span class="number">0.0</span>/<span class="number">24</span></span><br><span class="line">  services: ssh dhcpv6-client</span><br><span class="line">  ports: <span class="number">80</span>/tcp <span class="number">161</span>/udp</span><br><span class="line">  protocols: </span><br><span class="line">  masquerade: no</span><br><span class="line">  forward-ports: </span><br><span class="line">  source-ports: </span><br><span class="line">  icmp-blocks: </span><br><span class="line">  rich rules:</span><br></pre></td></tr></table></figure>
<p><strong>3. 允许请求HTTP与 HTTPS协议的流量设置为永久允许，并立即生效</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --permanent --add-service=http --add-service=https –zone=public</span><br><span class="line">$ firewall-cmd --reload</span><br><span class="line">$ firewall-cmd --list-services      <span class="comment">//查看服务</span></span><br><span class="line">ssh dhcpv6-client http https</span><br></pre></td></tr></table></figure>
<p><strong>4. 允许请求php-fpm服务的流量设置为永久允许，并立即生效</strong></p>
<blockquote>
<p>方法一：添加端口就可以并重载</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --add-port=9000/tcp --zone=public --permanent</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>方法二：复制一个service目录的模板，修改名字跟协议</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/usr/lib/firewalld/services </span><br><span class="line"></span><br><span class="line">$ cp http<span class="selector-class">.xml</span> php-fpm<span class="selector-class">.xml</span></span><br><span class="line">$ cat php-fpm<span class="selector-class">.xml</span>                        <span class="comment">//查看修改后的结果</span></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;service&gt;</span><br><span class="line">  &lt;short&gt;php-fpm&lt;/short&gt;</span><br><span class="line">  &lt;description&gt;php-fpm is the protocol used to serve Web pages. If you plan to make your Web server publicly available, enable this option. This option is not required for viewing pages locally or developing Web pages.&lt;/description&gt;</span><br><span class="line">  &lt;port protocol=&quot;tcp&quot; port=&quot;9000&quot;/&gt;</span><br><span class="line">&lt;/service&gt;</span><br><span class="line"></span><br><span class="line">$ firewall-cmd --add-service=php-fpm --zone=public --permanent   //设定服务php-fpm</span><br><span class="line">$ firewall-cmd --reload</span><br><span class="line">$ firewall-cmd --list-all                                       <span class="comment">//查看</span></span><br><span class="line">public (active)</span><br><span class="line">  target: default</span><br><span class="line">  icmp-block-inversion: no</span><br><span class="line">  interfaces: </span><br><span class="line">  sources: <span class="number">10.0</span>.<span class="number">0.0</span>/<span class="number">24</span></span><br><span class="line">  services: ssh dhcpv6-client http https php-fpm</span><br><span class="line">  ports: <span class="number">80</span>/tcp <span class="number">161</span>/udp <span class="number">9000</span>/tcp</span><br></pre></td></tr></table></figure>

</blockquote>
<h2 id="Firewalld端口转发策略"><a href="#Firewalld端口转发策略" class="headerlink" title="Firewalld端口转发策略"></a>Firewalld端口转发策略</h2><p>端口转发是指传统的目标地址映射，实现外网访问内网资源</p>
<p><strong>转发命令格式为</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd -pernanent -zone=&lt;区域&gt; --add-forward-port=port=&lt;源端口&gt;:proto=&lt;协议&gt;:toport=&lt;目标端口号&gt;:toadd=&lt;目标ip地址&gt;</span><br></pre></td></tr></table></figure>
<p><strong>1. 转发本机555/tcp端口的流量至22/tcp端口，要求当前和长期有效</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --add-forward-port=555:proto=tcp:toport=22:toaddr=10.0.0.7 --zone=public --permanent</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p><strong>2. 移除本机转发的555/tcp端口策略，要求当前和长期有效</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --remove-forward-port=555:proto=tcp:toport=22:toaddr=10.0.0.7 --zone=public --permanent</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p><strong>3. 如果需要将本地的10.0.0.7:6666端口转发至后端10.0.0.8:22端口</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//需要开启IP伪装</span></span><br><span class="line">$ firewall-cmd --add-masquerade --permanent</span><br><span class="line"></span><br><span class="line">$ firewall-cmd --add-forward-port=port=6666:proto=tcp:toport=22:toaddr=10.0.0.8 --permanent</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<h2 id="Firewalld富规则策略"><a href="#Firewalld富规则策略" class="headerlink" title="Firewalld富规则策略"></a>Firewalld富规则策略</h2><p>Firewalld中的富规则可以设置的更细致、更详细的策略配置，它可以针对系统服务、端口号、源地址和目标地址等诸多信息进行更优针对性的策略配置</p>
<p><strong>1. 富规则手册</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//富规则通用结构</span></span><br><span class="line">$ man firewalld<span class="selector-class">.richlanguage</span></span><br><span class="line">rule</span><br><span class="line">    <span class="selector-attr">[source]</span></span><br><span class="line">    <span class="selector-attr">[destination]</span></span><br><span class="line">    service|port|protocol|icmp-block|icmp-type|masquerade|forward-port|source-port</span><br><span class="line">    <span class="selector-attr">[log]</span></span><br><span class="line">    <span class="selector-attr">[audit]</span></span><br><span class="line">    <span class="selector-attr">[accept|reject|drop|mark]</span></span><br><span class="line"></span><br><span class="line">rule <span class="selector-attr">[family=&quot;ipv4|ipv6&quot;]</span></span><br><span class="line">source [not] address=&quot;address[/mask]&quot;|mac=&quot;mac-address&quot;|ipset=&quot;ipset&quot;</span><br><span class="line">destination [not] address=&quot;address[/mask]&quot;</span><br><span class="line">service name=&quot;service name&quot;</span><br><span class="line">protocol value=&quot;protocol value&quot;</span><br><span class="line">icmp-block name=&quot;icmptype name&quot;</span><br><span class="line">forward-port port=&quot;port value&quot; protocol=&quot;tcp|udp&quot; to-port=&quot;port value&quot; to-addr=&quot;address&quot;</span><br><span class="line">log <span class="selector-attr">[prefix=&quot;prefix text&quot;]</span> <span class="selector-attr">[level=&quot;log level&quot;]</span> <span class="selector-attr">[limit value=&quot;rate/duration&quot;]</span></span><br></pre></td></tr></table></figure>
<p><strong>2. 富规则则按先后顺序配置，按先匹配到的规则生效</strong></p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">–add-rich-rule=’<RULE>‘</td>
<td align="left">在指定的区添加一条富规则</td>
</tr>
<tr>
<td align="left">–remove-rich-rule=’<RULE>‘</td>
<td align="left">在指定的区删除一条富规则</td>
</tr>
<tr>
<td align="left">–list-rich-rules</td>
<td align="left">列出指定去里的所有富规则</td>
</tr>
<tr>
<td align="left">–list-all 和 –list-all-zone</td>
<td align="left">也能列出存在的富规则</td>
</tr>
</tbody></table>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p><strong>1. 允许10.0.0.0/24网段中10.0.0.1主机访问http服务，其他网络无法访问，当前和永久生效</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//10.0.0.0/24所有主机至public区域</span></span><br><span class="line">$ firewall-cmd --permanent --add-source=10.0.0.0/24 --zone=public</span><br><span class="line"><span class="comment">//仅允许public中的10.0.0.1主机访问http</span></span><br><span class="line">$ firewall-cmd --permanent --zone=public --add-rich-rule=&#x27;rule family=ipv4 source address=10.0.0.1/32 port port=80 protocol=tcp accept&#x27;</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p><strong>2. 拒绝10.0.0.0/24网段中的10.0.0.8主机发起的ssh请求，当前和永久生效</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --permanent --add-rich-rule=&#x27;rule family=ipv4 source address=10.0.0.8 port port=22 protocol=tcp drop&#x27;</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p><strong>3. 将远程10.0.0.1主机请求firewalld的5555端口，转发至firewalld防火墙的22端口</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --permanent --add-rich-rule=&#x27;rule family=ipv4 source address=10.0.0.1/32 forward-port port=5555 protocol=tcp to-port=22&#x27;</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p><strong>4. 将远程10.0.0.1主机请求firewalld的6666端口，转发至后端主机10.0.0.9的22端口</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --permanent --add-rich-rule=&#x27;rule family=ipv4 source address=10.0.0.1/32 forward-port port=6666 protocol=tcp to-port=22 to-addr=10.0.0.9&#x27;</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<h2 id="Firewalld实现共享上网"><a href="#Firewalld实现共享上网" class="headerlink" title="Firewalld实现共享上网"></a>Firewalld实现共享上网</h2><p>指定带有公网IP的实例上操作，启动NAT网关的SNAT源地址转换功能</p>
<p><strong>Firewalld防火墙开启IP伪装，实现地址转换</strong></p>
<blockquote>
<ol>
<li><p>网卡默认是在public的zones内，也是默认zones，永久添加源地址转换功能</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --permanent --add-masquerade</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端配置共享上网</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在配置之前，需要配置DNS，否则无法找到IP地址</span></span><br><span class="line">$ vim /etc/sysconfig/network-scripts/ifcfg-eth1</span><br><span class="line">DNS1=223.5.5.5</span><br><span class="line"></span><br><span class="line"><span class="comment">//然后配置网关</span></span><br><span class="line">route add default gw 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.7</span>                  <span class="comment">//临时配置</span></span><br><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-eth1   //永久配置</span><br><span class="line">  GETEWAY=172.16.1.7</span><br><span class="line"></span><br><span class="line"><span class="comment">//重启网卡</span></span><br><span class="line">$ nmcli connection reload</span><br><span class="line">$ nmcli connection down eth1 &amp;&amp; nmcli connection up eth1</span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Inaction</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://myboke.ink/2021/01/21/firewalld应用操作/">https://myboke.ink/2021/01/21/firewalld应用操作/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/firewalld/">firewalld</a></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/01/23/Typora-PicGo-%E5%9B%BE%E5%BA%8A/"><i class="fa fa-chevron-left">  </i><span>Typora+PicGo+图床</span></a></div><div class="next-post pull-right"><a href="/2021/01/21/iptables%E5%BA%94%E7%94%A8%E6%93%8D%E4%BD%9C/"><span>iptables应用操作</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '6cea6a646bff1a0d5f5b',
  clientSecret: '6e9ef08f31f505d416bc0afe2d304808e9063627',
  repo: 'zsjmal2316.github.io',
  owner: 'zsjmal2316',
  admin: 'zsjmal2316',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(http://img.xjh.me/desktop/bg/nature/64988447_p0.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2021 By Inaction</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>