<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="MySQL主从复制-8"><meta name="keywords" content="MySQL"><meta name="author" content="Inaction"><meta name="copyright" content="Inaction"><title>MySQL主从复制-8 | Inaction's Blog</title><link rel="shortcut icon" href="/imdadul-hussain-u_oLPS_ZYSc-unsplash.jpg"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?12b421fdad87d1edf2305ccb7229d2c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'G-8RMJ1F8ETC', 'auto');
ga('send', 'pageview');</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.3.0'
} </script><meta name="generator" content="Hexo 5.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">1.</span> <span class="toc-text">主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%AE%A1%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">MySQL主从复制管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84%E6%96%B9%E6%A1%88"><span class="toc-number">1.1.1.</span> <span class="toc-text">MySQL高可用架构方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL%E5%A4%8D%E5%88%B6%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.2.</span> <span class="toc-text">MySQL复制的类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6%EF%BC%88%E6%BA%90%E5%A4%8D%E5%88%B6%EF%BC%89"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">异步复制（源复制）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">半同步复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E6%97%B6%E5%A4%8D%E5%88%B6"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">延时复制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E6%90%AD%E5%BB%BA%E5%89%8D%E6%8F%90"><span class="toc-number">1.1.3.</span> <span class="toc-text">主从复制的搭建前提</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B%EF%BC%88%E7%94%9F%E4%BA%A7%EF%BC%89"><span class="toc-number">1.2.</span> <span class="toc-text">主从复制搭建过程（生产）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%87%86%E5%A4%87"><span class="toc-number">1.2.1.</span> <span class="toc-text">实例准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%AE%9E%E4%BE%8B%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.2.</span> <span class="toc-text">编写实例配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%BA%93%E5%88%9B%E5%BB%BA%E5%A4%8D%E5%88%B6%E7%94%A8%E6%88%B7"><span class="toc-number">1.2.3.</span> <span class="toc-text">主库创建复制用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">1.2.4.</span> <span class="toc-text">备份与导入数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E4%B8%BB%E5%BA%93"><span class="toc-number">1.2.5.</span> <span class="toc-text">连接主库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%8A%B6%E6%80%81"><span class="toc-number">1.2.6.</span> <span class="toc-text">检查主从复制状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">主从复制工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%B6%89%E5%8F%8A%E7%9A%84%E6%96%87%E4%BB%B6%E5%92%8C%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">主从复制涉及的文件和线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%B7%A5%E4%BD%9C%EF%BC%88%E8%BF%87%E7%A8%8B%EF%BC%89%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.2.</span> <span class="toc-text">主从复制工作（过程）原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7"><span class="toc-number">1.3.3.</span> <span class="toc-text">主从复制状态监控</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%95%85%E9%9A%9C%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.</span> <span class="toc-text">主从复制故障示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IO%E7%BA%BF%E7%A8%8B%E6%95%85%E9%9A%9C"><span class="toc-number">1.4.1.</span> <span class="toc-text">IO线程故障</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E4%B8%BB%E5%BA%93%E5%A4%B1%E8%B4%A5%EF%BC%9Aconnecting"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">连接主库失败：connecting</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82binlog-%E5%A4%B1%E8%B4%A5"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">请求binlog(失败)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL%E7%BA%BF%E7%A8%8B%E6%95%85%E9%9A%9C"><span class="toc-number">1.4.2.</span> <span class="toc-text">SQL线程故障</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%94%E7%A4%BASQL%E7%BA%BF%E7%A8%8B%E6%95%85%E9%9A%9C"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">演示SQL线程故障</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%951-%E5%88%A0%E9%99%A4%E5%BA%93"><span class="toc-number">1.4.2.1.1.</span> <span class="toc-text">解决方法1 删除库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%952-%E8%B7%B3%E8%BF%87%E8%BF%99%E4%B8%AA%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.4.2.1.2.</span> <span class="toc-text">解决方法2 跳过这个步骤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%953-%E4%BB%A5%E5%90%8E%E9%81%87%E5%88%B0%E8%BF%99%E4%BA%9B%E9%97%AE%E9%A2%98%E7%9B%B4%E6%8E%A5%E8%B7%B3%E8%BF%87"><span class="toc-number">1.4.2.1.3.</span> <span class="toc-text">解决方法3 以后遇到这些问题直接跳过</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E9%94%AE%E5%86%B2%E7%AA%81%E9%97%AE%E9%A2%98"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">主键冲突问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8DSQL%E7%BA%BF%E7%A8%8B%E6%95%85%E9%9A%9C"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">如何避免SQL线程故障</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%BB%B6%E6%97%B6%E7%9B%91%E6%8E%A7%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.5.</span> <span class="toc-text">主从延时监控的原因</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%BA%93%E6%96%B9%E9%9D%A2%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.5.1.</span> <span class="toc-text">主库方面原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E5%BA%93%E6%96%B9%E9%9D%A2%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.5.2.</span> <span class="toc-text">从库方面原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%BB%B6%E6%97%B6%E7%9A%84%E7%9B%91%E6%8E%A7%E9%80%89%E9%A1%B9"><span class="toc-number">1.5.3.</span> <span class="toc-text">主从延时的监控选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%BA%93%E5%BB%B6%E8%BF%9F%E9%97%AE%E9%A2%98"><span class="toc-number">1.5.4.</span> <span class="toc-text">主库延迟问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8pt%E5%B7%A5%E5%85%B7%E6%A3%80%E6%B5%8B%E4%B8%BB%E4%BB%8E%E5%BB%B6%E8%BF%9F"><span class="toc-number">1.5.5.</span> <span class="toc-text">使用pt工具检测主从延迟</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%BB%B6%E6%97%B6%E4%BB%8E%E5%BA%93"><span class="toc-number">1.6.</span> <span class="toc-text">主从延时从库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%BB%B6%E6%97%B6%E4%BB%8E%E5%BA%93%E5%91%BD%E4%BB%A4"><span class="toc-number">1.6.1.</span> <span class="toc-text">配置延时从库命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E6%97%B6%E4%BB%8E%E5%BA%93%E5%A4%84%E7%90%86%E7%9A%84%E9%80%BB%E8%BE%91%E6%95%85%E9%9A%9C"><span class="toc-number">1.6.2.</span> <span class="toc-text">延时从库处理的逻辑故障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%BC%94%E7%BB%83"><span class="toc-number">1.6.3.</span> <span class="toc-text">故障演练</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E8%BF%87%E6%BB%A4%E5%A4%8D%E5%88%B6%E5%BA%94%E7%94%A8"><span class="toc-number">1.7.</span> <span class="toc-text">主从过滤复制应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GTID%E5%A4%8D%E5%88%B6"><span class="toc-number">1.8.</span> <span class="toc-text">GTID复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GTID%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0"><span class="toc-number">1.8.1.</span> <span class="toc-text">GTID核心参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GTID%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.</span> <span class="toc-text">GTID复制配置过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GTID%E5%A4%8D%E5%88%B6%E5%92%8C%E6%99%AE%E9%80%9A%E5%A4%8D%E5%88%B6%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.8.3.</span> <span class="toc-text">GTID复制和普通复制的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GTID%E7%9A%84%E9%99%90%E5%88%B6%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.8.4.</span> <span class="toc-text">GTID的限制和解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#create%E8%AF%AD%E5%8F%A5%E9%99%90%E5%88%B6%E5%92%8C%E8%A7%A3%E6%B3%95"><span class="toc-number">1.8.4.1.</span> <span class="toc-text">create语句限制和解法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E8%A1%A8%E7%9A%84%E9%99%90%E5%88%B6%E5%92%8C%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.8.4.2.</span> <span class="toc-text">临时表的限制和建议</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GTID%E7%9A%84%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-number">1.8.5.</span> <span class="toc-text">GTID的体系结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GTID%E4%BF%AE%E5%A4%8D%E5%A4%8D%E5%88%B6%E9%97%AE%E9%A2%98"><span class="toc-number">1.8.6.</span> <span class="toc-text">GTID修复复制问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GTID%E4%B8%8D%E8%A7%84%E8%8C%83%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.8.7.</span> <span class="toc-text">GTID不规范的使用场景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6-1"><span class="toc-number">1.9.</span> <span class="toc-text">半同步复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%B8%BB%E4%BB%8E%E5%8D%8A%E5%90%8C%E6%AD%A5%E6%8F%92%E4%BB%B6"><span class="toc-number">1.9.1.</span> <span class="toc-text">安装主从半同步插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%E5%9C%A8MySQL-5-6%E5%92%8C5-7%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-number">1.9.2.</span> <span class="toc-text">半同步复制在MySQL 5.6和5.7的变化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="toc-number">1.9.3.</span> <span class="toc-text">测试半同步复制</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/imdadul-hussain-u_oLPS_ZYSc-unsplash.jpg"></div><div class="author-info__name text-center">Inaction</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">54</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">19</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">13</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friend Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://www.ji4n.cn/">Jen</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(img/wuwei.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Inaction's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">MySQL主从复制-8</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-16</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/">Linux</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/MySQL/">MySQL</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h1><h2 id="MySQL主从复制管理"><a href="#MySQL主从复制管理" class="headerlink" title="MySQL主从复制管理"></a>MySQL主从复制管理</h2><h3 id="MySQL高可用架构方案"><a href="#MySQL高可用架构方案" class="headerlink" title="MySQL高可用架构方案"></a>MySQL高可用架构方案</h3><ul>
<li>负载均衡：有一定的高可用性  LVS Nginx</li>
<li>主备系统：有高可用性，但是需要切换，是单活的架构 KA，MHA，MMM</li>
<li>真正高可用（多活系统）：NDF Cluster，Oracle RAC，Sysvase Cluster，InnoDB Cluster（MGR），PXC，MGC</li>
</ul>
<h3 id="MySQL复制的类型"><a href="#MySQL复制的类型" class="headerlink" title="MySQL复制的类型"></a>MySQL复制的类型</h3><p>大体有4种类型：异步复制、半同步复制、延迟复制和组复制（组复制不在这章说明）</p>
<h4 id="异步复制（源复制）"><a href="#异步复制（源复制）" class="headerlink" title="异步复制（源复制）"></a>异步复制（源复制）</h4><p>是经典的主从复制，搭建主从默认的架构方式，相对与性能会好一些，但是会有丢失数据的情况。异步复制源是主要的，有一个或多个从，这些从是次要的。当发生事务的时候，主库会写入自己的BinLog，然后通过dump线程发送新binlog给从库的io线程接收，后续主库不会等待从库的确认，而是继续处理提交的操作。在默认情况下，所有服务器都有数据的完成副本。源复制异步图如下：</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210521162805583.png" alt="image-20210521162805583"></p>
<h4 id="半同步复制"><a href="#半同步复制" class="headerlink" title="半同步复制"></a>半同步复制</h4><p>半同步复制，在同步步骤过程中增加了一个协议，主服务器在提交事务时，需要等待从服务器确认接收事务，接着返回一个ACK给主服务器，然后主服务器才能进行提交。如下图半同步复制图所示</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210521163057100.png" alt="image-20210521163057100"></p>
<h4 id="延时复制"><a href="#延时复制" class="headerlink" title="延时复制"></a>延时复制</h4><p>延时复制是在异步复制的基础上，人为的设定主库和从库的数据同步延迟时间，好处是能在误删除时，能够更快的恢复数据。比如有时候手抖误删除了库、表或者其他对象，还有不加where条件更新或删除，都可以使用延迟从库再误删前的时间点停下，然后进行恢复</p>
<h3 id="主从复制的搭建前提"><a href="#主从复制的搭建前提" class="headerlink" title="主从复制的搭建前提"></a>主从复制的搭建前提</h3><ul>
<li>2个或以上的数据库实例</li>
<li>主库需要开启二进制日志</li>
<li>server_id要不同，区分不同的节点</li>
<li>主库需要建立专用的复制用户(replication slave)</li>
<li>从库应该通过备份主库，复制主从的所有信息，将数据一致</li>
<li>人为的告诉从库一些复制信息（ip、port、user、pass与二进制日志起点等）</li>
<li>从库应该开启专门的复制线程</li>
</ul>
<h2 id="主从复制搭建过程（生产）"><a href="#主从复制搭建过程（生产）" class="headerlink" title="主从复制搭建过程（生产）"></a>主从复制搭建过程（生产）</h2><h3 id="实例准备"><a href="#实例准备" class="headerlink" title="实例准备"></a>实例准备</h3><p>使用2个实例，分别是3307和3308</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ systemcdtl start mysqld3307</span><br><span class="line">$ \rm -rf /data/3308/data/*</span><br><span class="line">$ \rm -rf /data/3308/mysql-bin.*</span><br><span class="line">$ mysqld --initialize-insecure --user=mysql --basedir=/application/mysql --datadir=/data/3308/data </span><br><span class="line">$ systemctl start mysqld3308</span><br></pre></td></tr></table></figure>
<p>检查是否可用</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -S /data/3307/mysql.sock -e &#x27;select @@port&#x27;</span><br><span class="line">$ mysql -S /data/3308/mysql.sock -e &#x27;select @@port&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="编写实例配置文件"><a href="#编写实例配置文件" class="headerlink" title="编写实例配置文件"></a>编写实例配置文件</h3><p>编写3307实例my.cnf的配置</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cat /data/3307/my.cnf </span><br><span class="line"><span class="selector-attr">[mysqld]</span></span><br><span class="line">basedir=/application/mysql</span><br><span class="line">datadir=/data/3307/data</span><br><span class="line">socket=/data/3307/mysql.sock</span><br><span class="line">log_error=/data/3307/mysql.log</span><br><span class="line">port=3307</span><br><span class="line">server_id=7</span><br><span class="line">log_bin=/data/3307/mysql-bin</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[mysql]</span></span><br><span class="line">socket=/data/3307/mysql.sock</span><br></pre></td></tr></table></figure>
<p>编写3308实例my.cnf的配置</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cat /data/3308/my.cnf </span><br><span class="line"><span class="selector-attr">[mysqld]</span></span><br><span class="line">basedir=/application/mysql</span><br><span class="line">datadir=/data/3308/data</span><br><span class="line">socket=/data/3308/mysql.sock</span><br><span class="line">log_error=/data/3308/mysql.log</span><br><span class="line">port=3308</span><br><span class="line">server_id=8</span><br><span class="line">log_bin=/data/3308/mysql-bin</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[mysql]</span></span><br><span class="line">socket=/data/3308/mysql.sock</span><br></pre></td></tr></table></figure>
<h3 id="主库创建复制用户"><a href="#主库创建复制用户" class="headerlink" title="主库创建复制用户"></a>主库创建复制用户</h3><p>创建用户与查看</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -S /data/3307/mysql.sock -e &quot;grant replication slave on *.* to repl@&#x27;10.0.0.%&#x27; identified by &#x27;123456&#x27;&quot;</span><br><span class="line">$ mysql -S /data/3307/mysql.sock -e &quot;select user,host from mysql.user;&quot; </span><br></pre></td></tr></table></figure>
<h3 id="备份与导入数据"><a href="#备份与导入数据" class="headerlink" title="备份与导入数据"></a>备份与导入数据</h3><p>3307 主（全备）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysqldump -S /data/3307/mysql.sock -A --master-data=2 --single-transaction -R -E --triggers &gt;/tmp/full.sql</span><br></pre></td></tr></table></figure>
<p>3308 从（导入）</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -S /data/3308/mysql.sock </span><br><span class="line">&gt; set sql_log_bin=0;</span><br><span class="line">&gt; <span class="selector-tag">source</span> /<span class="selector-tag">tmp</span>/<span class="selector-tag">full</span><span class="selector-class">.sql</span></span><br></pre></td></tr></table></figure>
<h3 id="连接主库"><a href="#连接主库" class="headerlink" title="连接主库"></a>连接主库</h3><p>需要连接主库的参数比较多，所以可以通过help查看，而不需自己手打下面的内容</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">help</span> <span class="selector-tag">change</span> <span class="selector-tag">master</span> <span class="selector-tag">to</span>  </span><br><span class="line"><span class="selector-tag">CHANGE</span> <span class="selector-tag">MASTER</span> <span class="selector-tag">TO</span></span><br><span class="line">  MASTER_HOST=&#x27;master2.example.com&#x27;,</span><br><span class="line">  MASTER_USER=&#x27;replication&#x27;,</span><br><span class="line">  MASTER_PASSWORD=&#x27;password&#x27;,</span><br><span class="line">  MASTER_PORT=3306,</span><br><span class="line">  MASTER_LOG_FILE=&#x27;master2-bin.001&#x27;,</span><br><span class="line">  MASTER_LOG_POS=4,</span><br><span class="line">  MASTER_CONNECT_RETRY=10;</span><br></pre></td></tr></table></figure>
<p>查看备份后数据的position的起始位置</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vim /tmp/full.sql</span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=&#x27;mysql-bin.000004&#x27;, MASTER_LOG_POS=444;</span><br></pre></td></tr></table></figure>
<p>将信息编写好写入从库</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">CHANGE</span> <span class="selector-tag">MASTER</span> <span class="selector-tag">TO</span></span><br><span class="line">  MASTER_HOST=&#x27;10.0.0.50&#x27;,</span><br><span class="line">  MASTER_USER=&#x27;repl&#x27;,</span><br><span class="line">  MASTER_PASSWORD=&#x27;123456&#x27;,</span><br><span class="line">  MASTER_PORT=3307,</span><br><span class="line">  MASTER_LOG_FILE=&#x27;mysql-bin.000004&#x27;,</span><br><span class="line">  MASTER_LOG_POS=444,</span><br><span class="line">  MASTER_CONNECT_RETRY=10;</span><br></pre></td></tr></table></figure>
<p>从库start slave，连接主库，从库开启复制线程（IO_T，SQL_T）</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -S /data/3308/mysql.sock </span><br><span class="line">&gt; <span class="selector-tag">start</span> <span class="selector-tag">slave</span>;</span><br></pre></td></tr></table></figure>
<h3 id="检查主从复制状态"><a href="#检查主从复制状态" class="headerlink" title="检查主从复制状态"></a>检查主从复制状态</h3><p>IO与SQL的状态显示Yes，就代表主从复制成功</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -S /data/3308/mysql.sock -e &#x27;show slave status\G&#x27;|grep Slave</span><br><span class="line">               <span class="selector-tag">Slave_IO_State</span>: <span class="selector-tag">Waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">master</span> <span class="selector-tag">to</span> <span class="selector-tag">send</span> <span class="selector-tag">event</span></span><br><span class="line">             <span class="selector-tag">Slave_IO_Running</span>: <span class="selector-tag">Yes</span></span><br><span class="line">            <span class="selector-tag">Slave_SQL_Running</span>: <span class="selector-tag">Yes</span></span><br><span class="line">      <span class="selector-tag">Slave_SQL_Running_State</span>: <span class="selector-tag">Slave</span> <span class="selector-tag">has</span> <span class="selector-tag">read</span> <span class="selector-tag">all</span> <span class="selector-tag">relay</span> <span class="selector-tag">log</span>; <span class="selector-tag">waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">more</span> <span class="selector-tag">updates</span></span><br></pre></td></tr></table></figure>
<p>测试，在3307实例中创建一个库，然后在3308实例中查看</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -uroot -p123456 -S /data/3307/mysql.sock </span><br><span class="line"></span><br><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">database</span> <span class="selector-tag">niubi</span>;</span><br><span class="line">&gt; <span class="selector-tag">mysql</span> <span class="selector-tag">-S</span> /<span class="selector-tag">data</span>/3308/<span class="selector-tag">mysql</span><span class="selector-class">.sock</span> <span class="selector-tag">-e</span> &quot;<span class="selector-tag">show</span> <span class="selector-tag">databases</span>;&quot;</span><br><span class="line">+<span class="selector-tag">--------------------</span>+</span><br><span class="line">| Database           |</span><br><span class="line">+<span class="selector-tag">--------------------</span>+</span><br><span class="line">| mysql              |</span><br><span class="line">| niubi              |</span><br></pre></td></tr></table></figure>
<h2 id="主从复制工作原理"><a href="#主从复制工作原理" class="headerlink" title="主从复制工作原理"></a>主从复制工作原理</h2><h3 id="主从复制涉及的文件和线程"><a href="#主从复制涉及的文件和线程" class="headerlink" title="主从复制涉及的文件和线程"></a>主从复制涉及的文件和线程</h3><p><strong>主库信息</strong></p>
<ul>
<li>binlog：二进制文件</li>
<li>Binlog_Dump Thread：DUMP_T</li>
</ul>
<p><strong>从库信息</strong>：</p>
<ul>
<li><p>relaylog：中继日志；master.info：主库信息文件；relaylog.info：relaylog应用的信息</p>
</li>
<li><p>Slave_IO_Thread: IO_T</p>
</li>
<li><p>Slave_SQL_Thread: SQL_T</p>
</li>
</ul>
<h3 id="主从复制工作（过程）原理"><a href="#主从复制工作（过程）原理" class="headerlink" title="主从复制工作（过程）原理"></a>主从复制工作（过程）原理</h3><p>主从工作过程如下图所示</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210217102825911.png"></p>
<p>主从过程文字描述</p>
<ul>
<li>从库执行change master to命令（主库的连接信息+binlog的起点）</li>
<li>从库会将以上信息，记录到master.info文件中</li>
<li>从库执行start slave命令，立即开启IO_T和SQL_T</li>
<li>从库IO_T，读取mater.info文件中的信息，获取到主库IP，POST，User，Pass,binlog的位置信息</li>
<li>从库通过IO_T请求连接主库，主库专门提供一个DUMP_T线程，负责和IO_T交互</li>
<li>IO_T根据binlog的位置信息（mysql-bin.000001,111)，请求主库新binlog</li>
<li>主库通过DUMP_T将最新的binlog，通过网络TP（传输）给从库的IO_T</li>
<li>IO_T接受到新的binlog日志，存储到TCP/IP缓存，TCP/IP接受到之后立即ACK给主库，并更新master.info</li>
<li>IO_T将TCP/IP缓存中的数据，转存到磁盘relaylog文件中</li>
<li>SQL_T读取relaylog中的信息，获取到上次已经应用过的relaylog的位置信息</li>
<li>SQL_T会按照上次的位置点回放最新的relaylog，再次更新relay.info信息</li>
<li>从库会自动purge（清理）应用过relaylog，进行定期清理</li>
</ul>
<blockquote>
<p>补充说明：一旦主从复制构建成功，主库当中发生了新的变化，都会通过DUMP_T发送一个信号给IO_T，增强了主从复制的实时性</p>
</blockquote>
<h3 id="主从复制状态监控"><a href="#主从复制状态监控" class="headerlink" title="主从复制状态监控"></a>主从复制状态监控</h3><p>从库命令</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span>\<span class="selector-tag">G</span></span><br></pre></td></tr></table></figure>
<p>主库有关的信息（master.info)</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span>\<span class="selector-tag">G</span>;</span><br><span class="line"><span class="selector-tag">Master_Host</span>: 10.0.0.51</span><br><span class="line"><span class="selector-tag">Master_User</span>: <span class="selector-tag">repl</span></span><br><span class="line"><span class="selector-tag">Master_Port</span>: 3307</span><br><span class="line"><span class="selector-tag">Connect_Retry</span>: 10</span><br><span class="line">*****************************</span><br><span class="line"><span class="selector-tag">Master_Log_File</span>: <span class="selector-tag">mysql-bin</span>.000006</span><br><span class="line"><span class="selector-tag">Read_Master_Log_Pos</span>: 606</span><br><span class="line">*****************************</span><br></pre></td></tr></table></figure>
<p>从库relay应用信息相关的（relay.info)</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Relay_Log_File</span>: <span class="selector-tag">mysql-relay-bin</span>.000002</span><br><span class="line"><span class="selector-tag">Relay_Log_Pos</span>: 482</span><br><span class="line"><span class="selector-tag">Relay_Master_Log_File</span>: <span class="selector-tag">mysql-bin</span>.000006</span><br></pre></td></tr></table></figure>
<p>从库线程运行状态（排错）</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Slave_IO_Running</span>: <span class="selector-tag">Yes</span></span><br><span class="line"><span class="selector-tag">Slave_SQL_Running</span>: <span class="selector-tag">Yes</span></span><br><span class="line"><span class="selector-tag">Last_IO_Errno</span>: 0</span><br><span class="line"><span class="selector-tag">Last_IO_Error</span>: </span><br><span class="line"><span class="selector-tag">Last_SQL_Errno</span>: 0</span><br><span class="line"><span class="selector-tag">Last_SQL_Error</span>: </span><br></pre></td></tr></table></figure>
<p>过滤复制有关的信息</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Replicate_Do_DB</span>: </span><br><span class="line"><span class="selector-tag">Replicate_Ignore_DB</span>: </span><br><span class="line"><span class="selector-tag">Replicate_Do_Table</span>: </span><br><span class="line"><span class="selector-tag">Replicate_Ignore_Table</span>: </span><br><span class="line"><span class="selector-tag">Replicate_Wild_Do_Table</span>: </span><br><span class="line"><span class="selector-tag">Replicate_Wild_Ignore_Table</span>: </span><br></pre></td></tr></table></figure>
<p>从库延时主机的时间（秒）：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Seconds_Behind_Master</span>: 0</span><br></pre></td></tr></table></figure>
<p>延时从库信息：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">SQL_Delay</span>: 0</span><br><span class="line"><span class="selector-tag">SQL_Remaining_Delay</span>: <span class="selector-tag">NULL</span></span><br></pre></td></tr></table></figure>
<p>GTID复制有关的状态信息</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Retrieved_Gtid_Set</span>: </span><br><span class="line"><span class="selector-tag">Executed_Gtid_Set</span>: </span><br><span class="line"><span class="selector-tag">Auto_Position</span>: 0</span><br></pre></td></tr></table></figure>
<h2 id="主从复制故障示例"><a href="#主从复制故障示例" class="headerlink" title="主从复制故障示例"></a>主从复制故障示例</h2><h3 id="IO线程故障"><a href="#IO线程故障" class="headerlink" title="IO线程故障"></a>IO线程故障</h3><h4 id="连接主库失败：connecting"><a href="#连接主库失败：connecting" class="headerlink" title="连接主库失败：connecting"></a>连接主库失败：connecting</h4><p>原因：可以是网络、连接信息错或变更了，或是防火墙、连接数上线等</p>
<p>排查思路</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -urepl -p123 -h 10.0.0.51 -P3307  //密码错误</span><br><span class="line">//<span class="selector-tag">mysql</span>: <span class="selector-attr">[Warning]</span> <span class="selector-tag">Using</span> <span class="selector-tag">a</span> <span class="selector-tag">password</span> <span class="selector-tag">on</span> <span class="selector-tag">the</span> <span class="selector-tag">command</span> <span class="selector-tag">line</span> <span class="selector-tag">interface</span> <span class="selector-tag">can</span> <span class="selector-tag">be</span> <span class="selector-tag">insecure</span>.</span><br><span class="line">//ERROR 1045 (28000): Access denied for user &#x27;repl&#x27;@&#x27;mysql&#x27; (using password: YES)</span><br><span class="line"></span><br><span class="line">$ mysql -urep -p123456 -h 10.0.0.51 -P3307  //账号错误</span><br><span class="line">//<span class="selector-tag">mysql</span>: <span class="selector-attr">[Warning]</span> <span class="selector-tag">Using</span> <span class="selector-tag">a</span> <span class="selector-tag">password</span> <span class="selector-tag">on</span> <span class="selector-tag">the</span> <span class="selector-tag">command</span> <span class="selector-tag">line</span> <span class="selector-tag">interface</span> <span class="selector-tag">can</span> <span class="selector-tag">be</span> <span class="selector-tag">insecure</span>.</span><br><span class="line">//ERROR 1045 (28000): Access denied for user &#x27;rep&#x27;@&#x27;mysql&#x27; (using password: YES)</span><br><span class="line"></span><br><span class="line">$ mysql -urepl -p123456 -h 10.0.0.52 -P3307 //地址错误</span><br><span class="line">//<span class="selector-tag">mysql</span>: <span class="selector-attr">[Warning]</span> <span class="selector-tag">Using</span> <span class="selector-tag">a</span> <span class="selector-tag">password</span> <span class="selector-tag">on</span> <span class="selector-tag">the</span> <span class="selector-tag">command</span> <span class="selector-tag">line</span> <span class="selector-tag">interface</span> <span class="selector-tag">can</span> <span class="selector-tag">be</span> <span class="selector-tag">insecure</span>.</span><br><span class="line">//ERROR 2003 (HY000): Can&#x27;t connect to MySQL server on &#x27;10.0.0.52&#x27; (113)</span><br><span class="line"></span><br><span class="line">$ mysql -urepl -p123456 -h 10.0.0.51 -P3309  //端口错误</span><br><span class="line">//<span class="selector-tag">mysql</span>: <span class="selector-attr">[Warning]</span> <span class="selector-tag">Using</span> <span class="selector-tag">a</span> <span class="selector-tag">password</span> <span class="selector-tag">on</span> <span class="selector-tag">the</span> <span class="selector-tag">command</span> <span class="selector-tag">line</span> <span class="selector-tag">interface</span> <span class="selector-tag">can</span> <span class="selector-tag">be</span> <span class="selector-tag">insecure</span>.</span><br><span class="line">//ERROR 2003 (HY000): Can&#x27;t connect to MySQL server on &#x27;10.0.0.51&#x27; (111)</span><br></pre></td></tr></table></figure>
<p>解决办法</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. <span class="selector-tag">stop</span> <span class="selector-tag">slave</span>;        //停止从库</span><br><span class="line">2. <span class="selector-tag">reset</span> <span class="selector-tag">slave</span> <span class="selector-tag">all</span>;   //所有文件清空</span><br><span class="line">3. <span class="selector-tag">change</span> <span class="selector-tag">master</span> <span class="selector-tag">to</span>;  //重新配置参数连接</span><br><span class="line">.........参数省略.........</span><br><span class="line">4. <span class="selector-tag">start</span> <span class="selector-tag">slave</span>;</span><br><span class="line">5. <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span>;</span><br><span class="line"><span class="selector-tag">Slave_IO_Running</span>: <span class="selector-tag">Yes</span></span><br><span class="line"><span class="selector-tag">Slave_SQL_Running</span>: <span class="selector-tag">Yes</span></span><br></pre></td></tr></table></figure>
<h4 id="请求binlog-失败"><a href="#请求binlog-失败" class="headerlink" title="请求binlog(失败)"></a>请求binlog(失败)</h4><p>原因：可能是binlog没开启或binlog损坏或不存在</p>
<p>主库执行了reset master处理，这个命令会刷新一个新的binlog，从库就会崩</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">reset</span> <span class="selector-tag">master</span></span><br></pre></td></tr></table></figure>
<p>从库查看</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span>\<span class="selector-tag">G</span>;</span><br><span class="line"><span class="selector-tag">Slave_IO_Running</span>: <span class="selector-tag">No</span></span><br><span class="line"><span class="selector-tag">Slave_SQL_Running</span>: <span class="selector-tag">Yes</span></span><br></pre></td></tr></table></figure>
<p>解决办法</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. <span class="selector-tag">stop</span> <span class="selector-tag">slave</span>;</span><br><span class="line">2. <span class="selector-tag">reset</span> <span class="selector-tag">slave</span> <span class="selector-tag">all</span>;  </span><br><span class="line">3. <span class="selector-tag">change</span> <span class="selector-tag">master</span> <span class="selector-tag">to</span>;  </span><br><span class="line">.........参数省略.........</span><br><span class="line">4. <span class="selector-tag">start</span> <span class="selector-tag">slave</span>;</span><br><span class="line">5. <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span>;</span><br><span class="line"><span class="selector-tag">Slave_IO_Running</span>: <span class="selector-tag">Yes</span></span><br><span class="line"><span class="selector-tag">Slave_SQL_Running</span>: <span class="selector-tag">Yes</span></span><br></pre></td></tr></table></figure>
<h3 id="SQL线程故障"><a href="#SQL线程故障" class="headerlink" title="SQL线程故障"></a>SQL线程故障</h3><p>原因：relay-log损坏或是约束冲突（主键，唯一键，非空）</p>
<h4 id="演示SQL线程故障"><a href="#演示SQL线程故障" class="headerlink" title="演示SQL线程故障"></a>演示SQL线程故障</h4><p>在从库创建一个库</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">database</span> <span class="selector-tag">chche</span>;</span><br></pre></td></tr></table></figure>
<p>在主库又创建一个一模一样的库</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; create database chche charset=utf8mb4;</span><br></pre></td></tr></table></figure>
<p>查看从库的状态</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span>\<span class="selector-tag">G</span>;</span><br></pre></td></tr></table></figure>
<p>报错信息</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Last_SQL_Error: Error &#x27;Can&#x27;t create database &#x27;chche&#x27;; database exists&#x27; on query. Default database: &#x27;chche&#x27;. Query: &#x27;create database chche charset=utf8mb4&#x27;</span><br></pre></td></tr></table></figure>
<h5 id="解决方法1-删除库"><a href="#解决方法1-删除库" class="headerlink" title="解决方法1 删除库"></a>解决方法1 删除库</h5><p>把握一个原则，一切以主库为准进行解决，如果出现问题，尽量进行反操作，最直接稳妥办法，重新构建主从</p>
<p>删除从库创建的库，然后重启启动</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">drop</span> <span class="selector-tag">database</span> <span class="selector-tag">chche</span>;</span><br><span class="line">&gt; <span class="selector-tag">start</span> <span class="selector-tag">slave</span>;</span><br><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span>\<span class="selector-tag">G</span>;</span><br></pre></td></tr></table></figure>
<h5 id="解决方法2-跳过这个步骤"><a href="#解决方法2-跳过这个步骤" class="headerlink" title="解决方法2 跳过这个步骤"></a>解决方法2 跳过这个步骤</h5><p>将同步指针向下移动一个，如果多次不同步，可以重复操作</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">stop</span> <span class="selector-tag">slave</span>;</span><br><span class="line">&gt; set global sql_slave_skip_counter=1;</span><br><span class="line">&gt; <span class="selector-tag">start</span> <span class="selector-tag">slave</span>;</span><br></pre></td></tr></table></figure>
<h5 id="解决方法3-以后遇到这些问题直接跳过"><a href="#解决方法3-以后遇到这些问题直接跳过" class="headerlink" title="解决方法3 以后遇到这些问题直接跳过"></a>解决方法3 以后遇到这些问题直接跳过</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vi /etc/my.cnf</span><br><span class="line">slave-skip-errors = 1032,1062,1007</span><br></pre></td></tr></table></figure>
<p>创建错误代码：</p>
<ul>
<li>1007：对象已存在</li>
<li>1062：无法执行DML</li>
<li>1062：主键冲突，或约束冲突</li>
</ul>
<blockquote>
<p>PS：方法2和方法3都有风险，总之一切都已主库为主最为安全</p>
</blockquote>
<h4 id="主键冲突问题"><a href="#主键冲突问题" class="headerlink" title="主键冲突问题"></a>主键冲突问题</h4><p>主库创建主键，并插入</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">table</span> <span class="selector-tag">t1</span> (<span class="selector-tag">id</span> <span class="selector-tag">int</span> <span class="selector-tag">primary</span> <span class="selector-tag">key</span> <span class="selector-tag">not</span> <span class="selector-tag">null</span> <span class="selector-tag">auto_increment</span>);</span><br></pre></td></tr></table></figure>
<p>从库插入一行数据</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">insert</span> <span class="selector-tag">into</span> <span class="selector-tag">t1</span> <span class="selector-tag">values</span>(1);</span><br></pre></td></tr></table></figure>
<p>主库也插入一行数据</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">insert</span> <span class="selector-tag">into</span> <span class="selector-tag">t1</span> <span class="selector-tag">values</span>(7);</span><br></pre></td></tr></table></figure>
<p>解决方案</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. <span class="selector-tag">stop</span> <span class="selector-tag">slave</span>;</span><br><span class="line">2. <span class="selector-tag">reset</span> <span class="selector-tag">slave</span> <span class="selector-tag">all</span>;   </span><br><span class="line">3. <span class="selector-tag">change</span> <span class="selector-tag">master</span> <span class="selector-tag">to</span>;</span><br><span class="line">.........参数省略.........</span><br><span class="line">4. <span class="selector-tag">start</span> <span class="selector-tag">slave</span>;</span><br><span class="line">5. <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span>;</span><br><span class="line"><span class="selector-tag">Slave_IO_Running</span>: <span class="selector-tag">Yes</span></span><br><span class="line"><span class="selector-tag">Slave_SQL_Running</span>: <span class="selector-tag">Yes</span> </span><br></pre></td></tr></table></figure>
<h4 id="如何避免SQL线程故障"><a href="#如何避免SQL线程故障" class="headerlink" title="如何避免SQL线程故障"></a>如何避免SQL线程故障</h4><ul>
<li>可以设置从库只读，read_only，super_read_only</li>
<li>使用读写分离中间件atlas、mycat、ProxySQL和MacScale等</li>
</ul>
<h2 id="主从延时监控的原因"><a href="#主从延时监控的原因" class="headerlink" title="主从延时监控的原因"></a>主从延时监控的原因</h2><h3 id="主库方面原因"><a href="#主库方面原因" class="headerlink" title="主库方面原因"></a>主库方面原因</h3><ul>
<li><p>binlog写入不及时</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sync_binlog=1  # 如果设置为0，那么binlog的读写就会先写入OS buffer，等待OS buffer满之后才写入磁盘</span><br></pre></td></tr></table></figure></li>
<li><p>默认情况下dump_t是串行传输binlog</p>
<p>在并发事务量大时或者大事务，由于dump_t是串行工作，所有会导致传送日志较慢</p>
<p><code>如何解决：</code>开启GTID，使用Group commit方式，可以支持DUMP_T并行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; show variables like &#x27;%group_commit%&#x27;;</span><br></pre></td></tr></table></figure></li>
<li><p>主库极其繁忙</p>
<p>可以由于慢语句、锁等待、从库个数以及网络延时的原因导致延时</p>
</li>
</ul>
<h3 id="从库方面原因"><a href="#从库方面原因" class="headerlink" title="从库方面原因"></a>从库方面原因</h3><p>传统复制（Classic）汇总</p>
<ul>
<li><p>主库并发事务量大，或者出现大事务</p>
</li>
<li><p>由于从库是单SQL线程，导致不管传的日志有多少，只能一次执行一个事务</p>
</li>
<li><p>5.6版本，有了GTID可以实现多SQL线程，但是只能基于不同库的事务进行并发回放（database）</p>
</li>
<li><p>5.7版本，又增强的GTID，增加了seq_no，增加了新型的并发SQl线程模式（logical clock），MTS技术</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> show variables like <span class="string">&#x27;%worker%&#x27;</span>;  <span class="comment"># 调整SQL线程个数</span></span></span><br><span class="line">+------------------------+-------+</span><br><span class="line">| Variable_name          | Value |</span><br><span class="line">+------------------------+-------+</span><br><span class="line">| slave_parallel_workers | 0     |</span><br><span class="line">+------------------------+-------+</span><br></pre></td></tr></table></figure>
<ul>
<li>主从硬件差异太大</li>
<li>主从的参数配置（不一样）</li>
<li>从库和主库的索引不一致</li>
<li>版本有差异</li>
</ul>
<h3 id="主从延时的监控选项"><a href="#主从延时的监控选项" class="headerlink" title="主从延时的监控选项"></a>主从延时的监控选项</h3><p>使用命令查看延时参数</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span>\<span class="selector-tag">G</span>;</span><br><span class="line"><span class="selector-tag">Seconds_Behind_Master</span>: 0</span><br></pre></td></tr></table></figure>
<p>查看主库状态信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> show master status;</span></span><br><span class="line">mysql-bin.000001 </span><br><span class="line">Position：1808</span><br></pre></td></tr></table></figure>
<p>查看从库状态信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> show slave status\G;</span></span><br><span class="line">  Relay_Log_Pos: 1974</span><br><span class="line">  Relay_Master_Log_File: mysql-bin.000001</span><br></pre></td></tr></table></figure>
<h3 id="主库延迟问题"><a href="#主库延迟问题" class="headerlink" title="主库延迟问题"></a>主库延迟问题</h3><p>对于延迟，我们可以查看参数show slave status里面的Seconds_behind_master（SBM）的选项，但是从严格意义上是不能当做主从延迟标准的，只能仅供参考</p>
<p>SBM的逻辑是对<code>sql_thread执行event的timestamp</code>和<code>io_thread复制好event的timestamp</code>（简写ts）进行比较，得到这个时间差值</p>
<p><strong>延时的问题</strong></p>
<ul>
<li>如果Master和Slave网络不好，即IO_Thread的同步到瓶颈，而从Slave端来看，SQL_Thread能够很快的应用日志数据，SBM值却是0，这样可能会造成一个幻觉，会觉得没有延迟。但实际上因为网络条件不佳，已经产生了很大的延迟</li>
<li>当从库长时间未收到主库传来的数据，等待时间超过参数slave_net_timeout默认的3600秒之后，Slave的状态Slave_IO_Running的值会变成No，而在这个过程中，其实得到是假象数据</li>
<li>从库存在大量的查询导致处理性能降低，也会造成延迟时间，而这个延迟时间其实是属于额外的资源消耗导致</li>
<li>如果一个数据库在1分钟内产生了大量的binlog，如果按照日志中的timestamp来作为标记，这个延迟会很小。比如延迟5秒左右，但是差异的日志量是1G，这种差异带来的负面影响大的</li>
</ul>
<p>所以延迟是一个比较难衡量的指标，可以基于日志维度进行衡量（binlog的偏移量差异），或者是基于时间维度，通过时间戳差值来衡量延迟</p>
<h3 id="使用pt工具检测主从延迟"><a href="#使用pt工具检测主从延迟" class="headerlink" title="使用pt工具检测主从延迟"></a>使用pt工具检测主从延迟</h3><p>相对容易理解的延迟计算方式是基于心跳机制，周期性发送一个标志位，以这个标志位到达从库的时间为准，得到的这个值就是延迟，而pt-hearbeat可以较准确的得到延迟情况，工具使用起来也非常便捷，属于pt工具集的一部分。</p>
<p>使用pt-hearbeat，需要创建一个用户pt_check，这个统一的用户方便后续标准化管理</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; grant select,process,super,replication slave on *.* to &#x27;pt-check&#x27;@&#x27;10.0.0.%&#x27; identified by &#x27;123456&#x27;;</span><br></pre></td></tr></table></figure>
<p>然后给与用户访问test数据库的权限</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; grant all privileges on test.* to &#x27;pt-check&#x27;@&#x27;10.0.0.%&#x27;;</span><br></pre></td></tr></table></figure>
<p>在后台启动这个心跳守护进程，其中的create-table就是创建测试表，interval是间隔1分钟，最小可以是0.01秒，update是更新test库上的测试表，而replace则是更新替换表里的时间，无须考虑表里是否有数据，daemonize是后台运行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pt-heartbeat h=&#x27;10.0.0.50&#x27;,u=&#x27;pt-check&#x27;,p=&#x27;123456&#x27;,P=3306 -D test --create-table --interval=1 --update --replace --daemonize</span><br></pre></td></tr></table></figure>
<p>使用ps命令查看hearbeat进程</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ps -ef|grep heartbeat</span><br><span class="line">root       4472      1  0 00:04 ?        00:00:00 perl /usr/bin/pt-heartbeat h=10.0.0.50,u=pt-check,p=123456,P=3306 -D test --create-table --interval=1 --update --replace --daemonize</span><br></pre></td></tr></table></figure>
<p>开启了后台守护进程，如果要停止，可以使用选项stop来做，会生成一个临时文件，注意下次重新启动的话，需要清理掉这个文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pt-heartbeat h=&#x27;10.0.0.50&#x27;,u=&#x27;pt-check&#x27;,p=&#x27;123456&#x27;,P=3306 -D test --stop</span><br><span class="line"><span class="selector-tag">Successfully</span> <span class="selector-tag">created</span> <span class="selector-tag">file</span> /<span class="selector-tag">tmp</span>/<span class="selector-tag">pt-heartbeat-sentinel</span></span><br></pre></td></tr></table></figure>
<p>接下来开启monitor选项来监控主从延迟的情况，需要设置server-id</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ pt-heartbeat h=&#x27;10.0.0.50&#x27;,u=&#x27;pt-check&#x27;,p=&#x27;123456&#x27;,P=3306 -D test --table=heartbeat --monitor</span><br><span class="line">The --master-server-id option must be specified because the heartbeat table `test`.`heartbeat` uses the server_id column for --update or --check but the server&#x27;s master could not be automatically determined.</span><br><span class="line"><span class="selector-tag">Please</span> <span class="selector-tag">read</span> <span class="selector-tag">the</span> <span class="selector-tag">DESCRIPTION</span> <span class="selector-tag">section</span> <span class="selector-tag">of</span> <span class="selector-tag">the</span> <span class="selector-tag">pt-heartbeat</span> <span class="selector-tag">POD</span>.</span><br></pre></td></tr></table></figure>
<p>主库查看server-id</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">hosts</span>;</span><br><span class="line">+<span class="selector-tag">-----------</span>+<span class="selector-tag">------</span>+<span class="selector-tag">------</span>+<span class="selector-tag">-----------</span>+<span class="selector-tag">--------------------------------------</span>+</span><br><span class="line">| Server_id | Host | Port | Master_id | Slave_UUID                           |</span><br><span class="line">+<span class="selector-tag">-----------</span>+<span class="selector-tag">------</span>+<span class="selector-tag">------</span>+<span class="selector-tag">-----------</span>+<span class="selector-tag">--------------------------------------</span>+</span><br><span class="line">|        51 |      | 3306 |        50 | 7fe26529-7cd1-11eb-8185-000c298004d3 |</span><br><span class="line">+<span class="selector-tag">-----------</span>+<span class="selector-tag">------</span>+<span class="selector-tag">------</span>+<span class="selector-tag">-----------</span>+<span class="selector-tag">--------------------------------------</span>+</span><br></pre></td></tr></table></figure>
<p>使用pt-heartbeat查看延时情况</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ pt-heartbeat h=&#x27;10.0.0.50&#x27;,u=&#x27;pt-check&#x27;,p=&#x27;123456&#x27;,P=3306 -D test --monitor --master-server-id=50</span><br><span class="line">1.01<span class="selector-tag">s</span> <span class="selector-attr">[  0.02s,  0.00s,  0.00s ]</span></span><br><span class="line">2.00<span class="selector-tag">s</span> <span class="selector-attr">[  0.05s,  0.01s,  0.00s ]</span></span><br><span class="line">3.00<span class="selector-tag">s</span> <span class="selector-attr">[  0.10s,  0.02s,  0.01s ]</span></span><br><span class="line">4.00<span class="selector-tag">s</span> <span class="selector-attr">[  0.17s,  0.03s,  0.01s ]</span></span><br><span class="line">5.00<span class="selector-tag">s</span> <span class="selector-attr">[  0.25s,  0.05s,  0.02s ]</span></span><br></pre></td></tr></table></figure>
<p>可以看到目前环境的延迟，方括号里面的指标是可以使用frames来定制，比如默认是1m，5m，15m</p>
<p>如果想即查即看，可以使用check选项，这个值没有frame的时间范围</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pt-heartbeat h=&#x27;10.0.0.50&#x27;,u=&#x27;pt-check&#x27;,p=&#x27;123456&#x27;,P=3306 -D test --table=heartbeat --master-server-id=50 --check</span><br><span class="line">1.01</span><br></pre></td></tr></table></figure>
<h2 id="主从延时从库"><a href="#主从延时从库" class="headerlink" title="主从延时从库"></a>主从延时从库</h2><p><strong>SQL线程延时介绍</strong></p>
<p>SQL线程延时：数据已经写入relaylog中了，SQL线程“慢点”运行，一般企业建议3-6小时，具体看公司运维人员对于故障的反应时间（单独的一台从库）</p>
<p><strong>为什么要有延时从库</strong></p>
<p>数据库故障：</p>
<ul>
<li>物理损坏：主从复制非常擅长解决物理损坏</li>
<li>逻辑损坏：普通主从复制没办法解决逻辑损坏</li>
</ul>
<h3 id="配置延时从库命令"><a href="#配置延时从库命令" class="headerlink" title="配置延时从库命令"></a>配置延时从库命令</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">stop</span> <span class="selector-tag">slave</span>;</span><br><span class="line">&gt; CHANGE MASTER TO MASTER_DELAY = 300;</span><br><span class="line">&gt; <span class="selector-tag">start</span> <span class="selector-tag">slave</span>;</span><br><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span> \<span class="selector-tag">G</span></span><br><span class="line"><span class="selector-tag">SQL_Delay</span>: 300</span><br><span class="line"><span class="selector-tag">SQL_Remaining_Delay</span>: 293</span><br></pre></td></tr></table></figure>
<h3 id="延时从库处理的逻辑故障"><a href="#延时从库处理的逻辑故障" class="headerlink" title="延时从库处理的逻辑故障"></a>延时从库处理的逻辑故障</h3><ul>
<li><p>监控到数据库逻辑故障</p>
</li>
<li><p>停从库SQL线程，查看记录已经回的位置（截取日志起点）</p>
</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">stop</span> <span class="selector-tag">sql_thread</span>;</span><br><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span>\<span class="selector-tag">G</span>;</span><br><span class="line"><span class="selector-tag">Relay_Log_File</span>: <span class="selector-tag">db01-relay-bin</span>.000002</span><br><span class="line"><span class="selector-tag">Relay_Log_Pos</span>: 320</span><br></pre></td></tr></table></figure>
<ul>
<li>截取relaylog起点与终点</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 起点</span><br><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span>\<span class="selector-tag">G</span>;</span><br><span class="line"><span class="selector-tag">Relay_Log_File</span>: <span class="selector-tag">mysql-relay-bin</span>.000002</span><br><span class="line"><span class="selector-tag">Relay_Log_Pos</span>: 320</span><br><span class="line"></span><br><span class="line"># 终点</span><br><span class="line">&gt; show relaylog events in &#x27;mysql-relay-bin.000002&#x27;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ul>
<li>模拟SQL线程回放日志</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 从库 </span><br><span class="line">&gt; <span class="selector-tag">source</span> <span class="selector-tag">xxxx</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>恢复业务</p>
<p>1）情况1：可以使用从库代替主库工作</p>
<p>2）情况2：从库导出故障库，还远到主库中</p>
</li>
</ul>
<h3 id="故障演练"><a href="#故障演练" class="headerlink" title="故障演练"></a>故障演练</h3><p>主库创建库和表，并插入些数据</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">database</span> <span class="selector-tag">delay</span> <span class="selector-tag">charset</span> <span class="selector-tag">utf8mb4</span>;</span><br><span class="line">&gt; <span class="selector-tag">use</span> <span class="selector-tag">delay</span>;</span><br><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">table</span> <span class="selector-tag">t1</span> (<span class="selector-tag">id</span> <span class="selector-tag">int</span>);</span><br><span class="line">&gt; <span class="selector-tag">insert</span> <span class="selector-tag">into</span> <span class="selector-tag">t1</span> <span class="selector-tag">values</span>(1),(2),(3);</span><br><span class="line">&gt; <span class="selector-tag">commit</span>;</span><br></pre></td></tr></table></figure>
<p>模拟主库出故障</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">drop</span> <span class="selector-tag">database</span> <span class="selector-tag">delay</span></span><br></pre></td></tr></table></figure>
<p>从库停止从库SQL线程，记录relay的位置</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">stop</span> <span class="selector-tag">slave</span> <span class="selector-tag">sql_thread</span>;</span><br><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span> \<span class="selector-tag">G</span></span><br><span class="line"><span class="selector-tag">Relay_Log_File</span>: <span class="selector-tag">mysql-relay-bin</span>.000003</span><br><span class="line"><span class="selector-tag">Relay_Log_Pos</span>: 320</span><br></pre></td></tr></table></figure>
<p>找到relay的截取终点</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; show relaylog events in &#x27;mysql-relay-bin.000003&#x27;;</span><br><span class="line">| mysql-relay-bin.000003 | 1146 | Query          |         7 | 3521 | drop database full           </span><br></pre></td></tr></table></figure>
<p>截取relay log</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd /data/3308/data/</span><br><span class="line">$ mysqlbinlog --start-position=320 --stop-position=1146 mysql-relay-bin.000003 &gt;/tmp/full.sql</span><br></pre></td></tr></table></figure>
<p>恢复relay从库</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -uroot -p -S /data/3308/mysql.sock </span><br><span class="line">&gt; set sql_log_bin=0;</span><br><span class="line">&gt; <span class="selector-tag">source</span> /<span class="selector-tag">tmp</span>/<span class="selector-tag">full</span><span class="selector-class">.sql</span></span><br></pre></td></tr></table></figure>
<h2 id="主从过滤复制应用"><a href="#主从过滤复制应用" class="headerlink" title="主从过滤复制应用"></a>主从过滤复制应用</h2><p>主库 do是表名单，ignore是黑名单，就是设置写不写入二进制日志</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">master</span> <span class="selector-tag">status</span>;</span><br><span class="line"><span class="selector-tag">binlog_do_db</span> </span><br><span class="line"><span class="selector-tag">binlog_ignore_db</span> </span><br></pre></td></tr></table></figure>
<p>从库 指定的库、指定的表、模糊指定</p>
 <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">slave</span> <span class="selector-tag">status</span> \<span class="selector-tag">G</span></span><br><span class="line">    </span><br><span class="line">//指定的库</span><br><span class="line">Replicate_Do_DB=</span><br><span class="line">Replicate_Ignore_DB=</span><br><span class="line">   </span><br><span class="line">//指定的表</span><br><span class="line">Replicate_Do_Table=</span><br><span class="line">Replicate_Ignore_Table=</span><br><span class="line">    </span><br><span class="line">//模糊指定</span><br><span class="line"><span class="selector-tag">Replicate_Wild_Do_Table</span>: </span><br><span class="line"><span class="selector-tag">Replicate_Wild_Ignore_Table</span>: </span><br></pre></td></tr></table></figure>
<p>写入到配置文件，重启即会生效的过滤</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/my.cnf</span><br><span class="line">replicate_do_db=repl</span><br><span class="line">$ systemctl restart mysqld3308</span><br></pre></td></tr></table></figure>
<h2 id="GTID复制"><a href="#GTID复制" class="headerlink" title="GTID复制"></a>GTID复制</h2><p>从MySQL 5.6.5版本开始新增了一种基于GTID的复制方式，通过GTID保证每个主库上提交的事务在集群中有一个全局唯一的ID，这种方式加强了数据库的主备一致性、故障恢复以及容错能力</p>
<p>GTID(Global Transacition ID)是对于一个已提交事务的唯一编号，当主库上提交事务或者被从库应用时，可以定位和追踪每一个事务，通过这种就不需要手工去找偏移量的值了，而是通过<code>CHANGE MASTER TO MASTER_HOST=&#39;xxx&#39;，MASTER_AUTO_POSITION=1</code>即可方便的搭建从库，在故障修改中也可以采用<code>MASTER_AUTO_POSITION=&#39;X&#39;</code>的方式</p>
<h3 id="GTID核心参数"><a href="#GTID核心参数" class="headerlink" title="GTID核心参数"></a>GTID核心参数</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">binlog_format=row              # 这条参数可以不用加入，因为默认就是使用row格式</span><br><span class="line">gtid-mode=on                   # 启动GTID类型，否则就是普通的复制架构</span><br><span class="line">enforce-gtid-consistency=true  # 强制GTID的一致性</span><br><span class="line">log-slave-updates=1            # slave更新是否计入日志</span><br></pre></td></tr></table></figure>
<h3 id="GTID复制配置过程"><a href="#GTID复制配置过程" class="headerlink" title="GTID复制配置过程"></a>GTID复制配置过程</h3><p>*<em>1. 清理环境</em></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ pkill mysqld</span><br><span class="line">$ \rm -rf /data/mysql/data/*</span><br><span class="line">$ \rm -rf /data/binlog/*</span><br></pre></td></tr></table></figure>
<p> <strong>2. 准备配置文件</strong></p>
<table>
<thead>
<tr>
<th>主机地址</th>
<th>SERVER_ID</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.51</td>
<td>51</td>
<td>主库</td>
</tr>
<tr>
<td>10.0.0.52</td>
<td>52</td>
<td>从库</td>
</tr>
<tr>
<td>10.0.0.53</td>
<td>53</td>
<td>从库</td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 主库db01：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat &gt; /etc/my.cnf &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/application/mysql/</span><br><span class="line">datadir=/data/mysql/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=51</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">autocommit=0</span><br><span class="line">log_bin=/data/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db01 [\\d]&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从库slave1(db02)：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat &gt; /etc/my.cnf &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/application/mysql</span><br><span class="line">datadir=/data/mysql/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=52</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">autocommit=0</span><br><span class="line">log_bin=/data/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db02 [\\d]&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从库slave2(db03)：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat &gt; /etc/my.cnf &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/application/mysql</span><br><span class="line">datadir=/data/mysql/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=53</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">autocommit=0</span><br><span class="line">log_bin=/data/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db03 [\\d]&gt;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><strong>3. 初始化数据（所有）</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysqld --initialize-insecure --user=mysql --basedir=/application/mysql  --datadir=/data/mysql/data</span><br></pre></td></tr></table></figure>
<p><strong>4. 启动数据库</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /etc/init.d/mysqld start</span><br></pre></td></tr></table></figure>
<p><strong>5. 构建主从</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 51 创建一个与从库连接的用户</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> grant replication slave  on *.* to repl@<span class="string">&#x27;10.0.0.%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> 52\53 连接主库</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> change master to</span> </span><br><span class="line">master_host=&#x27;10.0.0.51&#x27;,</span><br><span class="line">master_user=&#x27;repl&#x27;,</span><br><span class="line">master_password=&#x27;123&#x27; ,</span><br><span class="line">MASTER_AUTO_POSITION=1;</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> start slave;</span></span><br></pre></td></tr></table></figure>
<h3 id="GTID复制和普通复制的区别"><a href="#GTID复制和普通复制的区别" class="headerlink" title="GTID复制和普通复制的区别"></a>GTID复制和普通复制的区别</h3><ul>
<li><p>在主从复制环境中，主库发生过的事务，在全局都是有唯一GTID记录的，更方便Failover(故障转移)</p>
</li>
<li><p>change master to的时候不在需要binlog文件名和position号，而是有MASTER_ATUO_POSITION=1即可；</p>
</li>
<li><p>在复制过程中，从库不再依赖master.info文件，而是直接读取最后一个relaylog的GTID号</p>
</li>
<li><p>mysqldump备份时，默认会将备份中包含的事务操作，以这种方式显示<code>SET @@GLOBAL.GTID_PURGED=&#39;8c49d7ec-7e78-11e8-9638-000c29ca725d:1-11&#39;;</code></p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 传统型需要复制参数</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> CHANGE MASTER TO</span></span><br><span class="line">MASTER_HOST=&#x27;10.0.0.51&#x27;,</span><br><span class="line">MASTER_USER=&#x27;repl&#x27;,</span><br><span class="line">MASTER_PASSWORD=&#x27;123&#x27;,</span><br><span class="line">MASTER_PORT=3307,</span><br><span class="line">MASTER_LOG_FILE=&#x27;mysql-bin.000001&#x27;,</span><br><span class="line">MASTER_LOG_POS=444,</span><br><span class="line">MASTER_CONNECT_RETRY=10;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 增加GTID特性需要复制的参数</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> change master to</span> </span><br><span class="line">master_host=&#x27;10.0.0.51&#x27;,</span><br><span class="line">master_user=&#x27;repl&#x27;,</span><br><span class="line">master_password=&#x27;123&#x27; ,</span><br><span class="line">MASTER_AUTO_POSITION=1;</span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure>
<h3 id="GTID的限制和解决方案"><a href="#GTID的限制和解决方案" class="headerlink" title="GTID的限制和解决方案"></a>GTID的限制和解决方案</h3><p>虽然在5.7版本GTID有加强，但还是有一些场景是受限制的。一个是create table xxx as select的模式，另外一个是临时表相关的</p>
<h4 id="create语句限制和解法"><a href="#create语句限制和解法" class="headerlink" title="create语句限制和解法"></a>create语句限制和解法</h4><p>create table xxx as select的语句，其实会被拆分为两部分：create语句和insert语句，但是想成功操作，MySQL会出现以下错误</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">table</span> <span class="selector-tag">test</span>(<span class="selector-tag">id</span> <span class="selector-tag">int</span>);</span><br><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">table</span> <span class="selector-tag">test_a</span> <span class="selector-tag">as</span> <span class="selector-tag">select</span> * <span class="selector-tag">from</span> <span class="selector-tag">test</span>;</span><br><span class="line"><span class="selector-tag">ERROR</span> 1786 (<span class="selector-tag">HY000</span>): <span class="selector-tag">Statement</span> <span class="selector-tag">violates</span> <span class="selector-tag">GTID</span> <span class="selector-tag">consistency</span>: <span class="selector-tag">CREATE</span> <span class="selector-tag">TABLE</span> ... <span class="selector-tag">SELECT</span>.</span><br></pre></td></tr></table></figure>
<p>这条语句是复制表结构、复制数据，insert部分没问题，难点在于create table的部分，如果一个表的列有100个，那么拼出语句是将会很复杂工程。由于受GTID的限制，所以上述方面不能创建，但还有另MySQL特有的用法like可以解决</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">table</span> <span class="selector-tag">test_a</span> <span class="selector-tag">like</span> <span class="selector-tag">test</span></span><br><span class="line">&gt; <span class="selector-tag">insert</span> <span class="selector-tag">into</span> <span class="selector-tag">xxxx</span> <span class="selector-tag">select</span> * <span class="selector-tag">from</span> <span class="selector-tag">test</span>;</span><br></pre></td></tr></table></figure>
<h4 id="临时表的限制和建议"><a href="#临时表的限制和建议" class="headerlink" title="临时表的限制和建议"></a>临时表的限制和建议</h4><p>使用GTID复制模式，不支持create temporary table 和 drop temporary table。但是在<code>autocommit=1</code>的情况下是可以创建临时表，Master端创建临时表不产生GTID信息，所以不会同步到Slave，但是在删除临时表的时候会产生GTID，会导致主从中断</p>
<p><strong>autocommit=0 情况会报一下错误</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">temporary</span> <span class="selector-tag">table</span> <span class="selector-tag">test_c</span>(<span class="selector-tag">id</span> <span class="selector-tag">int</span>);</span><br><span class="line"><span class="selector-tag">ERROR</span> 1787 (<span class="selector-tag">HY000</span>): <span class="selector-tag">Statement</span> <span class="selector-tag">violates</span> <span class="selector-tag">GTID</span> <span class="selector-tag">consistency</span>: <span class="selector-tag">CREATE</span> <span class="selector-tag">TEMPORARY</span> <span class="selector-tag">TABLE</span> <span class="selector-tag">and</span> <span class="selector-tag">DROP</span> <span class="selector-tag">TEMPORARY</span> <span class="selector-tag">TABLE</span> <span class="selector-tag">can</span> <span class="selector-tag">only</span> <span class="selector-tag">be</span> <span class="selector-tag">executed</span> <span class="selector-tag">outside</span> <span class="selector-tag">transactional</span> <span class="selector-tag">context</span>.  <span class="selector-tag">These</span> <span class="selector-tag">statements</span> <span class="selector-tag">are</span> <span class="selector-tag">also</span> <span class="selector-tag">not</span> <span class="selector-tag">allowed</span> <span class="selector-tag">in</span> <span class="selector-tag">a</span> <span class="selector-tag">function</span> <span class="selector-tag">or</span> <span class="selector-tag">trigger</span> <span class="selector-tag">because</span> <span class="selector-tag">functions</span> <span class="selector-tag">and</span> <span class="selector-tag">triggers</span> <span class="selector-tag">are</span> <span class="selector-tag">also</span> <span class="selector-tag">considered</span> <span class="selector-tag">to</span> <span class="selector-tag">be</span> <span class="selector-tag">multi-statement</span> <span class="selector-tag">transactions</span>.</span><br></pre></td></tr></table></figure>
<p><strong>autocommit=1 情况</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; set autocommit=1;</span><br><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">temporary</span> <span class="selector-tag">table</span> <span class="selector-tag">test_b</span>(<span class="selector-tag">id</span> <span class="selector-tag">int</span>);</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, 0 <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (0.00 <span class="selector-tag">sec</span>)</span><br></pre></td></tr></table></figure>
<h3 id="GTID的体系结构"><a href="#GTID的体系结构" class="headerlink" title="GTID的体系结构"></a>GTID的体系结构</h3><p>可以分为从变量视图、表和文件视图、操作视图等三个角度看待GITD</p>
<p><strong>变量视图</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210304105528617.png"></p>
<table>
<thead>
<tr>
<th>GTID变量</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Executed_Gtid_Set</td>
<td>在当前实例上执行过的GTID集合</td>
</tr>
<tr>
<td>gtid_purged</td>
<td>gtid_purged用于记录已经被清除了的binlog事务集合，它是gtid_executed的子集</td>
</tr>
<tr>
<td>gtid_next</td>
<td>如何产生一个GTID，通常有AUTOMATIC、ANONYMOUS和显示GTID三种取值方式</td>
</tr>
<tr>
<td>Retrieved_Gtid_Set</td>
<td>Slave会扫描最后一个relay log文件，Retrieved_Gtid_Set显示的是当前扫描所得的GTID</td>
</tr>
</tbody></table>
<p><strong>表和文件视图</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210304105929581.png"></p>
<p>根据MySQL复制原理，MySQL Server在写binlog的时候，会先写一个特殊的Binlog Event，类型为GTID_Event，指定下一个事务的GTID，然后再写事务的Binlog，主从同步时GTID Event和事务的Binlog都会传递到从库，在从库应用的Relay Log，从库执行同样的GTID写入binlog</p>
<ul>
<li><p>mysql.gtid_executed说明</p>
<p>1）5.6版本必须设置log_slave_updates，因为当Slave重启后，无法得知当前Slave已经运行到的GTID位置，而gitd_executed是一个内存值，无法持久化。</p>
<p>2）5.7版本通过mysql.gtid_executed把这个值持久化来解决，所以在5.7版本log_slave_updates是一个可选项</p>
</li>
<li><p>mysql.gtid_executed引入带来的问题，会导致里面的数据会越来越多，可以查询引入一个新的线程和参数来进行管理</p>
<p>1）线程为：thread/sql/compree_gtid_table，可以查询performance_schema.thread来查看</p>
<p>2）参数为：gtid_executed_compression_period，主要用于控制每执行多少个事物，对表gtid_executed进行压缩，默认值为1000</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> select @@gtid_executed_compression_period;</span></span><br><span class="line">+------------------------------------+</span><br><span class="line">| @@gtid_executed_compression_period |</span><br><span class="line">+------------------------------------+</span><br><span class="line">|                               1000 |</span><br><span class="line">+------------------------------------+</span><br></pre></td></tr></table></figure>
<p><strong>操作视图</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210304113156547.png"></p>
<p>对于操作视图，主要是用来搭建主从复制关系所用。基本都是一次开启，长期生效的方式，如果是修复主从复制中的异常，如果是确认错误可以跳过的情况下，可以使用一下方法</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">stop</span> <span class="selector-tag">slave</span>;</span><br><span class="line">&gt; set gtid_next=&#x27;xxxxxxx&#x27;;   # 指定下一个事务执行的版本，即跳过的GTID</span><br><span class="line">&gt; <span class="selector-tag">beign</span>;</span><br><span class="line">&gt; <span class="selector-tag">commit</span>;                    # 注入一个空事务</span><br><span class="line">&gt; set gtid_next=&#x27;AUTOMATIC&#x27;  # 自动的寻找GTID事务</span><br><span class="line">&gt; <span class="selector-tag">start</span> <span class="selector-tag">slave</span>;               # 开始同步</span><br></pre></td></tr></table></figure>
<h3 id="GTID修复复制问题"><a href="#GTID修复复制问题" class="headerlink" title="GTID修复复制问题"></a>GTID修复复制问题</h3><p>上述可以解决了GTID跳过错误的方法，前提是这个错误是可以忽略的。但是如果MySQL宕机、MySQL掉电、MySQL主从偏移量差距大，想要修复主从关系，明显上述的方法是不能解决的，所以可以有以下方法解决，一切以主库为主</p>
<p>主库操作步骤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 重置binlog日志</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> reset master;</span>       </span><br></pre></td></tr></table></figure>
<p>从库操作步骤</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">stop</span> <span class="selector-tag">slave</span>;</span><br><span class="line">&gt; <span class="selector-tag">reset</span> <span class="selector-tag">slave</span> <span class="selector-tag">all</span>;</span><br><span class="line">&gt; <span class="selector-tag">change</span> <span class="selector-tag">master</span> <span class="selector-tag">to</span> </span><br><span class="line">  master_host=&#x27;10.0.0.51&#x27;,</span><br><span class="line">  master_user=&#x27;repl&#x27;,</span><br><span class="line">  master_password=&#x27;123&#x27; ,</span><br><span class="line">  MASTER_AUTO_POSITION=1;</span><br><span class="line">&gt; <span class="selector-tag">start</span> <span class="selector-tag">slave</span>;</span><br></pre></td></tr></table></figure>
<h3 id="GTID不规范的使用场景"><a href="#GTID不规范的使用场景" class="headerlink" title="GTID不规范的使用场景"></a>GTID不规范的使用场景</h3><p><strong>从库可写</strong></p>
<ul>
<li>如果是从库端写入了数据，GTID_Set就包含两个源，在使用可能导致混淆，比较规范的方法是对从库只有只读模式。</li>
</ul>
<p><strong>Purge binlog</strong></p>
<ul>
<li>主库端对于binary log的保留时间过短，同时主从网络由延时问题，都可能导致要应用GTID事务已经在主库被清理</li>
</ul>
<p><strong>复制模式为MASTER_AUTO_POSITION=0</strong></p>
<ul>
<li>如果开启了GTID，还是监视使用GTID协议的数据复制方式，如果依赖偏移量方式，在主从切换很容易出问题</li>
</ul>
<ul>
<li>在一些特殊的数据修复，使用<code>change master to xxx,master_auto_position=0;</code>配置时，语句不带<code>relay_log_file</code>和<code>relay_log_pos</code>选项都会导致relay log被清理，所以一组相对完整的语句为：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">change</span> <span class="selector-tag">master</span> <span class="selector-tag">to</span> </span><br><span class="line">master_user=[Master_user],</span><br><span class="line">master_port= [Master_port],</span><br><span class="line">master_host=[Master_Host],</span><br><span class="line">master_log_file=[Relay_Master_Log_File],</span><br><span class="line">master_log_pos=[Exec_Master_Log_Pos],</span><br><span class="line">relay_log_file=[Relay_Log_File],</span><br><span class="line">relay_log_pos=[Relay_Log_Pos],</span><br><span class="line">master_auto_position=0;</span><br></pre></td></tr></table></figure>
<p><strong>mysqldump导出导入导致从库混乱</strong></p>
<p>mysqldump会默认开启set-gtid-purged选项，在导出的dump文件中会包含set@@gtid_purge=xxx的语句。如果在跨服务器环境导入数据，可能会导致操作失误而直接对主库做了reset master操作</p>
<h2 id="半同步复制-1"><a href="#半同步复制-1" class="headerlink" title="半同步复制"></a>半同步复制</h2><p>开启半同步复制，需要安装插件，基本的要求是在满足异步复制的情况下。版本在5.5以上，并且设置变量<code>have_dynamic_loading为YES</code>，即判断是否支持动态插件</p>
<h3 id="安装主从半同步插件"><a href="#安装主从半同步插件" class="headerlink" title="安装主从半同步插件"></a>安装主从半同步插件</h3><p>主从都安装</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 主安装</span><br><span class="line">&gt; install plugin rpl_semi_sync_master soname &#x27;semisync_slave.so&#x27;;</span><br><span class="line"></span><br><span class="line"># 从安装</span><br><span class="line">&gt; install plugin rpl_semi_sync_slave soname &#x27;semisync_slave.so&#x27;;</span><br></pre></td></tr></table></figure>
<p>通过mysql.plugin选项查看是否安装</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">show</span> <span class="selector-tag">plugins</span>;                @查看所有插件</span><br><span class="line">&gt; select * from mysql.plugin;</span><br><span class="line">+<span class="selector-tag">----------------------</span>+<span class="selector-tag">--------------------</span>+</span><br><span class="line">| name                 | dl                 |</span><br><span class="line">+<span class="selector-tag">----------------------</span>+<span class="selector-tag">--------------------</span>+</span><br><span class="line">| rpl_semi_sync_master | semisync_master.so |</span><br><span class="line">+<span class="selector-tag">----------------------</span>+<span class="selector-tag">--------------------</span>+</span><br></pre></td></tr></table></figure>
<p>当然默认半同步的开关还没有打开</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; show variables like &#x27;rpl_semi_sync_master%&#x27;;</span><br><span class="line">+<span class="selector-tag">-------------------------------------------</span>+<span class="selector-tag">------------</span>+</span><br><span class="line">| Variable_name                             | Value      |</span><br><span class="line">+<span class="selector-tag">-------------------------------------------</span>+<span class="selector-tag">------------</span>+</span><br><span class="line">| rpl_semi_sync_master_enabled              | OFF        |</span><br><span class="line">| rpl_semi_sync_master_timeout              | 10000      |</span><br><span class="line">| rpl_semi_sync_master_trace_level          | 32         |</span><br><span class="line">| rpl_semi_sync_master_wait_for_slave_count | 1          |</span><br><span class="line">| rpl_semi_sync_master_wait_no_slave        | ON         |</span><br><span class="line">| rpl_semi_sync_master_wait_point           | AFTER_SYNC |</span><br><span class="line">+<span class="selector-tag">-------------------------------------------</span>+<span class="selector-tag">------------</span>+</span><br></pre></td></tr></table></figure>
<p>需要开启参数<code>rpl_semi_sync_master_enabled</code>和<code>rpl_semi_sync_slave_enabled</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 主开启</span><br><span class="line">&gt; set global rpl_semi_sync_master_enabled=1;</span><br><span class="line"></span><br><span class="line"># 从开启</span><br><span class="line">&gt; set global rpl_semi_sync_slave_enabled=1;</span><br></pre></td></tr></table></figure>
<p>在slave端需要做同样的操作，然后在slave端重启IO_Thread即可</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">stop</span> <span class="selector-tag">slave</span> <span class="selector-tag">io_thread</span>;</span><br><span class="line">&gt; <span class="selector-tag">start</span> <span class="selector-tag">slave</span> <span class="selector-tag">io_thread</span>;</span><br></pre></td></tr></table></figure>
<p>Master端与Slave端检查</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 主查看</span><br><span class="line">&gt; show status like &#x27;rpl_semi_sync_slave_status&#x27;;</span><br><span class="line">+<span class="selector-tag">----------------------------</span>+<span class="selector-tag">-------</span>+</span><br><span class="line">| Variable_name              | Value |</span><br><span class="line">+<span class="selector-tag">----------------------------</span>+<span class="selector-tag">-------</span>+</span><br><span class="line">| Rpl_semi_sync_slave_status | ON    |</span><br><span class="line">+<span class="selector-tag">----------------------------</span>+<span class="selector-tag">-------</span>+</span><br><span class="line"></span><br><span class="line"># 从查看</span><br><span class="line">&gt; show status like &#x27;rpl_semi_sync_master_status&#x27;;</span><br><span class="line">+<span class="selector-tag">-----------------------------</span>+<span class="selector-tag">-------</span>+</span><br><span class="line">| Variable_name               | Value |</span><br><span class="line">+<span class="selector-tag">-----------------------------</span>+<span class="selector-tag">-------</span>+</span><br><span class="line">| Rpl_semi_sync_master_status | ON    |</span><br><span class="line">+<span class="selector-tag">-----------------------------</span>+<span class="selector-tag">-------</span>+</span><br></pre></td></tr></table></figure>
<h3 id="半同步复制在MySQL-5-6和5-7的变化"><a href="#半同步复制在MySQL-5-6和5-7的变化" class="headerlink" title="半同步复制在MySQL 5.6和5.7的变化"></a>半同步复制在MySQL 5.6和5.7的变化</h3><p>MySQL 5.7版本中新增了一个参数（AFTER_SYNC）来控制半同步模式下主库在返回给会话事务成功之前提交事务的方式</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; show variables like &#x27;rpl_semi_sync_master_wait_point&#x27;;</span><br><span class="line">+<span class="selector-tag">---------------------------------</span>+<span class="selector-tag">------------</span>+</span><br><span class="line">| Variable_name                   | Value      |</span><br><span class="line">+<span class="selector-tag">---------------------------------</span>+<span class="selector-tag">------------</span>+</span><br><span class="line">| rpl_semi_sync_master_wait_point | AFTER_SYNC |</span><br><span class="line">+<span class="selector-tag">---------------------------------</span>+<span class="selector-tag">------------</span>+</span><br></pre></td></tr></table></figure>
<p>而在MySQL 5.6版本中设置的参数是AFTER_COMMIT</p>
<p>两个版本中的两个参数，AFTER_COMMIT模式可以理解是，当你购物时收到快递，很少人会去点击<strong>确认收货</strong>，而是过一段时间后才<strong>已收货</strong>。这个收货动作就像半同步里面的IO_Thread，通常是异步，会有延时。而AFTER_SYNC模式，则是收到快递之后，立马收到一条信息，显示快递状态<strong>已收货</strong></p>
<p>Master的数据写入了Binlog，Slave刷新到磁盘（relay log），同时Maser需要等待Slave反馈收到Relay Log，只有收到ACK后Master才将COMMIT OK结果返回给客户端，MySQL 5.7版本中的半同步复制，有个叫法是Loss-Less(无损)半同步复制。实现的方式有了一些差别，事务在提交之前发送给Slave，当Slave没有接收完成，并且如果发生Master宕机的事件，不会导致主从不一致，因为此时Master端还没有提交，所以主从都没有数据，这样就能够满足数据完成性和一致性</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img1/image-20210303163726830.png"></p>
<p><strong>步骤过程</strong></p>
<ul>
<li>主库执行新的事务，commit时，更新show master status\G，触发一个信号给</li>
<li>binlog dump thread接收到主库的show master status\G信息，通知从库日志更新了</li>
<li>从库IO线程请求新的二进制日志事件</li>
<li>主库会通过dump_T线程传送新的日志事件给从库IO线程</li>
<li>从库IO线程接收到binlog日志，将日志写入到磁盘上的relaylog文件时，给主库返回一个ACK</li>
<li>接受ACK后，触发主库可以commit提交</li>
<li>如果ACK达到了我们预设值的超时时间，半同步复制会切换为原始的异步复制.</li>
</ul>
<h3 id="测试半同步复制"><a href="#测试半同步复制" class="headerlink" title="测试半同步复制"></a>测试半同步复制</h3><p>创建一个库，做个小测试</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">database</span> <span class="selector-tag">test_sync</span> <span class="selector-tag">charset</span> <span class="selector-tag">utf8mb4</span>;</span><br></pre></td></tr></table></figure>
<p>创建一个表，插入数据，这个时候的执行速度是很快的</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">create</span> <span class="selector-tag">table</span> <span class="selector-tag">test_sync</span><span class="selector-class">.test</span>(<span class="selector-tag">id</span> <span class="selector-tag">int</span>);</span><br><span class="line">&gt; <span class="selector-tag">insert</span> <span class="selector-tag">into</span> <span class="selector-tag">test_sync</span><span class="selector-class">.test</span> <span class="selector-tag">values</span>(100);</span><br></pre></td></tr></table></figure>
<p>模拟网络延迟的情况，将Slave停止</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">stop</span> <span class="selector-tag">slave</span>;</span><br></pre></td></tr></table></figure>
<p>在回主库插入一行数据，这个时候插入数据会很慢，过程大概是10秒左右</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">insert</span> <span class="selector-tag">into</span> <span class="selector-tag">test_sync</span><span class="selector-class">.test</span> <span class="selector-tag">values</span>(101);</span><br></pre></td></tr></table></figure>
<p>10秒的等待是与半同步复制的参数有关，单位是毫秒</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> show variables like <span class="string">&#x27;rpl_semi_sync_master_timeout&#x27;</span>;</span></span><br><span class="line">+------------------------------+-------+</span><br><span class="line">| Variable_name                | Value |</span><br><span class="line">+------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_master_timeout | 10000 |</span><br><span class="line">+------------------------------+-------+</span><br></pre></td></tr></table></figure>
<p>再将半同步复制的开关打开，接着插入一行数据，插入的速度就会恢复</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">start</span> <span class="selector-tag">slave</span></span><br><span class="line">&gt; <span class="selector-tag">insert</span> <span class="selector-tag">into</span> <span class="selector-tag">test_sync</span><span class="selector-class">.test</span> <span class="selector-tag">values</span>(102);</span><br></pre></td></tr></table></figure>
<p>查看数据库信息，也可以看到明确的信息</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ vi mysql.log</span><br><span class="line">/<span class="selector-tag">Time</span></span><br><span class="line">2021<span class="selector-tag">-03-03T07</span><span class="selector-pseudo">:15</span><span class="selector-pseudo">:26.185567Z</span> 6 <span class="selector-attr">[Note]</span> <span class="selector-tag">Stop</span> <span class="selector-tag">asynchronous</span> <span class="selector-tag">binlog_dump</span> <span class="selector-tag">to</span> <span class="selector-tag">slave</span> (<span class="selector-tag">server_id</span>: 8)</span><br><span class="line">2021<span class="selector-tag">-03-03T07</span><span class="selector-pseudo">:45</span><span class="selector-pseudo">:00.136252Z</span> 0 <span class="selector-attr">[ERROR]</span> /<span class="selector-tag">application</span>/<span class="selector-tag">mysql</span>/<span class="selector-tag">bin</span>/<span class="selector-tag">mysqld</span>: <span class="selector-tag">Got</span> <span class="selector-tag">an</span> <span class="selector-tag">error</span> <span class="selector-tag">reading</span> <span class="selector-tag">communication</span> <span class="selector-tag">packets</span></span><br><span class="line">2021<span class="selector-tag">-03-03T07</span><span class="selector-pseudo">:45</span><span class="selector-pseudo">:20.478797Z</span> 5 <span class="selector-attr">[Warning]</span> <span class="selector-tag">Timeout</span> <span class="selector-tag">waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">reply</span> <span class="selector-tag">of</span> <span class="selector-tag">binlog</span> (<span class="selector-tag">file</span>: <span class="selector-tag">mysql-bin</span>.000001, <span class="selector-tag">pos</span>: 1321), <span class="selector-tag">s</span></span><br><span class="line"><span class="selector-tag">emi-sync</span> <span class="selector-tag">up</span> <span class="selector-tag">to</span> <span class="selector-tag">file</span> <span class="selector-tag">mysql-bin</span>.000001, <span class="selector-tag">position</span> 1065.</span><br><span class="line">2021<span class="selector-tag">-03-03T07</span><span class="selector-pseudo">:45</span><span class="selector-pseudo">:20.478829Z</span> 5 <span class="selector-attr">[Note]</span> <span class="selector-tag">Semi-sync</span> <span class="selector-tag">replication</span> <span class="selector-tag">switched</span> <span class="selector-tag">OFF</span>.</span><br><span class="line">2021<span class="selector-tag">-03-03T07</span><span class="selector-pseudo">:45</span><span class="selector-pseudo">:40.479547Z</span> 7 <span class="selector-attr">[Note]</span> <span class="selector-tag">Stop</span> <span class="selector-tag">semi-sync</span> <span class="selector-tag">binlog_dump</span> <span class="selector-tag">to</span> <span class="selector-tag">slave</span> (<span class="selector-tag">server_id</span>: 8)</span><br><span class="line">2021-03-03T07:45:40.479769Z 7 [Note] Aborted connection 7 to db: &#x27;unconnected&#x27; user: &#x27;repl&#x27; host: &#x27;mysql&#x27; (failed</span><br><span class="line"><span class="selector-tag">on</span> <span class="selector-tag">flush_net</span>())</span><br><span class="line">2021<span class="selector-tag">-03-03T07</span><span class="selector-pseudo">:46</span><span class="selector-pseudo">:30.185377Z</span> 8 <span class="selector-attr">[Note]</span> <span class="selector-tag">Start</span> <span class="selector-tag">binlog_dump</span> <span class="selector-tag">to</span> <span class="selector-tag">master_thread_id</span>(8) <span class="selector-tag">slave_server</span>(8), <span class="selector-tag">pos</span>(<span class="selector-tag">mysql-bin</span>.00000</span><br><span class="line">1, 1065)</span><br><span class="line">2021<span class="selector-tag">-03-03T07</span><span class="selector-pseudo">:46</span><span class="selector-pseudo">:30.185614Z</span> 8 <span class="selector-attr">[Note]</span> <span class="selector-tag">Start</span> <span class="selector-tag">semi-sync</span> <span class="selector-tag">binlog_dump</span> <span class="selector-tag">to</span> <span class="selector-tag">slave</span> (<span class="selector-tag">server_id</span>: 8), <span class="selector-tag">pos</span>(<span class="selector-tag">mysql-bin</span>.000001, 10</span><br><span class="line">65)</span><br><span class="line">2021<span class="selector-tag">-03-03T07</span><span class="selector-pseudo">:46</span><span class="selector-pseudo">:30.196521Z</span> 0 <span class="selector-attr">[Note]</span> <span class="selector-tag">Semi-sync</span> <span class="selector-tag">replication</span> <span class="selector-tag">switched</span> <span class="selector-tag">ON</span> <span class="selector-tag">at</span> (<span class="selector-tag">mysql-bin</span>.000001, 1321)</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Inaction</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://myboke.ink/2021/05/16/MySQL主从复制-8/">https://myboke.ink/2021/05/16/MySQL主从复制-8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/08/09/MySQL-MHA%E9%AB%98%E5%8F%AF%E7%94%A8-9/"><i class="fa fa-chevron-left">  </i><span>MySQL高可用InnoDB Cluster-10</span></a></div><div class="next-post pull-right"><a href="/2021/05/16/MySQL%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D-7/"><span>MySQL备份恢复-7</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '6cea6a646bff1a0d5f5b',
  clientSecret: '6e9ef08f31f505d416bc0afe2d304808e9063627',
  repo: 'zsjmal2316.github.io',
  owner: 'zsjmal2316',
  admin: 'zsjmal2316',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(img/wuwei.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2021 By Inaction</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">粤ICP备20067869号</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="120" alpha="0.3" zIndex="-1" data-click="false"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>