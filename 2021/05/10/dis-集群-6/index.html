<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Redis集群-6"><meta name="keywords" content="Redis"><meta name="author" content="Inaction"><meta name="copyright" content="Inaction"><title>Redis集群-6 | Inaction's Blog</title><link rel="shortcut icon" href="/imdadul-hussain-u_oLPS_ZYSc-unsplash.jpg"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?12b421fdad87d1edf2305ccb7229d2c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'G-8RMJ1F8ETC', 'auto');
ga('send', 'pageview');</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.3.0'
} </script><meta name="generator" content="Hexo 5.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E9%9B%86%E7%BE%A4"><span class="toc-number">1.</span> <span class="toc-text">Redis集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E5%8D%95%E7%82%B9%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.</span> <span class="toc-text">Redis单点存在的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E7%82%B9%E6%95%85%E9%9A%9C%E8%A7%A3%E5%86%B3"><span class="toc-number">1.1.1.</span> <span class="toc-text">单点故障解决</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.</span> <span class="toc-text">Redis一致性问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.2.1.</span> <span class="toc-text">强一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%83%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.2.2.</span> <span class="toc-text">较强一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.2.3.</span> <span class="toc-text">最终一致性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E4%B8%BB%E5%8D%95%E7%82%B9%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.</span> <span class="toc-text">Redis主单点的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFCAP%E5%8E%9F%E5%88%99"><span class="toc-number">1.4.</span> <span class="toc-text">什么是CAP原则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">1.5.</span> <span class="toc-text">Redis主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5"><span class="toc-number">1.5.1.</span> <span class="toc-text">增量同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E7%85%A7%E5%90%8C%E6%AD%A5"><span class="toc-number">1.5.2.</span> <span class="toc-text">快照同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E7%9B%98%E5%A4%8D%E5%88%B6"><span class="toc-number">1.5.3.</span> <span class="toc-text">无盘复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8F%82%E6%95%B0"><span class="toc-number">1.5.4.</span> <span class="toc-text">主从配置文件参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wait%E6%8C%87%E4%BB%A4"><span class="toc-number">1.5.5.</span> <span class="toc-text">wait指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.5.6.</span> <span class="toc-text">主从示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E5%A4%8D%E5%88%B6"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">建立复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E5%A4%8D%E5%88%B6"><span class="toc-number">1.5.6.2.</span> <span class="toc-text">关闭复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E5%A4%8D%E5%88%B6"><span class="toc-number">1.5.6.3.</span> <span class="toc-text">增量复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6%EF%BC%88AOF%EF%BC%89"><span class="toc-number">1.5.6.4.</span> <span class="toc-text">全量复制（AOF）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel%EF%BC%88%E5%93%A8%E5%85%B5%EF%BC%89"><span class="toc-number">1.6.</span> <span class="toc-text">Sentinel（哨兵）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinel%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="toc-number">1.6.1.</span> <span class="toc-text">Sentinel主要功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinel%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8F%82%E6%95%B0"><span class="toc-number">1.6.2.</span> <span class="toc-text">Sentinel配置文件参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinel%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">1.6.3.</span> <span class="toc-text">Sentinel集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%BB%8E%E5%85%B3%E7%B3%BB"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">配置主从关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEsentinel%E8%8A%82%E7%82%B9"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">配置sentinel节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bsentinel%E4%BF%A1%E6%81%AF"><span class="toc-number">1.6.3.3.</span> <span class="toc-text">查看sentinel信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinel%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">1.6.4.</span> <span class="toc-text">Sentinel故障转移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinel%E9%85%8D%E7%BD%AE%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">1.6.5.</span> <span class="toc-text">Sentinel配置优先级</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E9%9B%86%E7%BE%A4%E5%88%86%E7%89%87%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.7.</span> <span class="toc-text">Redis集群分片模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#client%E4%B8%9A%E5%8A%A1%E6%8B%86%E4%BB%BD"><span class="toc-number">1.7.1.</span> <span class="toc-text">client业务拆份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#client%E7%9A%84hash-%E5%8F%96%E6%A8%A1%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95"><span class="toc-number">1.7.2.</span> <span class="toc-text">client的hash+取模分片算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#client%E7%9A%84random%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95"><span class="toc-number">1.7.3.</span> <span class="toc-text">client的random分片算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#client%E7%9A%84ketama%E7%AE%97%E6%B3%95%EF%BC%88%E4%B8%80%E8%87%B4%E6%80%A7hash%EF%BC%89"><span class="toc-number">1.7.4.</span> <span class="toc-text">client的ketama算法（一致性hash）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%80%E8%87%B4%E6%80%A7hash"><span class="toc-number">1.7.4.1.</span> <span class="toc-text">什么是一致性hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7hash%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">1.7.4.2.</span> <span class="toc-text">一致性hash的原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.7.4.3.</span> <span class="toc-text">小结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E9%9B%86%E7%BE%A4%E5%88%86%E7%89%87%E4%BD%BF%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="toc-number">1.8.</span> <span class="toc-text">Redis集群分片使用的工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#twemproxy%E5%88%86%E7%89%87"><span class="toc-number">1.8.1.</span> <span class="toc-text">twemproxy分片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#twemporxy%E7%89%B9%E6%80%A7%E4%B8%8E%E7%BC%BA%E7%82%B9"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">twemporxy特性与缺点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#twemproxy%E9%9B%B6%E6%8B%B7%E8%B4%9D"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">twemproxy零拷贝</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#twemproxy%E7%9A%84%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">1.8.1.3.</span> <span class="toc-text">twemproxy的配置说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#twemproxy%E5%88%86%E9%85%8D%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.1.4.</span> <span class="toc-text">twemproxy分配过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-Cluster"><span class="toc-number">1.8.2.</span> <span class="toc-text">Redis Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-Cluster%E5%88%86%E9%85%8D%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">Redis Cluster分配过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-Cluster%E7%9A%84%E6%95%B0%E6%8D%AE%E5%88%86%E6%A7%BD"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">Redis Cluster的数据分槽</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#predixy%E5%88%86%E7%89%87"><span class="toc-number">1.8.3.</span> <span class="toc-text">predixy分片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#predixy%E4%B8%8E%E5%85%B6%E4%BB%96%E5%B7%A5%E5%85%B7%E7%9A%84%E5%8A%9F%E8%83%BD%E5%AF%B9%E6%AF%94"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">predixy与其他工具的功能对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#predixy%E7%9A%84%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">predixy的配置说明</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E9%9B%86%E7%BE%A4%E5%88%86%E7%89%87%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.9.</span> <span class="toc-text">Redis集群分片实例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#twemproxy%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.9.1.</span> <span class="toc-text">twemproxy实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">编译安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%8C%E5%90%AF%E5%8A%A8%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">编写配置文件，启动实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-Cluster%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.9.2.</span> <span class="toc-text">Redis Cluster实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BAredis-cluster"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">手动搭建redis cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%84%9A%E6%9C%AC%E5%90%AF%E5%81%9C"><span class="toc-number">1.9.2.1.1.</span> <span class="toc-text">通过脚本启停</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E9%83%A8%E7%BD%B2"><span class="toc-number">1.9.2.1.2.</span> <span class="toc-text">集群搭建部署</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%AF%8F%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84%E5%A4%8D%E5%88%B6%E5%85%B3%E7%B3%BB"><span class="toc-number">1.9.2.1.3.</span> <span class="toc-text">创建每个节点的复制关系</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#redis-cluster-%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">1.9.2.1.4.</span> <span class="toc-text">redis cluster 故障转移</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis%E8%84%9A%E6%9C%AC%E9%83%A8%E7%BD%B2redis-cluster"><span class="toc-number">1.9.2.2.</span> <span class="toc-text">redis脚本部署redis cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4%E5%AE%9E%E4%BE%8B%E5%92%8C%E5%88%86%E6%A7%BD"><span class="toc-number">1.9.2.2.1.</span> <span class="toc-text">自动创建集群实例和分槽</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E4%B8%8E%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.9.2.2.2.</span> <span class="toc-text">路由与事务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9D%80-%E7%AB%AF%E5%8F%A3%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="toc-number">1.9.2.2.3.</span> <span class="toc-text">指定地址&#x2F;端口创建集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A7%BD%E4%BD%8D%E8%BF%81%E7%A7%BB%E4%B8%8E%E5%A2%9E%E5%88%A0%E6%9F%A5cluster%E4%BF%A1%E6%81%AF"><span class="toc-number">1.9.2.2.4.</span> <span class="toc-text">槽位迁移与增删查cluster信息</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-cluster%E9%80%9A%E8%AE%AF%E8%BF%87%E7%A8%8B"><span class="toc-number">1.9.2.3.</span> <span class="toc-text">redis cluster通讯过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-cluster-ASK%E8%B7%AF%E7%94%B1%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.9.2.4.</span> <span class="toc-text">redis cluster ASK路由介绍</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#predixy%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.9.3.</span> <span class="toc-text">predixy实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDpredixy%E5%8C%85"><span class="toc-number">1.9.3.1.</span> <span class="toc-text">下载predixy包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%8C%E5%90%AF%E5%8A%A8%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.9.3.2.</span> <span class="toc-text">编辑配置文件，启动实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87Tag%E7%9A%84%E6%96%B9%E5%BC%8F%E5%88%86%E9%85%8D%E6%95%B0%E6%8D%AE"><span class="toc-number">1.9.3.3.</span> <span class="toc-text">通过Tag的方式分配数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#predixy%E6%94%AF%E6%8C%81%E5%8D%95%E7%BB%84redis%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.9.3.4.</span> <span class="toc-text">predixy支持单组redis事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#predixy%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">1.9.3.5.</span> <span class="toc-text">predixy故障转移</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA"><span class="toc-number">1.10.</span> <span class="toc-text">Redis数据导入导出</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E5%88%86%E6%9E%90%E9%94%AE%E5%80%BC%E5%A4%A7%E5%B0%8F"><span class="toc-number">1.11.</span> <span class="toc-text">Redis分析键值大小</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E4%BD%9C%E4%B8%BA%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.12.</span> <span class="toc-text">Redis作为缓存的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BB%E7%A9%BF"><span class="toc-number">1.12.1.</span> <span class="toc-text">击穿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BF%E9%80%8F"><span class="toc-number">1.12.2.</span> <span class="toc-text">穿透</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%AA%E5%B4%A9"><span class="toc-number">1.12.3.</span> <span class="toc-text">雪崩</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">1.13.</span> <span class="toc-text">redis分布式锁</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/imdadul-hussain-u_oLPS_ZYSc-unsplash.jpg"></div><div class="author-info__name text-center">Inaction</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">50</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">19</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">13</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friend Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://www.ji4n.cn/">Jen</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(img/beijing2.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Inaction's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">Redis集群-6</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-10</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/">Linux</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/Redis/">Redis</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="Redis集群"><a href="#Redis集群" class="headerlink" title="Redis集群"></a>Redis集群</h1><h2 id="Redis单点存在的问题"><a href="#Redis单点存在的问题" class="headerlink" title="Redis单点存在的问题"></a>Redis单点存在的问题</h2><p>redis不仅可以做缓存，也可以做数据库，如果redis是单点会照成哪些问题呢？</p>
<ul>
<li>单点故障（节点宕了就得停止对线上提供服务，恢复时间慢）</li>
<li>容量有限（通过增加多个节点来分担缓存数据）</li>
<li>访问压力（redis的连接数是有限的，通过增加多个节点分担访问压力）</li>
</ul>
<blockquote>
<p>注意：主备与主从是两种不同的概念</p>
<ul>
<li>主备：客户端只能访问主，备节点只能等主宕机之后，变成主后才能进行访问（期间备节点只能充当备份）</li>
<li>主从：客户端两个都能访问，主节点可以对用户提供增删改，从节点可以对用户提供查询（分工合作）</li>
</ul>
</blockquote>
<h3 id="单点故障解决"><a href="#单点故障解决" class="headerlink" title="单点故障解决"></a>单点故障解决</h3><p>单点故障，我们可以通过AKF（X-Y-Z）的原则，AKF也可以说是微服务4个原则之中的一个，但并不仅限于微服务，对于数据库和redis都可以使用AKF原则</p>
<ul>
<li>X轴：做redis的主备，主做增删改，从只做读，解决单点问题和容量的问题（数据是全量、镜像的），也就是下图的X轴</li>
<li>Y轴：按功能业务存储不同的业务，一个redis变成多个实例，相当于MySQL的分库，还能做实例的备份，也就是下图的Y轴</li>
<li>Z轴： 解决单业务的数据增长问题，使用分片的模式，通过哈希、取模等方式进行分片。例如：用户信息、订单信息、商品信息等等数据量大的业务，也就是下图的Z轴</li>
</ul>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210407221220732.png"></p>
<h2 id="Redis一致性问题"><a href="#Redis一致性问题" class="headerlink" title="Redis一致性问题"></a>Redis一致性问题</h2><p>上述通过AKF实现了一变多，解决单点故障、容量与压力问题。但这也会引出一个新的问题，那就是redis如何解决数据一致性，下述有三个方法解决</p>
<ul>
<li>强一致性（同步方式）</li>
<li>较强一致性（异步方式）</li>
<li>最终一致性（通过消息队列）</li>
</ul>
<h3 id="强一致性"><a href="#强一致性" class="headerlink" title="强一致性"></a>强一致性</h3><p>所有节点阻塞直到所有数据全部一致（强一致性），如果后端的从节点有问题，比如网络延时，丢包。那么可能会照成客户端获取不到数据或提交不了数据（客户端写的过程中可能会有一个超时时间，等待超时时间过了之后，后端的redis还没有写成功，那么返回给客户端的就是没有写成功）所以强一致性会有可能会破坏服务的可用性，如下图</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210407222340991.png"></p>
<h3 id="较强一致性"><a href="#较强一致性" class="headerlink" title="较强一致性"></a>较强一致性</h3><p>通过异步的方式同步数据，相当于降级，可以容忍数据丢失一部分。比如：主redis先回复，但从还没有同步完，主突然宕机了，就会造成数据的丢失，如下图</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210407222716421.png"></p>
<h3 id="最终一致性"><a href="#最终一致性" class="headerlink" title="最终一致性"></a>最终一致性</h3><p>redis通过中间件消息队列解决异步方式，让数据不丢失。客户端请求数据，主redis先将数据给到消息队列（如：kafka和zookeeper），然后再从kafka专递到从redis。期间主redis与kafka是同步阻塞的，因为是消息队列，所以可以非常的可靠、快速。如果消息中间件再搭上集群就会再多一分保障。</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210407223155127.png"></p>
<h2 id="Redis主单点的问题"><a href="#Redis主单点的问题" class="headerlink" title="Redis主单点的问题"></a>Redis主单点的问题</h2><p>上述解决了单点问题与一致性的问题，但我们的主redis还是单点，如果主宕机了，还是需要人为去实时监控并启动，内部从节点宕了并不影响集群，所以说最主要的还是主节点。而人为去启动是靠谱的，但也不能及时的发现主节点是否宕机，加上宕机之后需要切换从节点变成主节点的时候还需要消耗，明显会影响线上的业务（造成数据的延时和丢失）</p>
<p>对于这个问题，就需要通过HA（高可用）的方式进行自动恢复故障了，用HA模式来来代替人进行切换的工作</p>
<p>那么如何自动故障转移，这个就得想想是人怎么监控服务的，比如：有三个监控脚本监控（这个监控，就是下述讲的Sentinel）着redis，但这三个监控脚本如何决定redis是否存活，是都同时给出NO，还是给出两个NO，才确定redis是宕机呢？下面给出三个方案</p>
<ul>
<li><p>给出3个NO，那么就是强一致性（上述有说，如果是强一致，那么就会破坏服务的可用性，redis必须等待接收到3个NO）</p>
</li>
<li><p>给出1个NO，统计可能不准确（因为中间可能会出现网络延迟或网络分区），也就是势力范围不够（数据会不一至）</p>
</li>
<li><p>给出2个NO，代表有双方是连接的，势力是达成一致（只要redis接收到两个NO，就代表redis已经不存活，这种选票方式是最有效的）</p>
</li>
</ul>
<blockquote>
<p>补充：有些数据可以是分区容忍性，就是投票并不需要两个达成一致，只要有一个是OK的就行（得看对数据的看法）。比如：不是数据全量的，只要能拿到一部分数据就可以的，那么就不用强调最终一致性或强一致性</p>
</blockquote>
<h2 id="什么是CAP原则"><a href="#什么是CAP原则" class="headerlink" title="什么是CAP原则"></a>什么是CAP原则</h2><p>CAP原则又称CAP定理，指的是在一个分布式系统中，一致性（Consistency），可用性（Availability），分区容错性（Partition tolerance）。CAP原则指的是，这三个要素最多只能同时实现两点，不可能三者兼顾</p>
<p>分布式系统的节点往往都是分布在不同的机器上进行网络隔离开的，这显然会有网络端口的风险，而这个网段断开的专业词叫做“网络分区”</p>
<p>在网络分区发生时，两个分布式节点之间是无法进行通信，比如：主节点的修改操作将无法同步到从节点，所以会造成一致性的问题，如果要两个分布式节点数据保持一致，就必须牺牲可用性，也就是暂时停止对外服务，直到网络分区恢复后正常运行再对外提供服务（也就是强一致性），所以说CAP只能实现两点的原因</p>
<h2 id="Redis主从复制"><a href="#Redis主从复制" class="headerlink" title="Redis主从复制"></a>Redis主从复制</h2><p>通过上述redis单点问题、一致性问题、主单点问题都有了对应的方法解决。相信大家现在对主从已经不陌生了，有了主从机制就有了一个保障，当主节点“Master”宕机时，运维可以让从节点“Slave”进行接管，使得可以继续的为用户提供服务。否则主节点重新启动加载数据会消耗时间长，影响线上的服务</p>
<p><strong>Redis使用默认的异步复制，其特点是低延迟和高性能</strong>，是绝大多数Redis用例的自然复制模式。但从Redis服务器会异步地确认其从主Redis服务器周期接收到的数据量</p>
<h3 id="增量同步"><a href="#增量同步" class="headerlink" title="增量同步"></a>增量同步</h3><p>Redis复制同步的是指令流，主节点会将那些对自己的状态产生修改性影响的指令记录在本地的内存buffer中，然后异步将buffer中的指令同步到从节点，从节点一边执行同步的指令流来达到和主节点一样的状态，还会向主节点反馈自己同步的偏移量</p>
<p>内存中的buffer是有限的，主节点不能将所有的指令都记录在内存buffer中，Redis的复制内存buffer是一个定长的环形数组，如果数组内容满了，就会从头开始覆盖前面的内容。buffer的大小可以通过参数repl-backlog-size来控制，默认是1mb，根据生产环境决定大小</p>
<p>如果网络出现问题，从节点无法在短时间内与主节点进行同步，之前在buffer中的指令可能就会被后续的指令覆盖掉，从节就无法直接通过指令流来进程同步，这个时候就需要使用——快照同步</p>
<h3 id="快照同步"><a href="#快照同步" class="headerlink" title="快照同步"></a>快照同步</h3><p>快照同步是非常耗资源的，相当于全量同步数据了。它首先需要在主节点上进行一次bgsave，将当前内存的数据全部快照到磁盘文件中，然后再将快照文件的内存全部传送到从节点。从节点将快照文件接收完毕后，立即执行一次全量加载，加载之前会先将当前内存的数据清空，加载完毕后通知主节点继续进行增量同步</p>
<p>在整个快照同步过程中，主节点的复制buffer还在不停地往前移动，如果快照同步的时间过长或者复制buffer太小，都会导致同步期间的增量指令在复制buffer中被覆盖。这样快照同步完成后无法进程增量负责，然后会再次发起快照同步，接着可能会陷入快照同步的死循环</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210411213203979.png"></p>
<h3 id="无盘复制"><a href="#无盘复制" class="headerlink" title="无盘复制"></a>无盘复制</h3><p>主节点在进行快照同步时，会很耗时的文件IO操作，在非SSD磁盘存储时，快照同步会对系统的负载产生较大影响。特别是在进行AOF的fsync操作时，如果发生快照同步，fsync将会被推迟执行，这会严重影响主节点的服务效率</p>
<p>从Redis2.8.18版本开始，Redis支持无盘复制，所谓无盘复制是指主服务器直接通过套接字将快照内容发送到从节点，生成快照是一个遍历的过程。主节点会一边遍历内容，一边将序列化的内容发送到从节点，从节点还是跟之前一样，先将接收到的内容存储到磁盘文件中，然后再一次性加载</p>
<h3 id="主从配置文件参数"><a href="#主从配置文件参数" class="headerlink" title="主从配置文件参数"></a>主从配置文件参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>replicaof <masterip> <masterport></td>
<td>配置文件加载主节点信息，随服务启动生效</td>
</tr>
<tr>
<td>masterauth <master-password><br>masteruser <username></td>
<td>对主从建立添加用户和密码认证</td>
</tr>
<tr>
<td>replica-serve-stale-data yes/no</td>
<td>从节点跟随主节点后，在同步过程中，是否可以让从节点的数据继续对外查询，yes就是支持，no就是要等同步完才能给与查询</td>
</tr>
<tr>
<td>replica-read-only yes</td>
<td>复制的节点是否使用只读模式</td>
</tr>
<tr>
<td>repl-diskless-sync no</td>
<td>启动无盘同步，生成通过套接字将RDB传输到副本的子代</td>
</tr>
<tr>
<td>repl-diskless-sync-delay 5</td>
<td>无盘同步延迟时间</td>
</tr>
<tr>
<td>repl-diskless-load</td>
<td>通过什么模式进行无盘加载，默认是disabled<br>disabled：不使用无盘加载（首先将rdb文件存储到磁盘）<br>on-empty-db：仅在完全安全的情况下使用无盘加载<br>swapdb：直接从socket解析数据时，将当前数据库内容的副本保留在RAM中（注意：这需要足够的内存，如果没有足够的内容，则可能会杀死OOM）</td>
</tr>
<tr>
<td>repl-backlog-size 1mb</td>
<td>增量复制，队列大小（根据生产环境决定）</td>
</tr>
<tr>
<td>repl-backlog-ttl 3600</td>
<td>主服务器在一段时间内没有连接副本后或是从节点断开后，通过设置的秒数对待办事项缓冲区进行释放</td>
</tr>
<tr>
<td>min-replicas-to-write 3</td>
<td>同步过程中，副本最少中有几个写成功（默认是不开启，如果开启，就有点强一致性，需要做取舍）</td>
</tr>
<tr>
<td>min-replicas-max-lag 10</td>
<td>同步过程中，副本中最大延迟，默认不开启，开启则为10s</td>
</tr>
</tbody></table>
<h3 id="wait指令"><a href="#wait指令" class="headerlink" title="wait指令"></a>wait指令</h3><p>Redis的复制是异步进行，wait指令可以让异步复制变成同步复制，确保系统的强一致性（但会失去可用性）。wait指令是Redis3.0版本以后才出现的</p>
<p>指令示例：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k1</span> <span class="selector-tag">k1</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">wait</span> 1 5</span><br><span class="line">(<span class="selector-tag">integer</span>) 1</span><br></pre></td></tr></table></figure>
<p>wait提供两个参数，第一个是从节点的<strong>数量N</strong>，第二个参数是<strong>时间t</strong>，以毫秒为单位。两个参数的含义是：等待wait指令之前的所有写操作同步到N个从节点（也就是确保N个从节点的同步没有滞后），最多等待时间t。如果时间t=0，表示无限等待直到N个从节点同步完成</p>
<p>如果出现了网络分区，wait指令第二个参数时间t=0，主从同步无法继续进行，wait指令会永久阻塞，Redis就会失去可用性</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k2</span> <span class="selector-tag">k2</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">10.0.0.50<span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">wait</span> 1 5</span><br><span class="line">(<span class="selector-tag">integer</span>) 0</span><br></pre></td></tr></table></figure>
<h3 id="主从示例"><a href="#主从示例" class="headerlink" title="主从示例"></a>主从示例</h3><p>规划我们的目录文件，规划的目录可以自己规划，也可以根据我发布的的redis-安装文章进行规划，下述通过脚本进行创建目录规划</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /opt/redis-6.0.6/utils</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./install_server.sh</span> </span><br><span class="line">Welcome to the redis service installer</span><br><span class="line">This script will help you easily set up a running redis server</span><br><span class="line"></span><br><span class="line">Please select the redis port for this instance: [6379] </span><br><span class="line">Selecting default: 6379</span><br><span class="line">Please select the redis config file name [/etc/redis/6379.conf] /opt/redis_cluster/redis_6379/conf/redis_6379.conf</span><br><span class="line">Please select the redis log file name [/var/log/redis_6379.log] /opt/redis_cluster/redis_6379/logs/redis_6379.log           </span><br><span class="line">Please select the data directory for this instance [/var/lib/redis/6379] /data/redis_cluster/redis_6379</span><br><span class="line">Please select the redis executable path [/usr/local/bin/redis-server] </span><br><span class="line">Selected config:</span><br><span class="line">......................省略.............................</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir pid &amp;&amp; <span class="built_in">cd</span> pid &amp;&amp; touch redis_6379.pid  //创建pid文件</span></span><br></pre></td></tr></table></figure>
<p>规划好的目录是这样的，通过tree进行查看</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ cd /opt/redis_cluster/</span><br><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">├── <span class="selector-tag">redis_6379</span></span><br><span class="line">│   ├── <span class="selector-tag">conf</span></span><br><span class="line">│   │   └── <span class="selector-tag">redis_6379</span><span class="selector-class">.conf</span></span><br><span class="line">│   ├── <span class="selector-tag">logs</span></span><br><span class="line">│   │   └── <span class="selector-tag">redis_6379</span><span class="selector-class">.log</span></span><br><span class="line">│   └── <span class="selector-tag">pid</span></span><br><span class="line">│       └── <span class="selector-tag">redis_6379</span><span class="selector-class">.pid</span></span><br><span class="line">├── <span class="selector-tag">redis_6380</span></span><br><span class="line">│   ├── <span class="selector-tag">conf</span></span><br><span class="line">│   │   └── <span class="selector-tag">redis_6380</span><span class="selector-class">.conf</span></span><br><span class="line">│   ├── <span class="selector-tag">logs</span></span><br><span class="line">│   │   └── <span class="selector-tag">redis_6380</span><span class="selector-class">.log</span></span><br><span class="line">│   └── <span class="selector-tag">pid</span></span><br><span class="line">│       └── <span class="selector-tag">redis_6380</span><span class="selector-class">.pid</span></span><br><span class="line">└── <span class="selector-tag">redis_6381</span></span><br><span class="line">    ├── <span class="selector-tag">conf</span></span><br><span class="line">    │   └── <span class="selector-tag">redis_6381</span><span class="selector-class">.conf</span></span><br><span class="line">    ├── <span class="selector-tag">logs</span></span><br><span class="line">    │   └── <span class="selector-tag">redis_6381</span><span class="selector-class">.log</span></span><br><span class="line">    └── <span class="selector-tag">pid</span></span><br><span class="line">        └── <span class="selector-tag">redis_6381</span><span class="selector-class">.pid</span></span><br></pre></td></tr></table></figure>
<p>上述的脚本运行完之后，会帮我们启动redis，我们需要修改编写每个进程的配置文件（6380,6381配置除了端口、pid、日志，数据目录其他根6379一致）,</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /opt/redis_cluster/redis_6379/conf</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim redis_6379.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 不以守护进程方式启动，方便通过实验对日志分析</span></span></span><br><span class="line">daemonize no</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 绑定的主机地址</span></span></span><br><span class="line">bind 127.0.0.1</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 监听端口</span></span></span><br><span class="line">port 6379</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## pid文件和log文件的保存路径</span></span></span><br><span class="line">pidfile /opt/redis_cluster/redis_6379/pid/redis_6379.pid</span><br><span class="line"><span class="meta">#</span><span class="bash"> logfile /opt/redis_cluster/redis_6379/logs/redis_6379.log   //该日志直接输出屏幕，不写入文件，方面实验分析</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 设置数据库的数量，默认数据库为0</span></span></span><br><span class="line">databases 16</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 指定本地持久化文件的文件名，默认是dump.rdb</span></span></span><br><span class="line">dbfilename redis_6379.rdb</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 本地数据库的目录</span></span></span><br><span class="line">dir /data/redis_cluster/redis_6379</span><br></pre></td></tr></table></figure>
<p>修改完配置文件后，重新启动redis实例</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ pkill redis</span><br><span class="line">$ redis-server /opt/redis_cluster/redis_6379/conf/redis_6379.conf </span><br><span class="line">$ redis-server /opt/redis_cluster/redis_6380/conf/redis_6380.conf </span><br><span class="line">$ redis-server /opt/redis_cluster/redis_6381/conf/redis_6381.conf </span><br></pre></td></tr></table></figure>
<h4 id="建立复制"><a href="#建立复制" class="headerlink" title="建立复制"></a>建立复制</h4><p>配置主从复制的方式有三种</p>
<ul>
<li>配置文件中加入replicaof <masterip> <masterport>随redis启动生效</li>
<li>在redis-server启动命令加入 –replicaof <masterip> <masterport>启动生效</li>
<li>进入redis，直接使用命令：–replicaof <masterip> <masterport></li>
</ul>
<blockquote>
<p><strong>注意：replicaof是从5.0版本开始使用的复制参数，在5.0以前使用的是slaveof</strong></p>
</blockquote>
<p>建立主从关系，主6379，从6380和6381</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -p <span class="number">6380</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6381</span>&gt; REPLICAOF <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">6379</span></span><br><span class="line"></span><br><span class="line">$ redis-cli -p <span class="number">6381</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6381</span>&gt; REPLICAOF <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">6379</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//查看从节点的配置文件，可以看出已经同步完成</span></span><br><span class="line"><span class="number">2632</span>:S <span class="number">08</span> Apr <span class="number">2021</span> <span class="number">11</span>:<span class="number">36</span>:<span class="number">04.904</span> * Full resync <span class="keyword">from</span> master: a42c2d2f7bba58efd17dd2736cb41c3040a7b5a6:<span class="number">0</span></span><br><span class="line"><span class="number">2632</span>:S <span class="number">08</span> Apr <span class="number">2021</span> <span class="number">11</span>:<span class="number">36</span>:<span class="number">04.904</span> * Discarding previously cached master state.</span><br><span class="line"><span class="number">2632</span>:S <span class="number">08</span> Apr <span class="number">2021</span> <span class="number">11</span>:<span class="number">36</span>:<span class="number">04.904</span> * MASTER &lt;-&gt; REPLICA sync: receiving <span class="number">175</span> bytes <span class="keyword">from</span> master to disk</span><br><span class="line"><span class="number">2632</span>:S <span class="number">08</span> Apr <span class="number">2021</span> <span class="number">11</span>:<span class="number">36</span>:<span class="number">04.904</span> * MASTER &lt;-&gt; REPLICA sync: Flushing old data</span><br><span class="line"><span class="number">2632</span>:S <span class="number">08</span> Apr <span class="number">2021</span> <span class="number">11</span>:<span class="number">36</span>:<span class="number">04.905</span> * MASTER &lt;-&gt; REPLICA sync: Loading DB in memory</span><br><span class="line"><span class="number">2632</span>:S <span class="number">08</span> Apr <span class="number">2021</span> <span class="number">11</span>:<span class="number">36</span>:<span class="number">04.905</span> * Loading RDB produced by version <span class="number">6.0</span><span class="number">.6</span></span><br><span class="line"><span class="number">2632</span>:S <span class="number">08</span> Apr <span class="number">2021</span> <span class="number">11</span>:<span class="number">36</span>:<span class="number">04.905</span> * RDB age <span class="number">0</span> seconds</span><br><span class="line"><span class="number">2632</span>:S <span class="number">08</span> Apr <span class="number">2021</span> <span class="number">11</span>:<span class="number">36</span>:<span class="number">04.905</span> * RDB memory usage when created <span class="number">1.85</span> Mb</span><br><span class="line"><span class="number">2632</span>:S <span class="number">08</span> Apr <span class="number">2021</span> <span class="number">11</span>:<span class="number">36</span>:<span class="number">04.905</span> * MASTER &lt;-&gt; REPLICA sync: Finished with success</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：建立复制之后，只有主节点才能进行写入，从节点只能读（当前也可以通过配置文件进行配置，这是默认情况下）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//主</span><br><span class="line">127.0.0.1<span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">k1</span> <span class="selector-tag">v1</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line"></span><br><span class="line">//从</span><br><span class="line">127.0.0.1<span class="selector-pseudo">:6381</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">k1</span></span><br><span class="line">&quot;<span class="selector-tag">v1</span>&quot;</span><br><span class="line">127.0.0.1<span class="selector-pseudo">:6381</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">k2</span> <span class="selector-tag">v2</span></span><br><span class="line">(error) READONLY You can&#x27;t write against a read only replica. </span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="关闭复制"><a href="#关闭复制" class="headerlink" title="关闭复制"></a>关闭复制</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1<span class="selector-pseudo">:6380</span>&gt; <span class="selector-tag">REPLICAOF</span> <span class="selector-tag">no</span>  <span class="selector-tag">one</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line"></span><br><span class="line">//查看主日志，会发现连接的主机6380已经丢失</span><br><span class="line">2611<span class="selector-pseudo">:M</span> 08 <span class="selector-tag">Apr</span> 2021 12<span class="selector-pseudo">:16</span><span class="selector-pseudo">:44.839</span> # <span class="selector-tag">Connection</span> <span class="selector-tag">with</span> <span class="selector-tag">replica</span> 127.0.0.1<span class="selector-pseudo">:6380</span> <span class="selector-tag">lost</span>.</span><br></pre></td></tr></table></figure>
<h4 id="增量复制"><a href="#增量复制" class="headerlink" title="增量复制"></a>增量复制</h4><p>首先在主从已经同步，从已经同步过主，并且有了主的数据</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//主</span><br><span class="line">127.0.0.1<span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">k1</span> <span class="selector-tag">v1</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">127.0.0.1<span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">k2</span> <span class="selector-tag">v2</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line"></span><br><span class="line">//从</span><br><span class="line">127.0.0.1<span class="selector-pseudo">:6381</span>&gt; <span class="selector-tag">keys</span> *</span><br><span class="line">1) &quot;<span class="selector-tag">k2</span>&quot;</span><br><span class="line">2) &quot;<span class="selector-tag">k1</span>&quot;</span><br></pre></td></tr></table></figure>
<p>然后从宕机了，主库还继续写着数据</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//从</span><br><span class="line">$ redis-cli -p 6381 shutdown</span><br><span class="line"></span><br><span class="line">//主</span><br><span class="line">127.0.0.1<span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">k3</span> <span class="selector-tag">v3</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">127.0.0.1<span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">k3</span> <span class="selector-tag">v3</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br></pre></td></tr></table></figure>
<p>从库通过–replicaof参数进行增量备份，在重新查看数据，会增加主写入的数据</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ redis-server /opt/redis_cluster/redis_6381/conf/redis_6381.conf --replicaof 127.0.0.1 6379</span><br><span class="line">127.0.0.1<span class="selector-pseudo">:6381</span>&gt; <span class="selector-tag">keys</span> *</span><br><span class="line">1) &quot;<span class="selector-tag">k4</span>&quot;</span><br><span class="line">2) &quot;<span class="selector-tag">k3</span>&quot;</span><br><span class="line">3) &quot;<span class="selector-tag">k1</span>&quot;</span><br><span class="line">4) &quot;<span class="selector-tag">k2</span>&quot;</span><br></pre></td></tr></table></figure>
<p>查看主日志文件，可以发现是通过偏移量的形式进行写入从节点的的</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2781<span class="selector-pseudo">:M</span> 08 <span class="selector-tag">Apr</span> 2021 12<span class="selector-pseudo">:38</span><span class="selector-pseudo">:48.069</span> * <span class="selector-tag">Replica</span> 127.0.0.1<span class="selector-pseudo">:6381</span> <span class="selector-tag">asks</span> <span class="selector-tag">for</span> <span class="selector-tag">synchronization</span></span><br><span class="line">2781<span class="selector-pseudo">:M</span> 08 <span class="selector-tag">Apr</span> 2021 12<span class="selector-pseudo">:38</span><span class="selector-pseudo">:48.069</span> * <span class="selector-tag">Partial</span> <span class="selector-tag">resynchronization</span> <span class="selector-tag">request</span> <span class="selector-tag">from</span> 127.0.0.1<span class="selector-pseudo">:6381</span> <span class="selector-tag">accepted</span>. <span class="selector-tag">Sending</span> 886 <span class="selector-tag">bytes</span> <span class="selector-tag">of</span> <span class="selector-tag">backlog</span> <span class="selector-tag">starting</span> <span class="selector-tag">from</span> <span class="selector-tag">offset</span> 647.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：如果是将从节点的数据文件删除，那依然也是使用增量的方式，从库宕机的时间，主库还持续增加写入，同步的过程中并不会只增加（时间段）写的数据，而统一同步全部数据。</p>
</blockquote>
<h4 id="全量复制（AOF）"><a href="#全量复制（AOF）" class="headerlink" title="全量复制（AOF）"></a>全量复制（AOF）</h4><p>通过增加参数–appendonly yes，开始AOF日志模式的复制</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ redis-server /opt/redis_cluster/redis_6380/conf/redis_6380.conf --replicaof 10.0.0.50 6379 --appendonly yes</span><br></pre></td></tr></table></figure>
<p>查看主节点的日志</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">26691<span class="selector-pseudo">:M</span> 11 <span class="selector-tag">Apr</span> 2021 21<span class="selector-pseudo">:40</span><span class="selector-pseudo">:41.667</span> * <span class="selector-tag">Replica</span> 127.0.0.1<span class="selector-pseudo">:6380</span> <span class="selector-tag">asks</span> <span class="selector-tag">for</span> <span class="selector-tag">synchronization</span></span><br><span class="line">26691<span class="selector-pseudo">:M</span> 11 <span class="selector-tag">Apr</span> 2021 21<span class="selector-pseudo">:40</span><span class="selector-pseudo">:41.667</span> * <span class="selector-tag">Full</span> <span class="selector-tag">resync</span> <span class="selector-tag">requested</span> <span class="selector-tag">by</span> <span class="selector-tag">replica</span> 127.0.0.1<span class="selector-pseudo">:6380</span></span><br><span class="line">26691<span class="selector-pseudo">:M</span> 11 <span class="selector-tag">Apr</span> 2021 21<span class="selector-pseudo">:40</span><span class="selector-pseudo">:41.667</span> * <span class="selector-tag">Starting</span> <span class="selector-tag">BGSAVE</span> <span class="selector-tag">for</span> <span class="selector-tag">SYNC</span> <span class="selector-tag">with</span> <span class="selector-tag">target</span>: <span class="selector-tag">disk</span>   </span><br><span class="line">26691<span class="selector-pseudo">:M</span> 11 <span class="selector-tag">Apr</span> 2021 21<span class="selector-pseudo">:40</span><span class="selector-pseudo">:41.669</span> * <span class="selector-tag">Background</span> <span class="selector-tag">saving</span> <span class="selector-tag">started</span> <span class="selector-tag">by</span> <span class="selector-tag">pid</span> 28879</span><br><span class="line">28879<span class="selector-pseudo">:C</span> 11 <span class="selector-tag">Apr</span> 2021 21<span class="selector-pseudo">:40</span><span class="selector-pseudo">:41.673</span> * <span class="selector-tag">DB</span> <span class="selector-tag">saved</span> <span class="selector-tag">on</span> <span class="selector-tag">disk</span></span><br><span class="line">28879<span class="selector-pseudo">:C</span> 11 <span class="selector-tag">Apr</span> 2021 21<span class="selector-pseudo">:40</span><span class="selector-pseudo">:41.674</span> * <span class="selector-tag">RDB</span>: 4 <span class="selector-tag">MB</span> <span class="selector-tag">of</span> <span class="selector-tag">memory</span> <span class="selector-tag">used</span> <span class="selector-tag">by</span> <span class="selector-tag">copy-on-write</span></span><br><span class="line">26691<span class="selector-pseudo">:M</span> 11 <span class="selector-tag">Apr</span> 2021 21<span class="selector-pseudo">:40</span><span class="selector-pseudo">:41.770</span> * <span class="selector-tag">Background</span> <span class="selector-tag">saving</span> <span class="selector-tag">terminated</span> <span class="selector-tag">with</span> <span class="selector-tag">success</span></span><br><span class="line">26691<span class="selector-pseudo">:M</span> 11 <span class="selector-tag">Apr</span> 2021 21<span class="selector-pseudo">:40</span><span class="selector-pseudo">:41.771</span> * <span class="selector-tag">Synchronization</span> <span class="selector-tag">with</span> <span class="selector-tag">replica</span> 127.0.0.1<span class="selector-pseudo">:6380</span> <span class="selector-tag">succeeded</span></span><br></pre></td></tr></table></figure>
<h2 id="Sentinel（哨兵）"><a href="#Sentinel（哨兵）" class="headerlink" title="Sentinel（哨兵）"></a>Sentinel（哨兵）</h2><p>通过主从的方式已经可以解决了单点故障问题，包括容量和压力。但是有没有想过，如果在凌晨2点钟出现了故障（主宕机了），那么就需要人起床手工的去对主从的故障转移，这样的人工方式，显然效率会很低。所以出现了高可用的方式（HA）代替人工自动故障转移，Redis官方提供的方案就是——Redis Sentinel（哨兵）</p>
<p>Sentinel可以看做是对集群高可用的心脏，一般由3 ~ 5个节点组成，主节点挂了，集群也还可以继续正常运转</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210412005505181.png"></p>
<p>Sentinel负责持续监控主从节点的健康，当主节点宕机是，会自动投票选择一个最优的从节点切换成主节点。</p>
<p>客户端连接集群，会首先连接Sentinel，通过Sentinel来查询主节点的地址，然后再连接主节点进行交互数据。当主节点故障时，客户端会重新向Sentinel询要地址，Sentinel会将最新的主节点地址告诉客户端，进而无序重启即可自动完成故障转移的节点切换，如下图：主节点宕机后，集群自动转移</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210412010401047.png"></p>
<p>从图可以看出，如果主节点down了，之前的主从负责也断开，客户端和损坏的主节点也断开。一个从节点被转换为新的主节点，其他从节点开始和新的主节点建立复制关系。客户端通过新的主节点进行继续交互，Sentinel继续监控已经down的主节点，待恢复后，如下图</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210412010655821.png"></p>
<h3 id="Sentinel主要功能"><a href="#Sentinel主要功能" class="headerlink" title="Sentinel主要功能"></a>Sentinel主要功能</h3><ul>
<li><p>监控（Monitoring）</p>
<p>Sentinel会不断地定期检查你的主服务器和从服务器是否运行正常</p>
</li>
<li><p>提醒（Notification）</p>
<p> 当被监控的某个redis服务器出现问题时，Sentinel可以通过API将管理员或者其他应用程序发送通知</p>
</li>
<li><p>自动故障迁移</p>
<p>当一个主服务器不能正常工作时，Sentinel会开始一次自动故障迁移操作，它会将失效主服务器的其中一个从服务器升级为新的主服务器，并让失效主服务器的ITA从服务器改为复制新的主服务器；当客户端试图连接失效的主服务器时，Sentinel也会向客户端返回新主服务器的地址，使得可以使用新主服务器代替失效服务器</p>
</li>
</ul>
<h3 id="Sentinel配置文件参数"><a href="#Sentinel配置文件参数" class="headerlink" title="Sentinel配置文件参数"></a>Sentinel配置文件参数</h3><p>Sentinel的配置文件，在源码包中有一个sentinel.conf，可以根据里面的参数进行编写配置文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd /opt/redis-6.0.6</span><br><span class="line">$ ll sentinel.conf</span><br><span class="line"><span class="selector-tag">-rw-rw-r--</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 10743 <span class="selector-tag">Jul</span> 21  2020 <span class="selector-tag">sentinel</span><span class="selector-class">.conf</span></span><br></pre></td></tr></table></figure>
<p>下面列出一些Sentinel常用的配置参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>pidfile /var/run/redis-sentinel.pid</td>
<td>Sentinel运行的进行PID</td>
</tr>
<tr>
<td>port 26379</td>
<td>Sentinel使用的端口</td>
</tr>
<tr>
<td>daemonize no</td>
<td>是否在后台运行</td>
</tr>
<tr>
<td>logfile “”</td>
<td>Sentinel的日志路径</td>
</tr>
<tr>
<td>dir /tmp</td>
<td>Sentinel的数据路径</td>
</tr>
<tr>
<td>sentinel monitor mymaster 127.0.0.1 6379 2</td>
<td>mymaster（主节点别名）、主节点IP和端口，2（判断节点的势力，需两个Sentinel节点统一）</td>
</tr>
<tr>
<td>sentinel down-after-milliseconds <master-name> <milliseconds></td>
<td>选定sentinel认为服务器已经宕机的所需毫秒数</td>
</tr>
<tr>
<td>sentinel parallel-syncs <master-name> <numreplicas></td>
<td>向新的节点发起复制操作的从节点个数，1为轮询发起复制</td>
</tr>
<tr>
<td>sentinel failover-timeout <master-name> <milliseconds></td>
<td>故障转移超时时间，默认为3秒</td>
</tr>
</tbody></table>
<h3 id="Sentinel集群搭建"><a href="#Sentinel集群搭建" class="headerlink" title="Sentinel集群搭建"></a>Sentinel集群搭建</h3><h4 id="配置主从关系"><a href="#配置主从关系" class="headerlink" title="配置主从关系"></a>配置主从关系</h4><p>启动6379、80和81三个实例，并设置6389为主，其他节点为从主机</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ pkill redis</span><br><span class="line">$ redis-server /opt/redis_cluster/redis_6379/conf/redis_6379.conf </span><br><span class="line">$ redis-server /opt/redis_cluster/redis_6380/conf/redis_6380.conf </span><br><span class="line">$ redis-server /opt/redis_cluster/redis_6381/conf/redis_6381.conf </span><br><span class="line"></span><br><span class="line">$ redis-cli -p 6380</span><br><span class="line">&gt; <span class="selector-tag">REPLICAOF</span> 127.0.0.1 6379</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line"></span><br><span class="line">$ redis-cli -p 6381</span><br><span class="line">&gt; <span class="selector-tag">REPLICAOF</span> 127.0.0.1 6379</span><br><span class="line"><span class="selector-tag">OK</span></span><br></pre></td></tr></table></figure>
<h4 id="配置sentinel节点"><a href="#配置sentinel节点" class="headerlink" title="配置sentinel节点"></a>配置sentinel节点</h4><p>创建三个sentinel节点，分别为26379、80和81，然后编写配置</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ /opt/redis_cluster/</span><br><span class="line">$ mkdir sentinel &amp;&amp; cd sentinel/</span><br><span class="line">$ touch 26379.conf </span><br><span class="line">$ vi 26379.conf                     //80和81的配置是一样的，只是端口需要改变</span><br><span class="line"><span class="selector-tag">port</span> 26379</span><br><span class="line"><span class="selector-tag">sentinel</span> <span class="selector-tag">monitor</span> <span class="selector-tag">mymaster</span> 10.0.0.40 6379 2</span><br></pre></td></tr></table></figure>
<p>sentinel有两种不同命令的启动方式</p>
<ul>
<li><p>通过redis-server命令启动，但是需要加参数–sentinel</p>
</li>
<li><p>通过redis-sentinel命令启动，就不需要添加，可以查看源码的src下的执行命令，会发现redis-sentinel是redis-server的软连接</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ll</span> <span class="selector-tag">redis-</span>*</span><br><span class="line"><span class="selector-tag">lrwxrwxrwx</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span>      12 <span class="selector-tag">Mar</span> 27 21<span class="selector-pseudo">:23</span> <span class="selector-tag">redis-sentinel</span> <span class="selector-tag">-</span>&gt; <span class="selector-tag">redis-server</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>. 2 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 9033504 <span class="selector-tag">Mar</span> 27 21<span class="selector-pseudo">:23</span> <span class="selector-tag">redis-server</span></span><br></pre></td></tr></table></figure>
<p>启动sentinel节点，并查看输出日志分析</p>
</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ redis-server /opt/redis_cluster/sentinel/26379.conf --sentinel </span><br><span class="line">//输出的日志，会发现只监控6379，会将其他从节点一起监控</span><br><span class="line">78253<span class="selector-pseudo">:X</span> 14 <span class="selector-tag">Apr</span> 2021 23<span class="selector-pseudo">:39</span><span class="selector-pseudo">:45.564</span> # <span class="selector-tag">Sentinel</span> <span class="selector-tag">ID</span> <span class="selector-tag">is</span> <span class="selector-tag">dd03e8536ed70d017cb50b930396aa9146566a72</span></span><br><span class="line">78253<span class="selector-pseudo">:X</span> 14 <span class="selector-tag">Apr</span> 2021 23<span class="selector-pseudo">:39</span><span class="selector-pseudo">:45.564</span> # +<span class="selector-tag">monitor</span> <span class="selector-tag">master</span> <span class="selector-tag">mymaster</span> 127.0.0.1 6379 <span class="selector-tag">quorum</span> 2</span><br><span class="line">78253<span class="selector-pseudo">:X</span> 14 <span class="selector-tag">Apr</span> 2021 23<span class="selector-pseudo">:39</span><span class="selector-pseudo">:45.566</span> * +<span class="selector-tag">slave</span> <span class="selector-tag">slave</span> 127.0.0.1<span class="selector-pseudo">:6380</span> 127.0.0.1 6380 @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">14</span> Apr <span class="number">2021</span> <span class="number">23</span>:<span class="number">39</span>:<span class="number">45.569</span> * +slave slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6381</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6381</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"></span><br><span class="line">//接着启动剩下的两个sentinel，并查看<span class="number">26381</span>日志，会发现，三个sentinel已经全部监控上节点</span><br><span class="line">$ redis-server /opt/redis_cluster/sentinel/<span class="number">26380</span>.conf --sentinel     </span><br><span class="line">$ redis-server /opt/redis_cluster/sentinel/<span class="number">26381</span>.conf --sentinel </span><br><span class="line"><span class="number">78271</span>:X <span class="number">14</span> Apr <span class="number">2021</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">09.666</span> # Sentinel ID is <span class="number">1268</span>bda31eea1b390644b6563f8353189dcff4a3</span><br><span class="line"><span class="number">78271</span>:X <span class="number">14</span> Apr <span class="number">2021</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">09.666</span> # +monitor master mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span> quorum <span class="number">2</span></span><br><span class="line"><span class="number">78271</span>:X <span class="number">14</span> Apr <span class="number">2021</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">09.667</span> * +slave slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6380</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6380</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78271</span>:X <span class="number">14</span> Apr <span class="number">2021</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">09.715</span> * +slave slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6381</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6381</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78271</span>:X <span class="number">14</span> Apr <span class="number">2021</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">10.557</span> * +sentinel sentinel dd03e8536ed70d017cb50b930396aa9146566a72 <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">26379</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78271</span>:X <span class="number">14</span> Apr <span class="number">2021</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">10.568</span> * +sentinel sentinel d5a7199dd81724c944309bfde7de0505daa90167 <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">26380</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>
<h4 id="查看sentinel信息"><a href="#查看sentinel信息" class="headerlink" title="查看sentinel信息"></a>查看sentinel信息</h4><p>查看26379配置文件情况，也会发现，所有的主从节点和sentinel已经添加到了配置文件（26380与26381也一样）</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ vi /opt/redis_cluster/sentinel/23769.conf </span><br><span class="line"></span><br><span class="line"><span class="selector-tag">port</span> 26379</span><br><span class="line"><span class="selector-tag">sentinel</span> <span class="selector-tag">myid</span> <span class="selector-tag">dd03e8536ed70d017cb50b930396aa9146566a72</span></span><br><span class="line"># <span class="selector-tag">Generated</span> <span class="selector-tag">by</span> <span class="selector-tag">CONFIG</span> <span class="selector-tag">REWRITE</span></span><br><span class="line"><span class="selector-tag">protected-mode</span> <span class="selector-tag">no</span></span><br><span class="line"><span class="selector-tag">user</span> <span class="selector-tag">default</span> <span class="selector-tag">on</span> <span class="selector-tag">nopass</span> ~* +<span class="keyword">@all</span></span><br><span class="line">dir <span class="string">&quot;/opt/redis_cluster/sentinel&quot;</span></span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line">sentinel monitor mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span> <span class="number">2</span></span><br><span class="line">sentinel config-epoch mymaster <span class="number">0</span></span><br><span class="line">sentinel leader-epoch mymaster <span class="number">0</span></span><br><span class="line">sentinel known-replica mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6381</span></span><br><span class="line">sentinel known-replica mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6380</span></span><br><span class="line">sentinel known-sentinel mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">26381</span> <span class="number">1268</span>bda31eea1b390644b6563f8353189dcff4a3</span><br><span class="line">sentinel known-sentinel mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">26380</span> d5a7199dd81724c944309bfde7de0505daa90167</span><br><span class="line">sentinel current-epoch <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>还可以登录sentinel节点，查看信息，得到主节点是6379，有2个从主机，sentinel3个</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -p 26379</span><br><span class="line">&gt; <span class="selector-tag">info</span> <span class="selector-tag">sentinel</span></span><br><span class="line"># <span class="selector-tag">Sentinel</span></span><br><span class="line"><span class="selector-tag">sentinel_masters</span><span class="selector-pseudo">:1</span></span><br><span class="line"><span class="selector-tag">sentinel_tilt</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">sentinel_running_scripts</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">sentinel_scripts_queue_length</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">sentinel_simulate_failure_flags</span><span class="selector-pseudo">:0</span></span><br><span class="line">master0:name=mymaster,status=ok,address=127.0.0.1:6379,slaves=2,sentinels=3</span><br></pre></td></tr></table></figure>
<p>下述是sentinel查看命令总结</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>sentinel masters <master name></td>
<td>获取主库详细信息</td>
</tr>
<tr>
<td>sentinel slaves <master name></td>
<td>获取从库详细信息</td>
</tr>
<tr>
<td>sentinel sentinels <master name></td>
<td>获取那个主库详细信息</td>
</tr>
<tr>
<td>sentinel get-master-addr-by-name <master name></td>
<td>获取主节点ip和端口</td>
</tr>
<tr>
<td>sentinel flushconfig</td>
<td>刷新配置文件</td>
</tr>
<tr>
<td>sentinel failover <master name></td>
<td>故障转移（慎用）</td>
</tr>
</tbody></table>
<p>通过sentinel failover <master name> ，会自动转移主节点，下述的主已经变成了6380，所以要小心使用</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sentinel failover mymaster</span><br><span class="line">&gt; <span class="selector-tag">info</span> <span class="selector-tag">sentinel</span></span><br><span class="line"># <span class="selector-tag">Sentinel</span></span><br><span class="line"><span class="selector-tag">sentinel_masters</span><span class="selector-pseudo">:1</span></span><br><span class="line"><span class="selector-tag">sentinel_tilt</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">sentinel_running_scripts</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">sentinel_scripts_queue_length</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">sentinel_simulate_failure_flags</span><span class="selector-pseudo">:0</span></span><br><span class="line">master0:name=mymaster,status=ok,address=127.0.0.1:6380,slaves=2,sentinels=3</span><br></pre></td></tr></table></figure>
<p>sentinel节点从建立起来之后，会一直发送心跳的信息，可以通过消息订阅的命令进行查看</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">PSUBSCRIBE</span> *</span><br><span class="line"><span class="selector-tag">Reading</span> <span class="selector-tag">messages</span>... (<span class="selector-tag">press</span> <span class="selector-tag">Ctrl-C</span> <span class="selector-tag">to</span> <span class="selector-tag">quit</span>)</span><br><span class="line">1) &quot;<span class="selector-tag">psubscribe</span>&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) (<span class="selector-tag">integer</span>) 1</span><br><span class="line">1) &quot;<span class="selector-tag">pmessage</span>&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;__<span class="selector-tag">sentinel__</span><span class="selector-pseudo">:hello&quot;</span></span><br><span class="line">4) &quot;127.0.0.1,26380,<span class="selector-tag">d5a7199dd81724c944309bfde7de0505daa90167</span>,1,<span class="selector-tag">mymaster</span>,127.0.0.1,6380,1&quot;</span><br><span class="line">1) &quot;<span class="selector-tag">pmessage</span>&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;__<span class="selector-tag">sentinel__</span><span class="selector-pseudo">:hello&quot;</span></span><br><span class="line">4) &quot;127.0.0.1,26380,<span class="selector-tag">d5a7199dd81724c944309bfde7de0505daa90167</span>,1,<span class="selector-tag">mymaster</span>,127.0.0.1,6380,1&quot;</span><br><span class="line">1) &quot;<span class="selector-tag">pmessage</span>&quot;</span><br><span class="line">2) &quot;*&quot;</span><br></pre></td></tr></table></figure>
<h3 id="Sentinel故障转移"><a href="#Sentinel故障转移" class="headerlink" title="Sentinel故障转移"></a>Sentinel故障转移</h3><p>模拟主节点突然宕机，然后观察Sentinel节点选主的情况（宕机之后需要3秒钟，sentinel才会故障转移）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -p 6379 shutdown</span><br></pre></td></tr></table></figure>
<p>查看sentinel节点的日志，可以发现查看这条信息（+switch-master mymaster 127.0.0.1 6379 127.0.0.1 6380 ），主节点已经转移给了6380</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">78253<span class="selector-pseudo">:X</span> 15 <span class="selector-tag">Apr</span> 2021 00<span class="selector-pseudo">:15</span><span class="selector-pseudo">:24.986</span> # +<span class="selector-tag">sdown</span> <span class="selector-tag">master</span> <span class="selector-tag">mymaster</span> 127.0.0.1 6379</span><br><span class="line">78253<span class="selector-pseudo">:X</span> 15 <span class="selector-tag">Apr</span> 2021 00<span class="selector-pseudo">:15</span><span class="selector-pseudo">:25.048</span> # +<span class="selector-tag">odown</span> <span class="selector-tag">master</span> <span class="selector-tag">mymaster</span> 127.0.0.1 6379 <span class="selector-id">#quorum</span> 2/2</span><br><span class="line">78253<span class="selector-pseudo">:X</span> 15 <span class="selector-tag">Apr</span> 2021 00<span class="selector-pseudo">:15</span><span class="selector-pseudo">:25.048</span> # +<span class="selector-tag">new-epoch</span> 3</span><br><span class="line">78253<span class="selector-pseudo">:X</span> 15 <span class="selector-tag">Apr</span> 2021 00<span class="selector-pseudo">:15</span><span class="selector-pseudo">:25.048</span> # +<span class="selector-tag">try-failover</span> <span class="selector-tag">master</span> <span class="selector-tag">mymaster</span> 127.0.0.1 6379</span><br><span class="line">78253<span class="selector-pseudo">:X</span> 15 <span class="selector-tag">Apr</span> 2021 00<span class="selector-pseudo">:15</span><span class="selector-pseudo">:25.053</span> # +<span class="selector-tag">vote-for-leader</span> <span class="selector-tag">dd03e8536ed70d017cb50b930396aa9146566a72</span> 3</span><br><span class="line">78253<span class="selector-pseudo">:X</span> 15 <span class="selector-tag">Apr</span> 2021 00<span class="selector-pseudo">:15</span><span class="selector-pseudo">:25.071</span> # <span class="selector-tag">d5a7199dd81724c944309bfde7de0505daa90167</span> <span class="selector-tag">voted</span> <span class="selector-tag">for</span> <span class="selector-tag">dd03e8536ed70d017cb50b930396aa9146566a72</span> 3</span><br><span class="line">78253<span class="selector-pseudo">:X</span> 15 <span class="selector-tag">Apr</span> 2021 00<span class="selector-pseudo">:15</span><span class="selector-pseudo">:25.077</span> # 1268<span class="selector-tag">bda31eea1b390644b6563f8353189dcff4a3</span> <span class="selector-tag">voted</span> <span class="selector-tag">for</span> <span class="selector-tag">dd03e8536ed70d017cb50b930396aa9146566a72</span> 3</span><br><span class="line">78253<span class="selector-pseudo">:X</span> 15 <span class="selector-tag">Apr</span> 2021 00<span class="selector-pseudo">:15</span><span class="selector-pseudo">:25.106</span> # +<span class="selector-tag">elected-leader</span> <span class="selector-tag">master</span> <span class="selector-tag">mymaster</span> 127.0.0.1 6379</span><br><span class="line">78253<span class="selector-pseudo">:X</span> 15 <span class="selector-tag">Apr</span> 2021 00<span class="selector-pseudo">:15</span><span class="selector-pseudo">:25.106</span> # +<span class="selector-tag">failover-state-select-slave</span> <span class="selector-tag">master</span> <span class="selector-tag">mymaster</span> 127.0.0.1 6379</span><br><span class="line">78253<span class="selector-pseudo">:X</span> 15 <span class="selector-tag">Apr</span> 2021 00<span class="selector-pseudo">:15</span><span class="selector-pseudo">:25.165</span> # +<span class="selector-tag">selected-slave</span> <span class="selector-tag">slave</span> 127.0.0.1<span class="selector-pseudo">:6380</span> 127.0.0.1 6380 @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">15</span> Apr <span class="number">2021</span> <span class="number">00</span>:<span class="number">15</span>:<span class="number">25.165</span> * +failover-state-send-slaveof-noone slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6380</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6380</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">15</span> Apr <span class="number">2021</span> <span class="number">00</span>:<span class="number">15</span>:<span class="number">25.266</span> * +failover-state-wait-promotion slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6380</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6380</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">15</span> Apr <span class="number">2021</span> <span class="number">00</span>:<span class="number">15</span>:<span class="number">25.366</span> # +promoted-slave slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6380</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6380</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">15</span> Apr <span class="number">2021</span> <span class="number">00</span>:<span class="number">15</span>:<span class="number">25.366</span> # +failover-state-reconf-slaves master mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">15</span> Apr <span class="number">2021</span> <span class="number">00</span>:<span class="number">15</span>:<span class="number">25.443</span> * +slave-reconf-sent slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6381</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6381</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">15</span> Apr <span class="number">2021</span> <span class="number">00</span>:<span class="number">15</span>:<span class="number">25.765</span> * +slave-reconf-inprog slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6381</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6381</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">15</span> Apr <span class="number">2021</span> <span class="number">00</span>:<span class="number">15</span>:<span class="number">26.153</span> # -odown master mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">15</span> Apr <span class="number">2021</span> <span class="number">00</span>:<span class="number">15</span>:<span class="number">26.799</span> * +slave-reconf-done slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6381</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6381</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">15</span> Apr <span class="number">2021</span> <span class="number">00</span>:<span class="number">15</span>:<span class="number">26.861</span> # +failover-end master mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">15</span> Apr <span class="number">2021</span> <span class="number">00</span>:<span class="number">15</span>:<span class="number">26.861</span> # +switch-master mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6380</span>     //转换的主节点，<span class="number">6379</span>变成<span class="number">6380</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">15</span> Apr <span class="number">2021</span> <span class="number">00</span>:<span class="number">15</span>:<span class="number">26.861</span> * +slave slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6381</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6381</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6380</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">15</span> Apr <span class="number">2021</span> <span class="number">00</span>:<span class="number">15</span>:<span class="number">26.862</span> * +slave slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6380</span></span><br><span class="line"><span class="number">78253</span>:X <span class="number">15</span> Apr <span class="number">2021</span> <span class="number">00</span>:<span class="number">15</span>:<span class="number">56.925</span> # +sdown slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span> @ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6380</span></span><br></pre></td></tr></table></figure>
<p>也可以登录sentinel节点查看主节点信息</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -p 26379</span><br><span class="line">&gt; <span class="selector-tag">sentinel</span> <span class="selector-tag">get-master-addr-by-name</span> <span class="selector-tag">mymaster</span></span><br><span class="line">1) &quot;127.0.0.1&quot;</span><br><span class="line">2) &quot;6380&quot;	</span><br></pre></td></tr></table></figure>
<h3 id="Sentinel配置优先级"><a href="#Sentinel配置优先级" class="headerlink" title="Sentinel配置优先级"></a>Sentinel配置优先级</h3><p>redis sentinel存在多个从节点时，如果想将指定的从节点晋升为主节点，可以将其他从节点slaver priority配置为0，但是需要注意failover后，将slave-priority调回原值（优先级越高越优先）</p>
<p>操作过程如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -p 6379  </span><br><span class="line">&gt; <span class="selector-tag">CONFIG</span> <span class="selector-tag">GET</span> <span class="selector-tag">slave-priority</span></span><br><span class="line">1) &quot;<span class="selector-tag">slave-priority</span>&quot;</span><br><span class="line">2) &quot;100&quot;</span><br><span class="line">    </span><br><span class="line">$ redis-cli -h redis-41 6379 CONFIG SET slave-priority 0</span><br><span class="line">$ redis-cli -h redis-42 6379 CONFIG SET slave-priority 0</span><br></pre></td></tr></table></figure>
<p>通过sentinel命令主动切换，并查新查看主从信息</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -p 26379</span><br><span class="line">&gt; <span class="selector-tag">sentinel</span> <span class="selector-tag">failover</span> <span class="selector-tag">mymaster</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="selector-tag">info</span> <span class="selector-tag">sentinel</span></span><br><span class="line"># <span class="selector-tag">Sentinel</span></span><br><span class="line"><span class="selector-tag">sentinel_masters</span><span class="selector-pseudo">:1</span></span><br><span class="line"><span class="selector-tag">sentinel_tilt</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">sentinel_running_scripts</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">sentinel_scripts_queue_length</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">sentinel_simulate_failure_flags</span><span class="selector-pseudo">:0</span></span><br><span class="line">master0:name=mymaster,status=ok,address=127.0.0.1:6379,slaves=2,sentinels=3</span><br></pre></td></tr></table></figure>
<h2 id="Redis集群分片模式"><a href="#Redis集群分片模式" class="headerlink" title="Redis集群分片模式"></a>Redis集群分片模式</h2><p>Redis集群数据分片有很多种，如在客户端对业务进行拆分、hash+取模、random，一致性的hash等等，但要认清redis在架构中的位置，在这些功能中<strong>增删会照成时点的丢失</strong>，所以是不能通过这些方法来实现分布式数据库，而只能作为缓存使用，下述是四个不同分区方法</p>
<ul>
<li>client融于一部分逻辑代码，实现业务拆分，根据不同的业务访问redis示例</li>
<li>client按算法拆分，通过hash+取模（modula）的方式，对每台redis进行分区</li>
<li>client按算法拆份，通过random的方式，随机对每台redis进行分区</li>
<li>client按算法拆分，通过ketama（一致性hash）的方式，对每台redis进行分区（推荐使用）</li>
</ul>
<blockquote>
<p>PS：这里的客户端是使用的工具，如：redis cluster、twemproxy、predixy等</p>
</blockquote>
<h3 id="client业务拆份"><a href="#client业务拆份" class="headerlink" title="client业务拆份"></a>client业务拆份</h3><p>client融于一部分逻辑代码，通过业务进行拆分，根据不同的业务访问的redis实例。对于redis实例互相之间无感知的，所有数据到来都是连接通过client，然后由client连接redis，并分发获取的写或读值交给后端的redis。虽然这种方法可以分类，但是交集数据不多，因为每个实例都是按业务分开的</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210510151135416.png" alt="image-20210510151135416"></p>
<p>而且client连接成本很高，对redis会照成一定的性能影响（网络I/O多），如下图</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210418204249667.png"></p>
<p>那如何解决这个问题，可以使用nginx方法，做一个反向代理，这个时候的连接压力就没有那么大，而且只需要关注proxy的性能就行了。如果后续的并发量增大，可以做proxy的负载均衡（但也将client的逻辑实现，迁移到了由proxy实现，实现可以有modula、random、ketama的三种算法）。</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210418205008445.png"></p>
<p>或者通过LVS的四层转发，只需要让客户端访问一个IP地址，使用keepalived做高可用，也可以监控nginx（proxy）的健康值，接收的连接由LVS接收丢给nginx，接着nginx分发给后端的redis处理</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210418235511356.png"></p>
<h3 id="client的hash-取模分片算法"><a href="#client的hash-取模分片算法" class="headerlink" title="client的hash+取模分片算法"></a>client的hash+取模分片算法</h3><p>除了对业务进行拆分，我们还可以通过算法拆分，通过hash+取模的方式，对key进行hash映射成等宽的值（或字符串），然后通过取模的方式分发给后端redis。</p>
<ul>
<li>hash运算在这里是一种映射算法（其实就是归类），无论key的值是多长或多短，经过hash算法，都会输出成一个等宽的值（字符串）进行映射，算法有很多，比如：crc16、crc32、fnv、md5等等</li>
</ul>
<p>但是hash取模有一个弊端，就是模数值必须是固定的，比如下图：开始%3、%4，如果在后续再增加两台redis，那么这个模数值就需要发生变化， %3（redis1）的取模数据，就会放入到redis3或redis4。如果这个时候别的client去取值的话，数据已经可能不在redis1，所以会出现取不到数据的问题，也会影响分布式下的扩展性</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210510151241978.png" alt="image-20210510151241978"></p>
<h3 id="client的random分片算法"><a href="#client的random分片算法" class="headerlink" title="client的random分片算法"></a>client的random分片算法</h3><p>random的方式，也是数据不能拆分，那么使用random，就是通过随机扔给后端redis，这种方法会照成自己都不知道数据放入在那台redis中</p>
<p>但是它也有它的应用场景（消息队列），比如看下图：同使用一个k1，k1是list类型（list通过lpush的方式），里面有十个值，这十个值会随机分配到两台redis。另一个段的客户端可以通过rpop进行去除，就散是随机的，也是通过rpush按顺序去除。那么这种模式k1=topic，而每个redis就是parttion，等于topic%partition，与kafka定义是一样的，只不过kafka是基于磁盘的，而redis是使用内存的，而且速度更快。</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210510151338461.png"></p>
<p>所以说，虽然redis是基于进程的，进程只有4-5M，但是如果你把一些分布式的方法通过redis来应用也是可以的</p>
<h3 id="client的ketama算法（一致性hash）"><a href="#client的ketama算法（一致性hash）" class="headerlink" title="client的ketama算法（一致性hash）"></a>client的ketama算法（一致性hash）</h3><h4 id="什么是一致性hash"><a href="#什么是一致性hash" class="headerlink" title="什么是一致性hash"></a>什么是一致性hash</h4><p>在redis中hash算法，是将key映射成等宽长度的字符串，然后均匀的分配到服务器上，确保每台redis不会有太太的存储偏差。但是hash算法也有一个弊端。</p>
<p>比如：我们有5台服务器，通过hash算法将key的信息分配到5台服务器上，实现负载均衡。如果有一台redis服务器宕机了，key的信息会重新通过hash分配给4台服务器，操作几乎涉及所有服务器上的所有数据，工作量相当大（简而言之：hash算法增加或删除服务器，需要重新分配数据）</p>
<p>一致性hash算法（Consistent Hashing），就是在增加或删除服务器上，对原有的服务器和用户之间的映射关系产生的影响发挥到最小，算法能满足以下要求：</p>
<ul>
<li>平稳性：hash的最基本要求，均衡的分配数据到服务器</li>
<li>单调性：当date(数据)节点发生变动时，对于相同的date始终映射到相同的node(物理)节点中或者新增加的node节点中，避免无法找到原来的数据（但在redis使用还是会有一部分的数据丢失，新增节点如果接近date节点，那么用户在查询的过程中，会找离date节点近的node节点进行查询，但是新增节点并没有数据，所以会返回一个nil（简单来说：就是增节点可能会照成一些数据不能命中））</li>
<li>稳定性：当出现节点down掉或热数据访问需要动态扩容时，一致性hash可以尽量减少数据的移动</li>
</ul>
<h4 id="一致性hash的原理"><a href="#一致性hash的原理" class="headerlink" title="一致性hash的原理"></a>一致性hash的原理</h4><p>通过上述可以发现，一致性hash也是有弊端的，也会丢失一些数据。但是在增与删节点会对服务影响降到最少，以及对于数据移动会尽量减少。</p>
<p>那么一致性hash算法没有取模，所以不会有取模的模数固定，但一致性hash算法要求的是，需要date（虚拟）和node（物理）节点都进行hash运算，运算过程中会规划一个环形hash环，如下图</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210418215601120.png"></p>
<p>使用一致性hash算法，node1使用自己的参数（IP、host）通过这个算法跟hash映射数值，接着会在映射到圆环上，另一个节点node2也跟node1一样。如果有新的数据key来了，也进行hash映射数值，放入到圆环中。node节点都会具有排序，而通过算法算出的key也会进行排序，接着去找离自己最近的node节点，然后通过node节点存储数据key，如下图</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210418221454554.png"></p>
<p>如果在node1前面新增了一个node3，增加节点不会影响node1和node2数据，但是如果要查key的话，就会出现一个问题，它会先找到node3，而node3却没有你的数据。也就是新增节点会照成一部分的数据不能命中，如下图</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210418222116285.png"></p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>所以一致性hash既有优点也有缺点：</p>
<ul>
<li>优点：加节点，可以分担其他节点的压力，不会像取模算法照成全局洗牌（不用全部重新分配）</li>
<li>缺点，新增节点会照成一部分，数据不能命中（比如：查询数据会寻找自己最近的2个物理节点（node），在寻找过程中，如果两个node中都没有找到数据，就会击穿直到数据库，造成数据库压力）</li>
</ul>
<h2 id="Redis集群分片使用的工具"><a href="#Redis集群分片使用的工具" class="headerlink" title="Redis集群分片使用的工具"></a>Redis集群分片使用的工具</h2><h3 id="twemproxy分片"><a href="#twemproxy分片" class="headerlink" title="twemproxy分片"></a>twemproxy分片</h3><p>twemporxy（全称为“tow-em-proxy”），也叫nutcracker，是Twtter开源的，用于memcache和redis协议的快速轻量级代理。它的建立主要是为了减少与后端缓存服务器的连接数。</p>
<p>GitHub：<a target="_blank" rel="noopener" href="https://github.com/twitter/twemproxy">https://github.com/twitter/twemproxy</a></p>
<h4 id="twemporxy特性与缺点"><a href="#twemporxy特性与缺点" class="headerlink" title="twemporxy特性与缺点"></a>twemporxy特性与缺点</h4><p><strong>特性</strong></p>
<ul>
<li>快速且轻量级</li>
<li>可以维护持久的服务器连接</li>
<li>保持后端缓存服务器的连接数较低</li>
<li>支持多个服务器代理</li>
<li>同时支持多个服务器池</li>
<li>支持多种hash模式，包括一致性hash和分布…等等</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>不支持Redis事务操作</li>
<li>不支持对多个值的操作，比如交集并集等</li>
</ul>
<h4 id="twemproxy零拷贝"><a href="#twemproxy零拷贝" class="headerlink" title="twemproxy零拷贝"></a>twemproxy零拷贝</h4><p>在twemproxy中，用于传入请求和传输响应的所有内存都在mbuf中，Mbuf启动零拷贝（zero copy）。client会将接收请求相同的缓冲区将其转发到服务器。同样，从服务器接收到响应的同一个mbuf也用于将其转发到客户端</p>
<p>此外，mbufs的内存使用重用池进行管理，意味着，一旦分配了mbuf，就不会释放它，而是将其放回重用池中。默认情况下，每个mbuf块的大小是16字节。mbuf的大小和twemproxy可以支持的并发连接数之间需要权衡，较大的mbuf会减少读取请求或响应时twemproxy进行的读取系统调用的数量。但是，对于较大的mbuf，每个活动的连接都将占用16K字节的缓冲区，当twemproxy处理来自客户端的大量并发连接时。这可能是一个问题。twemproxy用于处理大量并发客户端连接时，应该使用-m或–mbuf-size = N 参数将块带下设置为较小的值，例如：512字节</p>
<h4 id="twemproxy的配置说明"><a href="#twemproxy的配置说明" class="headerlink" title="twemproxy的配置说明"></a>twemproxy的配置说明</h4><p>Twemproxy在进程启动时可以通过配置-c或–conf-file，来指定YAML配置文件，该配置文件用于指定的服务器池，以及管理每个池中的服务器，配置文件参数有如下</p>
<ul>
<li>listen：侦听的地址与断开，也可以是绝对路径的sock文件（例如：/var/run/nutcracker.sock）</li>
<li>client_connections：redis client允许最大连接数</li>
<li>hash：hash的函数名称，指定hash的算法。如：md5、crc16、crc32、fnv1_64等等</li>
<li>hash_tag：通过tag的方式，将key通过{}或$$的方法映射到同一台服务器上，只要标签中的相同就行。如：{kk}:k1、{kk}:k2、$$:k1、$$:k2</li>
<li>distribution：分布式的模式。如：ketama、modula、random</li>
<li>timeout：msec中的超时值，用于建立到服务器的连接或接受服务器的响应，默认情况下，可以不限时间</li>
<li>backlog：TCP backlog参数，默认为512</li>
<li>preconnect：布尔值，用于控制twemproxy是否应该在进程启动时预连接到池中的所有服务区，默认为flase</li>
<li>redis：布尔值，默认情况下是true，连接的是memcache协议，需要通过设置成flase，才是redis的协议</li>
<li>redis_auth：认证redis server的连接</li>
<li>redis_db：池服务区上使用的DB，默认值为0，Twemproxy就以DB 0的形成呈现给客户端</li>
<li>server_connections：可以打开每个服务器的最大连接，默认情况下，最大打开一个服务器连接</li>
<li>auto_eject_hosts：布尔值，控制当服务器连接失败server_failure_limit次数是否该临时弹出信息。有关信息，可以查询[liveness recommendations][<a target="_blank" rel="noopener" href="https://github.com/twitter/twemproxy/blob/master/notes/recommendation.md#liveness]%E8%BF%99%E4%B8%AA%E4%BF%A1%E6%81%AF%EF%BC%8C%E9%BB%98%E8%AE%A4%E5%80%BC%E4%B8%BAflase">https://github.com/twitter/twemproxy/blob/master/notes/recommendation.md#liveness]这个信息，默认值为flase</a></li>
<li>server_retry_timeout：当auto_eject_host设置为true时，在临时弹出的服务器上重新尝试之前，mesc中等待的超时值，默认为30000毫秒</li>
<li>server_failure_limit：当auto_eject_host设置为true是，将导致服务器临时弹出的连续失败次数，默认为2</li>
<li>server：服务器池的服务器地址，端口和权重</li>
</ul>
<p>配置文件的路径，在conf/nutcracker.yml，例如：下述的几个服务器池的配置</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">alpha</span>:</span><br><span class="line">  <span class="selector-tag">listen</span>: 127.0.0.1<span class="selector-pseudo">:22121</span>            //侦听的地址和端口</span><br><span class="line">  <span class="selector-tag">hash</span>: <span class="selector-tag">fnv1a_64</span>                     //使用的<span class="selector-tag">hash</span>算法</span><br><span class="line">  <span class="selector-tag">distribution</span>: <span class="selector-tag">ketama</span>               //分布式方式</span><br><span class="line">  <span class="selector-tag">auto_eject_hosts</span>: <span class="selector-tag">true</span>             //连接失败的临时弹出</span><br><span class="line">  <span class="selector-tag">redis</span>: <span class="selector-tag">true</span>                        //使用<span class="selector-tag">redis</span>协议</span><br><span class="line">  <span class="selector-tag">server_retry_timeout</span>: 2000         //连接失败后，2000毫秒，在重新连接</span><br><span class="line">  <span class="selector-tag">server_failure_limit</span>: 1            //连接失败1次，就临时弹出信息</span><br><span class="line">  <span class="selector-tag">servers</span>:                           //<span class="selector-tag">redis</span>服务的地址端口和权重，可以设置多个</span><br><span class="line">   <span class="selector-tag">-</span> 127.0.0.1<span class="selector-pseudo">:6379</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">beta</span>:</span><br><span class="line">  <span class="selector-tag">listen</span>: 127.0.0.1<span class="selector-pseudo">:22122</span></span><br><span class="line">  <span class="selector-tag">hash</span>: <span class="selector-tag">fnv1a_64</span></span><br><span class="line">  <span class="selector-tag">hash_tag</span>: &quot;&#123;&#125;&quot;</span><br><span class="line">  <span class="selector-tag">distribution</span>: <span class="selector-tag">ketama</span></span><br><span class="line">  <span class="selector-tag">auto_eject_hosts</span>: <span class="selector-tag">false</span></span><br><span class="line">  <span class="selector-tag">timeout</span>: 400</span><br><span class="line">  <span class="selector-tag">redis</span>: <span class="selector-tag">true</span></span><br><span class="line">  <span class="selector-tag">servers</span>:                         </span><br><span class="line">   <span class="selector-tag">-</span> 127.0.0.1<span class="selector-pseudo">:6380</span><span class="selector-pseudo">:1</span> <span class="selector-tag">server1</span></span><br><span class="line">   <span class="selector-tag">-</span> 127.0.0.1<span class="selector-pseudo">:6381</span><span class="selector-pseudo">:1</span> <span class="selector-tag">server2</span></span><br><span class="line">   <span class="selector-tag">-</span> 127.0.0.1<span class="selector-pseudo">:6382</span><span class="selector-pseudo">:1</span> <span class="selector-tag">server3</span></span><br><span class="line">   <span class="selector-tag">-</span> 127.0.0.1<span class="selector-pseudo">:6383</span><span class="selector-pseudo">:1</span> <span class="selector-tag">server4</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：twemproxy并不支持监控哨兵，只支持监控多个主Redis</p>
</blockquote>
<h4 id="twemproxy分配过程"><a href="#twemproxy分配过程" class="headerlink" title="twemproxy分配过程"></a>twemproxy分配过程</h4><p>client通过twemproxy连接redis，twemproxy选择不同的算法，比如：下图，选择了取模的方式，模数值是10，范围从0-9。twemproxy与redis中间会增加一个mapping（映射），将数据分配到两台主机</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210506094557599.png"></p>
<p>如需要增加节点，会重新进行hash分配给三台redis主机。因为使用的是取模的方法，所以会涉及到所有的数据，负担会加大。建议算法就使用一致性hash（ketama算法）</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210506094607448.png"></p>
<h3 id="Redis-Cluster"><a href="#Redis-Cluster" class="headerlink" title="Redis Cluster"></a>Redis Cluster</h3><h4 id="Redis-Cluster分配过程"><a href="#Redis-Cluster分配过程" class="headerlink" title="Redis Cluster分配过程"></a>Redis Cluster分配过程</h4><p>redis Cluster是Redis官方提供的集群化方法，是由三个节点组成的集群，集群没有主次关系，客户端可以想连接谁就连谁，一视同仁。</p>
<p>比如：如下图，客户端get k1，假设k1在redis2，通过hash之后，得到了4号槽位。而每个redis都有一个功能，就是将取模的算法放入到redis，然后根据算法的mapping对k1进行比对，如果redis2自己没有这个k1，就会重定向给其他redis主机。所以每台redis除了算法，还会有一张redis的映射关系表</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210419142327386.png"></p>
<p>但有一个问题，就是聚合操作很难实现，事务也很难实现，数据一旦被分开，就很难在一起使用</p>
<h4 id="Redis-Cluster的数据分槽"><a href="#Redis-Cluster的数据分槽" class="headerlink" title="Redis Cluster的数据分槽"></a>Redis Cluster的数据分槽</h4><p>Redis Cluster 将所有数据划分为16384个槽位，每个槽位负责其中一部分，槽位的信息存储于每个节点。每个key通过CRC 16校验后对16384取模来决定放置在哪个槽</p>
<p>例如：</p>
<ul>
<li>节点A包含0到5500号哈希槽</li>
<li>节点B包含5501到11000号哈希槽</li>
<li>节点C包含11001到16384号哈希槽</li>
</ul>
<p>如果想添加新的节点D，可以从A、B、C之间取一部分槽给D节点上。如果移除节点A，需要将A中的槽移动到B或C节点上，然后将没有任何槽的A节点从集群中移除即可。由于从一个节点将哈希槽移动到另一个节点并不会停止服务，所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态</p>
<p>此外，Redis Clster的每个节点会将集群的配置信息持久化到配置文件中，所以必须确保配置文件时可写的，而且尽量不要依靠人工修改配置文件</p>
<h3 id="predixy分片"><a href="#predixy分片" class="headerlink" title="predixy分片"></a>predixy分片</h3><p>上述的twemproxy是不支持哨兵的。而predixy是Redis哨兵、Redis集群的高性能和全功能代理。简单来说就是即支持Sentinel也支持Cluster</p>
<ul>
<li>后端为Redis Sentinel监控的一组Redis，功能完全等同于原始Redis</li>
<li>后端为Redis Sentinel监控的多组Redis，则有部分功能受限（如：事务）</li>
<li>后端为Redis Cluster，功能完全等同于Redis Cluster</li>
</ul>
<p>GitHub下载地址：<a target="_blank" rel="noopener" href="https://github.com/joyieldInc/predixy">https://github.com/joyieldInc/predixy</a></p>
<p>博客来源：<a target="_blank" rel="noopener" href="https://blog.csdn.net/rebaic/article/details/76384028">https://blog.csdn.net/rebaic/article/details/76384028</a></p>
<h4 id="predixy与其他工具的功能对比"><a href="#predixy与其他工具的功能对比" class="headerlink" title="predixy与其他工具的功能对比"></a>predixy与其他工具的功能对比</h4><table>
<thead>
<tr>
<th align="left"><strong>特性</strong></th>
<th align="left"><strong>predixy</strong></th>
<th align="left"><strong>twemproxy</strong></th>
<th align="left"><strong>codis</strong></th>
<th align="left"><strong>redis-cerberus</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">高可用</td>
<td align="left">Redis Sentinel或Redis Cluster</td>
<td align="left">一致性哈希</td>
<td align="left">Redis Sentinel</td>
<td align="left">Redis Cluster</td>
</tr>
<tr>
<td align="left">可扩展</td>
<td align="left">Key哈希分布或Redis Cluster</td>
<td align="left">Key哈希分布</td>
<td align="left">Key哈希分布</td>
<td align="left">Redis Cluster</td>
</tr>
<tr>
<td align="left">开发语言</td>
<td align="left">C++</td>
<td align="left">C</td>
<td align="left">GO</td>
<td align="left">C++</td>
</tr>
<tr>
<td align="left">多线程</td>
<td align="left">是</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">是</td>
</tr>
<tr>
<td align="left">事务</td>
<td align="left">Redis Sentinel模式单Redis组下支持</td>
<td align="left">不支持</td>
<td align="left">不支持</td>
<td align="left">不支持</td>
</tr>
<tr>
<td align="left">BLPOP/BRPOP/BLPOPRPUSH</td>
<td align="left">支持</td>
<td align="left">不支持</td>
<td align="left">不支持</td>
<td align="left">支持</td>
</tr>
<tr>
<td align="left">Pub/Sub</td>
<td align="left">支持</td>
<td align="left">不支持</td>
<td align="left">不支持</td>
<td align="left">支持</td>
</tr>
<tr>
<td align="left">Script</td>
<td align="left">支持load</td>
<td align="left">不支持</td>
<td align="left">不支持</td>
<td align="left">不支持</td>
</tr>
<tr>
<td align="left">Scan</td>
<td align="left">支持</td>
<td align="left">不支持</td>
<td align="left">不支持</td>
<td align="left">不支持</td>
</tr>
<tr>
<td align="left">Select DB</td>
<td align="left">支持</td>
<td align="left">不支持</td>
<td align="left">支持</td>
<td align="left">Redis Cluster只有一个DB</td>
</tr>
<tr>
<td align="left">Auth</td>
<td align="left">支持定义多个密码，给予不同读写及管理权限和Key访问空间</td>
<td align="left">不支持</td>
<td align="left">同redis</td>
<td align="left">不支持</td>
</tr>
<tr>
<td align="left">读从节点</td>
<td align="left">支持，可定义丰富规则读指定的从节点</td>
<td align="left">不支持</td>
<td align="left">支持，简单规则</td>
<td align="left">支持，简单规则</td>
</tr>
<tr>
<td align="left">多机房支持</td>
<td align="left">支持，可定义丰富规则调度流量</td>
<td align="left">不支持</td>
<td align="left">有限支持</td>
<td align="left">有限支持</td>
</tr>
<tr>
<td align="left">统计信息</td>
<td align="left">丰富</td>
<td align="left">丰富</td>
<td align="left">丰富</td>
<td align="left">简单</td>
</tr>
</tbody></table>
<blockquote>
<p>PS：关于更多的性能或其他问题，可以访问上述的GitHub和博客</p>
</blockquote>
<h4 id="predixy的配置说明"><a href="#predixy的配置说明" class="headerlink" title="predixy的配置说明"></a>predixy的配置说明</h4><p>predixy的配置类似redis，下载之后是在conf/目录下。每个配置文件的说明如下：</p>
<ul>
<li>predixy.conf：整体配置文件，会引用下面的配置文件</li>
<li>cluster.conf：用于Redis Cluster，配置后端redis信息</li>
<li>sentinel.conf：用于Redis Sentinel，配置侯丹redis信息</li>
<li>auth.conf：访问权限控制配置，可以定义多个验证密码，每个密码可设置读、写管理权限，以及定义可访问的键空间</li>
<li>dc.conf：多数据中心支持，可定义读写分离规则，读流量权重分配</li>
<li>latency.conf：延迟监控规定定义，可以指定需要监控的命令以及延迟时间间隔</li>
</ul>
<p>以sentinel配置文件为例，每个参数定义如下</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SentinelServerPool &#123;</span><br><span class="line">    <span class="selector-attr">[Password xxx]</span>       <span class="comment">//指定连接的redis实例默认的密码，不指定的情况下表示无密码     </span></span><br><span class="line">    <span class="selector-attr">[Databases number]</span>   <span class="comment">//指定redis db库数量，不指定默认为1</span></span><br><span class="line">    Hash atol|crc16      //对key采用的hash算法，当前只支持atol和crc16</span><br><span class="line">    <span class="selector-attr">[HashTag &quot;xx&quot;]</span>       <span class="comment">//指定哈希标签，不指定的话为&#123;&#125;</span></span><br><span class="line">    Distribution modula|random           //key使用的分片方法，当前只支持modula和random</span><br><span class="line">    <span class="selector-attr">[MasterReadPriority [0-100]</span>]         <span class="comment">//读写分离功能，从redis master节点执行读请求的优先级，默认为50，0表示禁止读redis master</span></span><br><span class="line">    <span class="selector-attr">[StaticSlaveReadPriority [0-100]</span>]    <span class="comment">//读写分离功能，从静态redis slave节点执行读请求的优先级，静态节点是指在本配置文件列出的redis节点，默认为0</span></span><br><span class="line">    <span class="selector-attr">[DynamicSlaveReadPriority [0-100]</span>]   <span class="comment">//动态节点指在本配置文件中没有列出，但是通过redis sentinel动态发现的节点，默认为0</span></span><br><span class="line">    <span class="selector-attr">[RefreshInterval number[s|ms|us]</span>]    <span class="comment">//周期性的请求redis sentinel以获取最新的集群信息，单位为秒，默认为1秒</span></span><br><span class="line">    <span class="selector-attr">[ServerTimeout number[s|ms|us]</span>]      <span class="comment">//请求在predixy中最长的处理/等待时间，如果超过该时间redis没有响应，则关闭连接，并返回错误响应（对于blpop阻塞式命令，该选项不起作用，为0则禁用此功能，即如果redis不返回就一直等待，默认为0）</span></span><br><span class="line">    <span class="selector-attr">[ServerFailureLimit number]</span>          <span class="comment">//一个redis实例出现多少次错误以后将其标记为失效，默认为10</span></span><br><span class="line">    <span class="selector-attr">[ServerRetryTimeout number[s|ms|us]</span>] <span class="comment">//一个redis实例失效后多久去检查是否恢复正常，默认为1</span></span><br><span class="line">    <span class="selector-attr">[KeepAlive seconds]</span>                  <span class="comment">//predixy与redis的tcp连接时间，0表示禁用此功能，默认为0</span></span><br><span class="line">    Sentinels &#123;                          <span class="comment">//指定sentinel的实例地址</span></span><br><span class="line">        + addr             </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    Group xxx &#123;                          <span class="comment">//定义一个redis组，Group的名字要与sentinel里的名字一直，Group可以显示列出redis地址，列出就是上面的静态节点。当然也可以默认不列出，不列出就会寻找动态节点</span></span><br><span class="line">        <span class="selector-attr">[+ addr]</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如下述的配置例子;</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SentinelServerPool &#123;</span><br><span class="line">    Databases 16</span><br><span class="line">    Hash crc16</span><br><span class="line">    HashTag &quot;&#123;&#125;&quot;</span><br><span class="line">    Distribution modula</span><br><span class="line">    MasterReadPriority 60</span><br><span class="line">    StaticSlaveReadPriority 50</span><br><span class="line">    DynamicSlaveReadPriority 50</span><br><span class="line">    RefreshInterval 1</span><br><span class="line">    ServerTimeout 1</span><br><span class="line">    ServerFailureLimit 10</span><br><span class="line">    ServerRetryTimeout 1</span><br><span class="line">    KeepAlive 120</span><br><span class="line">    Sentinels &#123;</span><br><span class="line">        + 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span>:<span class="number">26379</span></span><br><span class="line">        + <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">26380</span></span><br><span class="line">        + <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">26381</span></span><br><span class="line">    &#125;</span><br><span class="line">    Group master1 &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    Group master2 &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>该sentinel参数指定了是三个redis sentinel实例，分别是127.0.0.1:26379、127.0.0.1:26380、127.0.0.1:26381。</p>
</li>
<li><p>指定了两组redis，分别是master1和master2（命名可以自己自定义）。</p>
</li>
<li><p>没有指定静态节点，所有redis实例没有开启密码认证，指定了16个db，算法使用crc16计算key的哈希值，通过modula（取模）的方式将key分布到master1和master2实例中。</p>
</li>
<li><p>MasterReadPriority为60，比DynamicSlaveReadPriority为50的要大，所以读请求都会分到redis master节点。</p>
</li>
<li><p>RefreshInterval为1则每一秒钟向redis sentinel发送请求刷新集群信息。</p>
</li>
<li><p>ServerFailureLimit为10，表示redis实例失败累计达到10次后将该redis实例标记为失效，ServerRetryTimeout为1，每间隔1秒钟后检查是否恢复</p>
</li>
<li><p>KeepAlive为120，表示与tcp连接的时间，超过120没有客户端没有任何操作，则断开tcp连接</p>
</li>
</ul>
<blockquote>
<p>PS：需要了解更多的其他脚本参数信息，如：Redis Cluster和多数据中心等配置信息，可参考作者GitHub上的[详细文档][<a target="_blank" rel="noopener" href="https://github.com/joyieldInc/predixy/blob/master/doc/config_CN.md]">https://github.com/joyieldInc/predixy/blob/master/doc/config_CN.md]</a></p>
</blockquote>
<h2 id="Redis集群分片实例"><a href="#Redis集群分片实例" class="headerlink" title="Redis集群分片实例"></a>Redis集群分片实例</h2><h3 id="twemproxy实例"><a href="#twemproxy实例" class="headerlink" title="twemproxy实例"></a>twemproxy实例</h3><h4 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h4><p>下载twemproxy源码包并进行编译(debug版本)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/twitter/twemproxy.git</span><br><span class="line">$ cd twemproxy</span><br><span class="line">$ autoreconf -fvi</span><br><span class="line">$ ./configure --enable-debug=full</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line">$ nutcracker -h</span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：autoreconf -fvi &amp;&amp; ./configure 在执行前需要安装automake和libtool两个包</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y automake libtool</span><br></pre></td></tr></table></figure>
<p>编译完后复制启动脚本到/etc/init.d</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/<span class="selector-tag">opt</span>/<span class="selector-tag">twemproxy</span>/<span class="selector-tag">scripts</span></span><br><span class="line">$ cp nutcracker.init /etc/init.d/nutcracker</span><br><span class="line">$ /etc/init.d/nutcracker [start/stop/restart]</span><br></pre></td></tr></table></figure>
<h4 id="编写配置文件，启动实例"><a href="#编写配置文件，启动实例" class="headerlink" title="编写配置文件，启动实例"></a>编写配置文件，启动实例</h4><p>编译完成的配置文件在/etc/nutcracker目录下。上文说过，twemproxy是不支持sentinel的，只支持使用多个主的redis</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ cp nutcracker.yml&#123;,.bak&#125;</span><br><span class="line">$ vi /etc/nutcracker/nutcracker.yml</span><br><span class="line"><span class="selector-tag">alpha</span>:</span><br><span class="line">  <span class="selector-tag">listen</span>: 127.0.0.1<span class="selector-pseudo">:22121</span></span><br><span class="line">  <span class="selector-tag">hash</span>: <span class="selector-tag">fnv1a_64</span></span><br><span class="line">  <span class="selector-tag">distribution</span>: <span class="selector-tag">ketama</span></span><br><span class="line">  <span class="selector-tag">auto_eject_hosts</span>: <span class="selector-tag">true</span></span><br><span class="line">  <span class="selector-tag">redis</span>: <span class="selector-tag">true</span></span><br><span class="line">  <span class="selector-tag">server_retry_timeout</span>: 2000</span><br><span class="line">  <span class="selector-tag">server_failure_limit</span>: 1</span><br><span class="line">  <span class="selector-tag">servers</span>:</span><br><span class="line">   <span class="selector-tag">-</span> 127.0.0.1<span class="selector-pseudo">:6379</span><span class="selector-pseudo">:1</span></span><br><span class="line">   <span class="selector-tag">-</span> 127.0.0.1<span class="selector-pseudo">:6380</span><span class="selector-pseudo">:1</span></span><br></pre></td></tr></table></figure>
<p>启动redis6379和6380主机（两个实例之间是互相独立的），重启nutcracker，并测试查看两台实例的接收的数据</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ redis-server /opt/redis_cluster/redis_6380/conf/redis_6380.conf</span><br><span class="line">$ redis-server /opt/redis_cluster/redis_6379/conf/redis_6379.conf</span><br><span class="line">$ /etc/init.d/nutcracker</span><br><span class="line"><span class="selector-tag">Starting</span> <span class="selector-tag">twemproxy</span> (<span class="selector-tag">via</span> <span class="selector-tag">systemctl</span>):                        <span class="selector-attr">[  OK  ]</span></span><br><span class="line"></span><br><span class="line">$ redis-cli -p 22121</span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k1</span> <span class="selector-tag">v1</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k2</span> <span class="selector-tag">v2</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k3</span> <span class="selector-tag">v3</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">set</span> 1 <span class="selector-tag">sgadfsa</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line"></span><br><span class="line">//<span class="selector-tag">Redis</span> 6379实例</span><br><span class="line">$ redis-cli -p 6379</span><br><span class="line">&gt; <span class="selector-tag">keys</span> *</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line"></span><br><span class="line">//<span class="selector-tag">Redis</span> 6380实例</span><br><span class="line">$ redis-cli -p 6380</span><br><span class="line">&gt; <span class="selector-tag">keys</span> *</span><br><span class="line">1) &quot;<span class="selector-tag">k3</span>&quot;</span><br><span class="line">2) &quot;<span class="selector-tag">k2</span>&quot;</span><br><span class="line">3) &quot;<span class="selector-tag">k1</span>&quot;	</span><br></pre></td></tr></table></figure>
<h3 id="Redis-Cluster实例"><a href="#Redis-Cluster实例" class="headerlink" title="Redis Cluster实例"></a>Redis Cluster实例</h3><h4 id="手动搭建redis-cluster"><a href="#手动搭建redis-cluster" class="headerlink" title="手动搭建redis cluster"></a>手动搭建redis cluster</h4><ul>
<li>准备三台redis主机，每台主机部署主动节点（这里分别是redis-1(10.0.0.50)、redis-2(10.0.0.51)、redis-3(10.0.0.52)）</li>
<li>一台配置完，通过rsync或scp发送配置信息修改其他主机（或通过Ansible批量部署）</li>
<li>一个集群里有16384个槽位（0-16383），平均为5461个槽位</li>
<li>各个节点主从分配，如下图</li>
</ul>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210507111511548.png"></p>
<p><strong>redis-1部署（地址：10.0.0.50）</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /opt/redis_cluster/redis_&#123;6380,6381&#125;/&#123;conf,logs,pid&#125;</span><br><span class="line">$ mkdir -p /data/redis_cluster/redis_&#123;6380,6381&#125;</span><br><span class="line"></span><br><span class="line">//创建<span class="selector-tag">redis_6380</span><span class="selector-class">.conf</span>文件，并写入下述内容（6381一致）</span><br><span class="line">$ cat /opt/redis_cluster/redis_6380/conf/redis_6380.conf</span><br><span class="line"><span class="selector-tag">daemonize</span> <span class="selector-tag">yes</span></span><br><span class="line"><span class="selector-tag">bind</span> 10.0.0.50</span><br><span class="line"><span class="selector-tag">port</span> 6380</span><br><span class="line"><span class="selector-tag">pidfile</span> &quot;/<span class="selector-tag">opt</span>/<span class="selector-tag">redis_cluster</span>/<span class="selector-tag">redis_6380</span>/<span class="selector-tag">pid</span>/<span class="selector-tag">redis_6380</span><span class="selector-class">.pid</span>&quot;</span><br><span class="line"><span class="selector-tag">logfile</span> &quot;/<span class="selector-tag">opt</span>/<span class="selector-tag">redis_cluster</span>/<span class="selector-tag">redis_6380</span>/<span class="selector-tag">logs</span>/<span class="selector-tag">redis_6380</span><span class="selector-class">.log</span>&quot;</span><br><span class="line"><span class="selector-tag">dbfilename</span> &quot;<span class="selector-tag">redis_6380</span><span class="selector-class">.rdb</span>&quot;</span><br><span class="line"><span class="selector-tag">dir</span> &quot;/<span class="selector-tag">data</span>/<span class="selector-tag">redis_cluster</span>/<span class="selector-tag">redis_6380</span>&quot;</span><br><span class="line"><span class="selector-tag">cluster-enabled</span> <span class="selector-tag">yes</span>                      //激活集群模式</span><br><span class="line"><span class="selector-tag">cluster-config-file</span> <span class="selector-tag">nodes_6380</span><span class="selector-class">.conf</span>      //集群的配置文件</span><br><span class="line"><span class="selector-tag">cluster-node-timeout</span> 15000               //集群的超时时间</span><br><span class="line"></span><br><span class="line">$ cd /opt/redis_cluster/</span><br><span class="line">$ cp redis_6380/conf/redis_6380.conf redis_6381/conf/redis_6381.conf</span><br><span class="line">$ sed -i &#x27;s#6380#6381#g&#x27; redis_6381/conf/redis_6381.conf</span><br><span class="line"></span><br><span class="line">//传输到其他<span class="selector-tag">redis</span>主机</span><br><span class="line">$ rsync -avz /opt/redis_cluster/redis_638* redis-2:/opt/redis_cluster/</span><br><span class="line">$ rsync -avz /opt/redis_cluster/redis_638* redis-3:/opt/redis_cluster/</span><br><span class="line"></span><br><span class="line">//启动服务并查看进程</span><br><span class="line">$ redis-server /opt/redis_cluster/redis_6380/conf/redis_6380.conf</span><br><span class="line">$ redis-server /opt/redis_cluster/redis_6381/conf/redis_6381.conf </span><br><span class="line">$ ps -ef|grep redis</span><br><span class="line"><span class="selector-tag">root</span>       8987      1  0 21<span class="selector-pseudo">:21</span> ?        00<span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span> <span class="selector-tag">redis-server</span> 10.0.0.50<span class="selector-pseudo">:6380</span> <span class="selector-attr">[cluster]</span></span><br><span class="line"><span class="selector-tag">root</span>       9000      1  0 21<span class="selector-pseudo">:21</span> ?        00<span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span> <span class="selector-tag">redis-server</span> 10.0.0.50<span class="selector-pseudo">:6380</span> <span class="selector-attr">[cluster]</span></span><br></pre></td></tr></table></figure>
<p><strong>redis-2部署（地址：10.0.0.51）</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ find /opt/redis_cluster/redis_638* -type f -name &#x27;*.conf&#x27;|xargs sed -i &quot;/bind/s#50#51#g&quot;</span><br><span class="line">$ mkdir -p /data/redis_cluster/redis_&#123;6380,6381&#125;</span><br><span class="line"></span><br><span class="line">//启动服务并查看进程</span><br><span class="line">$ redis-server /opt/redis_cluster/redis_6380/conf/redis_6380.conf </span><br><span class="line">$ redis-server /opt/redis_cluster/redis_6381/conf/redis_6381.conf </span><br><span class="line">$ ps -ef|grep redis</span><br><span class="line"><span class="selector-tag">root</span>       7986      1  0 21<span class="selector-pseudo">:24</span> ?        00<span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span> <span class="selector-tag">redis-server</span> 10.0.0.51<span class="selector-pseudo">:6380</span> <span class="selector-attr">[cluster]</span></span><br><span class="line"><span class="selector-tag">root</span>       8022      1  0 21<span class="selector-pseudo">:25</span> ?        00<span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span> <span class="selector-tag">redis-server</span> 10.0.0.51<span class="selector-pseudo">:6381</span> <span class="selector-attr">[cluster]</span></span><br></pre></td></tr></table></figure>
<p><strong>redis-3部署（地址：10.0.0.51）</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ find /opt/redis_cluster/redis_638* -type f -name &#x27;*.conf&#x27;|xargs sed -i &quot;/bind/s#50#52#g&quot;</span><br><span class="line">$ mkdir -p /data/redis_cluster/redis_&#123;6380,6381&#125;</span><br><span class="line"></span><br><span class="line">//启动服务并查看进程</span><br><span class="line">$ redis-server /opt/redis_cluster/redis_6380/conf/redis_6380.conf </span><br><span class="line">$ redis-server /opt/redis_cluster/redis_6381/conf/redis_6381.conf </span><br><span class="line">$ ps -ef|grep redis</span><br><span class="line"><span class="selector-tag">root</span>       9140      1  0 21<span class="selector-pseudo">:32</span> ?        00<span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span> <span class="selector-tag">redis-server</span> 10.0.0.42<span class="selector-pseudo">:6380</span> <span class="selector-attr">[cluster]</span></span><br><span class="line"><span class="selector-tag">root</span>       9144      1  0 21<span class="selector-pseudo">:33</span> ?        00<span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span> <span class="selector-tag">redis-server</span> 10.0.0.42<span class="selector-pseudo">:6381</span> <span class="selector-attr">[cluster]</span></span><br></pre></td></tr></table></figure>
<h5 id="通过脚本启停"><a href="#通过脚本启停" class="headerlink" title="通过脚本启停"></a>通过脚本启停</h5><p>脚本内容，根据自己对redis的启停习惯，不一定要使用脚本启停</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">$ cat redis_shell.sh </span><br><span class="line">#!/<span class="selector-tag">bin</span>/<span class="selector-tag">bash</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">USAG</span>()&#123;</span><br><span class="line">    echo &quot;sh $0 &#123;start|stop|restart|login|ps|tail&#125; PORT&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">if</span> <span class="selector-attr">[ <span class="string">&quot;$#&quot;</span> = 1 ]</span></span><br><span class="line"><span class="selector-tag">then</span></span><br><span class="line">    REDIS_PORT=&#x27;6379&#x27;</span><br><span class="line"><span class="selector-tag">elif</span> </span><br><span class="line">    <span class="selector-attr">[ <span class="string">&quot;$#&quot;</span> = 2 -a -z <span class="string">&quot;$(echo &quot;</span>$2<span class="string">&quot;|sed &#x27;s#[0-9]##g&#x27;)&quot;</span> ]</span></span><br><span class="line"><span class="selector-tag">then</span></span><br><span class="line">    REDIS_PORT=&quot;$2&quot;</span><br><span class="line"><span class="selector-tag">else</span></span><br><span class="line">    <span class="selector-tag">USAG</span></span><br><span class="line">    <span class="selector-tag">exit</span> 0</span><br><span class="line"><span class="selector-tag">fi</span></span><br><span class="line"></span><br><span class="line">REDIS_IP=$(hostname -I|awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">PATH_DIR=/opt/redis_cluster/redis_$&#123;REDIS_PORT&#125;/</span><br><span class="line">PATH_CONF=/opt/redis_cluster/redis_$&#123;REDIS_PORT&#125;/conf/redis_$&#123;REDIS_PORT&#125;.conf</span><br><span class="line">PATH_LOG=/opt/redis_cluster/redis_$&#123;REDIS_PORT&#125;/logs/redis_$&#123;REDIS_PORT&#125;.log</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">CMD_START</span>()&#123;</span><br><span class="line">    redis-server $&#123;PATH_CONF&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">CMD_SHUTDOWN</span>()&#123;</span><br><span class="line">    redis-cli -c -h $&#123;REDIS_IP&#125; -p $&#123;REDIS_PORT&#125; shutdown</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">CMD_LOGIN</span>()&#123;</span><br><span class="line">    redis-cli -c -h $&#123;REDIS_IP&#125; -p $&#123;REDIS_PORT&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">CMD_PS</span>()&#123;</span><br><span class="line">    ps -ef|grep redis</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">CMD_TAIL</span>()&#123;</span><br><span class="line">    tail -f $&#123;PATH_LOG&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">    <span class="selector-tag">start</span>)</span><br><span class="line">        <span class="selector-tag">CMD_START</span></span><br><span class="line">        <span class="selector-tag">CMD_PS</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="selector-tag">stop</span>)</span><br><span class="line">        <span class="selector-tag">CMD_SHUTDOWN</span></span><br><span class="line">        <span class="selector-tag">CMD_PS</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="selector-tag">restart</span>)</span><br><span class="line">        <span class="selector-tag">CMD_START</span></span><br><span class="line">        <span class="selector-tag">CMD_SHUTDOWN</span></span><br><span class="line">        <span class="selector-tag">CMD_PS</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="selector-tag">login</span>)</span><br><span class="line">        <span class="selector-tag">CMD_LOGIN</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="selector-tag">ps</span>)</span><br><span class="line">        <span class="selector-tag">CMD_PS</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="selector-tag">tail</span>)</span><br><span class="line">        <span class="selector-tag">CMD_TAIL</span></span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="selector-tag">USAG</span></span><br><span class="line"><span class="selector-tag">esac</span></span><br></pre></td></tr></table></figure>
<p>我的脚本路径是/server/scripts，在此配置环境变量</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ tail -n 1 /etc/profile</span><br><span class="line">export PATH=$PATH:/server/scripts</span><br><span class="line">$ chmod u+x /server/scripts/redis_shell.sh</span><br><span class="line">$ source /etc/profile</span><br><span class="line"></span><br><span class="line">//传输到其他主机，然后加载上述的环境变量</span><br><span class="line">$ scp redis_shell.sh redis-2:/server/scripts</span><br><span class="line">$ scp redis_shell.sh redis-3:/server/scripts</span><br></pre></td></tr></table></figure>
<p>通过脚本启停实例</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ redis_shell.sh stop 6380</span><br><span class="line">$ redis_shell.sh start 6380</span><br><span class="line">$ redis_shell.sh login 6380     //登录</span><br><span class="line">10.0.0.50&gt; </span><br></pre></td></tr></table></figure>
<h5 id="集群搭建部署"><a href="#集群搭建部署" class="headerlink" title="集群搭建部署"></a>集群搭建部署</h5><p>redis-1可以先查看数据节点文件，登录6380查看，然后进行对比看是否一致</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /data/redis_cluster/redis_6380/nodes_6380.conf </span><br><span class="line">35510f4c3ced3411f7abdf6384e631714f527d6f :<span class="number">0</span>@<span class="number">0</span> myself,master - <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> connected</span><br><span class="line">vars currentEpoch <span class="number">0</span> lastVoteEpoch <span class="number">0</span></span><br><span class="line">$ redis_shell.sh login <span class="number">6380</span></span><br><span class="line"><span class="number">10.0</span>.<span class="number">0.50</span>&gt; cluster nodes</span><br><span class="line"><span class="number">35510</span>f4c3ced3411f7abdf6384e631714f527d6f :<span class="number">6380</span>@<span class="number">16380</span> myself,master - <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> connected</span><br></pre></td></tr></table></figure>
<p>redis-1（10.0.0.50）寻找6380其他节点加入集群：CLUSTER MEET</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">cluster</span> <span class="selector-tag">meet</span> 10.0.0.51 6380</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">cluster</span> <span class="selector-tag">meet</span> 10.0.0.52 6380</span><br><span class="line"><span class="selector-tag">OK</span>  </span><br><span class="line">&gt; <span class="selector-tag">cluster</span> <span class="selector-tag">meet</span> 10.0.0.50 6381</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">cluster</span> <span class="selector-tag">meet</span> 10.0.0.51 6381</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">cluster</span> <span class="selector-tag">meet</span> 10.0.0.52 6381</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">CLUSTER</span> <span class="selector-tag">NODES</span></span><br><span class="line">69614421<span class="selector-tag">b333bb23a4a5e5bac3dbf0f316f6f1d8</span> 10.0.0.51<span class="selector-pseudo">:6381</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601906195574 4 <span class="selector-tag">connected</span></span><br><span class="line">655<span class="selector-tag">d56a8b9448dcc16f765268c65618a762588ae</span> 10.0.0.52<span class="selector-pseudo">:6380</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601906196583 2 <span class="selector-tag">connected</span></span><br><span class="line">0<span class="selector-tag">f5d52468b67497d4cee08c5556c530737e9d04b</span> 10.0.0.50<span class="selector-pseudo">:6381</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601906194567 3 <span class="selector-tag">connected</span></span><br><span class="line">2<span class="selector-tag">da9331b3c2edaf0a2e46b19219f7dc0e5b703af</span> 10.0.0.50<span class="selector-pseudo">:6380</span> <span class="selector-tag">myself</span>,<span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 0 1 <span class="selector-tag">connected</span></span><br><span class="line"><span class="selector-tag">de5e61d765498747d46957b73fc55e413f58e0a9</span> 10.0.0.51<span class="selector-pseudo">:6380</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601906197589 0 <span class="selector-tag">connected</span></span><br><span class="line">0<span class="selector-tag">b176001007771efe27cf46053802b419768fa06</span> 10.0.0.52<span class="selector-pseudo">:6381</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601906196179 0 <span class="selector-tag">connected</span></span><br></pre></td></tr></table></figure>
<p>集群现在还没有分槽，所以查看cluster info，集群是显示失败的</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">10.0.0.50<span class="selector-pseudo">:6380</span>&gt; <span class="selector-tag">cluster</span> <span class="selector-tag">info</span></span><br><span class="line"><span class="selector-tag">cluster_state</span><span class="selector-pseudo">:fail</span></span><br><span class="line"><span class="selector-tag">cluster_slots_assigned</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">cluster_slots_ok</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">cluster_slots_pfail</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">cluster_slots_fail</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">cluster_known_nodes</span><span class="selector-pseudo">:6</span></span><br><span class="line"><span class="selector-tag">cluster_size</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">cluster_current_epoch</span><span class="selector-pseudo">:5</span></span><br><span class="line"><span class="selector-tag">cluster_my_epoch</span><span class="selector-pseudo">:1</span></span><br><span class="line"><span class="selector-tag">cluster_stats_messages_sent</span><span class="selector-pseudo">:5009</span></span><br><span class="line"><span class="selector-tag">cluster_stats_messages_received</span><span class="selector-pseudo">:4110</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>分槽位需要在每个主节点上配置，此时有2中方法执行</p>
<ul>
<li>分别登陆到每个主节点的客户端来执行命令</li>
<li>在其他一台redis主机上通过远程方式登陆到其他机器的主机点上执行命令</li>
</ul>
<p>下述是通过每个节点执行命令</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -h redis-1 -p 6380 cluster addslots &#123;0..5461&#125;</span><br><span class="line">$ redis-cli -h redis-2 -p 6380 cluster addslots &#123;5462..10922&#125;</span><br><span class="line">$ redis-cli -h redis-3 -p 6380 cluster addslots &#123;10923..16383&#125;</span><br></pre></td></tr></table></figure>
<p>分配完所有槽位之后再去查看集群的节点状态，并查看每个节点的分配情况</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -h redis-1 -p 6380</span><br><span class="line">&gt; <span class="selector-tag">cluster</span> <span class="selector-tag">info</span></span><br><span class="line"><span class="selector-tag">cluster_state</span><span class="selector-pseudo">:ok</span></span><br><span class="line"><span class="selector-tag">cluster_slots_assigned</span><span class="selector-pseudo">:16384</span></span><br><span class="line"><span class="selector-tag">cluster_slots_ok</span><span class="selector-pseudo">:16384</span></span><br><span class="line"><span class="selector-tag">cluster_slots_pfail</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">cluster_slots_fail</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">cluster_known_nodes</span><span class="selector-pseudo">:6</span></span><br><span class="line"><span class="selector-tag">cluster_size</span><span class="selector-pseudo">:3</span></span><br><span class="line"><span class="selector-tag">cluster_current_epoch</span><span class="selector-pseudo">:5</span></span><br><span class="line"><span class="selector-tag">cluster_my_epoch</span><span class="selector-pseudo">:1</span></span><br><span class="line"><span class="selector-tag">cluster_stats_messages_sent</span><span class="selector-pseudo">:5888</span></span><br><span class="line"><span class="selector-tag">cluster_stats_messages_received</span><span class="selector-pseudo">:4989</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">//查看每个节点分配</span><br><span class="line"><span class="selector-tag">redis-1</span><span class="selector-pseudo">:6380</span>&gt; <span class="selector-tag">cluster</span> <span class="selector-tag">nodes</span></span><br><span class="line">69614421<span class="selector-tag">b333bb23a4a5e5bac3dbf0f316f6f1d8</span> 10.0.0.51<span class="selector-pseudo">:6381</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601908073592 4 <span class="selector-tag">connected</span></span><br><span class="line">655<span class="selector-tag">d56a8b9448dcc16f765268c65618a762588ae</span> 10.0.0.52<span class="selector-pseudo">:6380</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601908069562 2 <span class="selector-tag">connected</span> 10923<span class="selector-tag">-16383</span></span><br><span class="line">0<span class="selector-tag">f5d52468b67497d4cee08c5556c530737e9d04b</span> 10.0.0.50<span class="selector-pseudo">:6381</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601908072584 3 <span class="selector-tag">connected</span></span><br><span class="line">2<span class="selector-tag">da9331b3c2edaf0a2e46b19219f7dc0e5b703af</span> 10.0.0.50<span class="selector-pseudo">:6380</span> <span class="selector-tag">myself</span>,<span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 0 1 <span class="selector-tag">connected</span> 0<span class="selector-tag">-5461</span></span><br><span class="line"><span class="selector-tag">de5e61d765498747d46957b73fc55e413f58e0a9</span> 10.0.0.51<span class="selector-pseudo">:6380</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601908070569 0 <span class="selector-tag">connected</span> 5462<span class="selector-tag">-10922</span></span><br><span class="line">0<span class="selector-tag">b17600100771efe27cf46053802b419768fa06</span> 10.0.0.52<span class="selector-pseudo">:6381</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601908071576 5 <span class="selector-tag">connected</span></span><br></pre></td></tr></table></figure>
<h5 id="创建每个节点的复制关系"><a href="#创建每个节点的复制关系" class="headerlink" title="创建每个节点的复制关系"></a>创建每个节点的复制关系</h5><ul>
<li>redis-1 6380为主，redis-3 6381为从</li>
<li>redis-2 6380为主，redis-1 6381为从</li>
<li>redis-3 6380为主，redis-2 6381为从</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -h redis-1 -p 6381 cluster replicate de5e61d765498747d46957b73fc55e413f58e0a9</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">$ redis-cli -h redis-2 -p 6381 cluster replicate 655d56a8b9448dcc16f765268c65618a762588ae</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">$ redis-cli -h redis-3 -p 6381 cluster replicate 2da9331b3c2edaf0a2e46b19219f7dc0e5b703af</span><br><span class="line"><span class="selector-tag">OK</span></span><br></pre></td></tr></table></figure>
<p>查看集群情况</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -c  -h redis-1 -p 6380 </span><br><span class="line"><span class="selector-tag">redis-1</span>&gt; <span class="selector-tag">cluster</span> <span class="selector-tag">nodes</span></span><br><span class="line">69614421<span class="selector-tag">b333bb23a4a5e5bac3dbf0f316f6f1d8</span> 10.0.0.51<span class="selector-pseudo">:6381</span> <span class="selector-tag">slave</span> 655<span class="selector-tag">d56a8b9448dcc16f765268c65618a762588ae</span> 0 1601910928235 4 <span class="selector-tag">connected</span></span><br><span class="line">655<span class="selector-tag">d56a8b9448dcc16f765268c65618a762588ae</span> 10.0.0.52<span class="selector-pseudo">:6380</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601910931256 2 <span class="selector-tag">connected</span> 10923<span class="selector-tag">-16383</span></span><br><span class="line">0<span class="selector-tag">f5d52468b67497d4cee08c5556c530737e9d04b</span> 10.0.0.50<span class="selector-pseudo">:6381</span> <span class="selector-tag">slave</span> <span class="selector-tag">de5e61d765498747d46957b73fc55e413f58e0a9</span> 0 1601910929242 3 <span class="selector-tag">connected</span></span><br><span class="line">2<span class="selector-tag">da9331b3c2edaf0a2e46b19219f7dc0e5b703af</span> 10.0.0.50<span class="selector-pseudo">:6380</span> <span class="selector-tag">myself</span>,<span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 0 1 <span class="selector-tag">connected</span> 0<span class="selector-tag">-5461</span></span><br><span class="line"><span class="selector-tag">de5e61d765498747d46957b73fc55e413f58e0a9</span> 10.0.0.51<span class="selector-pseudo">:6380</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601910932263 0 <span class="selector-tag">connected</span> 5462<span class="selector-tag">-10922</span></span><br><span class="line">0<span class="selector-tag">b17600100771efe27cf46053802b419768fa06</span> 10.0.0.52<span class="selector-pseudo">:6381</span> <span class="selector-tag">slave</span> 2<span class="selector-tag">da9331b3c2edaf0a2e46b19219f7dc0e5b703af</span> 0 1601908071576 5 <span class="selector-tag">connected</span></span><br></pre></td></tr></table></figure>
<h5 id="redis-cluster-故障转移"><a href="#redis-cluster-故障转移" class="headerlink" title="redis cluster 故障转移"></a>redis cluster 故障转移</h5><p>模拟一台主机的redis节点down机，然后查看集群的变化。使用暴力的方法kill -9杀掉redis-1的6380节点，理想情况下是redis-3的6381会升级为主节点</p>
<p>kill -9 杀掉 redis-1的6380节点</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ps -ef|grep redis</span><br><span class="line"><span class="selector-tag">root</span>       9152      1  0 21<span class="selector-pseudo">:34</span> ?        00<span class="selector-pseudo">:00</span><span class="selector-pseudo">:12</span> <span class="selector-tag">redis-server</span> 10.0.0.50<span class="selector-pseudo">:6380</span> <span class="selector-attr">[cluster]</span></span><br><span class="line"><span class="selector-tag">root</span>       9173      1  0 21<span class="selector-pseudo">:34</span> ?        00<span class="selector-pseudo">:00</span><span class="selector-pseudo">:11</span> <span class="selector-tag">redis-server</span> 10.0.0.50<span class="selector-pseudo">:6381</span> <span class="selector-attr">[cluster]</span></span><br><span class="line">$ kill -9 9152</span><br><span class="line">$ ps -ef|grep redis</span><br><span class="line"><span class="selector-tag">root</span>       9173      1  0 21<span class="selector-pseudo">:34</span> ?        00<span class="selector-pseudo">:00</span><span class="selector-pseudo">:11</span> <span class="selector-tag">redis-server</span> 10.0.0.50<span class="selector-pseudo">:6381</span> <span class="selector-attr">[cluster]</span></span><br></pre></td></tr></table></figure>
<p>这里需要注意故障转移的时间，我们在配置文件的故障转移的时间设置是15秒，所以需要等待一下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /opt/redis_cluster/redis_6381/conf/redis_6381.conf|grep cluster-node</span><br><span class="line"><span class="selector-tag">cluster-node-timeout</span> 15000</span><br></pre></td></tr></table></figure>
<p>查看日志变化</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tail -f /opt/redis_cluster/redis_6381/logs/redis_6381.log </span><br><span class="line">9173<span class="selector-pseudo">:S</span> 05 <span class="selector-tag">Oct</span> 23<span class="selector-pseudo">:21</span><span class="selector-pseudo">:12.044</span> * <span class="selector-tag">FAIL</span> <span class="selector-tag">message</span> <span class="selector-tag">received</span> <span class="selector-tag">from</span> 655<span class="selector-tag">d56a8b9448dcc16f765268c65618a762588ae</span> <span class="selector-tag">about</span> 2<span class="selector-tag">da9331b3c2edaf0a2e46b19219f7dc0e5b703af</span></span><br><span class="line">9173<span class="selector-pseudo">:S</span> 05 <span class="selector-tag">Oct</span> 23<span class="selector-pseudo">:21</span><span class="selector-pseudo">:12.045</span> # <span class="selector-tag">Cluster</span> <span class="selector-tag">state</span> <span class="selector-tag">changed</span>: <span class="selector-tag">fail</span></span><br><span class="line">9173<span class="selector-pseudo">:S</span> 05 <span class="selector-tag">Oct</span> 23<span class="selector-pseudo">:22</span><span class="selector-pseudo">:12.165</span> # <span class="selector-tag">Cluster</span> <span class="selector-tag">state</span> <span class="selector-tag">changed</span>: <span class="selector-tag">ok</span></span><br></pre></td></tr></table></figure>
<p>登录任意一个节点查看集群的状态，状态是ok就代表集群是可用的</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">cluster</span> <span class="selector-tag">info</span></span><br><span class="line"><span class="selector-tag">cluster_state</span><span class="selector-pseudo">:ok</span></span><br><span class="line"><span class="selector-tag">cluster_slots_assigned</span><span class="selector-pseudo">:16384</span></span><br><span class="line"><span class="selector-tag">cluster_slots_ok</span><span class="selector-pseudo">:16384</span></span><br><span class="line"><span class="selector-tag">cluster_slots_pfail</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">cluster_slots_fail</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">cluster_known_nodes</span><span class="selector-pseudo">:6</span></span><br><span class="line"><span class="selector-tag">cluster_size</span><span class="selector-pseudo">:3</span></span><br><span class="line"><span class="selector-tag">cluster_current_epoch</span><span class="selector-pseudo">:7</span></span><br><span class="line"><span class="selector-tag">cluster_my_epoch</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">cluster_stats_messages_sent</span><span class="selector-pseudo">:13994</span></span><br><span class="line"><span class="selector-tag">cluster_stats_messages_received</span><span class="selector-pseudo">:11384</span></span><br></pre></td></tr></table></figure>
<p>在查看集群节点的变化情况，会发现10.0.0.50:6380主机是显示fail的</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">Cluster</span> <span class="selector-tag">nodes</span></span><br><span class="line">69614421<span class="selector-tag">b333bb23a4a5e5bac3dbf0f316f6f1d8</span> 10.0.0.51<span class="selector-pseudo">:6381</span> <span class="selector-tag">slave</span> 655<span class="selector-tag">d56a8b9448dcc16f765268c65618a762588ae</span> 0 1601911527064 4 <span class="selector-tag">connected</span></span><br><span class="line">2<span class="selector-tag">da9331b3c2edaf0a2e46b19219f7dc0e5b703af</span> 10.0.0.50<span class="selector-pseudo">:6380</span> <span class="selector-tag">master</span>,<span class="selector-tag">fail</span> <span class="selector-tag">-</span> 1601911253618 1601911247570 1 <span class="selector-tag">disconnected</span></span><br><span class="line">655<span class="selector-tag">d56a8b9448dcc16f765268c65618a762588ae</span> 10.0.0.52<span class="selector-pseudo">:6380</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601911524038 2 <span class="selector-tag">connected</span> 10923<span class="selector-tag">-16383</span></span><br><span class="line"><span class="selector-tag">de5e61d765498747d46957b73fc55e413f58e0a9</span> 10.0.0.51<span class="selector-pseudo">:6380</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601911526055 0 <span class="selector-tag">connected</span> 5462<span class="selector-tag">-10922</span></span><br><span class="line">0<span class="selector-tag">b176001007771efe27cf46053802b419768fa06</span> 10.0.0.52<span class="selector-pseudo">:6381</span> <span class="selector-tag">master</span> <span class="selector-tag">-</span> 0 1601911525046 7 <span class="selector-tag">connected</span> 0<span class="selector-tag">-5461</span></span><br><span class="line">0<span class="selector-tag">f5d52468b67497d4cee08c5556c530737e9d04b</span> 10.0.0.50<span class="selector-pseudo">:6381</span> <span class="selector-tag">myself</span>,<span class="selector-tag">slave</span> <span class="selector-tag">de5e61d765498747d46957b73fc55e413f58e0a9</span> 0 0 3 <span class="selector-tag">connected</span></span><br></pre></td></tr></table></figure>
<h4 id="redis脚本部署redis-cluster"><a href="#redis脚本部署redis-cluster" class="headerlink" title="redis脚本部署redis cluster"></a>redis脚本部署redis cluster</h4><h5 id="自动创建集群实例和分槽"><a href="#自动创建集群实例和分槽" class="headerlink" title="自动创建集群实例和分槽"></a>自动创建集群实例和分槽</h5><p>上述可以看出，手动搭建随便于理解集群创建的流程和细节，但是需要花费更多的时间和步骤。当集群节点更多时，就会加大搭建集群的复杂度和运行成本。因此可以使用redis脚本简化集群创建、检查、槽迁移和均衡等常见运行操作</p>
<p>脚本的位置在utils/create-cluster目录下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/<span class="selector-tag">opt</span>/<span class="selector-tag">redis-6</span>.0.6/<span class="selector-tag">utils</span>/<span class="selector-tag">create-cluster</span></span><br><span class="line">$ ll</span><br><span class="line"><span class="selector-tag">total</span> 8</span><br><span class="line"><span class="selector-tag">-rwxrwxr-x</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 2694 <span class="selector-tag">Jul</span> 21  2020 <span class="selector-tag">create-cluster</span></span><br><span class="line"><span class="selector-tag">-rw-rw-r--</span>. 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 1436 <span class="selector-tag">Jul</span> 21  2020 <span class="selector-tag">README</span></span><br></pre></td></tr></table></figure>
<p>查看README文件，可见创建redis cluster只需要两个步骤</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vi README</span><br><span class="line"><span class="selector-tag">USAGE</span></span><br><span class="line"><span class="selector-tag">---</span></span><br><span class="line"><span class="selector-tag">number</span> <span class="selector-tag">of</span> <span class="selector-tag">instances</span> <span class="selector-tag">you</span> <span class="selector-tag">want</span> <span class="selector-tag">to</span> <span class="selector-tag">create</span>.</span><br><span class="line">2. <span class="selector-tag">Use</span> &quot;./<span class="selector-tag">create-cluster</span> <span class="selector-tag">start</span>&quot; <span class="selector-tag">in</span> <span class="selector-tag">order</span> <span class="selector-tag">to</span> <span class="selector-tag">run</span> <span class="selector-tag">the</span> <span class="selector-tag">instances</span>.</span><br><span class="line">3. <span class="selector-tag">Use</span> &quot;./<span class="selector-tag">create-cluster</span> <span class="selector-tag">create</span>&quot; <span class="selector-tag">in</span> <span class="selector-tag">order</span> <span class="selector-tag">to</span> <span class="selector-tag">execute</span> <span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">create</span>, <span class="selector-tag">so</span> <span class="selector-tag">that</span></span><br></pre></td></tr></table></figure>
<p>启动运行实例，创建槽位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">$ ./create-cluster start</span><br><span class="line"><span class="selector-tag">Starting</span> 30001</span><br><span class="line"><span class="selector-tag">Starting</span> 30002</span><br><span class="line"><span class="selector-tag">Starting</span> 30003</span><br><span class="line"><span class="selector-tag">Starting</span> 30004</span><br><span class="line"><span class="selector-tag">Starting</span> 30005</span><br><span class="line"><span class="selector-tag">Starting</span> 30006</span><br><span class="line"></span><br><span class="line">$ ./create-cluster create</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Performing</span> <span class="selector-tag">hash</span> <span class="selector-tag">slots</span> <span class="selector-tag">allocation</span> <span class="selector-tag">on</span> 6 <span class="selector-tag">nodes</span>...</span><br><span class="line"><span class="selector-tag">Master</span><span class="selector-attr">[0]</span> <span class="selector-tag">-</span>&gt; <span class="selector-tag">Slots</span> 0 <span class="selector-tag">-</span> 5460</span><br><span class="line"><span class="selector-tag">Master</span><span class="selector-attr">[1]</span> <span class="selector-tag">-</span>&gt; <span class="selector-tag">Slots</span> 5461 <span class="selector-tag">-</span> 10922</span><br><span class="line"><span class="selector-tag">Master</span><span class="selector-attr">[2]</span> <span class="selector-tag">-</span>&gt; <span class="selector-tag">Slots</span> 10923 <span class="selector-tag">-</span> 16383</span><br><span class="line"><span class="selector-tag">Adding</span> <span class="selector-tag">replica</span> 127.0.0.1<span class="selector-pseudo">:30005</span> <span class="selector-tag">to</span> 127.0.0.1<span class="selector-pseudo">:30001</span></span><br><span class="line"><span class="selector-tag">Adding</span> <span class="selector-tag">replica</span> 127.0.0.1<span class="selector-pseudo">:30006</span> <span class="selector-tag">to</span> 127.0.0.1<span class="selector-pseudo">:30002</span></span><br><span class="line"><span class="selector-tag">Adding</span> <span class="selector-tag">replica</span> 127.0.0.1<span class="selector-pseudo">:30004</span> <span class="selector-tag">to</span> 127.0.0.1<span class="selector-pseudo">:30003</span></span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Trying</span> <span class="selector-tag">to</span> <span class="selector-tag">optimize</span> <span class="selector-tag">slaves</span> <span class="selector-tag">allocation</span> <span class="selector-tag">for</span> <span class="selector-tag">anti-affinity</span></span><br><span class="line"><span class="selector-attr">[WARNING]</span> <span class="selector-tag">Some</span> <span class="selector-tag">slaves</span> <span class="selector-tag">are</span> <span class="selector-tag">in</span> <span class="selector-tag">the</span> <span class="selector-tag">same</span> <span class="selector-tag">host</span> <span class="selector-tag">as</span> <span class="selector-tag">their</span> <span class="selector-tag">master</span></span><br><span class="line"><span class="selector-tag">M</span>: <span class="selector-tag">eb77582251a92944351a610d7198a62121d06178</span> 127.0.0.1<span class="selector-pseudo">:30001</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[0-5460]</span> (5461 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line"><span class="selector-tag">M</span>: 4<span class="selector-tag">fda08789f270af5c0b9d00e9ff9ac3eb38c471c</span> 127.0.0.1<span class="selector-pseudo">:30002</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[5461-10922]</span> (5462 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line"><span class="selector-tag">M</span>: 1<span class="selector-tag">f9ad023299ad60df2762c92783f3cfdc6b25b7f</span> 127.0.0.1<span class="selector-pseudo">:30003</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[10923-16383]</span> (5461 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line"><span class="selector-tag">S</span>: <span class="selector-tag">ca7bf6dfe825ae02708b0a05fe8ee497eafd3a04</span> 127.0.0.1<span class="selector-pseudo">:30004</span></span><br><span class="line">   <span class="selector-tag">replicates</span> 1<span class="selector-tag">f9ad023299ad60df2762c92783f3cfdc6b25b7f</span></span><br><span class="line"><span class="selector-tag">S</span>: 6<span class="selector-tag">b8ba0b8d0ede30d6fc2ec14a8c913673e1c512a</span> 127.0.0.1<span class="selector-pseudo">:30005</span></span><br><span class="line">   <span class="selector-tag">replicates</span> <span class="selector-tag">eb77582251a92944351a610d7198a62121d06178</span></span><br><span class="line"><span class="selector-tag">S</span>: 0<span class="selector-tag">ab4a3a309afc0184dd5cfbe6d82c4ba2ad2f16c</span> 127.0.0.1<span class="selector-pseudo">:30006</span></span><br><span class="line">   <span class="selector-tag">replicates</span> 4<span class="selector-tag">fda08789f270af5c0b9d00e9ff9ac3eb38c471c</span></span><br><span class="line">Can I set the above configuration? (type &#x27;yes&#x27; to accept): yes   //输入yes，表示开始分槽位</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Nodes</span> <span class="selector-tag">configuration</span> <span class="selector-tag">updated</span></span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Assign</span> <span class="selector-tag">a</span> <span class="selector-tag">different</span> <span class="selector-tag">config</span> <span class="selector-tag">epoch</span> <span class="selector-tag">to</span> <span class="selector-tag">each</span> <span class="selector-tag">node</span></span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Sending</span> <span class="selector-tag">CLUSTER</span> <span class="selector-tag">MEET</span> <span class="selector-tag">messages</span> <span class="selector-tag">to</span> <span class="selector-tag">join</span> <span class="selector-tag">the</span> <span class="selector-tag">cluster</span></span><br><span class="line"><span class="selector-tag">Waiting</span> <span class="selector-tag">for</span> <span class="selector-tag">the</span> <span class="selector-tag">cluster</span> <span class="selector-tag">to</span> <span class="selector-tag">join</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Performing</span> <span class="selector-tag">Cluster</span> <span class="selector-tag">Check</span> (<span class="selector-tag">using</span> <span class="selector-tag">node</span> 127.0.0.1<span class="selector-pseudo">:30001)</span></span><br><span class="line"><span class="selector-tag">M</span>: <span class="selector-tag">eb77582251a92944351a610d7198a62121d06178</span> 127.0.0.1<span class="selector-pseudo">:30001</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[0-5460]</span> (5461 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line">   1 <span class="selector-tag">additional</span> <span class="selector-tag">replica</span>(<span class="selector-tag">s</span>)</span><br><span class="line"><span class="selector-tag">M</span>: 4<span class="selector-tag">fda08789f270af5c0b9d00e9ff9ac3eb38c471c</span> 127.0.0.1<span class="selector-pseudo">:30002</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[5461-10922]</span> (5462 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line">   1 <span class="selector-tag">additional</span> <span class="selector-tag">replica</span>(<span class="selector-tag">s</span>)</span><br><span class="line"><span class="selector-tag">S</span>: <span class="selector-tag">ca7bf6dfe825ae02708b0a05fe8ee497eafd3a04</span> 127.0.0.1<span class="selector-pseudo">:30004</span></span><br><span class="line">   <span class="selector-tag">slots</span>: (0 <span class="selector-tag">slots</span>) <span class="selector-tag">slave</span></span><br><span class="line">   <span class="selector-tag">replicates</span> 1<span class="selector-tag">f9ad023299ad60df2762c92783f3cfdc6b25b7f</span></span><br><span class="line"><span class="selector-tag">S</span>: 6<span class="selector-tag">b8ba0b8d0ede30d6fc2ec14a8c913673e1c512a</span> 127.0.0.1<span class="selector-pseudo">:30005</span></span><br><span class="line">   <span class="selector-tag">slots</span>: (0 <span class="selector-tag">slots</span>) <span class="selector-tag">slave</span></span><br><span class="line">   <span class="selector-tag">replicates</span> <span class="selector-tag">eb77582251a92944351a610d7198a62121d06178</span></span><br><span class="line"><span class="selector-tag">S</span>: 0<span class="selector-tag">ab4a3a309afc0184dd5cfbe6d82c4ba2ad2f16c</span> 127.0.0.1<span class="selector-pseudo">:30006</span></span><br><span class="line">   <span class="selector-tag">slots</span>: (0 <span class="selector-tag">slots</span>) <span class="selector-tag">slave</span></span><br><span class="line">   <span class="selector-tag">replicates</span> 4<span class="selector-tag">fda08789f270af5c0b9d00e9ff9ac3eb38c471c</span></span><br><span class="line"><span class="selector-tag">M</span>: 1<span class="selector-tag">f9ad023299ad60df2762c92783f3cfdc6b25b7f</span> 127.0.0.1<span class="selector-pseudo">:30003</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[10923-16383]</span> (5461 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line">   1 <span class="selector-tag">additional</span> <span class="selector-tag">replica</span>(<span class="selector-tag">s</span>)</span><br><span class="line"><span class="selector-attr">[OK]</span> <span class="selector-tag">All</span> <span class="selector-tag">nodes</span> <span class="selector-tag">agree</span> <span class="selector-tag">about</span> <span class="selector-tag">slots</span> <span class="selector-tag">configuration</span>.</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Check</span> <span class="selector-tag">for</span> <span class="selector-tag">open</span> <span class="selector-tag">slots</span>...</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Check</span> <span class="selector-tag">slots</span> <span class="selector-tag">coverage</span>...</span><br><span class="line"><span class="selector-attr">[OK]</span> <span class="selector-tag">All</span> 16384 <span class="selector-tag">slots</span> <span class="selector-tag">covered</span>.</span><br></pre></td></tr></table></figure>
<h5 id="路由与事务"><a href="#路由与事务" class="headerlink" title="路由与事务"></a>路由与事务</h5><p>连接30001端口，在不加-c的情况下写入数据，会发现需要移动主机才能写入，这里是引入ASK路由的功能，下述目录章节有详细说明</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -p 30001</span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k1</span> <span class="selector-tag">v1</span></span><br><span class="line">(<span class="selector-tag">error</span>) <span class="selector-tag">MOVED</span> 12706 127.0.0.1<span class="selector-pseudo">:30003</span>           //需要移动</span><br><span class="line"></span><br><span class="line">//加上<span class="selector-tag">-c</span>参数进行<span class="selector-tag">ASK</span>路由</span><br><span class="line">$ redis-cli -c -p 30001</span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k1</span> <span class="selector-tag">v1</span></span><br><span class="line"><span class="selector-tag">-</span>&gt; <span class="selector-tag">Redirected</span> <span class="selector-tag">to</span> <span class="selector-tag">slot</span> <span class="selector-attr">[12706]</span> <span class="selector-tag">located</span> <span class="selector-tag">at</span> 127.0.0.1<span class="selector-pseudo">:30003</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br></pre></td></tr></table></figure>
<p>对key开始事务</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">watch</span> <span class="selector-tag">k1</span></span><br><span class="line">&gt; <span class="selector-tag">multi</span> </span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k2</span> <span class="selector-tag">v2</span></span><br><span class="line"><span class="selector-tag">-</span>&gt; <span class="selector-tag">Redirected</span> <span class="selector-tag">to</span> <span class="selector-tag">slot</span> <span class="selector-attr">[449]</span> <span class="selector-tag">located</span> <span class="selector-tag">at</span> 127.0.0.1<span class="selector-pseudo">:30001</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">exec</span>                                   //但由于在设置<span class="selector-tag">key</span>会重新跳转，所以对这种<span class="selector-tag">key</span>不能开启事务</span><br><span class="line">(<span class="selector-tag">error</span>) <span class="selector-tag">ERR</span> <span class="selector-tag">EXEC</span> <span class="selector-tag">without</span> <span class="selector-tag">MULTI</span></span><br><span class="line"></span><br><span class="line">//通过&#123;&#125;<span class="selector-tag">tag</span>的方式创建，然后开启事务</span><br><span class="line">&gt; set &#123;kk&#125;1 v1</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; watch &#123;kk&#125;1</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">127.0.0.1<span class="selector-pseudo">:30001</span>&gt; <span class="selector-tag">multi</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">127.0.0.1:30001&gt; set &#123;kk&#125;2 v2</span><br><span class="line"><span class="selector-tag">QUEUED</span></span><br><span class="line">127.0.0.1:30001&gt; get &#123;kk&#125;2</span><br><span class="line"><span class="selector-tag">QUEUED</span></span><br><span class="line">127.0.0.1<span class="selector-pseudo">:30001</span>&gt; <span class="selector-tag">exec</span></span><br><span class="line">1) <span class="selector-tag">OK</span></span><br><span class="line">2) &quot;<span class="selector-tag">v2</span>&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：通过打tag的方式创建key，就会只指定在自身实例下。所以在创建同样的tag是就不会跳转到其他节点</p>
</blockquote>
<h5 id="指定地址-端口创建集群"><a href="#指定地址-端口创建集群" class="headerlink" title="指定地址/端口创建集群"></a>指定地址/端口创建集群</h5><p>通过客户端命令redis-cli + –cluster参数可以指定要创建的地址和端口</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli --cluster help   //查看更多的参数操作</span><br><span class="line">$ redis-cli --cluster create 10.0.0.50:6380 10.0.0.51:6380 10.0.0.52:6380 10.0.0.50:6381 10.0.0.51:6381 10.0.0.52:6381 --cluster-replicas 1</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Performing</span> <span class="selector-tag">hash</span> <span class="selector-tag">slots</span> <span class="selector-tag">allocation</span> <span class="selector-tag">on</span> 6 <span class="selector-tag">nodes</span>...</span><br><span class="line"><span class="selector-tag">Master</span><span class="selector-attr">[0]</span> <span class="selector-tag">-</span>&gt; <span class="selector-tag">Slots</span> 0 <span class="selector-tag">-</span> 5460</span><br><span class="line"><span class="selector-tag">Master</span><span class="selector-attr">[1]</span> <span class="selector-tag">-</span>&gt; <span class="selector-tag">Slots</span> 5461 <span class="selector-tag">-</span> 10922</span><br><span class="line"><span class="selector-tag">Master</span><span class="selector-attr">[2]</span> <span class="selector-tag">-</span>&gt; <span class="selector-tag">Slots</span> 10923 <span class="selector-tag">-</span> 16383</span><br><span class="line"><span class="selector-tag">Adding</span> <span class="selector-tag">replica</span> 10.0.0.51<span class="selector-pseudo">:6381</span> <span class="selector-tag">to</span> 10.0.0.50<span class="selector-pseudo">:6380</span></span><br><span class="line"><span class="selector-tag">Adding</span> <span class="selector-tag">replica</span> 10.0.0.52<span class="selector-pseudo">:6381</span> <span class="selector-tag">to</span> 10.0.0.51<span class="selector-pseudo">:6380</span></span><br><span class="line"><span class="selector-tag">Adding</span> <span class="selector-tag">replica</span> 10.0.0.50<span class="selector-pseudo">:6381</span> <span class="selector-tag">to</span> 10.0.0.52<span class="selector-pseudo">:6380</span></span><br><span class="line"><span class="selector-tag">M</span>: 9<span class="selector-tag">d5083b940b8e5aae963b042d2be0ad9f4c9529d</span> 10.0.0.50<span class="selector-pseudo">:6380</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[0-5460]</span> (5461 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line"><span class="selector-tag">M</span>: 0<span class="selector-tag">fdf8f7922fe38ba9837cd2fa3e5c9f1ab0d649a</span> 10.0.0.51<span class="selector-pseudo">:6380</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[5461-10922]</span> (5462 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line"><span class="selector-tag">M</span>: 2<span class="selector-tag">de412dddf4d09fa5095ee3f3d9503c447e22e27</span> 10.0.0.52<span class="selector-pseudo">:6380</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[10923-16383]</span> (5461 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line"><span class="selector-tag">S</span>: 31<span class="selector-tag">e0c9ecabe77f920ad0b4db0323fa1c1ab5d7a3</span> 10.0.0.50<span class="selector-pseudo">:6381</span></span><br><span class="line">   <span class="selector-tag">replicates</span> 2<span class="selector-tag">de412dddf4d09fa5095ee3f3d9503c447e22e27</span></span><br><span class="line"><span class="selector-tag">S</span>: <span class="selector-tag">fef0a1ad39d605393b0b629924ead9db2c6cee54</span> 10.0.0.51<span class="selector-pseudo">:6381</span></span><br><span class="line">   <span class="selector-tag">replicates</span> 9<span class="selector-tag">d5083b940b8e5aae963b042d2be0ad9f4c9529d</span></span><br><span class="line"><span class="selector-tag">S</span>: 30651<span class="selector-tag">b452124b6fd1e4457e30238f2fd068b5d35</span> 10.0.0.52<span class="selector-pseudo">:6381</span></span><br><span class="line">   <span class="selector-tag">replicates</span> 0<span class="selector-tag">fdf8f7922fe38ba9837cd2fa3e5c9f1ab0d649a</span></span><br><span class="line">Can I set the above configuration? (type &#x27;yes&#x27; to accept): yes</span><br><span class="line">...后面的信息分配槽位与上述一样</span><br></pre></td></tr></table></figure>
<h5 id="槽位迁移与增删查cluster信息"><a href="#槽位迁移与增删查cluster信息" class="headerlink" title="槽位迁移与增删查cluster信息"></a>槽位迁移与增删查cluster信息</h5><p>槽位迁移操作步骤</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli --cluster reshard 10.0.0.50:6380</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Performing</span> <span class="selector-tag">Cluster</span> <span class="selector-tag">Check</span> (<span class="selector-tag">using</span> <span class="selector-tag">node</span> 10.0.0.50<span class="selector-pseudo">:6380)</span></span><br><span class="line"><span class="selector-tag">M</span>: 9<span class="selector-tag">d5083b940b8e5aae963b042d2be0ad9f4c9529d</span> 10.0.0.50<span class="selector-pseudo">:6380</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[0-5460]</span> (5461 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line">   1 <span class="selector-tag">additional</span> <span class="selector-tag">replica</span>(<span class="selector-tag">s</span>)</span><br><span class="line">...</span><br><span class="line"><span class="selector-tag">M</span>: 0<span class="selector-tag">fdf8f7922fe38ba9837cd2fa3e5c9f1ab0d649a</span> 10.0.0.51<span class="selector-pseudo">:6380</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[5461-10922]</span> (5462 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line">   1 <span class="selector-tag">additional</span> <span class="selector-tag">replica</span>(<span class="selector-tag">s</span>)</span><br><span class="line"><span class="selector-attr">[OK]</span> <span class="selector-tag">All</span> <span class="selector-tag">nodes</span> <span class="selector-tag">agree</span> <span class="selector-tag">about</span> <span class="selector-tag">slots</span> <span class="selector-tag">configuration</span>.</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Check</span> <span class="selector-tag">for</span> <span class="selector-tag">open</span> <span class="selector-tag">slots</span>...</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Check</span> <span class="selector-tag">slots</span> <span class="selector-tag">coverage</span>...</span><br><span class="line"><span class="selector-attr">[OK]</span> <span class="selector-tag">All</span> 16384 <span class="selector-tag">slots</span> <span class="selector-tag">covered</span>.</span><br><span class="line"><span class="selector-tag">How</span> <span class="selector-tag">many</span> <span class="selector-tag">slots</span> <span class="selector-tag">do</span> <span class="selector-tag">you</span> <span class="selector-tag">want</span> <span class="selector-tag">to</span> <span class="selector-tag">move</span> (<span class="selector-tag">from</span> 1 <span class="selector-tag">to</span> 16384)? 2000   //需要移动多少槽位</span><br><span class="line"><span class="selector-tag">What</span> <span class="selector-tag">is</span> <span class="selector-tag">the</span> <span class="selector-tag">receiving</span> <span class="selector-tag">node</span> <span class="selector-tag">ID</span>? 0<span class="selector-tag">fdf8f7922fe38ba9837cd2fa3e5c9f1ab0d649a</span>   //移动给那台<span class="selector-tag">redis</span>节点，输入<span class="selector-tag">node</span> <span class="selector-tag">ID</span>，这里移动给10.0.0.51<span class="selector-pseudo">:6380</span></span><br><span class="line"><span class="selector-tag">Please</span> <span class="selector-tag">enter</span> <span class="selector-tag">all</span> <span class="selector-tag">the</span> <span class="selector-tag">source</span> <span class="selector-tag">node</span> <span class="selector-tag">IDs</span>.                                    </span><br><span class="line">  Type &#x27;all&#x27; to use all the nodes as source nodes for the hash slots.     //输入all，表示重其他节点平均迁移</span><br><span class="line">  Type &#x27;done&#x27; once you entered all the source nodes IDs.                  //done表示结束</span><br><span class="line"><span class="selector-tag">Source</span> <span class="selector-tag">node</span> <span class="selector-id">#1</span>: 9<span class="selector-tag">d5083b940b8e5aae963b042d2be0ad9f4c9529d</span>    //需要移动槽位的源<span class="selector-tag">node</span>，可以有多个，这里只移动了10.0.0.50<span class="selector-pseudo">:6380</span>的槽位</span><br><span class="line"><span class="selector-tag">Source</span> <span class="selector-tag">node</span> <span class="selector-id">#2</span>: <span class="selector-tag">done</span>                                       //<span class="selector-tag">done</span>结束</span><br><span class="line"><span class="selector-tag">Ready</span> <span class="selector-tag">to</span> <span class="selector-tag">move</span> 2000 <span class="selector-tag">slots</span>.</span><br><span class="line">  <span class="selector-tag">Source</span> <span class="selector-tag">nodes</span>:</span><br><span class="line">    <span class="selector-tag">M</span>: 9<span class="selector-tag">d5083b940b8e5aae963b042d2be0ad9f4c9529d</span> 10.0.0.50<span class="selector-pseudo">:6380</span></span><br><span class="line">       <span class="selector-tag">slots</span>:<span class="selector-attr">[0-5460]</span> (5461 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line">       1 <span class="selector-tag">additional</span> <span class="selector-tag">replica</span>(<span class="selector-tag">s</span>)</span><br><span class="line">...</span><br><span class="line">    <span class="selector-tag">Moving</span> <span class="selector-tag">slot</span> 2 <span class="selector-tag">from</span> 9<span class="selector-tag">d5083b940b8e5aae963b042d2be0ad9f4c9529d</span>          //列出需要移动的槽位有哪些</span><br><span class="line"><span class="selector-tag">Do</span> <span class="selector-tag">you</span> <span class="selector-tag">want</span> <span class="selector-tag">to</span> <span class="selector-tag">proceed</span> <span class="selector-tag">with</span> <span class="selector-tag">the</span> <span class="selector-tag">proposed</span> <span class="selector-tag">reshard</span> <span class="selector-tag">plan</span> (<span class="selector-tag">yes</span>/<span class="selector-tag">no</span>)? <span class="selector-tag">yes</span>      //输入<span class="selector-tag">yes</span>表示开始迁移</span><br><span class="line"><span class="selector-tag">Moving</span> <span class="selector-tag">slot</span> 0 <span class="selector-tag">from</span> 10.0.0.50<span class="selector-pseudo">:6380</span> <span class="selector-tag">to</span> 10.0.0.51<span class="selector-pseudo">:6380</span>: </span><br><span class="line"><span class="selector-tag">Moving</span> <span class="selector-tag">slot</span> 1 <span class="selector-tag">from</span> 10.0.0.50<span class="selector-pseudo">:6380</span> <span class="selector-tag">to</span> 10.0.0.51<span class="selector-pseudo">:6380</span>:</span><br></pre></td></tr></table></figure>
<p>通过info或者check检查redis cluster的信息</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli --cluster info 10.0.0.50:6380</span><br><span class="line">10.0.0.50:6380 (9d5083b9...) -&gt; 0 keys | 3461 slots | 1 slaves.      </span><br><span class="line">10.0.0.52:6380 (2de412dd...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line">10.0.0.51:6380 (0fdf8f79...) -&gt; 0 keys | 7462 slots | 1 slaves.      //增加了两千槽位</span><br><span class="line"></span><br><span class="line">$ redis-cli --cluster check 10.0.0.50:6380                           //check信息内容会比info更丰富些</span><br><span class="line">10.0.0.50:6380 (9d5083b9...) -&gt; 0 keys | 3461 slots | 1 slaves.</span><br><span class="line">10.0.0.52:6380 (2de412dd...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line">10.0.0.51:6380 (0fdf8f79...) -&gt; 0 keys | 7462 slots | 1 slaves.</span><br><span class="line"><span class="selector-attr">[OK]</span> 0 <span class="selector-tag">keys</span> <span class="selector-tag">in</span> 3 <span class="selector-tag">masters</span>.</span><br><span class="line">0.00 <span class="selector-tag">keys</span> <span class="selector-tag">per</span> <span class="selector-tag">slot</span> <span class="selector-tag">on</span> <span class="selector-tag">average</span>.</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Performing</span> <span class="selector-tag">Cluster</span> <span class="selector-tag">Check</span> (<span class="selector-tag">using</span> <span class="selector-tag">node</span> 10.0.0.50<span class="selector-pseudo">:6380)</span></span><br><span class="line"><span class="selector-tag">M</span>: 9<span class="selector-tag">d5083b940b8e5aae963b042d2be0ad9f4c9529d</span> 10.0.0.50<span class="selector-pseudo">:6380</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[2000-5460]</span> (3461 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line">   1 <span class="selector-tag">additional</span> <span class="selector-tag">replica</span>(<span class="selector-tag">s</span>)</span><br><span class="line"><span class="selector-tag">S</span>: 30651<span class="selector-tag">b452124b6fd1e4457e30238f2fd068b5d35</span> 10.0.0.52<span class="selector-pseudo">:6381</span></span><br><span class="line">   <span class="selector-tag">slots</span>: (0 <span class="selector-tag">slots</span>) <span class="selector-tag">slave</span></span><br><span class="line">   <span class="selector-tag">replicates</span> 0<span class="selector-tag">fdf8f7922fe38ba9837cd2fa3e5c9f1ab0d649a</span></span><br><span class="line"><span class="selector-tag">M</span>: 2<span class="selector-tag">de412dddf4d09fa5095ee3f3d9503c447e22e27</span> 10.0.0.52<span class="selector-pseudo">:6380</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[10923-16383]</span> (5461 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line">   1 <span class="selector-tag">additional</span> <span class="selector-tag">replica</span>(<span class="selector-tag">s</span>)</span><br><span class="line"><span class="selector-tag">S</span>: 31<span class="selector-tag">e0c9ecabe77f920ad0b4db0323fa1c1ab5d7a3</span> 10.0.0.50<span class="selector-pseudo">:6381</span></span><br><span class="line">   <span class="selector-tag">slots</span>: (0 <span class="selector-tag">slots</span>) <span class="selector-tag">slave</span></span><br><span class="line">   <span class="selector-tag">replicates</span> 2<span class="selector-tag">de412dddf4d09fa5095ee3f3d9503c447e22e27</span></span><br><span class="line"><span class="selector-tag">S</span>: <span class="selector-tag">fef0a1ad39d605393b0b629924ead9db2c6cee54</span> 10.0.0.51<span class="selector-pseudo">:6381</span></span><br><span class="line">   <span class="selector-tag">slots</span>: (0 <span class="selector-tag">slots</span>) <span class="selector-tag">slave</span></span><br><span class="line">   <span class="selector-tag">replicates</span> 9<span class="selector-tag">d5083b940b8e5aae963b042d2be0ad9f4c9529d</span></span><br><span class="line"><span class="selector-tag">M</span>: 0<span class="selector-tag">fdf8f7922fe38ba9837cd2fa3e5c9f1ab0d649a</span> 10.0.0.51<span class="selector-pseudo">:6380</span></span><br><span class="line">   <span class="selector-tag">slots</span>:<span class="selector-attr">[0-1999]</span>,<span class="selector-attr">[5461-10922]</span> (7462 <span class="selector-tag">slots</span>) <span class="selector-tag">master</span></span><br><span class="line">   1 <span class="selector-tag">additional</span> <span class="selector-tag">replica</span>(<span class="selector-tag">s</span>)</span><br><span class="line"><span class="selector-attr">[OK]</span> <span class="selector-tag">All</span> <span class="selector-tag">nodes</span> <span class="selector-tag">agree</span> <span class="selector-tag">about</span> <span class="selector-tag">slots</span> <span class="selector-tag">configuration</span>.</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Check</span> <span class="selector-tag">for</span> <span class="selector-tag">open</span> <span class="selector-tag">slots</span>...</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Check</span> <span class="selector-tag">slots</span> <span class="selector-tag">coverage</span>...</span><br><span class="line"><span class="selector-attr">[OK]</span> <span class="selector-tag">All</span> 16384 <span class="selector-tag">slots</span> <span class="selector-tag">covered</span>.</span><br></pre></td></tr></table></figure>
<p>删除节点与添加节点</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//删除节点</span><br><span class="line">$ redis-cli --cluster del-node 10.0.0.50:6381 31e0c9ecabe77f920ad0b4db0323fa1c1ab5d7a3</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Removing</span> <span class="selector-tag">node</span> 31<span class="selector-tag">e0c9ecabe77f920ad0b4db0323fa1c1ab5d7a3</span> <span class="selector-tag">from</span> <span class="selector-tag">cluster</span> 10.0.0.50<span class="selector-pseudo">:6381</span></span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Sending</span> <span class="selector-tag">CLUSTER</span> <span class="selector-tag">FORGET</span> <span class="selector-tag">messages</span> <span class="selector-tag">to</span> <span class="selector-tag">the</span> <span class="selector-tag">cluster</span>...</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Sending</span> <span class="selector-tag">CLUSTER</span> <span class="selector-tag">RESET</span> <span class="selector-tag">SOFT</span> <span class="selector-tag">to</span> <span class="selector-tag">the</span> <span class="selector-tag">deleted</span> <span class="selector-tag">node</span>.</span><br><span class="line"></span><br><span class="line">//添加节点，添加的从在前，主在后</span><br><span class="line">$ redis-cli --cluster add-node --cluster-slave 10.0.0.50:6381 10.0.0.50:6380 </span><br></pre></td></tr></table></figure>
<h4 id="redis-cluster通讯过程"><a href="#redis-cluster通讯过程" class="headerlink" title="redis cluster通讯过程"></a>redis cluster通讯过程</h4><p>在分布式存储中需要提供维护节点元数据信息的机制，所谓的元数据是指：节点负责哪些数据，是否出现故障灯状态信息，redis集群采用Gossip（流言）协议。Gossip协议工作原理就是节点不断的交互信息，一段时间后所有的节点都会知道集群完整信息。</p>
<p><strong>通讯过程</strong></p>
<ul>
<li>集群中的每一个节点都会单独开辟一个TCP通道，用于节点之间彼此通信，通信端口在基础端口上加10000</li>
<li>每个节点在固定周期内荣国特定规则选择结构节点发送ping消息</li>
<li>接收到ping消息的节点用pong消息作为回应。集群中每个节点通过一定规则挑选要通信的节点，每个节点可能知道全部节点，也可能仅知道部分节点，只要这些节点彼此可以通信，最终它们都会达成一致的状态。当节点出现故障，新节点加入，主从角色会随着变换</li>
</ul>
<p>查看通信端口</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ss -lnp|grep redis</span><br><span class="line">tcp    LISTEN     0      128    10.0.0.50:16380                 *:*                   users:((&quot;redis-server&quot;,pid=47847,fd=8))</span><br><span class="line">tcp    LISTEN     0      128    10.0.0.50:16381                 *:*                   users:((&quot;redis-server&quot;,pid=47853,fd=8))</span><br></pre></td></tr></table></figure>
<p><strong>通讯消息类型</strong></p>
<p>Gossip协议：负责信息交换，节点彼此发送Gossip消息。常见的消息有：ping、pong、meet和fail等</p>
<ul>
<li>meet消息：用于通知新节点加入，消息发送者通知接受者加入到集群，meet消息通信正常后，接收节点会加入到集群中并进行ping和pong的消息交换</li>
<li>ping消息：集群内交换最频繁的消息，集群内每个节点每秒与其他节点发送ping消息，用于检测节点是否在线和交换彼此信息</li>
<li>pong消息：接收ping、meet消息时，作为响应消息回复给发送方确认消息正常通信，节点也可以向集群内广播自身的pong消息来通知整个集群对自身状态更新</li>
<li>fail消息：当有节点下线时，则会在集群内广播一个fail消息，告诉其他节点更新自己的状态</li>
</ul>
<p><strong>通讯示意图</strong></p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210507155750212.png"></p>
<h4 id="redis-cluster-ASK路由介绍"><a href="#redis-cluster-ASK路由介绍" class="headerlink" title="redis cluster ASK路由介绍"></a>redis cluster ASK路由介绍</h4><p>在集群模式下，redis接收任何键相关命令时首先会计算键对应的槽，再根据槽找出所对应的节点。如果节点是自身，则处理该指令，否则回复MOVED重定向错误，通知客户端请求正确的节点，这个过程称为重定向。如以下例子</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -h redis-1 -p 6381</span><br><span class="line"><span class="selector-tag">redis-1</span><span class="selector-pseudo">:6381</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">k1</span> <span class="selector-tag">vv</span></span><br><span class="line">(<span class="selector-tag">error</span>) <span class="selector-tag">MOVED</span> 12706 10.0.0.51<span class="selector-pseudo">:6380</span></span><br><span class="line"></span><br><span class="line">//登录<span class="selector-tag">redis-2</span>主机</span><br><span class="line">$ redis-cli -h redis-2 -p 6380</span><br><span class="line"><span class="selector-tag">redis-2</span><span class="selector-pseudo">:6380</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">k1</span> <span class="selector-tag">vv</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：可以看出，在实例redis-1的6381不能进行写入的功能，错误的提醒需跳转到redis-2的6380主机才能进行写入。所涉及的跳转就是ASK路由的一种方法</p>
</blockquote>
<p>如下图所示，可以看出ASK路由的过程</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210507161106355.png"></p>
<p>ask路由：在命令行下可以加上-c命令，表示可以允许重定向</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli --help</span><br><span class="line"><span class="selector-tag">-c</span>                 <span class="selector-tag">Enable</span> <span class="selector-tag">cluster</span> <span class="selector-tag">mode</span> (<span class="selector-tag">follow</span> <span class="selector-tag">-ASK</span> <span class="selector-tag">and</span> <span class="selector-tag">-MOVED</span> <span class="selector-tag">redirections</span>).</span><br><span class="line"></span><br><span class="line">$ redis-cli -c -h redis-1 -p 6380    //将上-c参数</span><br><span class="line"><span class="selector-tag">redis-1</span><span class="selector-pseudo">:6380</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">k1</span></span><br><span class="line"><span class="selector-tag">-</span>&gt; <span class="selector-tag">Redirected</span> <span class="selector-tag">to</span> <span class="selector-tag">slot</span> <span class="selector-attr">[12706]</span> <span class="selector-tag">located</span> <span class="selector-tag">at</span> 10.0.0.52<span class="selector-pseudo">:6380</span>  </span><br><span class="line">&quot;<span class="selector-tag">vv</span>&quot;</span><br><span class="line">10.0.0.52<span class="selector-pseudo">:6380</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">k2</span> <span class="selector-tag">v2</span>                              //跳转到10.0.0.42主机点解</span><br><span class="line"><span class="selector-tag">-</span>&gt; <span class="selector-tag">Redirected</span> <span class="selector-tag">to</span> <span class="selector-tag">slot</span> <span class="selector-attr">[449]</span> <span class="selector-tag">located</span> <span class="selector-tag">at</span> 10.0.0.50<span class="selector-pseudo">:6380</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br></pre></td></tr></table></figure>
<h3 id="predixy实例"><a href="#predixy实例" class="headerlink" title="predixy实例"></a>predixy实例</h3><h4 id="下载predixy包"><a href="#下载predixy包" class="headerlink" title="下载predixy包"></a>下载predixy包</h4><p>下载编译好的二进制安装包</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/joyieldInc/predixy/releases/download/1.0.5/predixy-1.0.5-bin-amd64-linux.tar.gz</span><br><span class="line">$ tar xf predixy-1.0.5-bin-amd64-linux.tar.gz  -C /opt</span><br><span class="line">$ pwd</span><br><span class="line">/<span class="selector-tag">opt</span>/<span class="selector-tag">predixy-1</span>.0.5/<span class="selector-tag">conf</span></span><br><span class="line">$ ll</span><br><span class="line"><span class="selector-tag">total</span> 36</span><br><span class="line"><span class="selector-tag">-rw-rw-r--</span> 1 501 501 2395 <span class="selector-tag">Oct</span> 20  2018 <span class="selector-tag">auth</span><span class="selector-class">.conf</span></span><br><span class="line"><span class="selector-tag">-rw-rw-r--</span> 1 501 501 1041 <span class="selector-tag">Oct</span> 20  2018 <span class="selector-tag">cluster</span><span class="selector-class">.conf</span></span><br><span class="line"><span class="selector-tag">-rw-rw-r--</span> 1 501 501 3426 <span class="selector-tag">Oct</span> 20  2018 <span class="selector-tag">command</span><span class="selector-class">.conf</span></span><br><span class="line"><span class="selector-tag">-rw-rw-r--</span> 1 501 501  781 <span class="selector-tag">Oct</span> 20  2018 <span class="selector-tag">dc</span><span class="selector-class">.conf</span></span><br><span class="line"><span class="selector-tag">-rw-rw-r--</span> 1 501 501 2121 <span class="selector-tag">Oct</span> 20  2018 <span class="selector-tag">latency</span><span class="selector-class">.conf</span></span><br><span class="line"><span class="selector-tag">-rw-rw-r--</span> 1 501 501 2547 <span class="selector-tag">Oct</span> 20  2018 <span class="selector-tag">predixy</span><span class="selector-class">.conf</span></span><br><span class="line"><span class="selector-tag">-rw-rw-r--</span> 1 501 501 1421 <span class="selector-tag">Oct</span> 20  2018 <span class="selector-tag">sentinel</span><span class="selector-class">.conf</span></span><br><span class="line"><span class="selector-tag">-rw-rw-r--</span> 1 501 501 2016 <span class="selector-tag">Oct</span> 20  2018 <span class="selector-tag">standalone</span><span class="selector-class">.conf</span></span><br><span class="line"><span class="selector-tag">-rw-rw-r--</span> 1 501 501   98 <span class="selector-tag">Oct</span> 20  2018 <span class="selector-tag">try</span><span class="selector-class">.conf</span></span><br></pre></td></tr></table></figure>
<h4 id="编辑配置文件，启动实例"><a href="#编辑配置文件，启动实例" class="headerlink" title="编辑配置文件，启动实例"></a>编辑配置文件，启动实例</h4><p>Redis实例配置部分，predixy支持Redis Sentinel和Redis Cluster来使用redis，<strong>一个配置里这两种形式只能出现一种</strong>。下述先配置Sentinel</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vi predixy.conf</span><br><span class="line"><span class="selector-tag">Bind</span> 127.0.0.1<span class="selector-pseudo">:7617</span></span><br><span class="line"><span class="selector-tag">Include</span> <span class="selector-tag">sentinel</span><span class="selector-class">.conf</span></span><br></pre></td></tr></table></figure>
<p>编辑predixy的sentinel.conf文件，添加三个哨兵，两组redis主从</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ cp sentinel<span class="selector-class">.conf</span>&#123;,<span class="selector-class">.bak</span>&#125;</span><br><span class="line">$ vi sentinel<span class="selector-class">.conf</span></span><br><span class="line">## Examples:</span><br><span class="line">SentinelServerPool &#123;</span><br><span class="line">    Databases <span class="number">16</span></span><br><span class="line">    Hash crc16</span><br><span class="line">    HashTag <span class="string">&quot;&#123;&#125;&quot;</span></span><br><span class="line">    Distribution modula</span><br><span class="line">    MasterReadPriority <span class="number">60</span></span><br><span class="line">    StaticSlaveReadPriority <span class="number">50</span></span><br><span class="line">    DynamicSlaveReadPriority <span class="number">50</span></span><br><span class="line">    RefreshInterval <span class="number">1</span></span><br><span class="line">    ServerTimeout <span class="number">1</span></span><br><span class="line">    ServerFailureLimit <span class="number">10</span></span><br><span class="line">    ServerRetryTimeout <span class="number">1</span></span><br><span class="line">    KeepAlive <span class="number">120</span></span><br><span class="line">    Sentinels &#123;</span><br><span class="line">        + <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">26379</span></span><br><span class="line">        + <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">26380</span></span><br><span class="line">        + <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">26381</span></span><br><span class="line">    &#125;</span><br><span class="line">    Group master1 &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    Group master2 &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写redis sentinel脚本，监控两组redis主从</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/<span class="selector-tag">opt</span>/<span class="selector-tag">redis_cluster</span>/<span class="selector-tag">sentine</span></span><br><span class="line">$ ll</span><br><span class="line"><span class="selector-tag">total</span> 12</span><br><span class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 904 <span class="selector-tag">May</span>  6 18<span class="selector-pseudo">:04</span> 26379<span class="selector-class">.conf</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 904 <span class="selector-tag">May</span>  6 18<span class="selector-pseudo">:04</span> 26380<span class="selector-class">.conf</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">root</span> <span class="selector-tag">root</span> 904 <span class="selector-tag">May</span>  6 18<span class="selector-pseudo">:04</span> 26381<span class="selector-class">.conf</span></span><br><span class="line"></span><br><span class="line">//26380和26381实例的配置与26379保持一致</span><br><span class="line">$ vi 26379.conf</span><br><span class="line"><span class="selector-tag">sentinel</span> <span class="selector-tag">known-replica</span> <span class="selector-tag">master1</span> 127.0.0.1 36380</span><br><span class="line"><span class="selector-tag">sentinel</span> <span class="selector-tag">known-replica</span> <span class="selector-tag">master2</span> 127.0.0.1 46380</span><br><span class="line"></span><br><span class="line">//启动</span><br><span class="line">$ redis-server 26379.conf --sentinel</span><br><span class="line">$ redis-server 26380.conf --sentinel</span><br><span class="line">$ redis-server 26381.conf --sentinel</span><br></pre></td></tr></table></figure>
<p>创建两组redis主从，并启动</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/<span class="selector-tag">opt</span>/<span class="selector-tag">redis_cluster</span></span><br><span class="line">$ mkdir redis_36379  redis_36380  redis_46379  redis_46380</span><br><span class="line"></span><br><span class="line">//启动第一组主从</span><br><span class="line">$ cd redis_36379/</span><br><span class="line">$ redis-server --port 36379</span><br><span class="line">$ cd redis_36380</span><br><span class="line">$ redis-server --port 36380 --replicaof 127.0.0.1 36379</span><br><span class="line"></span><br><span class="line">//启动第二组主从</span><br><span class="line">$ cd redis_46379</span><br><span class="line">$ redis-server --port 46379</span><br><span class="line">$ cd redis_46380</span><br><span class="line">$ redis-server --port 46380 --replicaof 127.0.0.1 46379</span><br></pre></td></tr></table></figure>
<p>连接predixy的7617端口，写入数据并查看数据分配</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -p 7617</span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k1</span> <span class="selector-tag">v1</span></span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k2</span> <span class="selector-tag">v2</span></span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k3</span> <span class="selector-tag">v3</span></span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k4</span> <span class="selector-tag">v4</span></span><br><span class="line"></span><br><span class="line">//连接两组<span class="selector-tag">redis</span>主并查看</span><br><span class="line">$ redis-cli -p 36379</span><br><span class="line">&gt; <span class="selector-tag">keys</span> *</span><br><span class="line">2) &quot;<span class="selector-tag">k3</span>&quot;</span><br><span class="line">3) &quot;<span class="selector-tag">k1</span>&quot;</span><br><span class="line"></span><br><span class="line">$ redis-cli -p 46379</span><br><span class="line">&gt; <span class="selector-tag">keys</span> *</span><br><span class="line">2) &quot;<span class="selector-tag">k4</span>&quot;</span><br><span class="line">3) &quot;<span class="selector-tag">k2</span>&quot;</span><br></pre></td></tr></table></figure>
<h4 id="通过Tag的方式分配数据"><a href="#通过Tag的方式分配数据" class="headerlink" title="通过Tag的方式分配数据"></a>通过Tag的方式分配数据</h4><p>默认情况下，predixy可以通过<code>&#123;&#125; values</code>进行打tag（也可以自己修改其他的方式）来统一分配到一个redis主，如下述操作</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -p 7617</span><br><span class="line">&gt; set &#123;kk&#125;q1 v1</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; set &#123;kk&#125;q2 v2</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; set &#123;kk&#125;q3 v3</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line"></span><br><span class="line">//查看两组<span class="selector-tag">redis</span>主情况</span><br><span class="line">$ redis-cli -p 36379</span><br><span class="line">&gt; <span class="selector-tag">keys</span> *</span><br><span class="line">(<span class="selector-tag">empty</span> <span class="selector-tag">array</span>)</span><br><span class="line"></span><br><span class="line">$ redis-cli -p 46379</span><br><span class="line">&gt; <span class="selector-tag">keys</span> *</span><br><span class="line">1) &quot;&#123;kk&#125;q3&quot;</span><br><span class="line">2) &quot;&#123;kk&#125;q1&quot;</span><br><span class="line">3) &quot;&#123;kk&#125;q4&quot;</span><br><span class="line">4) &quot;&#123;kk&#125;q2&quot;</span><br></pre></td></tr></table></figure>
<h4 id="predixy支持单组redis事务"><a href="#predixy支持单组redis事务" class="headerlink" title="predixy支持单组redis事务"></a>predixy支持单组redis事务</h4><p>predixy如果存在两组redis主从，是不能对key执行事务的。但是在使用一组的情况下，是可以对key进行监控和事务的</p>
<p>查看两组redis主从执行事务情况下的</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -<span class="selector-tag">p</span> 7617</span><br><span class="line">&gt; multi</span><br><span class="line">(error) ERR forbid transaction in current server pool</span><br><span class="line">&gt; watch &#123;kk&#125;q1</span><br><span class="line">(error) ERR forbid transaction in current server pool</span><br></pre></td></tr></table></figure>
<p>删除master2组，只留master1，查看只有一组的redis主从执行事务情况</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ vi /opt/predixy-1.0.5/conf/sentinel.conf       </span><br><span class="line">    <span class="selector-tag">Group</span> <span class="selector-tag">master1</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">$ pkill predixy</span><br><span class="line">$ /opt/predixy-1.0.5/bin/predixy /opt/predixy-1.0.5/conf/predixy.conf </span><br><span class="line">$ redis-cli -p 7617</span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k1</span> <span class="selector-tag">v1</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k2</span> <span class="selector-tag">v2</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">watch</span> <span class="selector-tag">k1</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">MULTI</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">get</span> <span class="selector-tag">k1</span></span><br><span class="line"><span class="selector-tag">QUEUED</span></span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">k3</span> <span class="selector-tag">v3</span></span><br><span class="line"><span class="selector-tag">QUEUED</span></span><br><span class="line">&gt; <span class="selector-tag">exec</span></span><br><span class="line">1) &quot;<span class="selector-tag">v1</span>&quot;</span><br><span class="line">2) <span class="selector-tag">OK</span></span><br></pre></td></tr></table></figure>
<h4 id="predixy故障转移"><a href="#predixy故障转移" class="headerlink" title="predixy故障转移"></a>predixy故障转移</h4><p>predixy使用sentinel的配置文件，在监控sentinel的前提下，sentinel监控了redis 主从。所以当主down主的时候，会有新的slave进行替代主。无论后端配置的实例有多少，或多复杂。对于连接predixy的端口，进行写入和读取都是在无感知的（当然在选主的过程中可能会丢失一些数据）</p>
<p>模拟redis 主down机，查看sentinel日志与主从日志</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -p 36379 shutdown</span><br><span class="line"></span><br><span class="line">//<span class="selector-tag">sentinel</span>日志，发现<span class="selector-tag">master1</span>组的36379已经<span class="selector-tag">down</span>，开始自动故障转移，将<span class="selector-tag">master1</span>组的主设置为36380</span><br><span class="line">46847<span class="selector-pseudo">:X</span> 07 <span class="selector-tag">May</span> 2021 01<span class="selector-pseudo">:24</span><span class="selector-pseudo">:19.006</span> # +<span class="selector-tag">sdown</span> <span class="selector-tag">master</span> <span class="selector-tag">master1</span> 127.0.0.1 36379</span><br><span class="line">46847<span class="selector-pseudo">:X</span> 07 <span class="selector-tag">May</span> 2021 01<span class="selector-pseudo">:24</span><span class="selector-pseudo">:19.066</span> # +<span class="selector-tag">odown</span> <span class="selector-tag">master</span> <span class="selector-tag">master1</span> 127.0.0.1 36379 <span class="selector-id">#quorum</span> 2/2</span><br><span class="line">46847<span class="selector-pseudo">:X</span> 07 <span class="selector-tag">May</span> 2021 01<span class="selector-pseudo">:24</span><span class="selector-pseudo">:19.136</span> # +<span class="selector-tag">new-epoch</span> 3</span><br><span class="line">46847<span class="selector-pseudo">:X</span> 07 <span class="selector-tag">May</span> 2021 01<span class="selector-pseudo">:24</span><span class="selector-pseudo">:19.142</span> # +<span class="selector-tag">vote-for-leader</span> 32<span class="selector-tag">e218675943fa543acbeebd6bc9ed68bf7940ec</span> 3</span><br><span class="line">46847<span class="selector-pseudo">:X</span> 07 <span class="selector-tag">May</span> 2021 01<span class="selector-pseudo">:24</span><span class="selector-pseudo">:19.142</span> # <span class="selector-tag">Next</span> <span class="selector-tag">failover</span> <span class="selector-tag">delay</span>: <span class="selector-tag">I</span> <span class="selector-tag">will</span> <span class="selector-tag">not</span> <span class="selector-tag">start</span> <span class="selector-tag">a</span> <span class="selector-tag">failover</span> <span class="selector-tag">before</span> <span class="selector-tag">Fri</span> <span class="selector-tag">May</span>  7 01<span class="selector-pseudo">:30</span><span class="selector-pseudo">:19</span> 2021</span><br><span class="line">46847<span class="selector-pseudo">:X</span> 07 <span class="selector-tag">May</span> 2021 01<span class="selector-pseudo">:24</span><span class="selector-pseudo">:20.317</span> # +<span class="selector-tag">config-update-from</span> <span class="selector-tag">sentinel</span> 32<span class="selector-tag">e218675943fa543acbeebd6bc9ed68bf7940ec</span> 127.0.0.1 26381 @ master1 <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">36379</span></span><br><span class="line"><span class="number">46847</span>:X <span class="number">07</span> May <span class="number">2021</span> <span class="number">01</span>:<span class="number">24</span>:<span class="number">20.317</span> # +switch-master master1 <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">36379</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">36380</span></span><br><span class="line"><span class="number">46847</span>:X <span class="number">07</span> May <span class="number">2021</span> <span class="number">01</span>:<span class="number">24</span>:<span class="number">20.317</span> * +slave slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">36379</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">36379</span> @ master1 <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">36380</span></span><br><span class="line"><span class="number">46847</span>:X <span class="number">07</span> May <span class="number">2021</span> <span class="number">01</span>:<span class="number">24</span>:<span class="number">50.398</span> # +sdown slave <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">36379</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">36379</span> @ master1 <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">36380</span></span><br><span class="line"></span><br><span class="line">//redis-<span class="number">36380</span>的日志，丢弃之前缓存的master状态，然后将自己设置成主</span><br><span class="line"><span class="number">6889</span>:M <span class="number">07</span> May <span class="number">2021</span> <span class="number">01</span>:<span class="number">24</span>:<span class="number">19.364</span> * Discarding previously cached master state.</span><br><span class="line"><span class="number">46889</span>:M <span class="number">07</span> May <span class="number">2021</span> <span class="number">01</span>:<span class="number">24</span>:<span class="number">19.364</span> # Setting secondary replication ID to <span class="number">714747</span>f58da66e26759ff73049ed3b859dd4e748, valid up to <span class="attribute">offset:</span> <span class="number">31403</span>. New replication ID is <span class="number">71</span>fd48c254418326c844bbd110d39536457dfaf6</span><br><span class="line"><span class="number">46889</span>:M <span class="number">07</span> May <span class="number">2021</span> <span class="number">01</span>:<span class="number">24</span>:<span class="number">19.364</span> * MASTER MODE enabled (user request from <span class="string">&#x27;id=9 addr=127.0.0.1:36114 fd=13 name=sentinel-32e21867-cmd age=104 idle=0 flags=x db=0 sub=0 psub=0 multi=4 qbuf=202 qbuf-free=32566 obl=45 oll=0 omem=0 events=r cmd=exec user=default&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Redis数据导入导出"><a href="#Redis数据导入导出" class="headerlink" title="Redis数据导入导出"></a>Redis数据导入导出</h2><p>下载地址与参考：<a target="_blank" rel="noopener" href="https://github.com/vipshop/redis-migrate-tool">https://github.com/vipshop/redis-migrate-tool</a></p>
<p>安装下载工具</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y libtool bzip2 git -y</span><br><span class="line">$ cd /opt/</span><br><span class="line">$ git clone https://github.com/vipshop/redis-migrate-tool.git</span><br><span class="line">$ cd redis-migrate-tool/</span><br><span class="line">$ autoreconf -fvi</span><br><span class="line">$ ./configure</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line">$ src/redis-migrate-tool -h</span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：如果使用git下载不了，那么直接下载.zip包，然后上传解压</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rz -E</span><br><span class="line">$ unzip redis-migrate-tool-master.zip -d /opt/</span><br></pre></td></tr></table></figure>
<p>创建配置文件</p>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cat redis_6379_to6380_.conf</span><br><span class="line"><span class="selector-attr">[source]</span></span><br><span class="line"><span class="selector-tag">type</span>: <span class="selector-tag">single</span></span><br><span class="line"><span class="selector-tag">servers</span>:</span><br><span class="line"><span class="selector-tag">-</span> 10.0.0.50<span class="selector-pseudo">:6379</span></span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[target]</span></span><br><span class="line"><span class="selector-tag">type</span>: <span class="selector-tag">redis</span> <span class="selector-tag">cluster</span></span><br><span class="line"><span class="selector-tag">servers</span>:</span><br><span class="line"><span class="selector-tag">-</span> 10.0.0.51<span class="selector-pseudo">:6380</span></span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[common]</span></span><br><span class="line"><span class="selector-tag">listen</span>: 0.0.0.0<span class="selector-pseudo">:8888</span></span><br><span class="line"><span class="selector-tag">source</span> <span class="selector-tag">safe</span><span class="selector-pseudo">:true</span></span><br></pre></td></tr></table></figure>
<p>生成测试数据</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat for.sh </span><br><span class="line">#!/<span class="selector-tag">bin</span>/<span class="selector-tag">bash</span></span><br><span class="line"></span><br><span class="line">for i in &#123;1..1000&#125;</span><br><span class="line"><span class="selector-tag">do</span></span><br><span class="line">  redis-cli -c -h 10.0.0.40 -p 6379 set yes_k$&#123;i&#125; no_v$&#123;i&#125;</span><br><span class="line">  echo $&#123;i&#125;</span><br><span class="line"><span class="selector-tag">done</span></span><br></pre></td></tr></table></figure>
<p>开启6379进程，并指定导入命令</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ redis_shell.sh start 6379</span><br><span class="line">$ redis-migrate-tool -c redis_6379_to6380_.conf </span><br></pre></td></tr></table></figure>
<p>检查数据是否导入成功</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ redis-migrate-tool -c redis_6379_to6380_.conf -C redis_check</span><br><span class="line"><span class="selector-tag">Check</span> <span class="selector-tag">job</span> <span class="selector-tag">is</span> <span class="selector-tag">running</span>...</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">Checked</span> <span class="selector-tag">keys</span>: 1000</span><br><span class="line"><span class="selector-tag">Inconsistent</span> <span class="selector-tag">value</span> <span class="selector-tag">keys</span>: 0</span><br><span class="line"><span class="selector-tag">Inconsistent</span> <span class="selector-tag">expire</span> <span class="selector-tag">keys</span> : 0</span><br><span class="line"><span class="selector-tag">Other</span> <span class="selector-tag">check</span> <span class="selector-tag">error</span> <span class="selector-tag">keys</span>: 0</span><br><span class="line"><span class="selector-tag">Checked</span> <span class="selector-tag">OK</span> <span class="selector-tag">keys</span>: 1000</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">All</span> <span class="selector-tag">keys</span> <span class="selector-tag">checked</span> <span class="selector-tag">OK</span>!</span><br><span class="line"><span class="selector-tag">Check</span> <span class="selector-tag">job</span> <span class="selector-tag">finished</span>, <span class="selector-tag">used</span> 0.021<span class="selector-tag">s</span></span><br></pre></td></tr></table></figure>
<h2 id="Redis分析键值大小"><a href="#Redis分析键值大小" class="headerlink" title="Redis分析键值大小"></a>Redis分析键值大小</h2><p>redis的内存使用太太的键值过多，不知如何判断哪些键值占用的容量较大，而在线分析会影响性能。</p>
<p>下载工具进行分析</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ yum install python-pip gcc python-devel -y</span><br><span class="line">$ cd /opt/</span><br><span class="line">$ git clone https://github.com/sripathikrishnan/redis-rdb-tools.git</span><br><span class="line">$ cd redis-rdb-tools</span><br><span class="line">$ python setup.py install</span><br></pre></td></tr></table></figure>
<p>使用方法</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd /data/redis_cluster/redis_6380/</span><br><span class="line">$ rdb -c memory redis_6380.rdb -f redis_6380.rdb.csv</span><br></pre></td></tr></table></figure>
<p>分析导出</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ awk -f &#x27;,&#x27; &#x27;&#123;print $4,$2,$3,$1&#125;&#x27; redis_6380.rdb.csv | sort &gt;6380.txt</span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：更多详细的操作请参考作者的[GitHub][<a target="_blank" rel="noopener" href="https://github.com/sripathikrishnan/redis-rdb-tools]%E4%BF%A1%E6%81%AF">https://github.com/sripathikrishnan/redis-rdb-tools]信息</a></p>
</blockquote>
<h2 id="Redis作为缓存的问题"><a href="#Redis作为缓存的问题" class="headerlink" title="Redis作为缓存的问题"></a>Redis作为缓存的问题</h2><p>通过下图了解，redis作为缓存在架构中的一个位置，在前端的nginx接收请求会缓解几万的并发压力，分发到后端client server（web集群，微服务spring等服务），再到redis缓存减压几万的数据并发压力，最后到DB（数据库）也就不会有太大的压力（可能就几百或几千的压力）</p>
<p>那么redis的击穿、穿透和雪崩，是在redis充当缓存的角色才有。充当缓存的过程中，可以设置key的过期时间和使用不同的算法来维持内存的使用。</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210415121050234.png"></p>
<h3 id="击穿"><a href="#击穿" class="headerlink" title="击穿"></a>击穿</h3><p><strong>击穿：</strong>是由于key的过期了造成并发访问数据库，前提是发生了高并发的情况（如：且key刚好过期，但过期之后有一大批并发数据过来访问刚好过期的key，由于已经没有该key，所以会造成直接访问数据库获取数据，就会造成所谓的击穿）</p>
<p><strong>如何解决击穿问题</strong></p>
<p>那么解决击穿问题，就要先解决并发的问题，需要阻塞并发的数据访问数据库</p>
<ul>
<li>可以设置setnx命令（判断key存不存在，不存在才设置），形成分布式锁</li>
</ul>
<p>分布式锁本质上要实现的目标就是在Redis里面占一个“位”，当别的进程也要占“位”时，发现已经有人存在了，就会放弃去请求或稍后再试</p>
<p>占“位”就是通过setnx（set if not exists）命令，只允许被一个客户端占“位”，先到先占，用完了，再调用del命令指令释放，如下述操作</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">setnx</span> <span class="selector-tag">lock</span><span class="selector-pseudo">:k1</span> <span class="selector-tag">true</span>    //<span class="selector-tag">lock</span><span class="selector-pseudo">:k1</span>是一个<span class="selector-tag">key</span>，可以随意起名</span><br><span class="line">(<span class="selector-tag">integer</span>) 1</span><br><span class="line">...........</span><br><span class="line">&gt; <span class="selector-tag">del</span> <span class="selector-tag">lock</span><span class="selector-pseudo">:k1</span></span><br><span class="line">(<span class="selector-tag">integer</span>) 1</span><br></pre></td></tr></table></figure>
<p>如下图，这是一个分布式锁通过setex的请求的过程</p>
<ul>
<li>请求发现没有该key，并返回nil（get key）</li>
<li>通过setnx创建没有的key</li>
<li>只有通过setnx创建了（就是获得锁的人），才能去访问DB</li>
<li>如果没有成功设置的key，则sleep（睡眠几秒）</li>
</ul>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210415160611640.png"></p>
<p>但如果在setnx过程中，逻辑执行中间出现异常了，请求的数据挂了（就是没有设置成功）或del指令没有被调用，那么后面的请求就会一直等着这个锁，直到成功了，就会照成<strong>死锁</strong>的问题。</p>
<p><strong>如何解决死锁问题</strong></p>
<p>那么如何解决将死锁变成活锁的问题？</p>
<ul>
<li>设置锁的过期时间，但设置锁的过期，设置多久才合适（如果设置了5秒钟，但请求不到1秒就挂了，剩下的时候就需要等待4秒钟。如果设置小了，没更新完或是数据库连接过程中产生拥塞了，就会照成锁超时（显然由产生一个问题）</li>
<li>那就设置使用多线程，一个线程取库，一个线程监控是否取回来更新锁时间（但是需要代码逻辑的提高）</li>
<li>当前最好的使用分布式锁，如zookeeper（但比较耗费经费）</li>
</ul>
<p>通过setnx设置时间的操作，比如增加5s，这样即使中间出现异常也可以保证5s之后锁会自动释放</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">setnx</span> <span class="selector-tag">lock</span><span class="selector-pseudo">:k2</span> <span class="selector-tag">true</span></span><br><span class="line">(<span class="selector-tag">integer</span>) 1</span><br><span class="line">&gt; <span class="selector-tag">expire</span> <span class="selector-tag">lock</span><span class="selector-pseudo">:k2</span> 5</span><br><span class="line">(<span class="selector-tag">integer</span>) 1</span><br><span class="line">&gt; <span class="selector-tag">get</span> <span class="selector-tag">lock</span><span class="selector-pseudo">:k2</span></span><br><span class="line">&quot;<span class="selector-tag">true</span>&quot;</span><br><span class="line">&gt; <span class="selector-tag">get</span> <span class="selector-tag">lock</span><span class="selector-pseudo">:k2</span></span><br><span class="line">(<span class="selector-tag">nil</span>)</span><br><span class="line">...............</span><br><span class="line">&gt; <span class="selector-tag">del</span> <span class="selector-tag">lock</span><span class="selector-pseudo">:k2</span></span><br><span class="line">(<span class="selector-tag">integer</span>) 0</span><br></pre></td></tr></table></figure>
<p>但是还有一个小问题，如果在setnx和expire之间服务器进程突然down了，可能是因为掉电或是人为照成，就会导致expire得不到执行，间接照成死锁</p>
<p>这种问题的根源在于setnx和expire是两条指令而不是原子指令。如果这两条指令可以一起执行就会出问题。事务也解决不了这个问题，因为expire需要依赖于setnx的执行结构，如果没有抢到锁，expire是不应该执行的，而事务是需要一次性执行的，要么全部执行，要么都不执行</p>
<ul>
<li>原子操作：指不会被线程调度机制打断的操作，一旦操作开始，就会一直运行到结束，中间不会有任何线程切换</li>
</ul>
<p>解决这个问题，Redis在2.8版本中，加入了set指令的扩展参数，使用的setnx和expire指令可以一起执行，彻底解决了分布式的问题。如下面的操作</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">lock</span><span class="selector-pseudo">:k3</span> <span class="selector-tag">true</span> <span class="selector-tag">ex</span> 5 <span class="selector-tag">nx</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">get</span> <span class="selector-tag">lock</span><span class="selector-pseudo">:k3</span></span><br><span class="line">(<span class="selector-tag">nil</span>)</span><br><span class="line">&gt; <span class="selector-tag">set</span> <span class="selector-tag">lock</span><span class="selector-pseudo">:k3</span> <span class="selector-tag">true</span> <span class="selector-tag">ex</span> 5 <span class="selector-tag">nx</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">&gt; <span class="selector-tag">get</span> <span class="selector-tag">lock</span><span class="selector-pseudo">:k3</span></span><br><span class="line">&quot;<span class="selector-tag">true</span>&quot;</span><br><span class="line">&gt; <span class="selector-tag">get</span> <span class="selector-tag">lock</span><span class="selector-pseudo">:k3</span></span><br><span class="line">(<span class="selector-tag">nil</span>)</span><br><span class="line">...............</span><br><span class="line">&gt; <span class="selector-tag">del</span> <span class="selector-tag">lock</span><span class="selector-pseudo">:k3</span></span><br><span class="line">(<span class="selector-tag">integer</span>) 0</span><br></pre></td></tr></table></figure>
<p>但还是因为不能确定每个key锁等待的时间，所以引出了多线程和zookeeper。如下图，描述解决死锁的三种方法</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210415160812865.png"></p>
<h3 id="穿透"><a href="#穿透" class="headerlink" title="穿透"></a>穿透</h3><p><strong>穿透：</strong>是业务在接收查询过程中，系统根本不存在的这些业务数据（比如：公司是做食品产品的，数据库会将一些热数据放入的redis缓存，但是在前面的业务搜索时候，没有搜索数据库中的全量产品，而搜索了一些不存在的产品，这些数据是在数据库没有的（缓存就更加没有了）。然后这些数据会全部通过数据库查询，本来就没有的数据，却还要消耗资源去查询，这就形成了一种穿透的概念</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210415145322542.png"></p>
<p><strong>如何解决穿透</strong></p>
<p>得通过布隆过滤器，判断缓存中是否存在，如果存在，就说明可能有一个这个数据（布隆过滤器不是100%判断成功的），那么布隆过滤器有三种采用的算法就，如下图</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210415150925140.png"></p>
<ul>
<li>Client实现bloom算法，自己承载bitmap（位图），redis服务只做缓存</li>
<li>Client实现bloom算法，将bitmap后置到redis，redis承载bitmap </li>
<li>Client没有算法，使用redis集成的bloom模块</li>
</ul>
<blockquote>
<p>注：这里的Client不是代表用户客户端，而是在redis前面的服务作为client（如web集群，spring等等服务）</p>
</blockquote>
<p>但是布隆过滤有一个缺点，就是不能删除，可能需要选择布隆鸟或者布隆+解决删除的问题（有兴趣的可以去了解）</p>
<h3 id="雪崩"><a href="#雪崩" class="headerlink" title="雪崩"></a>雪崩</h3><p><strong>雪崩：</strong>跟击穿差不多，雪崩比击穿更真实一些。击穿是一下子一个key产生多个并发请求，而雪崩是几百个key同时生效，然后每个key有20-30个请求，照成数据库的压力。（比如：一些key，设置过期时间是晚上零点整（24:00）过期，结果到24:00过期后，需要等待加载一批新的数据过来，而在这个等待过程中，可能会间接照成大量的key失效，这些失效的key就会去访问数据库，照成数据库的压力）。还有如果设置的过期时间key是24:00，那么过期key必须24:00更新，如果24::00点过了1分，那么获取的就是老数据的，就相当于脏读了</p>
<p><strong>如何解决雪崩</strong></p>
<p>在考虑如何解决的雪崩时候，你需要知道什么最容易产生雪崩。通过上述你可能已经知道零点整是最容易产生雪崩，那么解决方案呢，就是使用下述的均匀分布过期时间</p>
<ul>
<li><p>均匀分布过期时间（随机），分开3种情况</p>
<p>1）key必须零点整过期（有时点性），到达一致性的效果</p>
<p>2）时点性无关，就是key的过期时间是随机的（只要是跟时间点没关的话，就不用考虑那么多了，直接使用随机分布过期时间）</p>
</li>
<li><p>怎么解决key有时点性，也有两种方法</p>
<p>1）跟击穿相差不多，为了达到一致性，第一个过期的key偷偷的向数据库把24:00点的数据更回来（取回来之后，后续的key继续更新回来）</p>
<p>2）在业务层加上一个判断，零点整延迟（业务只要到24:00了，就随机sleep几秒），这样的小延迟是随机的，在加上redis的过期key也是随机的，所以可以避免不会有太太的请求到数据库</p>
</li>
</ul>
<blockquote>
<p>注：两种方法需要做一个取舍，要么达到数据库的一致性，一个个更新回来，要么就是随机不管，但也会照成少量的key访问数据库</p>
</blockquote>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210415155827844.png"></p>
<h2 id="redis分布式锁"><a href="#redis分布式锁" class="headerlink" title="redis分布式锁"></a>redis分布式锁</h2><p>redis分布式锁，在击穿事件中已经说明，分别是以下方法</p>
<ul>
<li>当key过期之后，通过setnx设置key值，判断key是否存在，不存在才能进行创建，只有设置完成的才能访问DB</li>
<li>合理设置锁的过期时间，锁时间多了，会等待，锁时间少了，锁会过期</li>
<li>多线程（守护线程，延迟过期时间），一个线程取库，一个线程监控更新回来的锁时间</li>
<li>zookeeper（最容易的分布式锁），虽然速率是没有redis快，但可以达到准确性和一致性</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Inaction</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://myboke.ink/2021/05/10/dis-集群-6/">https://myboke.ink/2021/05/10/dis-集群-6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis/">Redis</a></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/05/15/MySQL%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-6/"><i class="fa fa-chevron-left">  </i><span>MySQL日志管理-6</span></a></div><div class="next-post pull-right"><a href="/2021/05/10/Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-5/"><span>Redis消息队列-5</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '6cea6a646bff1a0d5f5b',
  clientSecret: '6e9ef08f31f505d416bc0afe2d304808e9063627',
  repo: 'zsjmal2316.github.io',
  owner: 'zsjmal2316',
  admin: 'zsjmal2316',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(img/beijing2.png)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2021 By Inaction</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">本网站由清远市网络安全与维护技能大师项目支持</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="120" alpha="0.3" zIndex="-1" data-click="false"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>