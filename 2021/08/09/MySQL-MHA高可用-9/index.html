<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="MySQL高可用InnoDB Cluster-10"><meta name="keywords" content="MySQL"><meta name="author" content="Inaction"><meta name="copyright" content="Inaction"><title>MySQL高可用InnoDB Cluster-10 | Inaction's Blog</title><link rel="shortcut icon" href="/imdadul-hussain-u_oLPS_ZYSc-unsplash.jpg"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?12b421fdad87d1edf2305ccb7229d2c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'G-8RMJ1F8ETC', 'auto');
ga('send', 'pageview');</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.3.0'
} </script><meta name="generator" content="Hexo 5.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL%E9%AB%98%E5%8F%AF%E7%94%A8-InnoDB-Cluster"><span class="toc-number">1.</span> <span class="toc-text">MySQL高可用-InnoDB Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB-Cluster%E4%B8%89%E5%A4%A7%E4%BB%B6"><span class="toc-number">1.1.</span> <span class="toc-text">InnoDB Cluster三大件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MRG%E6%8F%92%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">MRG插件结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sandbox%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2InnoDB-CLuster"><span class="toc-number">1.3.</span> <span class="toc-text">Sandbox快速部署InnoDB CLuster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85sandbox"><span class="toc-number">1.3.1.</span> <span class="toc-text">安装sandbox</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85MySQL"><span class="toc-number">1.3.2.</span> <span class="toc-text">安装MySQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85MySQL-Shell%E5%92%8CRouter"><span class="toc-number">1.3.3.</span> <span class="toc-text">安装MySQL Shell和Router</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BACluster"><span class="toc-number">1.3.4.</span> <span class="toc-text">创建Cluster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8BCluster%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.5.</span> <span class="toc-text">查看Cluster信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2"><span class="toc-number">1.3.6.</span> <span class="toc-text">故障自动切换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6-MGR%EF%BC%88%E7%BB%84%E5%A4%8D%E5%88%B6%EF%BC%89"><span class="toc-number">1.4.</span> <span class="toc-text">核心组件 MGR（组复制）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MGR%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.1.</span> <span class="toc-text">MGR介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MGR%E6%8A%80%E6%9C%AF"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">MGR技术</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MGR%E7%94%A8%E4%BE%8B"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">MGR用例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E4%B8%BB%E5%92%8C%E5%8D%95%E4%B8%BB%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.2.</span> <span class="toc-text">多主和单主模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E4%B8%BB%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">单主模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E7%9A%84%E5%88%9D%E9%80%89%E7%AE%97%E6%B3%95"><span class="toc-number">1.4.2.1.1.</span> <span class="toc-text">主的初选算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%8F%91%E7%8E%B0%E4%B8%BB"><span class="toc-number">1.4.2.1.2.</span> <span class="toc-text">如何发现主</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E4%B8%BB%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">多主模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%A3%80%E6%9F%A5"><span class="toc-number">1.4.2.2.1.</span> <span class="toc-text">事务检查</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Data-Definition-Statements%EF%BC%88%E6%95%B0%E6%8D%AE%E5%AE%9A%E4%B9%89%E8%AF%AD%E5%8F%A5%EF%BC%89"><span class="toc-number">1.4.2.2.2.</span> <span class="toc-text">Data Definition Statements（数据定义语句）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="toc-number">1.4.2.2.3.</span> <span class="toc-text">版本兼容性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MGR%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.3.</span> <span class="toc-text">MGR服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%84%E6%88%90%E5%91%98"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">组成员</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%A3%80%E6%B5%8B"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">故障检测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E9%94%99"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">容错</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MGR%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.5.</span> <span class="toc-text">MGR实例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%B8%BB%E6%A8%A1%E5%BC%8F%E4%B8%8B%E9%85%8D%E7%BD%AEGroup-Replication%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.5.1.</span> <span class="toc-text">单主模式下配置Group Replication实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">存储引擎</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">复制参数设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%84%E5%A4%8D%E5%88%B6%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">组复制设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F%E6%81%A2%E5%A4%8D%E7%9A%84%E7%94%A8%E6%88%B7"><span class="toc-number">1.5.1.4.</span> <span class="toc-text">用于分布式恢复的用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%BB%84%E5%A4%8D%E5%88%B6"><span class="toc-number">1.5.1.5.</span> <span class="toc-text">启动组复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%AF%BC%E7%BB%84%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.5.1.6.</span> <span class="toc-text">引导组设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%85%B6%E4%BB%96%E5%AE%9E%E4%BE%8B%E5%88%B0%E7%BB%84"><span class="toc-number">1.5.1.7.</span> <span class="toc-text">添加其他实例到组</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.5.1.7.1.</span> <span class="toc-text">添加第二个实例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%9B%B4%E5%A4%9A%E7%9A%84%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.5.1.7.2.</span> <span class="toc-text">添加更多的实例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2MGR"><span class="toc-number">1.5.2.</span> <span class="toc-text">本地部署MGR</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%AE%9E%E4%BE%8B%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">编写实例的配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MGR%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">1.5.3.</span> <span class="toc-text">MGR常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E5%B0%91%E5%8F%82%E6%95%B0%E9%97%AE%E9%A2%98"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">缺少参数问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E5%86%85%E5%AE%B9%E4%B8%8D%E4%B8%80%E8%87%B4"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">复制内容不一致</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#recovery%E8%BF%9E%E6%8E%A5%E6%8A%A5%E9%94%99"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">recovery连接报错</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E4%B8%80%E4%B8%AA%E5%A4%8D%E5%88%B6%E7%BB%84%E4%B8%AD%E7%9A%84%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="toc-number">1.5.3.4.</span> <span class="toc-text">判断一个复制组中的主节点</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/imdadul-hussain-u_oLPS_ZYSc-unsplash.jpg"></div><div class="author-info__name text-center">Inaction</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">54</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">19</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">13</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friend Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://www.ji4n.cn/">Jen</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(img/wuwei.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Inaction's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">MySQL高可用InnoDB Cluster-10</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-09</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/">Linux</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/MySQL/">MySQL</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="MySQL高可用-InnoDB-Cluster"><a href="#MySQL高可用-InnoDB-Cluster" class="headerlink" title="MySQL高可用-InnoDB Cluster"></a>MySQL高可用-InnoDB Cluster</h1><h2 id="InnoDB-Cluster三大件"><a href="#InnoDB-Cluster三大件" class="headerlink" title="InnoDB Cluster三大件"></a>InnoDB Cluster三大件</h2><p>InnoDB Cluster的三大件MySQL Shell、MySQL Router和MGR（MySQL Group Replication），其中MGR是InnoDB Cluster方案中的一个重要组件。如下MySQL官方给出的结构图</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210519111917493.png"></p>
<p>MySQL的这个高可用方案是一个share nothing的架构，这样也就是使得整个架构有强一致性的设计方式，自然会用到组播的方式</p>
<h2 id="MRG插件结构"><a href="#MRG插件结构" class="headerlink" title="MRG插件结构"></a>MRG插件结构</h2><p>MySQL Group Replication是一个MySQL插件，它基于现有的MySQL复制基础结构，利用二进制日志，基于行的日志记录和全局事务标识符等功能。它与当前的MySQL框架集成，如性能模式或插件和服务基础设施。下图提供了一个框图，描述了MySQL组复制的总体体系结构</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210525193056668.png"></p>
<ul>
<li>API层：MySQL Group Replication插件包括一组用于Capture（捕获）、Applier（应用）和Lifecycle（生命周期）的api，这些api控制插件如何与MySQL服务器交互，得到Server的状态，完成事务的管理。有接口使信息从服务器流向插件，反之亦然</li>
</ul>
<ul>
<li>组件层：当通知被路由时到组成员时，成员会做出反应。capture负责跟踪与正在执行事务相关的上下文信息；applier负责在数据库上执行远程事务；recovery负责管理分布式恢复</li>
<li>复制层：包含复制协议的特定逻辑。它处理冲突检测，并接收事务并将事务传播到组</li>
<li>通信层：组复制插件架构的最后两层是组通信系统(GCS) API，基于paxos的组通信引擎(XCom)的实现。GCS API是一个高级API，它抽象了构建复制状态机所需的属性。因此，它将消息层的实现与插件的其余上层解耦，组的通信引擎处理与复制组成员之间的通信</li>
</ul>
<p>可以看出，MGR是一个标准的分布式架构设计，基于Paxos的组通信引擎（XCom）的实现</p>
<h2 id="Sandbox快速部署InnoDB-CLuster"><a href="#Sandbox快速部署InnoDB-CLuster" class="headerlink" title="Sandbox快速部署InnoDB CLuster"></a>Sandbox快速部署InnoDB CLuster</h2><p>安装InnoDB Cluster环境的一个基本要求就是python，Centos7系统默认就是使用python2.7，所以我们可以不需要安装python，直接安装其他环境</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python -V</span></span><br><span class="line">Python 2.7.5</span><br></pre></td></tr></table></figure>
<h3 id="安装sandbox"><a href="#安装sandbox" class="headerlink" title="安装sandbox"></a>安装sandbox</h3><p>只需要下载cpan指令，然后通过一条命令即可下载了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> yum install -y cpan</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cpan MySQL::Sandbox   //输出的信息，全部回车即可</span></span><br></pre></td></tr></table></figure>
<h3 id="安装MySQL"><a href="#安装MySQL" class="headerlink" title="安装MySQL"></a>安装MySQL</h3><p>可以参考我的另一篇文章，关于MySQL安装的，这里不在演示步骤。安装MySQL[链接][<a href="https://myboke.ink/2021/02/20/MySQL%E6%A6%82%E8%BF%B0%E4%B8%8E%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85-1/#MySQL%E4%BB%8B%E7%BB%8D]">https://myboke.ink/2021/02/20/MySQL%E6%A6%82%E8%BF%B0%E4%B8%8E%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85-1/#MySQL%E4%BB%8B%E7%BB%8D]</a></p>
<h3 id="安装MySQL-Shell和Router"><a href="#安装MySQL-Shell和Router" class="headerlink" title="安装MySQL Shell和Router"></a>安装MySQL Shell和Router</h3><ul>
<li>[官方MySQL Shell下载][<a target="_blank" rel="noopener" href="https://downloads.mysql.com/archives/shell/]">https://downloads.mysql.com/archives/shell/]</a></li>
<li>[官方MySQL Router下载][<a target="_blank" rel="noopener" href="https://downloads.mysql.com/archives/router/]">https://downloads.mysql.com/archives/router/]</a></li>
</ul>
<p>可通过Linux的wget命令下载，也可以在本地上传，然后上传解压</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://downloads.mysql.com/archives/get/p/43/file/mysql-shell-8.0.25-linux-glibc2.12-x86-64bit.tar.gz</span><br><span class="line">$ wget https://downloads.mysql.com/archives/get/p/41/file/mysql-router-8.0.25-linux-glibc2.12-x86_64.tar.xz</span><br><span class="line">$ mkdir /mysql-tools</span><br><span class="line">$ tar xf mysql-router-8.0.20-linux-glibc2.12-x86_64.tar.xz -C /mysql-tools</span><br><span class="line">$ tar xf mysql-shell-8.0.20-linux-glibc2.12-x86-64bit.tar.gz -C /mysql-tools</span><br></pre></td></tr></table></figure>
<h3 id="创建Cluster"><a href="#创建Cluster" class="headerlink" title="创建Cluster"></a>创建Cluster</h3><p>安装完之后通过Mysql Shell命令mysqlsh脚本开始部署，创建一个端口为3210的实例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /mysql-tools/mysql-shell-8.0.20-linux-glibc2.12-x86-64bit/bin/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./mysqlsh</span> </span><br><span class="line">...</span><br><span class="line">MySQL  JS &gt; dba.deploySandboxInstance(3210)   //默认回车即可</span><br></pre></td></tr></table></figure>
<p>可输入密码，也可以回车不输入，一个端口3210的MySQL服务就启动好了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Instance localhost:3210 successfully deployed and started.</span><br><span class="line">Use shell.connect(&#x27;root@localhost:3210&#x27;) to connect to the instance.</span><br></pre></td></tr></table></figure>
<p>后续继续创建两个节点3220和3230</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MySQL  JS &gt; dba.deploySandboxInstance(3220)</span><br><span class="line">MySQL  JS &gt; dba.deploySandboxInstance(3230)</span><br></pre></td></tr></table></figure>
<p>创建的实例可在<code>$/home/mysql-sandboxes</code>目录下查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ll /root/mysql-sandboxes/</span></span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x. 5 root root 116 May 20 21:04 3210</span><br><span class="line">drwxr-xr-x. 5 root root 116 May 20 20:28 3220</span><br><span class="line">drwxr-xr-x. 5 root root 116 May 20 20:30 3230</span><br><span class="line"></span><br><span class="line">ll /root/mysql-sandboxes/3210</span><br><span class="line">3210.pid  bin  my.cnf  mysql-files  sandboxdata  start.sh  stop.sh</span><br></pre></td></tr></table></figure>
<p>切换连接到3210实例，开始创建Cluster</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MySQL  JS &gt; \connect root@localhost:3210</span><br><span class="line">...</span><br><span class="line">MySQL  localhost:3210 ssl  JS &gt; </span><br></pre></td></tr></table></figure>
<p>定义一个Cluster变量，接着节点1就开启了Cluster创建，可以从下述信息看出，至少需要3个节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3210 ssl  JS &gt; var cluster = dba.createCluster(&#x27;t_Cluster&#x27;)</span><br><span class="line">Adding Seed Instance...</span><br><span class="line">Cluster successfully created. Use Cluster.addInstance() to add MySQL instances.</span><br><span class="line">At least 3 instances are needed for the cluster to be able to withstand up to</span><br><span class="line">one server failure.</span><br></pre></td></tr></table></figure>
<p>后续将两个节点添加进来，加入3220和3230实例，可以默认回车，也可以根据输出的信息进行填写</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3210 ssl  JS &gt; cluster.addInstance(&#x27;root@localhost:3220&#x27;)</span><br><span class="line">MySQL  localhost:3210 ssl  JS &gt; cluster.addInstance(&#x27;root@localhost:3230&#x27;)</span><br></pre></td></tr></table></figure>
<p>配置MySQL Router，创建个软连接，保证能够正常调用（要绝对路径）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ln -s /mysql-tools/mysql-router-8.0.20-linux-glibc2.12-x86_64/bin/mysqlrouter /usr/bin/mysqlroute</span></span><br></pre></td></tr></table></figure>
<p>在配置MySQL Router的启动节点为端口3310的实例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /mysql-tools/mysql-router-8.0.20-linux-glibc2.12-x86_64/bin/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./mysqlrouter --bootstrap root@localhost:3210 --user=root  //没有密码的直接回车</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Bootstrapping system MySQL Router instance...</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#</span><span class="bash"> MySQL Router configured <span class="keyword">for</span> the InnoDB Cluster <span class="string">&#x27;t_Cluster&#x27;</span></span></span><br><span class="line">After this MySQL Router has been started with the generated configuration</span><br><span class="line">    $ /etc/init.d/mysqlrouter restart</span><br><span class="line">or</span><br><span class="line">    $ systemctl start mysqlrouter</span><br><span class="line">or</span><br><span class="line">    $ ./mysqlrouter -c /mysql-tools/mysql-router-8.0.20-linux-glibc2.12-x86_64/mysqlrouter.conf</span><br><span class="line">the cluster &#x27;t_Cluster&#x27; can be reached by connecting to:</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># MySQL Classic protocol</span></span></span><br><span class="line">- Read/Write Connections: localhost:6446</span><br><span class="line">- Read/Only Connections:  localhost:6447</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># MySQL X protocol</span></span></span><br><span class="line">- Read/Write Connections: localhost:64460</span><br><span class="line">- Read/Only Connections:  localhost:64470</span><br></pre></td></tr></table></figure>
<p>从输出的日志来看，分配的读写端口是6446，只读端口是6447，还有X协议连接的端口为64460和64470。可以查看一下<code>/mysql-tools/mysql-router-8.0.20-linux-glibc2.12-x86_64/mysqlrouter.conf</code>配置文件都有哪些信息，下述只截取一部分</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /mysql-tools/mysql-router-8.0.20-linux-glibc2.12-x86_64/mysqlrouter.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> File automatically generated during MySQL Router bootstrap</span></span><br><span class="line">[DEFAULT]</span><br><span class="line">name=system</span><br><span class="line">user=root</span><br><span class="line">keyring_path=/mysql-tools/mysql-router-8.0.20-linux-glibc2.12-x86_64/var/lib/mysqlrouter/keyring</span><br><span class="line">master_key_path=/mysql-tools/mysql-router-8.0.20-linux-glibc2.12-x86_64/mysqlrouter.key</span><br><span class="line">connect_timeout=15</span><br><span class="line">read_timeout=30</span><br><span class="line">dynamic_state=/mysql-tools/mysql-router-8.0.20-linux-glibc2.12-x86_64/bin/../var/lib/mysqlrouter/state.json</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>启动MySQL Router，接着尝试使用6446端口来连接登录，通过MySQL Shell连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./mysqlrouter &amp;</span></span><br><span class="line">[1] 6954</span><br><span class="line"><span class="meta">$</span><span class="bash"> ./mysqlsh --uri root@localhost:6446</span></span><br><span class="line">MySQL  localhost:6446 ssl  JS &gt; </span><br></pre></td></tr></table></figure>
<p>之后可以切换到SQL模式，查看端口会发现是3210节点，这是由MySQL Router做了转接，连接到了里面的读写节点3210</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:6446 ssl  SQL &gt; select @@port;</span><br><span class="line">+--------+</span><br><span class="line">| @@port |</span><br><span class="line">+--------+</span><br><span class="line">|   3210 |</span><br><span class="line">+--------+</span><br></pre></td></tr></table></figure>
<h3 id="查看Cluster信息"><a href="#查看Cluster信息" class="headerlink" title="查看Cluster信息"></a>查看Cluster信息</h3><p>查看Cluster的集群名称，如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:6446 ssl  JS &gt; dba.getCluster()</span><br><span class="line">&lt;Cluster:t_Cluster&gt;</span><br></pre></td></tr></table></figure>
<p>查看Cluster的状态信息，如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 设置变量</span></span><br><span class="line">MySQL  localhost:6446 ssl  JS &gt; var cluster = dba.getCluster()</span><br><span class="line"></span><br><span class="line">MySQL  localhost:6446 ssl  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;t_Cluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;127.0.0.1:3210&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;REQUIRED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;127.0.0.1:3210&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;127.0.0.1:3210&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;127.0.0.1:3220&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;127.0.0.1:3220&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;127.0.0.1:3230&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;127.0.0.1:3230&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;topologyMode&quot;: &quot;Single-Primary&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;127.0.0.1:3210&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以通过describe得到一些基本的信息，如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:6446 ssl  JS &gt; cluster.describe();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;t_Cluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;topology&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;address&quot;: &quot;127.0.0.1:3210&quot;, </span><br><span class="line">                &quot;label&quot;: &quot;127.0.0.1:3210&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                &quot;address&quot;: &quot;127.0.0.1:3220&quot;, </span><br><span class="line">                &quot;label&quot;: &quot;127.0.0.1:3220&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                &quot;address&quot;: &quot;127.0.0.1:3230&quot;, </span><br><span class="line">                &quot;label&quot;: &quot;127.0.0.1:3230&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ], </span><br><span class="line">        &quot;topologyMode&quot;: &quot;Single-Primary&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="故障自动切换"><a href="#故障自动切换" class="headerlink" title="故障自动切换"></a>故障自动切换</h3><p>模拟一个节点出现问题，可使用<code>killSandboxInstance</code>方法，如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:6446 ssl  JS &gt; dba.killSandboxInstance(3210)</span><br><span class="line"></span><br><span class="line">Killing MySQL instance...</span><br><span class="line">Instance localhost:3210 successfully killed.</span><br></pre></td></tr></table></figure>
<p>查看进程是否被清理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps -ef|grep 3210</span></span><br><span class="line">root       7009   6991  0 20:59 pts/0    00:00:00 grep --color=auto 3210</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ps -ef|grep 3220</span>   </span><br><span class="line">root       5707      1  0 20:28 pts/2    00:00:00 /bin/bash /root/mysql-sandboxes/3220/start.sh --user=root</span><br><span class="line">root       5708   5707  0 20:28 pts/2    00:00:10 /root/mysql-sandboxes/3220/bin/mysqld --defaults-file=/root/mysql-sandboxes/3220/my.cnf --user=root</span><br></pre></td></tr></table></figure>
<p>可以看到3210实例进程已经被清理，查看3220实例进程还是存在的</p>
<p>再次通过MySQL Shell重新连接6446端口，然后切换sql模式，查看端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:6446 ssl  JS &gt; \quit</span><br><span class="line">Bye!</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./mysqlsh --uri root@localhost:6446</span></span><br><span class="line">MySQL  localhost:6446 ssl  JS &gt; \sql</span><br><span class="line">Switching to SQL mode... Commands end with ;</span><br><span class="line">MySQL  localhost:6446 ssl  SQL &gt; select @@port;</span><br><span class="line">+--------+</span><br><span class="line">| @@port |</span><br><span class="line">+--------+</span><br><span class="line">|   3230 |</span><br></pre></td></tr></table></figure>
<p>查看的端口已经切换成3230，就说明故障切换没有产生问题，接着在把宕机的节点启动起来</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:6446 ssl  SQL &gt; \js</span><br><span class="line">Switching to JavaScript mode...</span><br><span class="line"></span><br><span class="line">MySQL  localhost:6446 ssl  JS &gt; dba.startSandboxInstance(3210)</span><br><span class="line">Starting MySQL instance...</span><br><span class="line">Instance localhost:3210 successfully started.</span><br></pre></td></tr></table></figure>
<p>重新查看Cluster的状态，会发现3230已经是主了，而3210会被切换成读节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:6446 ssl  JS &gt; dba.getCluster()</span><br><span class="line">&lt;Cluster:t_Cluster&gt;</span><br><span class="line">MySQL  localhost:6446 ssl  JS &gt; var cluster = dba.getCluster()</span><br><span class="line">MySQL  localhost:6446 ssl  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;t_Cluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;127.0.0.1:3230&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;REQUIRED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;127.0.0.1:3210&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;127.0.0.1:3210&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;127.0.0.1:3220&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;127.0.0.1:3220&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;127.0.0.1:3230&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;127.0.0.1:3230&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;topologyMode&quot;: &quot;Single-Primary&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;127.0.0.1:3230&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="核心组件-MGR（组复制）"><a href="#核心组件-MGR（组复制）" class="headerlink" title="核心组件 MGR（组复制）"></a>核心组件 MGR（组复制）</h2><h3 id="MGR介绍"><a href="#MGR介绍" class="headerlink" title="MGR介绍"></a>MGR介绍</h3><p>MySQL组复制（MRG，MySQL Group Replication）提供分布式状态机复制与服务器之间的强协调。当服务器属于同一组时，它们会自动协调自己。组可以在<u>单主模式</u>下操作，并具有自动主选，即每次只有一个服务器接受更新</p>
<p>或者，对于更高级的用户，可以以<u>多主模式</u>部署组，这种模式下，所有服务器都可以接受更新，即使它们是并发发布的。但这种功能的代价是应用程序必须克服这种部署所施加的限制</p>
<p>组复制内置一个组成员服务，组成员的构建了一个组视图，成员自由离开或加入组，视图会相应的更新。如果是意外离开组，会通过故障检测到这一点，然后通知组视图进行更改，过程都是自动的</p>
<p>当提交一个事务，需要组中的大多数成员同意给定事务在全局事务序列中的顺序。当决定提交或中止事务是由每个服务器单独完成的，但需要所有服务器做出相同的决定。如果出现网络分区，导致成员分裂，则系统不会继续运行，而是知道这个问题解决之后才继续运行<em>（组复制也有一个内置的自动恢复的保护机制）</em></p>
<p>所有这些都是由提供的组通信系统(GCS)协议提供的。它们提供了故障检测机制、组成员服务和安全且完全有序的消息传递。所有这些属性都是创建组复制的关键，确保在服务器组中一致地复制数据。这项技术的核心是Paxos算法的实现，它充当组通信引擎。</p>
<h4 id="MGR技术"><a href="#MGR技术" class="headerlink" title="MGR技术"></a>MGR技术</h4><p>组复制是一种可用于实现<u>容错系统</u>的技术，每个服务器都有自己的完整数据副本(无共享复制方案)。组复制又由多个服务器组成，组中的每个服务器可以独立的执行事务，但所有的读写事务需要得到组的批准才能提交。换句话说，对于任何读写事务，组决定是否提交，不是原服务器单方面决定。而只读事务就不需要组内批准</p>
<p>当读写事务准备在原服务器上提交时，服务器会自动广播写值(更改的行)和相应的写集(更新的行的唯一标识符)。因为事务是通过原子广播发送的，所以要么组中的所有服务器都接收该事务，要么没有服务器接收，如果它们都收到它，那么他们都以相同的顺序接收。因此，所有服务器以相同的顺序接收相同的事务集，并为事务建立一个全局总排序</p>
<p>组复制是一个<u>最终的一致性系统</u>，意味着一旦传入的流量变慢或停止，所有组成员就具有相同的数据内容。例如，在单主模式中，主服务器并发的、无冲突的本地事务可能会以不同于Group Replication所同意的全局顺序提交。</p>
<p>下图描述了MySQL组复制协议，通过将其与MySQL复制(或MySQL半同步复制)进行比较，可以看到一些区别，图中缺少了一些Paxos的相关信息</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210521173758783.png"></p>
<h4 id="MGR用例"><a href="#MGR用例" class="headerlink" title="MGR用例"></a>MGR用例</h4><p>通过组复制，可以创建具有冗余的系统，即使服务器出现故障，只要不是全部或者大部分服务器出现故障，系统仍然是可以用的。但会根据故障的服务器的数量，组可能会降低性能或可扩展性，但仍然可用</p>
<p>尽管数据库服务是可用的，但如果服务器是发生意外down机，那些连接到它的客户端必须重定向或故障转移到不同的服务区。组复制不能解决这个问题，但可以通过MySQL Routing来解决路由的问题（即重定向到可用的主机）</p>
<p>总的来说，MySQL Group Replication提供了一个高可用性、高弹性、可靠的MySQL服务。</p>
<blockquote>
<p>PS：要部署多个MySQL实例，可以使用InnoDB Cluster，然后使用MySQL Shell轻松管理一组MySQL服务器实例。InnoDB Cluster将MySQL Group Replication包装在一个编程环境中，能够轻松部署MySQL实例集群来实现高可用性。还有InnoDB集群与MySQL路由器无缝连接，可以使应用程序无需编写自己的故障转移过程就可以连接到集群。但是，对于不需要高可用性的类似用例，可以使用InnoDB replicasset</p>
</blockquote>
<p><strong>示例用例</strong></p>
<p>下列例子是组复制典型使用情况</p>
<ul>
<li><p>弹性复制：需要非常灵活的复制基础设施的环境，其中服务器的数量必须动态增加或减少，并且副作用尽可能少。例如，用于云的数据库服务</p>
</li>
<li><p>高可用分片：高可用分片——分片是实现写扩展的一种流行方法。使用MySQL组复制实现高可用分片，其中每个分片映射到一个复制组</p>
</li>
<li><p>替代异步源副本复制：在某些情况下，使用单一源服务器会使它成为一个争用点。在某些情况下，写入整个组可能被证明更具可伸缩性</p>
</li>
<li><p>自主系统：此外，可以部署MySQL Group Replication纯粹是为了实现复制协议内建的自动化(已经在上述描述过了)</p>
</li>
</ul>
<h3 id="多主和单主模式"><a href="#多主和单主模式" class="headerlink" title="多主和单主模式"></a>多主和单主模式</h3><p>组复制能运行在单主模式或多主模式，组模式可以通过MySQL指令或配置文件进行转换，由系统变量<code>group_replication_single_primary_mode</code>指定，在所有成员上必须是相同的。ON表示单主模式（默认模式），OFF表示多主模式。不能让组的成员以不同的模式部署，例如，一个成员以多主模式配置，而另一个成员以单主模式配置</p>
<p>不能在“组复制”运行时手动修改<code>group_replication_single_primary_mode</code>的值。在MySQL 8.0.13中，可以使用<code>group_replication_switch_to_single_primary_mode()</code>和<code>group_replication_switch_to_multi_primary_mode()</code>函数将组从一种模式移动到另一种模式，而组复制仍在运行中</p>
<p>这些功能管理更改组模式的过程，并确保您的数据的安全性和一致性。在以前的版本中，要修改组模式，必须先停止“组复制”，接着在所有成员上修改<code>group_replication_single_primary_mode</code>的值，然后执行组重新启动(由具有<code>group_replication_bootstrap_group=ON</code>的服务器引导)，以实现对新的操作配置的更改。不需要重新启动服务器</p>
<p>无论部署模式是什么，Group Replication都不会处理客户端故障转移。需要通过中间件框架(如MySQL Router 8.0)、代理、连接器或应用程序本身来处理</p>
<h4 id="单主模式"><a href="#单主模式" class="headerlink" title="单主模式"></a>单主模式</h4><p>在单主服务器模式下（<code>group_replication_single_primary_mode = ON</code>），组具有一个成员设置为读写模式的主服务器。其他成员都设置为只读模式（<code>super_read_only = ON</code>）。主服务器通常是引导该组的第一台服务器。加入该组的所有其他服务器了解主服务器，并自动设置为只读模式。</p>
<p>在单主模式下，组复制强制只有一个服务器写入组，因此与多主模式相比，一致性检查可以不那么严格，DDL语句不需要特别小心地处理。<code>group_replication_enfor_update_everywhere_checks</code>选项用于启用或禁用组的严格一致性检查。当部署为单主模式或将组更改为单主模式时，此变量必须设置为OFF</p>
<p>被指定为主服务器的成员可以通过以下方式更改：</p>
<ul>
<li>如果现有的初选退出，无论是自愿的还是意外的，一个新的初选将<code>自动</code>选出</li>
<li>可以使用<code>group_replication_set_as_primary()</code>函数指定一个特定成员作为新的主节点</li>
<li>如果使用<code>group_replication_switch_to_single_primary_mode()</code>函数将一个运行在多主模式下的组修改为单主模式。自动选择一个新的主，或可以通过使用功能指定新的主</li>
</ul>
<p>仅当所有组成员都运行MySQL 8.0.13或更高版本时，才可以使用该功能。自动选择新的主服务器或手动指定新的主服务器时，它将自动设置为可<code>读写</code>，其他组成员保留为从主机，只能只读。 下图选主的一个过程</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210524092921874.png"></p>
<p>当一个新的主服务器被选出或指定时，可能会有一些已经在旧主服务器上应用，但还没有在此服务器上应用的更改。在这种情况下，直到新的主数据库赶上旧的主数据库，读写事务可能会导致冲突并回滚，而只读事务可能导致陈旧的读取。组复制的流控制机制最大程度地减少了快速成员和慢成员之间的差异，如果激活并适当调整了它，则可以减少这种情况的发生</p>
<p>有关流量控制的更多信息，可通过官方[Flow Contorl][<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-flow-control.html]%E8%BF%9B%E8%A1%8C%E8%AF%A6%E7%BB%86%E7%9A%84%E4%BA%86%E8%A7%A3%E3%80%82%E4%BB%8EMySQL">https://dev.mysql.com/doc/refman/8.0/en/group-replication-flow-control.html]进行详细的了解。从MySQL</a> 8.0.14开始，还可以使用<code>group_replication_consistency</code>系统变量来配置组的事务一致性级别，以防止出现此问题。</p>
<p>设置<code>BEFORE_ON_PRIMARY_FAILOVER</code>（或更高的一致性级别）将在新选举的主数据库上保存新事务。事务一致性的更多信息，可通过官方<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-consistency-guarantees.html">Transaction Consistency Guarantees”</a>进行详细的了解。如果没有为组使用流控制和事务一致性保证，则优良作法是在将新的主应用程序重新路由到该主数据库之前，等待新主数据库应用其复制相关的中继日志</p>
<h5 id="主的初选算法"><a href="#主的初选算法" class="headerlink" title="主的初选算法"></a>主的初选算法</h5><p>每个成员都按照其MySQL Server版本中的主要选举算法在本地做出自己的决定。由于所有成员都必须做出相同的决定。因此，如果其他组成员正在运行较低版本的MySQL Server，则成员将调整其主要选举算法，从而使其与组中拥有最低MySQL Server版本的成员具有相同的行为</p>
<p>成员按顺序选举主要成员时考虑的因素如下：</p>
<ul>
<li><p>考虑的第一个因素是哪个或哪些成员运行最低的MySQL Server版本。如果所有组成员都在运行MySQL 8.0.17或更高版本，则首先按其发行版的补丁程序对成员进行排序。如果所有成员运行的是MySQL Server 5.7或MySQL 8.0.16或更低版本，则首先按其发行版的主版本对成员进行排序，并且忽略补丁程序版本</p>
</li>
<li><p>如果有多个成员正在运行最低的MySQL Server版本，则考虑的第二个因素是每个成员的成员权重，具体由成员上的<code>group_replication_member_weight</code>系统变量指定。如果这个组的所有成员正在运行MySQL Server 5.7，则这个参数是不可用的，因此这个因素会被忽略</p>
<p><code>group_replication_member_weight</code>系统变量的取值范围是0 ~ 100。所有成员的默认权重为50，因此设置低于此权重以降低排序，设置高于此权重以增加排序。可以使用这个加权函数来确定使用更好的硬件的优先级，或者确保在计划的主节点维护期间将故障转移到特定的成员</p>
</li>
<li><p>如果有多个成员正在运行最低的MySQL Server版本，并且多个成员中有一个具有最高成员权重（或忽略了成员权重），则考虑的第三个因素是每个成员的已生成服务器<code>UUID</code>的标识符顺序 ，由server_uuid系统变量指定。该因素可作为最后选择的保证。因此，如果不能由任何重要因素决定，则所有小组成员均会做出相同的决定</p>
</li>
</ul>
<h5 id="如何发现主"><a href="#如何发现主" class="headerlink" title="如何发现主"></a>如何发现主</h5><p>在单主模式下部署时找出当前哪个服务器是主服务器，可使用<code>Performance_schema.replication_group_members</code>表中的MEMBER_ROLE列。 例如下述命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT MEMBER_HOST, MEMBER_ROLE FROM performance_schema.replication_group_members;</span></span><br><span class="line">+-------------------------+-------------+</span><br><span class="line">| MEMBER_HOST             | MEMBER_ROLE |</span><br><span class="line">+-------------------------+-------------+</span><br><span class="line">| remote1.example.com     | PRIMARY     |</span><br><span class="line">| remote2.example.com     | SECONDARY   |</span><br><span class="line">| remote3.example.com     | SECONDARY   |</span><br><span class="line">+-------------------------+-------------+</span><br></pre></td></tr></table></figure>
<p>或者使用<code>group_replication_primary_member</code>状态变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW STATUS LIKE <span class="string">&#x27;group_replication_primary_member&#x27;</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：<code>group_replication_primary_member</code>状态变量已被弃用，并计划在以后的版本中删除</p>
</blockquote>
<h4 id="多主模式"><a href="#多主模式" class="headerlink" title="多主模式"></a>多主模式</h4><p>在多主要模式下（<code>group_replication_single_primary_mode = OFF</code>），没有成员具有特殊角色。在加入组时，所有成员都被设置为读写模式，并且可以处理写事务，即使它们是并发读写的</p>
<p>如果成员停止接受写事务(例如，在意外的服务器退出的情况下)，连接到该成员的客户端可以被重定向或故障转移到处于读写模式的任何其他成员。Group Replication本身并不处理客户端故障转移，因此需要使用中间件框架(如MySQL Router 8.0)、代理、连接器或应用程序本身来安排</p>
<p>下述描述了客户端故障转移，显示了如果一个成员离开组，客户端如何重新连接到一个可选组成员</p>
<p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/redis-pages/image-20210524144410871.png"></p>
<p>组复制是一个最终的一致性系统。意味着一旦传入流量变慢或停止，所有组成员就具有相同的数据内容。当流量在流动时，可以在某些成员上先进行事务外部化，尤其是在某些成员的写吞吐量低于其他成员的情况下，这可能导致过时的读取</p>
<p>在多主数据库模式下，速度较慢的成员还可能积压过多的事务进行认证和应用，从而导致更大的冲突和认证失败风险。为了限制这些问题，可以激活和优化Group Replication的流控制机制，以最小化快速成员和慢速成员之间的差异，可通过官方[Flow Contorl][<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-flow-control.html]%E8%BF%9B%E8%A1%8C%E8%AF%A6%E7%BB%86%E7%9A%84%E4%BA%86%E8%A7%A3">https://dev.mysql.com/doc/refman/8.0/en/group-replication-flow-control.html]进行详细的了解</a></p>
<p>从MySQL 8.0.14开始，如果为组中的每个事务提供事务一致性保证，可以使用<code>group_replication_consistency</code>系统变量来实现这一点。选择适合组的工作负载和数据读写优先级的设置，并考虑到增加一致性所需的同步的性能影响。还可以为单个会话设置系统变量，以保护特别是对并发敏感的事务，可通过官方<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-consistency-guarantees.html">Transaction Consistency Guarantees”</a>进行详细的了解</p>
<h5 id="事务检查"><a href="#事务检查" class="headerlink" title="事务检查"></a>事务检查</h5><p>当一个组以多主模式部署时，将检查事务，以确保它们与该模式兼容。“Group Replication”部署为多主模式时，需要进行如下严格的一致性检查</p>
<ul>
<li>如果事务是在SERIALIZABLE（可序列化）隔离级别下执行的，那么它的提交将在与组同步时失败</li>
<li>如果一个事务针对具有级联约束的外键的表执行，那么它在与组同步时提交失败</li>
</ul>
<p><code>group_replication_enforce_update_everywhere_checks</code>系统变量。在多主模式下，通常应该设置为ON，但是可以选择通过将系统变量设置为OFF来禁用检查。<code>单机部署</code>时，系统变量必须设置为<code>“OFF”</code></p>
<h5 id="Data-Definition-Statements（数据定义语句）"><a href="#Data-Definition-Statements（数据定义语句）" class="headerlink" title="Data Definition Statements（数据定义语句）"></a>Data Definition Statements（数据定义语句）</h5><p>在多主模式下的Group Replication拓扑中，在执行数据定义语句(通常也称为数据定义语言(DDL))时需要注意。MySQL 8.0引入了对原子数据定义语言(DDL)语句的支持，其中完整的DDL语句作为单个原子事务提交或回滚</p>
<p>然而，DDL语句，无论是原子的还是其他的，都会隐式地结束当前会话中活动的任何事务，就像在执行语句之前执行了COMMIT一样。意味着DDL语句不能在另一个事务中执行，在事务控制语句中，如START transaction…COMMIT，或与同一事务中的其他语句组合</p>
<p>Group Replication基于乐观复制范式，其中语句将乐观地执行，并在必要时稍后回滚。每个服务器在执行时都不会首先确保组协议的安全。因此，在多主模式下复制DDL语句时需要格外小心</p>
<p>如果对同一对象进行模式更改（使用DDL）并更改对象包含的数据（使用DML），则需要通过同一服务器处理更改，而模式操作尚未完成并在各处复制。如果不这样做，当操作被中断或仅部分完成时，可能会导致数据不一。如果组以单主服务器模式部署，则不会发生此问题，因为所有更改都是通过同一服务器（主服务器）执行的</p>
<p>关于MySQL 8.0中对原子DDL的支持以及某些语句的复制所导致的行为变化的详细信息，可参考官方<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/atomic-ddl.html">Atomic Data Definition Statement Support</a></p>
<h5 id="版本兼容性"><a href="#版本兼容性" class="headerlink" title="版本兼容性"></a>版本兼容性</h5><p>对于版本的兼容性，最好是所有成员都运行相同版本的MySQL Server，也运行相同版本的Group Replication。如果一个组的成员运行了多个不同的MySQL Server版本，就有可能成员与成员之间是不兼容的，会出现有成员不支持一些功能，或者缺少其他成员的功能。为了防止这个情况，当一个成员加入，对该组的所有成员进行兼容性检查</p>
<p>如果一个加入成员运行的MySQL Server版本高于现有组成员运行的最低版本，它加入组但保持只读模式。(在以单主模式运行的组中，新添加的成员在任何情况下默认为只读）运行MySQL 8.0.17或更高版本的成员在检查他们的兼容性时要考虑补丁版本。运行MySQL 8.0.16或更低版本，或MySQL 5.7的成员，只考虑主版本</p>
<p>在多主模式下运行的组中，成员使用不同的MySQL Server版本，组复制自动管理运行MySQL 8.0.17或更高版本的成员的读写和只读状态。如果成员离开组，则运行现在最低版本的成员将自动设置为读写模式</p>
<p>当使用<code>group_replication_switch_to_multi_primary_mode()</code>函数将运行在单主模式下的组更改为运行在多主模式下时，group Replication会自动将成员设置为正确的模式。如果运行的MySQL服务器版本高于组中最低版本，则成员将自动处于只读模式，运行最低版本的成员将处于读写模式</p>
<p>关于组版本兼容性以及这如何影响升级过程中组的行为的完整信息，可参考官网<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-online-upgrade-combining-versions.html">Combining Different Member Versions in a Group</a> </p>
<h3 id="MGR服务"><a href="#MGR服务" class="headerlink" title="MGR服务"></a>MGR服务</h3><h4 id="组成员"><a href="#组成员" class="headerlink" title="组成员"></a>组成员</h4><p>在MySQL组复制中，一组服务器组成一个复制组。群组具有名称，名称采用UUID的形式。这个组是动态的，服务器可以随时离开(自愿或非自愿)并加入。每当服务器加入或离开时，组会调整自身动态</p>
<p>组复制具有一个组成员服务，该服务定义了哪些服务器处于Oneline或是Down，在线服务器列表称为视图。组成员不仅必须事务提交达成一致，而且还必须就当前视图的提交达成一致。如果该组的成员同意别的成员加入，则需要重新配置，接着触发视图更改。如果服务器自愿或不自愿离开组，则组会动态安排其配置，并触发视图更改</p>
<p>在成员自愿离开的情况下，会启动一个动态组重新配置，这个时期，所有成员必须在没有离开组的情况下达成视图一致的更改。如果成员非自愿离开（例如：网络连接超时、断开或Down机），在这种情况下，组复制会启动故障检测机制短时间识别出已离开的成员，并重新配置组。但是，如果组不能达成协议（例如，因为它的分区方式没有大多数服务器在线）系统不能动态改变配置，并阻塞以防止裂脑的情况。这种情况需要管理员的干预</p>
<p>成员可能会短暂脱机，接着会通过故障检测将故障之前重新配置组或删除组成员的信息，尝试再次重新加入组。这种情况下，重新加入的成员会忘记之前的状态。但如果其他成员向该新加入的成员发送用于其down前的状态信息，可能会导致，数据的不一致。如果这种情况下的成员参与了XCom的共识协议，这可能会导致XCom在相同的共识回合中通过在失败前和失败后做出不同的决定而提供不同的价值。</p>
<p>为了应对这种可能性，从MySQL 5.7.22和MySQL 8.0中，Group Replication检查相同服务器的新身份加入组，而旧身份(具有相同的地址和端口号)仍然作为成员离开的情况。新的身份被阻止加入组，直到旧身份通过重新配置和被删除</p>
<blockquote>
<p>注意：如果<code>group_replication_member_expel_timeout</code>系统变量添加了一个等待时间，以允许成员有更多时间在被驱逐之前与该组重新连接，则被怀疑的成员如果重新连接到该组，则可以作为其当前身份再次在该组中活动。当成员超过驱逐超时并被逐出组时，或当组复制在服务器上被<code>STOP GROUP_REPLICATION</code>语句停止时，或服务器出现故障时，它必须作为一个新的身份重新加入</p>
</blockquote>
<h4 id="故障检测"><a href="#故障检测" class="headerlink" title="故障检测"></a>故障检测</h4><p>Group Replication包括一个故障检测机制，该机制能够发现并报告哪些服务器是静默的状态（被认为是死亡的）。故障检测可以说是用于一个分布式服务，它提供关于哪些服务器可能已死(或可疑)的信息。当服务器静默时，检测就会被怀疑。当服务器A在给定的时间段内没有收到来自服务器B的消息时，就会发生超时和产生提高怀疑。之后，如果组认为怀疑可能是真的，那么组就认定的服务器确实发生了故障。意味着组中的其余成员将做出共同决定以移除该成员</p>
<p>如果一个成员与组中成员隔离了，该成员会怀疑其他成员都down机了。但由于无法确保与团体协议的一直（因为它无法确保势力的人数），所以不会产生任何动作。而隔离组时，该成员将无法执行本地的事务</p>
<p>如果网络不稳定，成员经常出现重新连接的状态，可能会照成将所有成员标记为开除，之后组就会不存在。为了解决这个问题，从MySQL 8.0.20开始，Group Replication的Group Communication System (GCS)跟踪被标记为开除的组成员，并在决定是否有多数成员时将他们视为可疑成员组中的成员。这可以确保至少有一个成员留在组中，并且组可以继续存在当一个被开除的成员已经被开除出组时，GCS将删除该成员被开除的记录，以便该成员可以在可能的情况下重新加入组</p>
<p>关于组复制系统变量系统，可参考官网“对故障检测和网络分区的响应”<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-responses-failure.html">Responses to Failure Detection and Network Partitioning</a>.</p>
<h4 id="容错"><a href="#容错" class="headerlink" title="容错"></a>容错</h4><p>MySQL组复制建立在Paxos分布式算法的实现上，提供服务器之间的分布式协调。因此，它需要大多数服务器处于活动状态以达到相应人数，从而做出决定。这直接影响到系统在不损害自身和整体功能的情况下可以容忍的故障数量。容忍f次故障所需的服务器数量(n)是n = 2 x f + 1</p>
<p>实践过程中，意味着要容忍一个故障，组中必须有是三个服务器。因此，如果有一个服务器失败，仍然有两个服务器构成多数（三分之二），并允许系统继续自动做出决定和进展。但是如果有第二台服务器非自愿的失败，组中就只有一个服务器，这个时候就会照成阻塞，因为不够势力人数来做出最终的决定</p>
<p>下表示是对于公式算出所需服务器数量</p>
<table>
<thead>
<tr>
<th>组</th>
<th>主机数</th>
<th>故障容忍</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>4</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>6</td>
<td>4</td>
<td>2</td>
</tr>
<tr>
<td>7</td>
<td>4</td>
<td>3</td>
</tr>
</tbody></table>
<h2 id="MGR实例"><a href="#MGR实例" class="headerlink" title="MGR实例"></a>MGR实例</h2><p>MySQL Group Replication作为MySQL服务器的插件提供，组中的每个服务器都需要配置和安装插件。需创建至少有三个成员的复制组所需的步骤</p>
<blockquote>
<p>PS：要部署多个MySQL实例，可以使用InnoDB Cluster，使用MySQL Shell中轻松管理一组MySQL服务器实例。InnoDB Cluster将MySQL Group Replication包装在一个编程环境中，使能够轻松部署MySQL实例集群来实现高可用性</p>
</blockquote>
<h3 id="单主模式下配置Group-Replication实例"><a href="#单主模式下配置Group-Replication实例" class="headerlink" title="单主模式下配置Group Replication实例"></a>单主模式下配置Group Replication实例</h3><p>用于组复制的MySQL Server实例所需的配置设置，配置MySQL5.7版本的组复制，而一个组中可以使用的最大实例数是9</p>
<ul>
<li>存储引擎</li>
<li>复制框架</li>
<li>组复制设置</li>
</ul>
<h4 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h4><p>对于组复制，数据必须存储在InnoDB事务存储引擎中，使用其他存储引擎(包括临时内存存储引擎)可能导致组复制出错。禁用系统变量disabled_storage_engines的方法如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">disabled_storage_engines=&quot;MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY&quot;</span><br></pre></td></tr></table></figure>
<h4 id="复制参数设置"><a href="#复制参数设置" class="headerlink" title="复制参数设置"></a>复制参数设置</h4><p>设置根据MySQL组复制要求配置复制（必须配置）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server_id=1</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line">log_bin=binlog</span><br><span class="line">log_slave_updates=ON</span><br><span class="line">binlog_format=ROW</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br></pre></td></tr></table></figure>
<ul>
<li><code>server_id=1</code>设置服务器唯一标识符</li>
<li><code>gtid_mode=ON</code>开启GTID模式</li>
<li><code>enforce_gtid_consistency=ON</code>开启GTID一致性</li>
<li><code>binlog_checksum=NONE</code>禁用二进制日志事件校验</li>
<li><code>log_bin=binlog</code>开启binlog日志</li>
<li><code>log_slave_updates=ON</code>开启从主机更新功能</li>
<li><code>binlog_format=ROW</code>使用基于行的格式（默认情况下也是ROW）</li>
<li><code>master_info_repository=TABLE</code>将复制元数据存储在表</li>
<li><code>relay_log_info_repository=TABLE</code>等同上述</li>
</ul>
<h4 id="组复制设置"><a href="#组复制设置" class="headerlink" title="组复制设置"></a>组复制设置</h4><p>下述部分为服务器配置组复制设置（必须配置）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">plugin_load_add=&#x27;group_replication.so&#x27;</span><br><span class="line">group_replication_group_name=&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;</span><br><span class="line">group_replication_start_on_boot=off</span><br><span class="line">group_replication_local_address= &quot;mgr-1:33061&quot;</span><br><span class="line">group_replication_group_seeds= &quot;mgr-1:33061,mgr-2:33061,mgr-3:33061&quot;</span><br><span class="line">group_replication_bootstrap_group=off</span><br><span class="line">group_replication_allow_local_disjoint_gtids_join=on</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> group_replication_single_primary_mode=<span class="literal">true</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> group_replication_enforce_update_everywhere_checks=<span class="literal">false</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>transaction_write_set_extraction</code>表示server必须为每个事务收集写集合，比使用XXHASH64哈希算法将其编码为散列</p>
</li>
<li><p><code>plugin-load-add</code>表示启动服务器时自动加载到插件列表中，在生产部署追踪，比手动方便些</p>
</li>
<li><p><code>group_replication_group_name</code>配置告诉插件，它正在加入或创建的组名为“aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa”。</p>
<p><code>group_replication_group_name</code>必须是合法的UUID。可以使用<code>SELECT UUID()</code>随机来生成一个。UUID是构成gtid的一部分，当组成员从客户端接收到的事务，以及组成员内部生成的视图更改事件时被写入二进制日志，则使用gtid。当然测试环境使用的时候，可以使用aaa…aaa方便简便配置</p>
</li>
<li><p><code>group_replication_start_on_boot</code>参数设置为off，启动服务器时不自动开启插件，注意这点很重要，是确保在手动启动插件之前配置服务器。一旦配置了成员，则可以将group_replication_start_on_boot设置为on，以便在服务器启动时自动开启组复制</p>
</li>
<li><p><code>group_replication_local_address</code>参数是设置成员的通信地址与端口。组复制将地址用于组通信引擎（XCom，Paxos协议）的远程实例成员连接</p>
<p><code>group_replication_local_address</code>配置的地址是所有成员主机中可解析的，每个服务器实例位于不同地址。例如使用10.0.0.1主机地址，需要确保能够通过DNS或/etc/hosts文件解析成功</p>
<p><code>group_replication_local_address</code>的端口为“33061”，只有主机名或IP地址都相同，就可以使用相同的端口或相同的IP（相同IP适用于本地部署组复制）</p>
</li>
</ul>
<blockquote>
<p>PS：如果加入的成员不能解析到其他成员的主机名，则分布式恢复会失败。客户端连接的主机名可以通过Performance Schema表中的<code>replication_group_members的Member_host</code>列中验证。</p>
</blockquote>
<ul>
<li><code>group_replication_group_seeds</code>参数设置新成员与其他组成员建立连接（主机名和端口）。一旦建立连接，组成员信息就可以通过Performance Schema表replication_group_members中列出。通常，group_replication_group_seeds列表包含组成员的每个group_replication_local_address的hostname:port，但这不是强制性的，可以选择组成员的子集作为种子</li>
</ul>
<blockquote>
<p>PS：<code>group_replication_group_seeds</code>中列出的<code>hostname:port</code>是种子成员的内部网络地址，由每个成员主机上的<code>group_replication_local_address</code>配置，而不是用于客户端连接的<code>hostname:port</code>。例如，在<code>Performance Schema</code>表中的<code>Replication_group_members</code>中显示</p>
</blockquote>
<ul>
<li><code>group_replication_bootstrap_group</code>会指示插件是否引导该组。 在这种情况下，即使mgr-1是组的第一个成员，也会在选项文件中将此变量设置为off。 反之在实例运行时配置group_replication_bootstrap_group，以确保只有一个成员实际引导该组</li>
</ul>
<blockquote>
<p>PS：必须在任何时候（通常是在第一次引导该组时，或者在整个组都关闭并再次备份的情况下），仅在任何时候在属于该组的一个服务器实例上启用<code>group_replication_bootstrap_group</code>变量。如果多次引导组，例如当多个服务器实例设置了此选项为on时，那么就会创建一个人工的脑分裂场景，其中存在两个具有相同名称的不同组。所以在第一个服务器实例启动后，必须将<code>group_replication_bootstrap_group</code>设置为off</p>
</blockquote>
<ul>
<li><code>group_replication_allow_local_disjoint_gtids_join</code>自动连接访问到上述设置的主机端口</li>
<li><code>group_replication_single_primary_mode</code>设置为single-primary模式，默认情况下就是true</li>
<li><code>group_replication_enforce_update_everywhere_checks</code>检查参数在各个节点是否一致</li>
</ul>
<h4 id="用于分布式恢复的用户"><a href="#用于分布式恢复的用户" class="headerlink" title="用于分布式恢复的用户"></a>用于分布式恢复的用户</h4><p>成员加入组中时，组复制使用分布式流程来同步组成员，通过<code>group_replication_recovery</code>参数复制通信将事务从主成员的二进制日志传输到其他成员中。这时就需要具有权限的复制用户，以便组复制能够建立成员到成员之间的通信</p>
<p>在通信的过程中，必须使用同一个复制用户在每个组成员进行分布式恢复。创建的用户过程可以在二进制日志抓取，然后通过分布式恢复来复制用于创建用户的语句。或者禁用二进制记录，然后手动在每个成员主机上创建用户。</p>
<p>按照以下步骤创建用于分布式恢复的复制用户：</p>
<ul>
<li>启动MySQL服务器实例，然后连接一个客户端到它</li>
<li>如果要禁用二进制日志，可以通过以下语句来实现:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET SQL_LOG_BIN=0;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建一个具有REPLICATION SLAVE权限的MySQL用户，用于分布式恢复，如果服务器设置支持克隆，则创建BACKUP_ADMIN权限，用于克隆操作中的donor。下述中显示了密码为password和用户rpl_user</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE USER rpl_user@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;rpl_user&#x27;</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION SLAVE ON *.* TO rpl_user@<span class="string">&#x27;%&#x27;</span>;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mysql&gt; GRANT BACKUP_ADMIN ON *.* TO rpl_user@<span class="string">&#x27;%&#x27;</span>; //5.7版本不需要</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果禁用了二进制日志记录，在创建用户之后，通过下述语句重新开启二进制</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET SQL_LOG_BIN=1;</span></span><br></pre></td></tr></table></figure>
<p>创建复制用户后，必须向服务器提供用户凭据，以便可以使用分布式恢复。可以通过将用户凭据设置为``group_replication_bootstrap_group`通信的凭据，使用 CHANGE MASTER TO语句（5.7版本到8.0.23版本）</p>
<blockquote>
<p>PS：在MySQL 8.0.23版本中可以使用<code>CHANGE REPLICATION SOURCE TO</code>语句，或者从8.0.21开始，可以在<code>START GROUP_REPLICATION</code>语句上为分布式恢复指定用户凭据</p>
</blockquote>
<p>使用<code>CHANGE MASTER TO</code>设置的用户凭据，是以纯文本形式存储在服务器。在启动组复制应用时，<code>group_relication_start_on_boot</code>参数变量设置为ON时会自动启动</p>
<blockquote>
<p>PS：使用<code>START GROUP_REPLICATION</code>指定的用户凭据是仅保存在内存中，并通过<code>STOP GROUP_REPLICATION</code>语句关机及删除，需要重新获取凭据，则再次发出<code>START GROUP_REPLICATION</code>语句。这种指定用户凭据的方法有助于保护组复制服务器免受未经授权的访问</p>
</blockquote>
<p>如果选择使用<code>CHANGE REPLICATION SOURCE to | CHANGE MASTER to</code>语句提供用户凭证，现在在服务器实例上发出以下语句，用创建用户时使用的值替换rpl_user和password</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> MySQL 5.7：</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_USER=<span class="string">&#x27;rpl_user&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;rpl_user&#x27;</span> \\</span></span><br><span class="line"><span class="bash">		      FOR CHANNEL <span class="string">&#x27;group_replication_recovery&#x27;</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> MySQL 8.0.23:</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE REPLICATION SOURCE TO SOURCE_USER=<span class="string">&#x27;rpl_user&#x27;</span>, SOURCE_PASSWORD=<span class="string">&#x27;rpl_user&#x27;</span> \\</span></span><br><span class="line"><span class="bash">		      FOR CHANNEL <span class="string">&#x27;group_replication_recovery&#x27;</span>;</span></span><br></pre></td></tr></table></figure>
<h4 id="启动组复制"><a href="#启动组复制" class="headerlink" title="启动组复制"></a>启动组复制</h4><p>配置并启动服务器mgr-1实例后，需要安装组复制插件，也可以在配置文件中指定插件<code>plugin_load_add =&#39;group_replication.so&#39;</code>，然后可以继续执行下一步。 下述是手动安装插件使用的指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSTALL PLUGIN group_replication SONAME &#x27;group_replication.so&#x27;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：mysql.session 用户必须存在才能加载组复制。 mysql.session 是在 MySQL 5.7.19 版本中添加的。如果您的数据字典是使用早期版本初始化的，则必须执行MySQL升级过程(升级MySQL的过程，可参考官网<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/upgrading.html">Upgrading MySQL</a>)。如果没有运行升级，则“Group Replication”启动失败，并提示错误</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">There was an error when trying to access the server with user: mysql.session@localhost. Make sure the user is present in the server and that mysql_upgrade was ran after a server update..</span><br></pre></td></tr></table></figure>
<p>检查插件是否安装成功，可以执行SHOW PLUGINS，然后检查输出，显示的内容如下:</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW PLUGINS;</span></span><br><span class="line">+----------------------------+----------+--------------------+----------------------+-------------+</span><br><span class="line">| Name                       | Status   | Type               | Library              | License     |</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+-------------+</span><br><span class="line">| binlog                     | ACTIVE   | STORAGE ENGINE     | NULL                 | PROPRIETARY |</span><br><span class="line"></span><br><span class="line">(...)</span><br><span class="line"></span><br><span class="line">| group_replication          | ACTIVE   | GROUP REPLICATION  | group_replication.so | PROPRIETARY |</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+-------------+</span><br></pre></td></tr></table></figure>
<h4 id="引导组设置"><a href="#引导组设置" class="headerlink" title="引导组设置"></a>引导组设置</h4><p>首次启动组复制过程称为引导，可以通过<code>group_replication_bootstrap_group</code>进行引导组。引导只能由一个服务器完成，服务器启动该组并只能执行一次。这也是为什么<code>group_replication_bootstrap_group</code>参数选项没有在配置文件的原因。</p>
<p>如果该选项存储在配置文件，则重新启动时会自动引导第二个具有相同名称的组，而两个不同的组就会具有相同的名称，这往往是不允许的。反之手动选项设置为ON时，停止之后并在启动插件。为了安全引导该组，使用下述的语句</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET GLOBAL group_replication_bootstrap_group=ON;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START GROUP_REPLICATION;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET GLOBAL group_replication_bootstrap_group=OFF;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：或者如果你在<code>START GROUP_REPLICATION</code>语句上为分布式恢复提供用户凭证(可以从MySQL 8.0.21中获得)，则使用以下语句:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET GLOBAL group_replication_bootstrap_group=ON;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START GROUP_REPLICATION USER=<span class="string">&#x27;rpl_user&#x27;</span>, PASSWORD=<span class="string">&#x27;password&#x27;</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET GLOBAL group_replication_bootstrap_group=OFF;</span></span><br></pre></td></tr></table></figure>
<p>语句成功设置之后，可以<code>performance_schema.replication_group_members</code>通过下述语句查询组中的视图成员</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM performance_schema.replication_group_members;</span></span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+---------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE  |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+---------------+</span><br><span class="line">| group_replication_applier | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa |   mgr-1        |       3306  | ONLINE        |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+---------------+</span><br></pre></td></tr></table></figure>
<p>表中的信息确认组中存在唯一标识符为 <code>aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa</code> 的成员，该成员处于 ONLINE 状态并在 mgr-1 侦听端口 3306 。可以通过创建库和表来确定组复制是否成功设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE DATABASE <span class="built_in">test</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> USE <span class="built_in">test</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE TABLE t1 (c1 INT PRIMARY KEY, c2 TEXT NOT NULL);</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> INSERT INTO t1 VALUES (1, <span class="string">&#x27;wu&#x27;</span>);</span></span><br></pre></td></tr></table></figure>
<p>检查表 t1 的内容和二进制日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM t1;</span></span><br><span class="line">+----+------+</span><br><span class="line">| c1 | c2   |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | wu |</span><br><span class="line">+----+------+</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW BINLOG EVENTS;</span></span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br><span class="line">| Log_name      | Pos | Event_type     | Server_id | End_log_pos | Info                                                               |</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br><span class="line">| binlog.000001 |   4 | Format_desc    |         1 |         123 | Server ver: 8.0.25-log, Binlog ver: 4                              |</span><br><span class="line">| binlog.000001 | 123 | Previous_gtids |         1 |         150 |                                                                    |</span><br><span class="line">| binlog.000001 | 150 | Gtid           |         1 |         211 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1&#x27;  |</span><br><span class="line">| binlog.000001 | 211 | Query          |         1 |         270 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 | 270 | View_change    |         1 |         369 | view_id=14724817264259180:1                                        |</span><br><span class="line">| binlog.000001 | 369 | Query          |         1 |         434 | COMMIT                                                             |</span><br><span class="line">| binlog.000001 | 434 | Gtid           |         1 |         495 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:2&#x27;  |</span><br><span class="line">| binlog.000001 | 495 | Query          |         1 |         585 | CREATE DATABASE test                                               |</span><br><span class="line">| binlog.000001 | 585 | Gtid           |         1 |         646 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:3&#x27;  |</span><br><span class="line">| binlog.000001 | 646 | Query          |         1 |         770 | use `test`; CREATE TABLE t1 (c1 INT PRIMARY KEY, c2 TEXT NOT NULL) |</span><br><span class="line">| binlog.000001 | 770 | Gtid           |         1 |         831 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:4&#x27;  |</span><br><span class="line">| binlog.000001 | 831 | Query          |         1 |         899 | BEGIN                                                              |</span><br><span class="line">...</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>上述所示，创建了数据库和表，并将它们对应的 DDL 语句写入二进制日志。数据也插入到表中并写入二进制日志，因此可以通过二进制日志进行状态传输来进行分布式恢复</p>
<h4 id="添加其他实例到组"><a href="#添加其他实例到组" class="headerlink" title="添加其他实例到组"></a>添加其他实例到组</h4><h5 id="添加第二个实例"><a href="#添加第二个实例" class="headerlink" title="添加第二个实例"></a><strong>添加第二个实例</strong></h5><p>此时，组中有一个成员，服务器mgr-1。为了添加第二个实例，即服务器mgr-2，首先要为它创建配置文件。配置信息类似于mgr-1的配置，除了server_id和地址端口配置不一样外，其他的都差不多相同，不同的配置我会注释信息提示</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Disable other storage engines</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash">disabled_storage_engines=<span class="string">&quot;MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Replication configuration parameters</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash">server_id=2</span></span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line">log_slave_updates=ON</span><br><span class="line">log_bin=binlog</span><br><span class="line">binlog_format=ROW</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Group Replication configuration</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash">transaction_write_set_extraction=XXHASH64</span></span><br><span class="line">plugin_load_add=&#x27;group_replication.so&#x27;</span><br><span class="line">group_replication_group_name=&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;</span><br><span class="line">group_replication_start_on_boot=off</span><br><span class="line">group_replication_local_address= &quot;mgr-2:33061&quot;</span><br><span class="line">group_replication_group_seeds= &quot;mgr-1:33061,mgr-2:33061,mgr-3:33061&quot;</span><br><span class="line">group_replication_bootstrap_group= off</span><br></pre></td></tr></table></figure>
<p>与服务器mgr-1的过程类似，有了选项文件，就可以启动服务器，然后按如下方式配置分布式恢复凭据。 这些命令与设置服务器 mgr-1 时使用的相同，因为用户在组内共享。如果你依赖分布式在所有成员配置用户，当mgr-2连接到mgr-1，通过复制或克隆mgr-1的复制用户信息，可以参考官网<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-distributed-recovery.html">Distributed Recovery</a></p>
<p>如果在 mgr-1上配置用户凭据时未启用二进制日志记录，并且未将远程克隆操作用于状态传输，则必须在 mgr-2 上创建复制用户。操作的语句如下 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SET SQL_LOG_BIN=0;</span><br><span class="line">CREATE USER rpl_user@&#x27;%&#x27; IDENTIFIED BY &#x27;rpl_user&#x27;;</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO rpl_user@&#x27;%&#x27;;</span><br><span class="line">SET SQL_LOG_BIN=1;</span><br><span class="line">CHANGE MASTER TO MASTER_USER=&#x27;rpl_user&#x27;, MASTER_PASSWORD=&#x27;rpl_user&#x27; \\</span><br><span class="line">	FOR CHANNEL &#x27;group_replication_recovery&#x27;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：如果使用<code>CHANGE REPLICATION SOURCE TO</code>语句提供用户凭据，则使用下述的语句（MySQL 8.0.23）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CHANGE REPLICATION SOURCE TO SOURCE_USER=&#x27;rpl_user&#x27;, SOURCE_PASSWORD=&#x27;password&#x27; \\</span><br><span class="line">	FOR CHANNEL &#x27;group_replication_recovery&#x27;;</span><br></pre></td></tr></table></figure>
<p>启动组复制，mgr-2启动加入组的过程</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START GROUP_REPLICATION;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：或者，如果您在 START GROUP_REPLICATION 语句（MySQL 8.0.21）上提供用于分布式恢复的用户凭据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START GROUP_REPLICATION USER=<span class="string">&#x27;rpl_user&#x27;</span>, PASSWORD=<span class="string">&#x27;password&#x27;</span>;</span></span><br></pre></td></tr></table></figure>
<p>与上述mgr-1上执行的步骤相同，但缺少一些步骤，在mgr-2加入组时<u>不需要引导组</u>，因为已经有一个组成员引导（组已经存在了）。此时，只需要将服务器mgr-2添加到已经存在的组中即可</p>
</blockquote>
<blockquote>
<p>PS：当成功启动并加入组时，会检查<code>super_read_only</code>变量。该成员的配置文件中的<code>super_read_only</code>会设置为ON，确保因任何原因启动组复制时失败的服务器不接受事务。如果使用的是多主模式，那么加入组之后，<code>super_read_only</code>会设置为OFF</p>
</blockquote>
<p>检查performance_schema.replication_group_members表会显示组中已有两个ONLINE服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM performance_schema.replication_group_members;</span></span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | a6d58ecb-c871-11eb-a20a-000c2965a579 | mgr-2       |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | d0c3200d-c864-11eb-b732-000c298e405e | mgr-1       |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br></pre></td></tr></table></figure>
<p>验证mgr-2是否已经同步mgr-1，如下所示</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW DATABASES LIKE <span class="string">&#x27;test&#x27;</span>;</span></span><br><span class="line">+-----------------+</span><br><span class="line">| Database (test) |</span><br><span class="line">+-----------------+</span><br><span class="line">| test            |</span><br><span class="line">+-----------------+</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM test.t1;</span></span><br><span class="line">+----+------+</span><br><span class="line">| c1 | c2   |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | Luis |</span><br><span class="line">+----+------+</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW BINLOG EVENTS;</span></span><br><span class="line">+---------------+------+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br><span class="line">| Log_name      | Pos  | Event_type     | Server_id | End_log_pos | Info                                                               |</span><br><span class="line">+---------------+------+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br><span class="line">| binlog.000001 |    4 | Format_desc    |         2 |         123 | Server ver: 8.0.25-log, Binlog ver: 4                              |</span><br><span class="line">| binlog.000001 |  123 | Previous_gtids |         2 |         150 |                                                                    |</span><br><span class="line">| binlog.000001 |  150 | Gtid           |         1 |         211 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1&#x27;  |</span><br><span class="line">| binlog.000001 |  211 | Query          |         1 |         270 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 |  270 | View_change    |         1 |         369 | view_id=14724832985483517:1                                        |</span><br><span class="line">| binlog.000001 |  369 | Query          |         1 |         434 | COMMIT                                                             |</span><br><span class="line">| binlog.000001 |  434 | Gtid           |         1 |         495 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:2&#x27;  |</span><br><span class="line">| binlog.000001 |  495 | Query          |         1 |         585 | CREATE DATABASE test                                               |</span><br><span class="line">| binlog.000001 |  585 | Gtid           |         1 |         646 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:3&#x27;  |</span><br><span class="line">| binlog.000001 |  646 | Query          |         1 |         770 | use `test`; CREATE TABLE t1 (c1 INT PRIMARY KEY, c2 TEXT NOT NULL) |</span><br><span class="line">| binlog.000001 |  770 | Gtid           |         1 |         831 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:4&#x27;  |</span><br><span class="line">| binlog.000001 |  831 | Query          |         1 |         890 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 |  890 | Table_map      |         1 |         933 | table_id: 108 (test.t1)                                            |</span><br><span class="line">| binlog.000001 |  933 | Write_rows     |         1 |         975 | table_id: 108 flags: STMT_END_F                                    |</span><br><span class="line">| binlog.000001 |  975 | Xid            |         1 |        1002 | COMMIT /* xid=30 */                                                |</span><br><span class="line">| binlog.000001 | 1002 | Gtid           |         1 |        1063 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:5&#x27;  |</span><br><span class="line">...</span><br><span class="line">+---------------+------+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<h5 id="添加更多的实例"><a href="#添加更多的实例" class="headerlink" title="添加更多的实例"></a><strong>添加更多的实例</strong></h5><p>添加第三台实例或更多的实例，步骤与mgr-2基本相同，总结一下命令</p>
<p>创建配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Disable other storage engines</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash">disabled_storage_engines=<span class="string">&quot;MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Replication configuration parameters</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash">server_id=3</span></span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line">log_slave_updates=ON</span><br><span class="line">log_bin=binlog</span><br><span class="line">binlog_format=ROW</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Group Replication configuration</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash">transaction_write_set_extraction=XXHASH64</span></span><br><span class="line">plugin_load_add=&#x27;group_replication.so&#x27;</span><br><span class="line">group_replication_group_name=&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;</span><br><span class="line">group_replication_start_on_boot=off</span><br><span class="line">group_replication_local_address= &quot;mgr-3:33061&quot;</span><br><span class="line">group_replication_group_seeds= &quot;mgr-1:33061,mgr-2:33061,mgr-3:33061&quot;</span><br><span class="line">group_replication_bootstrap_group= off</span><br></pre></td></tr></table></figure>
<p>使用CHANGE MASTER TO语句提供用户凭据，语句如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> SET SQL_LOG_BIN=0;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> CREATE USER rpl_user@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;rpl_user&#x27;</span>;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> GRANT REPLICATION SLAVE ON *.* TO rpl_user@<span class="string">&#x27;%&#x27;</span>;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> SET SQL_LOG_BIN=1;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_USER=<span class="string">&#x27;rpl_user&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;rpl_user&#x27;</span>  \\</span></span><br><span class="line"><span class="bash">FOR CHANNEL <span class="string">&#x27;group_replication_recovery&#x27;</span>;</span></span><br></pre></td></tr></table></figure>
<p>如果需要安装组复制插件和启动组复制</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> INSTALL PLUGIN group_replication SONAME <span class="string">&#x27;group_replication.so&#x27;</span>;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> START GROUP_REPLICATION;</span></span><br></pre></td></tr></table></figure>
<p>在通过<code>performance_schema。Replication_group_members</code>表查看组的情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM performance_schema.replication_group_members;</span></span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | ac39f1e6-6dfa-11e6-a69d-00212844f856 | mgr-3       |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | a6d58ecb-c871-11eb-a20a-000c2965a579 | mgr-2       |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | d0c3200d-c864-11eb-b732-000c298e405e | mgr-1       |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+---------------+</span><br></pre></td></tr></table></figure>
<p>验证服务器 mgr-3 是否已同步</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW DATABASES LIKE <span class="string">&#x27;test&#x27;</span>;</span></span><br><span class="line">+-----------------+</span><br><span class="line">| Database (test) |</span><br><span class="line">+-----------------+</span><br><span class="line">| test            |</span><br><span class="line">+-----------------+</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM test.t1;</span></span><br><span class="line">+----+------+</span><br><span class="line">| c1 | c2   |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | Luis |</span><br><span class="line">+----+------+</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW BINLOG EVENTS;</span></span><br><span class="line">+---------------+------+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br><span class="line">| Log_name      | Pos  | Event_type     | Server_id | End_log_pos | Info                                                               |</span><br><span class="line">+---------------+------+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br><span class="line">| binlog.000001 |    4 | Format_desc    |         3 |         123 | Server ver: 8.0.25-log, Binlog ver: 4                              |</span><br><span class="line">| binlog.000001 |  123 | Previous_gtids |         3 |         150 |                                                                    |</span><br><span class="line">| binlog.000001 |  150 | Gtid           |         1 |         211 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1&#x27;  |</span><br><span class="line">| binlog.000001 |  211 | Query          |         1 |         270 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 |  270 | View_change    |         1 |         369 | view_id=14724832985483517:1                                        |</span><br><span class="line">| binlog.000001 |  369 | Query          |         1 |         434 | COMMIT                                                             |</span><br><span class="line">| binlog.000001 |  434 | Gtid           |         1 |         495 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:2&#x27;  |</span><br><span class="line">| binlog.000001 |  495 | Query          |         1 |         585 | CREATE DATABASE test                                               |</span><br><span class="line">| binlog.000001 |  585 | Gtid           |         1 |         646 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:3&#x27;  |</span><br><span class="line">| binlog.000001 |  646 | Query          |         1 |         770 | use `test`; CREATE TABLE t1 (c1 INT PRIMARY KEY, c2 TEXT NOT NULL) |</span><br><span class="line">| binlog.000001 |  770 | Gtid           |         1 |         831 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:4&#x27;  |</span><br><span class="line">| binlog.000001 |  831 | Query          |         1 |         890 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 |  890 | Table_map      |         1 |         933 | table_id: 108 (test.t1)                                            |</span><br><span class="line">| binlog.000001 |  933 | Write_rows     |         1 |         975 | table_id: 108 flags: STMT_END_F                                    |</span><br><span class="line">| binlog.000001 |  975 | Xid            |         1 |        1002 | COMMIT /* xid=29 */                                                |</span><br><span class="line">| binlog.000001 | 1002 | Gtid           |         1 |        1063 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:5&#x27;  |</span><br><span class="line">| binlog.000001 | 1063 | Query          |         1 |        1122 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 | 1122 | View_change    |         1 |        1261 | view_id=14724832985483517:2                                        |</span><br><span class="line">| binlog.000001 | 1261 | Query          |         1 |        1326 | COMMIT                                                             |</span><br><span class="line">| binlog.000001 | 1326 | Gtid           |         1 |        1387 | SET @@SESSION.GTID_NEXT= &#x27;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:6&#x27;  |</span><br><span class="line">...</span><br><span class="line">+---------------+------+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="本地部署MGR"><a href="#本地部署MGR" class="headerlink" title="本地部署MGR"></a>本地部署MGR</h3><p>常见的部署方法是在多个服务器部署Group Replication实例，以提高高可用性。也是在本地部署Group Replication，如用于测试的目的</p>
<p>初始化MySQL Server实例的复制组，需要分别创建三个数据目录（这里以5.7版本为例）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysqld --initialize-insecure --user=mysql --basedir=/application/mysql --datadir=/data/mysql_mgr1/data</span><br><span class="line">mysqld --initialize-insecure --user=mysql --basedir=/application/mysql --datadir=/data/mysql_mgr2/data</span><br><span class="line">mysqld --initialize-insecure --user=mysql --basedir=/application/mysql --datadir=/data/mysql_mgr2/data</span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：使用<code>-initialize-insecure</code>，是免创建密码，是不安全的做法，生产环境不建议使用</p>
</blockquote>
<h4 id="编写实例的配置文件"><a href="#编写实例的配置文件" class="headerlink" title="编写实例的配置文件"></a>编写实例的配置文件</h4><p>如果是本地部署，需要额外注意datadir指定的数据目录和socker配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> server configuration</span></span><br><span class="line">datadir=&lt;full_path_to_data&gt;/data/s1</span><br><span class="line">basedir=&lt;full_path_to_bin&gt;/mysql-8.0/</span><br><span class="line"></span><br><span class="line">port=24801</span><br><span class="line">socket=&lt;full_path_to_sock_dir&gt;/mgr-1.sock</span><br></pre></td></tr></table></figure>
<p>因为是本地部署，所以只需要改变三个实例不同的端口即可，地址不需要改变。然后每个成员需要能够连接到其group_replication_local_address上的其他成员。例如，在成员mgr-1添加如下配置（mgr-2与mgr-3类似）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">group_replication_local_address= &quot;127.0.0.1:24901&quot;</span><br><span class="line">group_replication_group_seeds= &quot;127.0.0.1:24901,127.0.0.1:24902,127.0.0.1:24903&quot;</span><br></pre></td></tr></table></figure>
<p>24901端口是mgr-1与其他成员通信的，对于其他成员，也要将其修改通信端口。其余的配置跟上述配置单模式相似</p>
<h3 id="MGR常见问题"><a href="#MGR常见问题" class="headerlink" title="MGR常见问题"></a>MGR常见问题</h3><h4 id="缺少参数问题"><a href="#缺少参数问题" class="headerlink" title="缺少参数问题"></a>缺少参数问题</h4><p>如果抛出以下的错误，这个就是基本错误，说明离成功搭建不远了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Plugin group_replication reported: &#x27;The member contains transactions not present in the group. The member will now exit the group.&#x27;</span><br><span class="line">[Note] Plugin group_replication reported: &#x27;To force this member into the group you can use the group_replication_allow_local_disjoint_gtids_join_option&#x27;</span><br></pre></td></tr></table></figure>
<p>从日志可以看出提示，需要设置<code>group_replication_allow_local_disjoint_gtids_join_option=on</code>参数，然后运行start group_replication重新启动</p>
<p>通过配置文件加入，也可以在MySQL通过下述指令设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">set</span> global group_replication_allow_local_disjoint_gtids_join_option=on</span></span><br></pre></td></tr></table></figure>
<h4 id="复制内容不一致"><a href="#复制内容不一致" class="headerlink" title="复制内容不一致"></a>复制内容不一致</h4><p>在添加第二个节点使用指令<code>start group_replication</code>加入组时，出现<code>RECOVERING</code>的状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> select * from performance_schema.replication_group_members;</span></span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 56b18008-cabd-11eb-bc62-000c298e405e | mgr-1       |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | a6d58ecb-c871-11eb-a20a-000c2965a579 | mgr-2       |        3306 | RECOVERING   |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br></pre></td></tr></table></figure>
<p>查看错误日志出现的报错问题</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2021-06-10T02:43:02.328189Z 0 [ERROR] Plugin group_replication reported: &#x27;This member has more executed transactions than those present in the group. Local transactions: a6d58ecb-c871-11eb-a20a-000c2965a579:1-2 &gt; Group transactions: aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-9,</span><br><span class="line">d0c3200d-c864-11eb-b732-000c298e405e:1-3,</span><br><span class="line">e1c232d9-c870-11eb-991f-000c298e405e:1-4&#x27;</span><br><span class="line">2021-06-10T02:43:02.328189Z 0 [ERROR] Plugin group_replication reported: &#x27;The member contains transactions not present in the group. The member will now exit the group.&#x27;</span><br></pre></td></tr></table></figure>
<p>解决办法：将binlog日志将全部清空，通过下述指令（不管是主成员，还是其他成员，都将binlog恢复最初始的状态）    </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> reset master;</span></span><br></pre></td></tr></table></figure>
<p>原因可能是节点之前有操作了创建用户或节点之前加入组时没有成功，所以通过上述命令，清空Executd_Gtid_Set和binlog</p>
<p>如果连接还是出现<code>RECOVERING</code>状态，也有可能是applier与recovery的<code>relay-bin-group_replication</code>文件信息不一致，可通过下述命令恢复初始的状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> reset slave;</span></span><br></pre></td></tr></table></figure>
<h4 id="recovery连接报错"><a href="#recovery连接报错" class="headerlink" title="recovery连接报错"></a>recovery连接报错</h4><p>在添加第二个节点使用指令<code>start group_replication</code>加入组时，出现RECOVERING的状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> select * from performance_schema.replication_group_members;</span></span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 56b18008-cabd-11eb-bc62-000c298e405e | mgr-1       |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | a6d58ecb-c871-11eb-a20a-000c2965a579 | mgr-2       |        3306 | RECOVERING   |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br></pre></td></tr></table></figure>
<p>查看错误日志出现的报错问题</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2021-06-11T07:51:19.813021Z 61 [ERROR] Plugin group_replication reported: &#x27;There was an error when connecting to the donor server. Please check that group_replication_recovery channel credentials and all MEMBER_HOST column values of performance_schema.replication_group_members table are correct and DNS resolvable.&#x27;</span><br><span class="line">2021-06-11T07:51:19.813036Z 61 [ERROR] Plugin group_replication reported: &#x27;For details please check performance_schema.replication_connection_status table and error log messages of Slave I/O for channel group_replication_recovery.&#x27;</span><br></pre></td></tr></table></figure>
<p>错误日志提示的信息，让我们去查看<code>performance_schema.replication_group_members</code>表，先看看是什么原因</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> select * from performance_schema.replication_connection_status\G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             CHANNEL_NAME: group_replication_applier</span><br><span class="line">               GROUP_NAME: e1c232d9-c870-11eb-991f-000c298e405e</span><br><span class="line">              SOURCE_UUID: e1c232d9-c870-11eb-991f-000c298e405e</span><br><span class="line">                THREAD_ID: NULL</span><br><span class="line">            SERVICE_STATE: ON</span><br><span class="line">COUNT_RECEIVED_HEARTBEATS: 0</span><br><span class="line"> LAST_HEARTBEAT_TIMESTAMP: 0000-00-00 00:00:00</span><br><span class="line"> RECEIVED_TRANSACTION_SET: </span><br><span class="line">        LAST_ERROR_NUMBER: 0</span><br><span class="line">       LAST_ERROR_MESSAGE: </span><br><span class="line">     LAST_ERROR_TIMESTAMP: 0000-00-00 00:00:00</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">             CHANNEL_NAME: group_replication_recovery</span><br><span class="line">               GROUP_NAME: </span><br><span class="line">              SOURCE_UUID: </span><br><span class="line">                THREAD_ID: NULL</span><br><span class="line">            SERVICE_STATE: OFF</span><br><span class="line">COUNT_RECEIVED_HEARTBEATS: 0</span><br><span class="line"> LAST_HEARTBEAT_TIMESTAMP: 0000-00-00 00:00:00</span><br><span class="line"> RECEIVED_TRANSACTION_SET: </span><br><span class="line">        LAST_ERROR_NUMBER: 1130</span><br><span class="line">       LAST_ERROR_MESSAGE: error connecting to master &#x27;rpl_user@mgr-1:3306&#x27; - retry-time: 60  retries: 1</span><br><span class="line">     LAST_ERROR_TIMESTAMP: 2021-06-11 15:50:19</span><br></pre></td></tr></table></figure>
<p>上述查询的表可以看到在<code>group_replication_recovery</code>下的信息出现了报错。这是错误信息可能是<strong>主成员没有创建对应的用户，或是没有对该用户进行授权</strong></p>
<p>解决办法，通过以下命令创建用户与授权，然后再重新连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> CREATE USER rpl_user@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;rpl_user&#x27;</span>;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> GRANT REPLICATION SLAVE ON *.* TO rpl_user@<span class="string">&#x27;%&#x27;</span>;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br></pre></td></tr></table></figure>
<h4 id="判断一个复制组中的主节点"><a href="#判断一个复制组中的主节点" class="headerlink" title="判断一个复制组中的主节点"></a>判断一个复制组中的主节点</h4><p>判断复制组中哪个是主节点，如果完全靠猜或日志来判断，会不确认和有些麻烦。所以可以通过下述的语句过滤得到</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> SELECT * FROM performance_schema.replication_group_members <span class="built_in">where</span> member_id = (select variable_value from performance_schema.global_status <span class="built_in">where</span> variable_name= <span class="string">&#x27;group_replication_primary_member&#x27;</span>);</span></span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 56b18008-cabd-11eb-bc62-000c298e405e | mgr-1       |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Inaction</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://myboke.ink/2021/08/09/MySQL-MHA高可用-9/">https://myboke.ink/2021/08/09/MySQL-MHA高可用-9/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/08/09/MySQL%E9%AB%98%E5%8F%AF%E7%94%A8MHA-9/"><i class="fa fa-chevron-left">  </i><span>MySQL高可用MHA-9</span></a></div><div class="next-post pull-right"><a href="/2021/05/16/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6-8/"><span>MySQL主从复制-8</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '6cea6a646bff1a0d5f5b',
  clientSecret: '6e9ef08f31f505d416bc0afe2d304808e9063627',
  repo: 'zsjmal2316.github.io',
  owner: 'zsjmal2316',
  admin: 'zsjmal2316',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(img/wuwei.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2021 By Inaction</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">粤ICP备20067869号</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="120" alpha="0.3" zIndex="-1" data-click="false"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>