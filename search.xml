<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>VRRP协议与原理</title>
      <link href="2021/01/17/VRRP%E5%8D%8F%E8%AE%AE%E4%B8%8E%E5%8E%9F%E7%90%86/"/>
      <url>2021/01/17/VRRP%E5%8D%8F%E8%AE%AE%E4%B8%8E%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1 id="VRRP协议与原理"><a href="#VRRP协议与原理" class="headerlink" title="VRRP协议与原理"></a>VRRP协议与原理</h1><h2 id="VRRP概述"><a href="#VRRP概述" class="headerlink" title="VRRP概述"></a>VRRP概述</h2><blockquote><ol><li>VRRP（Virtual Route Redundancy Protocol）虚拟路由器冗余协议是一种网关备份冗余解决方案，它对Ethernet上的计算机等终端的默认网关进行冗余备份，实现当其中一台网关设备宕机时，备份网关设备能够快速自动切换并接管转发工作，防止因网关设备故障引发转发数据失败，提高了网络服务质量.</li><li>VRRP通过使用虚拟路由器技术实现了主机默认网关的备份，同时也可以通过VRRP来实现网关的负载均衡.</li></ol></blockquote><h2 id="协议版本：VRRPv2-常用）和VRRPv3："><a href="#协议版本：VRRPv2-常用）和VRRPv3：" class="headerlink" title="协议版本：VRRPv2(常用）和VRRPv3："></a>协议版本：VRRPv2(常用）和VRRPv3：</h2><blockquote><p>VRRPv2仅适用于IPv4网络，VRRPv3适用于IPv4和IPv6两种网络.</p></blockquote><h2 id="VRRP原理"><a href="#VRRP原理" class="headerlink" title="VRRP原理"></a>VRRP原理</h2><p><strong>VRRP将局域网内的一组路由器划分在一起，称为一个备份组。备份组由一个Master路由器和多个Backup路由器组成，功能上相当于一台虚拟路由器。</strong></p><blockquote><p>VRRP备份组具有以下特点：</p><ul><li>虚拟路由器具有IP地址，称为虚拟IP地址。局域网内的主机仅需要知道这个虚拟路由器的IP地址，并将其设置为缺省路由的下一跳地址。</li><li>网络内的主机通过这个虚拟路由器与外部网络进行通信。</li><li>备份组内的路由器根据优先级，选举出Master路由器，承担网关功能。其他路由器作为Backup路由器，当Master路由器发生故障时，取代Master继续履行网关职责，从而保证网络内的主机不间断地与外部网络进行通信。</li></ul></blockquote><h2 id="VRRP组"><a href="#VRRP组" class="headerlink" title="VRRP组"></a>VRRP组</h2><blockquote><ol><li>一个VRRP组由多台协同工作的路由器组成，使用相同的VRID（虚拟路由器标识符）进行标识，属于同一个VRRP组的路由器之间交互VRRP协议报文并产生一台虚拟路由器。</li><li>一个VRRP组中只能出现一台Master路由器。</li><li>一个接口可以加入单个VRRP组，也可以加入多个VRRP组。不同的VRRP组需使用不同的VRID进行区分。</li></ol></blockquote><h2 id="虚拟-（路由器-IP-MAC）"><a href="#虚拟-（路由器-IP-MAC）" class="headerlink" title="虚拟 （路由器 IP MAC）"></a>虚拟 （路由器 IP MAC）</h2><blockquote><ol><li><p>虚拟路由器</p><ul><li><p>虚拟路由器的IP地址（虚拟IP地址）由网络管理员在配置VRRP时指定，一台虚拟路由器可以有一个或多个IP地址，而虚拟MAC地址的格式是0000-5e00-01xx”,其中XX为VRID，</p></li><li><p>一个VRRP组只会产生一台虚拟路由器。当Master路由器收到请求虚拟路由器MAC地址的ARP Request时，它在ARP Reply中回应的MAC地址是虚拟MAC地址，而不是其物理接口MAC地址。</p></li><li><p>通常情况下，VRRP路由器接口IP地址不会与虚拟路由器的IP地址重叠，如果使用某个路由器接口的IP地址，则该路由器将无条件的称为Master。</p></li></ul></li><li><p>Ｍaster路由器：</p><ul><li><p>Master路由器是接口处于Master状态，也被称为主路由器。主路由器在一个VRRP组中承担报文转发任务，只有Ｍaster路由器才会响应针对虚拟IP地址的ARP Requeset。</p></li><li><p> Master路由器会以一定的时间间隔周期性地发送VRRP报文，以便通知一个VRRP组中的Backup路由器关于自己的存活情况。</p></li></ul></li><li><p>Backup路由器：</p><ul><li>Backup路由器是接口处于Backup状态，也被称为备份路由器，Backup路由器会实时侦听Master路由器发送出来的VRRP报文，它随时准备接替Master路由器的工作。</li></ul></li><li><p>抢占模式</p><ul><li>VRRP优先级越大的称为主路由器，优先级相同情况下，则接口IP地址最大的成为主路由器。如果Backup激活了抢占功能，当发现Master路由器的优先级比自己更低时，它将立即成为Master状态。而如果Backup路由器没有激活抢占功能，那么即使收到比自己更低的优先级，也只能依然保持Backup状态，直到Master路由器失效。</li></ul></li></ol></blockquote><h2 id="VRRP状态"><a href="#VRRP状态" class="headerlink" title="VRRP状态"></a>VRRP状态</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117142114.png" alt="image-20210117142114261"></p><blockquote><ol><li><p>Initialize（初始状态）：</p><ul><li><p>接口配置VRRP后，如果该接口时Down的（例如接口关闭，或者没有连接任何线缆）则该接口的状态停滞在Initialize。</p></li><li><p>当接口UP后，如果其VRRP优先级为255(这种情况发生在接口的实际IP地址是VRRP虚拟IP地址的情况下）那么接口的VRRP状态将由Initialize切换到Master。</p></li><li><p>如果优先级不是255，则进入Backup状态。</p></li></ul></li><li><p>Backup状态：</p><ul><li><p>它会实时监控当前Master路由器的状态，并随时接替工作。</p><p>a. 对关于VRRP虚拟IP地址的ARP请求不响应。</p><p>b. 丢弃目的MAC地址为VRRP虚拟MAC地址的数据帧。</p><p>c. 不接受目的IP地址为VRRP虚拟IP地址的数据包</p><p>d. 实时侦听Master路由器发送的报文。若该VRRP报文的优先级为0（这意味着当前Master路由器希望主动放弃Master状态）</p></li></ul></li><li><p>Master状态：</p><ul><li><p>它承担着数据转发任务</p><p>a. 当收到关于虚拟IP地址的ARP请求时，以虚拟MAC地址进行回应。</p><p>b. 转发目的MAC地址为虚拟MAC地址。</p><p>c. 周期性地发送VRRP报文，时间间隔缺省为1S。</p><p>d. 当收到一个VRRP报文时，若该优先级为０，则继续发送自己的报文，若该VRRP报文优先级不为０，并比本接口的VRRP优先级值更大，或者VRRP优先级相等但是VRRP报文的源IP地址比本接口大，则将接口切换成Backuo状态。若该VRRP报文不为0，并且比本接口优先级更小，则忽略该报文。</p></li></ul></li></ol></blockquote><h2 id="VRRP定时器"><a href="#VRRP定时器" class="headerlink" title="VRRP定时器"></a>VRRP定时器</h2><p><strong>VRRP在运行过程中使用两个定时器用来进行状态检测.</strong></p><blockquote><ol><li>通过定时器（adver-timer）:该定时器在主路由器中使用，用来定于通告间隔（adver-interval）.主路由器以该定时器的间隔定期发送VRRP通告报文，用来告知其他备份路由器自己仍在先.通告间隔默认为1秒，可以通过配置进行修改</li><li>主路由器失效时器（master-down-timer）：该定时器在备份路由器中使用，用来定义主路由器失效（mater-down-interval）/主路由器失效间隔指的是备路由器多长时间没有收到主路由器的通告报文后，将认为主路由器一失效，并开始选举新的主路由器.主路由器失效间隔是通告间隔的3倍，默认为3秒</li></ol></blockquote><h2 id="VRRP报文结构"><a href="#VRRP报文结构" class="headerlink" title="VRRP报文结构"></a>VRRP报文结构</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117142259.png" alt="image-20210117142259403"></p><blockquote><p>报文格式：VRRP协议的正常工作以来于VRRP报文的正确收发，VRRP之定义了一种报文格式，即通过报文，它被封装在IP报文中，IP头部的协议号字段值为112，报文的目的IP地址是组播地址224.0.0.18.</p><ol><li><p>各个字段的含义如下：</p><ul><li><p>版本（Version）：对于VRRPv2来说，该字段的值恒为2</p></li><li><p>类型（Type）：VRRP之定义了通告报文这一种报文类型.该字段的值恒为1.</p></li><li><p>虚拟路由器ID（VRID）：虚拟路由器的标识符，取值范围是1~255，属于同一个VRRP组的路由器需使用相同的VRID.</p></li><li><p>优先级（Priority）：取值范围0~255，该值越大，则VRRP优先级越高，路由器也就越有可能成为Master</p></li><li><p>IP地址个数（Count IP Address）：VRRP组中虚拟IP地址的个数.这个字段的值指示了改报文后续的”IP地址”字段的个数</p></li><li><p>认证类型（Authentication Type）：VRRP报文的认证烈性，有以下三种情况. </p><p>a. 当该字段为0时，表示无认证（Non Authentication）；</p><p>b. 当该字段为1时，表示明文认证方式（Simple Text Password）；</p><p>c. 当该字段为2时，表示MD5认证方式（IP Authentication Header）；</p></li><li><p>通告间隔（Advertisement Interval）：VRRP报文的发送时间间隔（单位为秒），缺省情况下，VRRP的报文发送时间间隔为1s.</p></li><li><p>校验和（Checksum）：校验和</p></li><li><p>IP地址（IP address）：VRRP虚拟IP地址</p></li><li><p>认证数据（Authentication Data）：VRRP认证数据，当VRRP明文认证或MD5认证被激活时，该字段则填充相应的数据.</p></li></ul></li></ol></blockquote><h2 id="単网关的缺陷"><a href="#単网关的缺陷" class="headerlink" title="単网关的缺陷"></a>単网关的缺陷</h2><p><strong>当网关路由器R-A出现故障时，本网段内以该设备为网关的主机都不能与Internet进行通信.</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117142525.png" alt="image-20210117142525718"></p><h2 id="多网关存在的问题"><a href="#多网关存在的问题" class="headerlink" title="多网关存在的问题"></a>多网关存在的问题</h2><blockquote><ol><li>通过部署多网关的方式实现网关的备份</li><li>但多网关可能会出现一些问题：网关间IP地址冲突；主机会频繁切换网络接口</li></ol></blockquote><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117142608.png" alt="image-20210117142549799"></p><h2 id="VRRP基本结构"><a href="#VRRP基本结构" class="headerlink" title="VRRP基本结构"></a>VRRP基本结构</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117142628.png" alt="image-20210117142628405"></p><h2 id="VRRP主备备份工作过程"><a href="#VRRP主备备份工作过程" class="headerlink" title="VRRP主备备份工作过程"></a>VRRP主备备份工作过程</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117142642.png" alt="image-20210117142642803"></p><h3 id="VRRP主备路由器切换过程（1）"><a href="#VRRP主备路由器切换过程（1）" class="headerlink" title="VRRP主备路由器切换过程（1）"></a>VRRP主备路由器切换过程（1）</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117142706.png" alt="image-20210117142706033"></p><h3 id="VRRP主备路由器切换过程（2）"><a href="#VRRP主备路由器切换过程（2）" class="headerlink" title="VRRP主备路由器切换过程（2）"></a>VRRP主备路由器切换过程（2）</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117142726.png" alt="image-20210117142726738"></p><h2 id="VRRP负载分担工作过程"><a href="#VRRP负载分担工作过程" class="headerlink" title="VRRP负载分担工作过程"></a>VRRP负载分担工作过程</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117142812.png" alt="image-20210117142745058"></p><h2 id="实验1"><a href="#实验1" class="headerlink" title="实验1"></a>实验1</h2><p><strong>如图所示：R1与R2分两个组，组1是由R1为主，组2有R2为主，R1与R2各VRRP组中高优先级设置为150，低优先级设置为120.通过VRRP实现负载分担</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117142812.png" alt="image-20210117142812828"></p><h3 id="主机地址配置"><a href="#主机地址配置" class="headerlink" title="主机地址配置"></a>主机地址配置</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PC2：VPCS&gt; ip 192.168.1.1/24 192.168.1.254</span><br><span class="line">PC3：VPCS&gt; ip 192.168.1.2/24 192.168.1.253</span><br></pre></td></tr></table></figure><h3 id="R1配置"><a href="#R1配置" class="headerlink" title="R1配置"></a>R1配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">interface Ethernet0/1</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.251</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line"> vrrp 1 ip 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.254</span></span><br><span class="line"> vrrp 1 priority 150</span><br><span class="line"> vrrp 2 ip 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.253</span></span><br><span class="line"> vrrp 2 priority 120</span><br><span class="line">！</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip <span class="selector-tag">address</span> 1<span class="selector-class">.1</span><span class="selector-class">.1</span><span class="selector-class">.1</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.255</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><h3 id="R2配置"><a href="#R2配置" class="headerlink" title="R2配置"></a>R2配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">interface Ethernet0/1</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.252</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line"> vrrp 1 ip 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.254</span></span><br><span class="line"> vrrp 1 priority 120</span><br><span class="line"> vrrp 2 ip 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.253</span></span><br><span class="line"> vrrp 2 priority 150</span><br><span class="line">！</span><br><span class="line">interface Loopback0</span><br><span class="line">ip <span class="selector-tag">address</span> 2<span class="selector-class">.2</span><span class="selector-class">.2</span><span class="selector-class">.2</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.255</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><h2 id="使用show查看配置"><a href="#使用show查看配置" class="headerlink" title="使用show查看配置"></a>使用show查看配置</h2><h3 id="R1"><a href="#R1" class="headerlink" title="R1"></a>R1</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117142932.png" alt="image-20210117142932728"></p><h3 id="R2"><a href="#R2" class="headerlink" title="R2"></a>R2</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117142946.png" alt="image-20210117142946507"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117142957.png" alt="image-20210117142957230"></p><h3 id="PC2-通过追踪显然PC2走VRRP组1"><a href="#PC2-通过追踪显然PC2走VRRP组1" class="headerlink" title="PC2:通过追踪显然PC2走VRRP组1"></a>PC2:通过追踪显然PC2走VRRP组1</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117143016.png" alt="image-20210117143016247"></p><h3 id="PC3：通过追踪显然PC3走VRRP组2"><a href="#PC3：通过追踪显然PC3走VRRP组2" class="headerlink" title="PC3：通过追踪显然PC3走VRRP组2"></a>PC3：通过追踪显然PC3走VRRP组2</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117143029.png" alt="image-20210117143029022"></p><h2 id="实验2"><a href="#实验2" class="headerlink" title="实验2"></a>实验2</h2><p><strong>如图所示：在S-A和S-B上配置VRRP，实现主机的网关冗余。所配置的参数.S-A、S-B各VRRP组中高优先级设置为150，低优先级设置为120，并设置抢占功能为5秒</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117143047.png" alt="image-20210117143047782"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117143058.png" alt="image-20210117143058692"></p><h3 id="主机地址配置-1"><a href="#主机地址配置-1" class="headerlink" title="主机地址配置"></a>主机地址配置</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PC1：VPCS&gt; ip 192.168.10.1/24 192.168.10.254</span><br><span class="line">PC2：VPCS&gt; ip 192.168.20.1/24 192.168.20.254</span><br><span class="line">PC3：VPCS&gt; ip 192.168.30.1/24 192.168.30.254</span><br><span class="line">PC4：VPCS&gt; ip 192.168.40.1/24 192.168.40.254</span><br></pre></td></tr></table></figure><h3 id="S-A配置"><a href="#S-A配置" class="headerlink" title="S-A配置"></a>S-A配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">S-<span class="selector-tag">A</span>(config)<span class="selector-id">#vlan</span> 10,20,30,40</span><br><span class="line">interface GigabitEthernet0/0</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface GigabitEthernet0/1</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Vlan10</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.10</span><span class="selector-class">.252</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line"> vrrp 10 ip 192<span class="selector-class">.168</span><span class="selector-class">.10</span><span class="selector-class">.254</span></span><br><span class="line"> vrrp 10 preempt delay minimum 5</span><br><span class="line"> vrrp 10 priority 150</span><br><span class="line">!</span><br><span class="line">interface Vlan20</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.20</span><span class="selector-class">.252</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line"> vrrp 20 ip 192<span class="selector-class">.168</span><span class="selector-class">.20</span><span class="selector-class">.254</span></span><br><span class="line"> vrrp 20 preempt delay minimum 5</span><br><span class="line"> vrrp 20 priority 150</span><br><span class="line">!</span><br><span class="line">interface Vlan30</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.30</span><span class="selector-class">.252</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line"> vrrp 30 ip 192<span class="selector-class">.168</span><span class="selector-class">.30</span><span class="selector-class">.254</span></span><br><span class="line"> vrrp 30 preempt delay minimum 5</span><br><span class="line"> vrrp 30 priority 120</span><br><span class="line">!</span><br><span class="line">interface Vlan40</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.40</span><span class="selector-class">.252</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line"> vrrp 40 ip 192<span class="selector-class">.168</span><span class="selector-class">.40</span><span class="selector-class">.254</span></span><br><span class="line"> vrrp 40 preempt delay minimum 5</span><br><span class="line"> vrrp 40 priority 120</span><br><span class="line">!</span><br></pre></td></tr></table></figure><h3 id="S-B配置"><a href="#S-B配置" class="headerlink" title="S-B配置"></a>S-B配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">S-<span class="selector-tag">B</span>(config)<span class="selector-id">#vlan</span> 10,20,30,40</span><br><span class="line">interface GigabitEthernet0/0</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface GigabitEthernet0/1</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Vlan10</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.10</span><span class="selector-class">.253</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line"> vrrp 10 ip 192<span class="selector-class">.168</span><span class="selector-class">.10</span><span class="selector-class">.254</span></span><br><span class="line"> vrrp 10 preempt delay minimum 5</span><br><span class="line"> vrrp 10 priority 120</span><br><span class="line">!</span><br><span class="line">interface Vlan20</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.20</span><span class="selector-class">.253</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line"> vrrp 20 ip 192<span class="selector-class">.168</span><span class="selector-class">.20</span><span class="selector-class">.254</span></span><br><span class="line"> vrrp 20 preempt delay minimum 5</span><br><span class="line"> vrrp 20 priority 120</span><br><span class="line">!</span><br><span class="line">interface Vlan30</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.30</span><span class="selector-class">.253</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line"> vrrp 30 ip 192<span class="selector-class">.168</span><span class="selector-class">.30</span><span class="selector-class">.254</span></span><br><span class="line"> vrrp 30 preempt delay minimum 5</span><br><span class="line"> vrrp 30 priority 150</span><br><span class="line">!</span><br><span class="line">interface Vlan40</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.40</span><span class="selector-class">.253</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line"> vrrp 40 ip 192<span class="selector-class">.168</span><span class="selector-class">.40</span><span class="selector-class">.254</span></span><br><span class="line"> vrrp 40 preempt delay minimum 5</span><br><span class="line"> vrrp 40 priority 150</span><br></pre></td></tr></table></figure><h3 id="S-C配置"><a href="#S-C配置" class="headerlink" title="S-C配置"></a>S-C配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">S-C(config)<span class="selector-id">#vlan</span> 10,20,30,40</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/0</span><br><span class="line">switchport access vlan 10</span><br><span class="line">switchport mode access</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line">switchport access vlan 20</span><br><span class="line">switchport mode access</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line"></span><br><span class="line">S-D：</span><br><span class="line">S-D(config)<span class="selector-id">#vlan</span> 10,20,30,40</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/0</span><br><span class="line">switchport access vlan 30</span><br><span class="line">switchport mode access</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line">switchport access vlan 40</span><br><span class="line">switchport mode access</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br></pre></td></tr></table></figure><h2 id="使用show查看配置-1"><a href="#使用show查看配置-1" class="headerlink" title="使用show查看配置"></a>使用show查看配置</h2><h3 id="S-A"><a href="#S-A" class="headerlink" title="S-A"></a>S-A</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117143221.png" alt="image-20210117143207719"></p><h3 id="S-B"><a href="#S-B" class="headerlink" title="S-B"></a>S-B</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117143221.png" alt="image-20210117143221155"></p><h3 id="PC1"><a href="#PC1" class="headerlink" title="PC1"></a>PC1</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117143234.png" alt="image-20210117143234447"></p><h3 id="PC3"><a href="#PC3" class="headerlink" title="PC3"></a>PC3</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117143244.png" alt="image-20210117143244166"></p>]]></content>
      
      
      <categories>
          
          <category> 路由交换 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VRRP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PVLAN</title>
      <link href="2021/01/17/PVLAN/"/>
      <url>2021/01/17/PVLAN/</url>
      
        <content type="html"><![CDATA[<h1 id="PVLAN"><a href="#PVLAN" class="headerlink" title="PVLAN"></a>PVLAN</h1><h2 id="PVLAN应用场景"><a href="#PVLAN应用场景" class="headerlink" title="PVLAN应用场景"></a>PVLAN应用场景</h2><blockquote><ol><li>private vlan的重要功能就是能够实现节约IP地址，隔离广播风暴，病毒攻击，控制端口二层互访.适用于大的二层结构的环境，例如：用户多，vlan多，但是IP地址又是同一个网段，又要实现彼此之间的二层隔离，个别vlan之间又需要访问的情况下，private vlan可以解决上面的问题</li><li>另一种比较典型的PVLAN应用类似于端口隔离功能（switchport protected），即将所有用户端口设置为隔离VLAN(Isolated Port），这样即使同一vlan，同一网段的IP之间的用户也无法访问，可以有效隔离病毒传播。</li></ol></blockquote><h2 id="PVLAN功能介绍"><a href="#PVLAN功能介绍" class="headerlink" title="PVLAN功能介绍"></a>PVLAN功能介绍</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117140743.png"></p><blockquote><ol><li>服务提供商如果给每个用户一个VLAN，则由于一台设备支持的VLAN数最大只有4094而限制了服务提供商能支持的用户数；在三层设备上，每个VLAN被分配一个子网地址或一系列地址，这种情况导致IP地址的浪费，对于这个问题我们可以使用private vlan来解决.</li><li>private vlan将一个vlan的二层广播域分成多个子域，每个子域都由一个私有vlan对组成：主vlan（primary vlan）和辅助vlan（secondary vlan）.</li><li>private vlan域中所有的私有vlan共享同一个主vlan</li><li>每个子域的辅助vlan id不同. 一个private vlan域中只有一个主vlan</li></ol></blockquote><p><strong>有两种类型的辅助vlan</strong></p><blockquote><ol><li>隔离vlan（lsolated vlan）：同一个隔离vlan中的端口不可以互相进行二层通信，一个private vlan域中只有一个隔离vlan</li><li>团体vlan（Community vlan）：同一团体vlan中的端口可以互相进行二层通信，但不能与其他群体vlan中的端口进行二层通信，一个private vlan中可以有多个团体vlan</li></ol></blockquote><p><strong>private vlan域内三种常见的端口角色</strong></p><blockquote><ol><li>混杂端口（Promiscuous Port）：混杂端口为主vlan中的端口，可以与任意端口通信，包括同一个Private vlan的隔离端口和团体端口.</li><li>隔离端口（lsolated Port）：隔离vlan中的端口彼此之间不能通信，只能与混杂端口进行通信</li><li>团体端口（Community Port）：属于团体vlan中的端口，同一团体vlan可以进行通信也可以和混杂端口通信，不能与其他团体vlan通信以及隔离端口通信</li><li>只有主vlan可以创建SVI接口，配置IP作为网关使用，辅助vlan不可以创建SVI</li></ol></blockquote><h2 id="SVI接口"><a href="#SVI接口" class="headerlink" title="SVI接口"></a>SVI接口</h2><blockquote><p>SVI（switch virtual interface）交换虚拟接口，即交互三层管理vlan地址，一个由交换端口构成的vlan（其实就是通常所说的vlan接口）用于连接整个vlan。也称为逻辑三层接口. SVI是联系vlan的IP接口，一个SVI只能和一个vlan相联系.</p></blockquote><h2 id="PVLAN实验"><a href="#PVLAN实验" class="headerlink" title="PVLAN实验"></a>PVLAN实验</h2><h3 id="实验1"><a href="#实验1" class="headerlink" title="实验1"></a>实验1</h3><p><strong>如图所示：在主vlan中有2个部门，服务器属于主vlan10并配置混杂端口，其中财务部属于隔离vlan20，商务部门属于团体vlan30</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117140914.png"></p><h4 id="主机地址配置"><a href="#主机地址配置" class="headerlink" title="主机地址配置"></a>主机地址配置</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">VPC1:VPCS&gt; ip <span class="number">192.168</span>.<span class="number">1.1</span>/<span class="number">24</span> <span class="number">192.168</span>.<span class="number">1.254</span></span><br><span class="line">VPC2:VPCS&gt; ip <span class="number">192.168</span>.<span class="number">1.2</span>/<span class="number">24</span> <span class="number">192.168</span>.<span class="number">1.254</span></span><br><span class="line">VPC3:VPCS&gt; ip <span class="number">192.168</span>.<span class="number">1.3</span>/<span class="number">24</span> <span class="number">192.168</span>.<span class="number">1.254</span></span><br><span class="line">VPC4:VPCS&gt; ip <span class="number">192.168</span>.<span class="number">1.4</span>/<span class="number">24</span> <span class="number">192.168</span>.<span class="number">1.254</span></span><br><span class="line">VPC5:VPCS&gt; ip <span class="number">192.168</span>.<span class="number">1.5</span>/<span class="number">24</span> <span class="number">192.168</span>.<span class="number">1.254</span></span><br></pre></td></tr></table></figure><h4 id="S1配置"><a href="#S1配置" class="headerlink" title="S1配置"></a>S1配置</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">vlan 10</span><br><span class="line">  private-vlan primary     <span class="selector-id">#--</span>&gt;设置vlan10为主vlan</span><br><span class="line">  private-vlan association 20,30 <span class="selector-id">#--</span>&gt;关联辅助vlan20和vlan30</span><br><span class="line">!</span><br><span class="line">vlan 20</span><br><span class="line">  private-vlan isolated    <span class="selector-id">#--</span>&gt;设置vlan20为隔离vlan</span><br><span class="line">!</span><br><span class="line">vlan 30</span><br><span class="line">  private-vlan community   <span class="selector-id">#--</span>&gt;设置vlan30为团体vlan</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> switchport private-vlan host-association 10 20</span><br><span class="line">                           #--&gt;将e0/1接口加入到隔离vlan</span><br><span class="line"> switchport mode private-vlan host </span><br><span class="line">                           <span class="selector-id">#--</span>&gt;设置模式为private-vlan</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> switchport private-vlan host-association 10 20 </span><br><span class="line">                           #--&gt;将e0/1接口加入到隔离vlan</span><br><span class="line"> switchport mode private-vlan host </span><br><span class="line">                           <span class="selector-id">#--</span>&gt;设置模式为private-vlan</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line"> switchport private-vlan host-association 10 30 </span><br><span class="line">                           #--&gt;将e0/1接口加入到团体vlan</span><br><span class="line"> switchport mode private-vlan host </span><br><span class="line">                           <span class="selector-id">#--</span>&gt;设置模式为private-vlan</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/3</span><br><span class="line"> switchport private-vlan host-association 10 30 </span><br><span class="line">                           #--&gt;将e0/1接口加入到团体vlan</span><br><span class="line"> switchport mode private-vlan host</span><br><span class="line">                           <span class="selector-id">#--</span>&gt;设置模式为private-vlan</span><br><span class="line">!</span><br><span class="line">interface Vlan10</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.254</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line"> private-vlan mapping 20,30  </span><br><span class="line">                           <span class="selector-id">#--</span>&gt;将辅助vlan映射到SVI接口</span><br><span class="line">！</span><br><span class="line">interface  Ethernet1/1</span><br><span class="line">switchport private-vlan mapping 10 11-12</span><br><span class="line">switchport mode private-vlan promiscuous</span><br></pre></td></tr></table></figure><blockquote><ol><li>PC1和PC2隔离vlan不能互相ping通，但是能和主vlan10的PC5ping通</li><li>PC3和PC4团体vlan能互相ping通，也能和主vlan10的PC5ping通</li><li>主vlanPC5能和辅助vlan的全部主机ping通</li></ol></blockquote><h3 id="使用show查看配置"><a href="#使用show查看配置" class="headerlink" title="使用show查看配置"></a>使用show查看配置</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117141012.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117141019.png"></p><h3 id="实验2"><a href="#实验2" class="headerlink" title="实验2"></a>实验2</h3><p><strong>如图所示：三台交换机，一台三层，两台二层，三台交换机分别有主vlan10和辅助vlan11,12，S-A和S-B之间做trunk，S-A和Swith（三层）做混杂端口，Swith（三层）上配置192.168.1.254/24的网关</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117141044.png"></p><h4 id="主机地址配置-1"><a href="#主机地址配置-1" class="headerlink" title="主机地址配置"></a>主机地址配置</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">VPC1:VPCS&gt; ip <span class="number">192.168</span>.<span class="number">1.1</span>/<span class="number">24</span> <span class="number">192.168</span>.<span class="number">1.254</span></span><br><span class="line">VPC2:VPCS&gt; ip <span class="number">192.168</span>.<span class="number">1.2</span>/<span class="number">24</span> <span class="number">192.168</span>.<span class="number">1.254</span></span><br><span class="line">VPC3:VPCS&gt; ip <span class="number">192.168</span>.<span class="number">1.3</span>/<span class="number">24</span> <span class="number">192.168</span>.<span class="number">1.254</span></span><br><span class="line">VPC4:VPCS&gt; ip <span class="number">192.168</span>.<span class="number">1.4</span>/<span class="number">24</span> <span class="number">192.168</span>.<span class="number">1.254</span></span><br><span class="line">VPC5:VPCS&gt; ip <span class="number">192.168</span>.<span class="number">1.5</span>/<span class="number">24</span> <span class="number">192.168</span>.<span class="number">1.254</span></span><br></pre></td></tr></table></figure><h4 id="S-A配置"><a href="#S-A配置" class="headerlink" title="S-A配置"></a>S-A配置</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vlan 10</span><br><span class="line">  private-vlan primary</span><br><span class="line">  private-vlan association 11-12</span><br><span class="line">!</span><br><span class="line">vlan 11</span><br><span class="line">  private-vlan community</span><br><span class="line">!</span><br><span class="line">vlan 12</span><br><span class="line">  private-vlan isolated</span><br><span class="line">！</span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> switchport private-vlan host-association 10 11</span><br><span class="line"> switchport mode private-vlan host</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> switchport private-vlan host-association 10 11</span><br><span class="line"> switchport private-vlan mapping 10 11-12</span><br><span class="line"> switchport mode private-vlan promiscuous</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line"> switchport private-vlan host-association 10 12</span><br><span class="line"> switchport mode private-vlan host</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/3</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet1/0</span><br><span class="line"> switchport private-vlan mapping 10 11-12</span><br><span class="line"> switchport mode private-vlan promiscuous</span><br></pre></td></tr></table></figure><h4 id="S-B配置"><a href="#S-B配置" class="headerlink" title="S-B配置"></a>S-B配置</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vlan 10</span><br><span class="line">  private-vlan primary</span><br><span class="line">  private-vlan association 11-12</span><br><span class="line">!</span><br><span class="line">vlan 11</span><br><span class="line">  private-vlan community</span><br><span class="line">!</span><br><span class="line">vlan 12</span><br><span class="line">  private-vlan isolated</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> switchport private-vlan host-association 10 11</span><br><span class="line"> switchport mode private-vlan host</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line"> switchport private-vlan host-association 10 12</span><br><span class="line"> switchport mode private-vlan host</span><br></pre></td></tr></table></figure><h4 id="Switch1（三层）配置"><a href="#Switch1（三层）配置" class="headerlink" title="Switch1（三层）配置"></a>Switch1（三层）配置</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vlan 10</span><br><span class="line">  private-vlan primary</span><br><span class="line">  private-vlan association 11-12</span><br><span class="line">!</span><br><span class="line">vlan 11</span><br><span class="line">  private-vlan community</span><br><span class="line">!</span><br><span class="line">vlan 12</span><br><span class="line">  private-vlan isolated</span><br><span class="line">!</span><br><span class="line">interface Vlan10</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.254</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line"> private-vlan mapping 11-12</span><br><span class="line">！</span><br><span class="line">interface GigabitEthernet0/0</span><br><span class="line"> switchport private-vlan mapping 10 11-12</span><br><span class="line"> switchport mode private-vlan promiscuous</span><br></pre></td></tr></table></figure><blockquote><ol><li>PC3和PC5隔离vlan11不能相通，但是ping通主vlan的SVI接口</li><li>PC1，PC2和PC5团体vlan12可以互相ping通，也可以ping通主vlan的SVI接口</li></ol></blockquote><h4 id="使用show查看配置-1"><a href="#使用show查看配置-1" class="headerlink" title="使用show查看配置"></a>使用show查看配置</h4><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117141148.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117141202.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117141213.png"></p>]]></content>
      
      
      <categories>
          
          <category> 路由交换 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VLAN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VLAN实验</title>
      <link href="2021/01/17/VLAN%E5%AE%9E%E9%AA%8C/"/>
      <url>2021/01/17/VLAN%E5%AE%9E%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h1 id="VLAN实验"><a href="#VLAN实验" class="headerlink" title="VLAN实验"></a>VLAN实验</h1><h2 id="Access链路应用"><a href="#Access链路应用" class="headerlink" title="Access链路应用"></a>Access链路应用</h2><p><strong>划分了两个VLAN</strong></p><blockquote><p>PC1和PC3网段属于VLAN10<br>PC2和PC4网段属于VLAN20<br>主机地址<br>PC1：192.1.1.1<br>PC2：192.1.1.2<br>PC3：192.1.1.3<br>PC4：192.1.1.4</p></blockquote><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117135816.png"></p><h3 id="S3配置"><a href="#S3配置" class="headerlink" title="S3配置"></a>S3配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">int e0/0</span><br><span class="line">swi mo acc</span><br><span class="line">swi acc vlan 10</span><br><span class="line"></span><br><span class="line">int e0/1</span><br><span class="line">swi mo acc</span><br><span class="line">swi acc vlan 20</span><br><span class="line"></span><br><span class="line">int e0/2</span><br><span class="line">swi mo acc</span><br><span class="line">swi acc vlan 10</span><br><span class="line"></span><br><span class="line">int e0/3</span><br><span class="line">swi mo acc</span><br><span class="line">swi acc vlan 20</span><br></pre></td></tr></table></figure><p><strong>PC1和PC3同属于一个vlan,可以ping通，但是和P2和P4不同vlan不能ping通，换过来说P2和P4也一样不能ping通P1和P3</strong></p><h2 id="Trunk链路应用"><a href="#Trunk链路应用" class="headerlink" title="Trunk链路应用"></a>Trunk链路应用</h2><p><strong>还是根据上面的地址和VLAN划分，添加多了一台交换机</strong></p><h3 id="S1和S2的配置"><a href="#S1和S2的配置" class="headerlink" title="S1和S2的配置"></a>S1和S2的配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">S1：int e0/0</span><br><span class="line">Swi trunk encapsulation dot1q</span><br><span class="line">Swi mode trunk</span><br><span class="line"></span><br><span class="line">S2：int e0/0</span><br><span class="line">Swi trunk encapsulation dot1q</span><br><span class="line">Swi mode trunk</span><br></pre></td></tr></table></figure><p><strong>终端和交换机之间的access接口配置还是一样，两端的交换机需要封装802.1q协议，封装之后，应用trunk模式，同VLAN之间可以通信，不同VLAN还是不能通信</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117135919.png"></p><p><strong>使用wireshark抓取的icmp数据包，turnk封装了802.1q，VLAN-id为10</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117135937.png"></p><h2 id="交换机不同模式使用出现的问题"><a href="#交换机不同模式使用出现的问题" class="headerlink" title="交换机不同模式使用出现的问题"></a>交换机不同模式使用出现的问题</h2><h3 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h3><p><strong>switch1两个接口都是VLAN10，switch2两个接口都是VLAN20，请问它们可以通信么？</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117140005.png"></p><h4 id="switch-1配置"><a href="#switch-1配置" class="headerlink" title="switch 1配置"></a>switch 1配置</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">S1(config)<span class="selector-id">#vlan</span> 10</span><br><span class="line">interface GigabitEthernet0/0</span><br><span class="line">switchport access vlan 10</span><br><span class="line">switchport mode access</span><br><span class="line"></span><br><span class="line">interface GigabitEthernet0/1</span><br><span class="line">switchport access vlan 10</span><br><span class="line">switchport mode access</span><br></pre></td></tr></table></figure><h4 id="switch-2配置"><a href="#switch-2配置" class="headerlink" title="switch 2配置"></a>switch 2配置</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">S2(config)<span class="selector-id">#vlan</span> 20</span><br><span class="line">interface GigabitEthernet0/0</span><br><span class="line">switchport access vlan 20</span><br><span class="line">switchport mode access</span><br><span class="line"></span><br><span class="line">interface GigabitEthernet0/1</span><br><span class="line">switchport access vlan 20</span><br><span class="line">switchport mode access</span><br></pre></td></tr></table></figure><p><strong>答：不能通信，因为VLAN需要同步</strong></p><p><strong>修改配置：两者交换机同步既可以通信了</strong></p><blockquote><p>switch 1<br>S1(config)#vlan 10<br>S1(config)#vlan 20</p><p>switch 2<br>S2(config)#vlan 10<br>S2(config)#vlan 20</p></blockquote><p><strong>答：两边VLAN同步，两边的接口都是相同的vlan-id，而access接口发送出去的一定是无标记帧</strong></p><blockquote><p>说明：PC1发送数据包给PC2，进入到switch1中，没有标签的数据包会打上vlan-id标签，发现目标是从自己gi0/1接口出去的，查看自己的gi0/1接口vlan-id标签，发现标签是一致，然后剥开vlan-id标签发送给switch2，接着switch2情况也和switch1一样.最终抵达PC2</p></blockquote><h3 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h3><p><strong>switch2的access-VLAN20接口改成trunk-VLAN20，请问PC1能pingPC2么?</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117140148.png"></p><h4 id="switch-2的配置"><a href="#switch-2的配置" class="headerlink" title="switch 2的配置"></a>switch 2的配置</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">interface GigabitEthernet0/0</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport trunk native vlan 20</span><br><span class="line">switchport mode trunk</span><br></pre></td></tr></table></figure><p><strong>答：不能ping通，因为模式不一样，一个是没有封装802.1q，一个没有封装了802.1q，匹配不成功，所以数据不可达</strong></p><h3 id="问题3"><a href="#问题3" class="headerlink" title="问题3"></a>问题3</h3><p><strong>switch1的g0/1接口设置成为trunk-VLAN10，switch2还是原来的trunk-VLAN20，PC1能否ping通PC2</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117140242.png"></p><p><strong>答：不能ping通</strong></p><blockquote><ol><li>不同vlan不能相通</li><li>如果两台通信的交换机配置的native vlan不一致,就会出现mismatch（不匹配）错误，两端的native vlan不匹配的trunk链路,一端的端口会被block住,而不会转发流量.</li></ol></blockquote><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117140326.png"></p><h2 id="综合实验"><a href="#综合实验" class="headerlink" title="综合实验"></a>综合实验</h2><blockquote><ol><li>s2两端都为access-vlan10，s3连接终端的接口为access-vlan20，连接三层交换机的接口为trunk-vlan20.</li><li>s1三层交换机gi0/1接口为192.168.1.254,gi0/0接口为172.16.1.254.</li></ol></blockquote><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117140354.png"></p><h3 id="主机地址配置"><a href="#主机地址配置" class="headerlink" title="主机地址配置"></a>主机地址配置</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PC3</span><br><span class="line">VPCS&gt; ip 192.168.1.1/24 192.168.1.25</span><br><span class="line">PC4</span><br><span class="line">VPCS&gt; ip 172.16.1.1/24 172.16.1.254</span><br></pre></td></tr></table></figure><h3 id="S2配置"><a href="#S2配置" class="headerlink" title="S2配置"></a>S2配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">interface GigabitEthernet0/0</span><br><span class="line"> switchport access vlan 10</span><br><span class="line"> switchport mode access</span><br><span class="line">!</span><br><span class="line">interface GigabitEthernet0/1</span><br><span class="line"> switchport access vlan 10</span><br><span class="line"> switchport mode access</span><br></pre></td></tr></table></figure><h3 id="S3配置-1"><a href="#S3配置-1" class="headerlink" title="S3配置"></a>S3配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">interface GigabitEthernet0/0</span><br><span class="line"> switchport access vlan 20</span><br><span class="line">!</span><br><span class="line">interface GigabitEthernet0/1</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport trunk native vlan 20</span><br><span class="line"> switchport mode trunk</span><br></pre></td></tr></table></figure><h3 id="S1配置"><a href="#S1配置" class="headerlink" title="S1配置"></a>S1配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">interface GigabitEthernet0/0</span><br><span class="line"> no switchport</span><br><span class="line"> ip <span class="selector-tag">address</span> 172<span class="selector-class">.16</span><span class="selector-class">.1</span><span class="selector-class">.254</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line">!</span><br><span class="line">interface GigabitEthernet0/1</span><br><span class="line"> no switchport</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.254</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br></pre></td></tr></table></figure><p><strong>上面的配置配置完，PC3可以ping通PC4，为什么可以相通.</strong></p><blockquote><p>答：PC3发送数据包给PC4，中间的access口都是透明，可以找到自己的网关，发现下一跳的路由是172.16.1.0/24，对应的接口是gi0/0，然后从gi0/0接口转发出去给S3的gi0/1接口，gi0/1接收到没有打标签的包，随即打上native标签20转发给gi0/0接口，gi0/0接口检查发送过来native跟自己的native是否一致，一致则剥开标签转发给PC4，数据包抵达目的.</p><p>如果S3的gi0/1接口没有打上native-id20，那么将不能通信，因为跟access的接口native不对应，所以目标不可达</p><p>S3接口设置了native-id20，那么对应上access的native，则查看允许通过列表是否通过，通过则转发数据，不通过则丢弃</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 路由交换 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VLAN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VLAN原理</title>
      <link href="2021/01/17/VLAN%E5%8E%9F%E7%90%86/"/>
      <url>2021/01/17/VLAN%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1 id="VLAN原理"><a href="#VLAN原理" class="headerlink" title="VLAN原理"></a>VLAN原理</h1><h2 id="广播域过大带来的影响"><a href="#广播域过大带来的影响" class="headerlink" title="广播域过大带来的影响"></a>广播域过大带来的影响</h2><blockquote><ol><li>广播帧泛洪产生大量的数据包（消耗交换机的资源）</li><li>由于都处于一个广播，安全性没有了保障（降低了安全性）</li></ol></blockquote><h2 id="VLAN（虚拟局域网virtual-LAN）"><a href="#VLAN（虚拟局域网virtual-LAN）" class="headerlink" title="VLAN（虚拟局域网virtual LAN）"></a>VLAN（虚拟局域网virtual LAN）</h2><blockquote><ol><li>VLAN的出现减少了广播带来负担，并且提高了安全性</li><li>VLAN号共有4096个，0-4095</li><li>0,4095：这两个号保留，仅限系统使用。用户不能查看。</li><li>CISCO默认VLAN1，不能删除。也同样不能做修改</li><li>2－1001：用于以太网的VLAN，用户可根据这一段号码自己创建VLAN</li><li>1002－1005：用于FDDI和令牌环的默认VLAN，不能删除。</li><li>1006－4094：仅用于以太网的VLAN. 扩展的VLAN，只有3550以上的交换机才能配，且必须将VTP模式设为透明模式。</li></ol></blockquote><h2 id="VLAN的作用"><a href="#VLAN的作用" class="headerlink" title="VLAN的作用"></a>VLAN的作用</h2><blockquote><ol><li>隔离广播域</li><li>VLAN将一个局域网划分成多个虚拟局域网（简单的说把一台交换机划分了多个小型交换机）</li><li>增加了局域网的安全性（不同VLAN之间不能互相通信）</li></ol></blockquote><h2 id="Access接入链路"><a href="#Access接入链路" class="headerlink" title="Access接入链路"></a>Access接入链路</h2><p><strong>Access链路一般应用于终端和交换机之间</strong></p><blockquote><p>一般部署在终端和交换机之间,一个access口属于一个VLAN接收到不带tag的数据帧时会打上接口的native-id后接收</p><ol><li>从access接口发送出去的帧一定是无标记帧</li><li>交换机上接收带tag的数据帧,则对比tag与native-id是否一致,如果相同则接收,如果不同则丢弃.</li><li>交换机发送数据帧与接口的native-id进行对比,一致则剥离tag发送,如果不同,则直接丢弃该数据帧</li></ol></blockquote><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117135130.png"></p><h2 id="Trunk干道链路"><a href="#Trunk干道链路" class="headerlink" title="Trunk干道链路"></a>Trunk干道链路</h2><p><strong>Trunk链路：用于交换机和交换机之间</strong></p><blockquote><ol><li><p>交换机从trunk链路接收数据帧</p><ul><li><p>带Tag,直接对比允许通过列表</p></li><li><p>不带Tag,打上端口的native-id,对比native-id是否在允许通过列表</p></li></ul></li><li><p>交换机将数据帧从trunk链路发送出去</p><ul><li><p>Tag与端口的native-id相同时,剥离Tag后对比允许通过列表</p></li><li><p>Tag与端口的native不同时,则直接将Tag对比允许通过列表</p></li></ul></li><li><p>native（本地vian-id）说明：</p><ul><li>如果两台通信的交换机配置的native vlan不一致,就会出现mismatch（不匹配）错误,两端的native vlan不匹配的trunk链路,一端的端口会被block住,而不会转发流量.</li></ul></li></ol></blockquote><h2 id="802-1Q报文格式"><a href="#802-1Q报文格式" class="headerlink" title="802.1Q报文格式"></a>802.1Q报文格式</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117135304.png"></p><p><strong>四个字节的标签头包含了2个字节的标签协议标识（TPID）和2个字节的标签控制信息（TCI）</strong></p><p><strong>TPID（Tag Protocol Identifier）是IEEE定义的新的类型,表明这是一个加了802.1Q标签的帧. TPID包含了一个固定的值0x8100</strong></p><p><strong>TCI是包含的是帧的控制信息,它包含了下面的一些元素：</strong></p><blockquote><ol><li>PRI字段主要用于QOS,默认值为0,范围为0-7,其中数值越大越优先,当交换机发生拥塞时,PRI数据越大的数据帧会达到优先转发</li><li>Canonical Format Indicator(CFI)：CFI值为0说明是规范格式,1为非规范格式,它被用在令牌环/源路由FDDiscard介质访问方法中来指示封装帧中所带地址的比特次序信息</li><li>VLAN的ID,取值范围为0-4095,一共4096个,由于0和4095的协议保留取值,所以VLAN ID的取值范围为1-4094每个支持802.1Q协议的交换机发送出来的数据包都会包含这个域,以指明主机属于哪一个VLAN.</li></ol></blockquote><p><strong><code>注意：终端设备在网卡不支持VLAN id的情况下会直接丢弃携带VLAN Tag的数据帧</code></strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117135436.png"></p><h2 id="Hybrid混合链路"><a href="#Hybrid混合链路" class="headerlink" title="Hybrid混合链路"></a>Hybrid混合链路</h2><p><strong>混合链路：华为默认的交换机的端口类型,同时具有access链路与trunk链路,可以部署在任何的交换机链路上</strong></p><blockquote><ol><li>Hybrid端口既可以连接主机,又可以连接交换机</li><li>Hybrid端口可以以Tagged或Untagged方式加入VLAN</li><li>接收报文的处理与trunk接口处理方式一致</li></ol></blockquote><h3 id="发送报文"><a href="#发送报文" class="headerlink" title="发送报文"></a>发送报文</h3><blockquote><p>Port hybrid tagged vlan x:在发送数据帧时允许VLAN x通过,保持tag发送<br>Port hybrid tagged vlan x:在发送数据帧时允许VLAN x 通过,将tag剥离后再发出</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 路由交换 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VLAN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MSTP</title>
      <link href="2021/01/17/MSTP/"/>
      <url>2021/01/17/MSTP/</url>
      
        <content type="html"><![CDATA[<h1 id="MSTP"><a href="#MSTP" class="headerlink" title="MSTP"></a>MSTP</h1><h2 id="MSTP概述"><a href="#MSTP概述" class="headerlink" title="MSTP概述"></a>MSTP概述</h2><p><strong>多生成树协议（Multi spanning tree protocol）</strong></p><blockquote><ol><li>MSTP（多生成树实例）：MSTP生成树不是基于VLAN运行的，而是基于Instance（实例）运行的。可以把一个或多个VLAN映射到Instance，然后Instance计算生成树。基于Instance的生成树被称为MSTI（多生成树实例）。</li><li>MSTP为每个Instance维护独立的MSTI。映射到同一个Instance的VLAN将共享同一棵生成树。</li><li>每个MSTP引入了域的概念，我们可以将一个大型的交换网络划分成多个MST域（多生成域）一个MST域内可以包含一台或者多台交换机。同属一个域的交换机必须配置相同的域名，相同的修订级别，以及相同的VLNA与Instance的映射关系。</li><li>每个MST域内都存在一棵IST（内部生成树）缺省时，交换机上的所有VLNA属于Instance０，而IST则是MST域内的交换机对Instance０计算出的一棵生成树。</li><li>缺省时，MST域名是交换设备主控板上管理网口的MAC地址。</li></ol></blockquote><h2 id="单生成树的弊端-部分VLAN路径不通"><a href="#单生成树的弊端-部分VLAN路径不通" class="headerlink" title="单生成树的弊端-部分VLAN路径不通"></a>单生成树的弊端-部分VLAN路径不通</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117130807.png"></p><h2 id="单生成树的弊端-无法实现流量分担"><a href="#单生成树的弊端-无法实现流量分担" class="headerlink" title="单生成树的弊端-无法实现流量分担"></a>单生成树的弊端-无法实现流量分担</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117130826.png"></p><h2 id="单生成树的弊端-次优二层路径"><a href="#单生成树的弊端-次优二层路径" class="headerlink" title="单生成树的弊端-次优二层路径"></a>单生成树的弊端-次优二层路径</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117130849.png"></p><h2 id="多生成树实例解决单生成树弊端"><a href="#多生成树实例解决单生成树弊端" class="headerlink" title="多生成树实例解决单生成树弊端"></a>多生成树实例解决单生成树弊端</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117130905.png"></p><h2 id="实验1"><a href="#实验1" class="headerlink" title="实验1"></a>实验1</h2><p><strong>如图所示：在数据中心交换机SW1、SW2上配置MSTP防止二层环路；要求VLAN10数据流经过SW1转发，VLAN20数据流经过SW2转发，SW1和SW2其中一台宕机时均可无缝切换至另一台进行转发。switch 是两台PC的网关，所配置的参数要求如下：</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">region-name为cisco；</span><br><span class="line">revision版本为1；</span><br><span class="line">实例1，包含VLAN10</span><br><span class="line">实例2，包含VLAN20</span><br><span class="line">SW1作为实例1中的主根，SW2作为实例1的从根；</span><br><span class="line">SW2作为实例2中的主根，SW1作为实例2的从根；</span><br><span class="line">主根优先级为4096，从根优先级为8192；</span><br><span class="line">网关：PC1-192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.254</span> PC2-172<span class="selector-class">.16</span><span class="selector-class">.1</span><span class="selector-class">.254</span> </span><br></pre></td></tr></table></figure><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117131008.png"></p><h3 id="配置主机地址"><a href="#配置主机地址" class="headerlink" title="配置主机地址"></a>配置主机地址</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PC1：VPCS&gt; ip 192.168.1.1/24 192.168.1.254</span><br><span class="line">PC2：VPCS&gt; ip 172.16.1.1/24 172.16.1.254</span><br></pre></td></tr></table></figure><h3 id="Switch配置"><a href="#Switch配置" class="headerlink" title="Switch配置"></a>Switch配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Switch(config)<span class="selector-id">#vlan</span> 10,20</span><br><span class="line">interface GigabitEthernet0/0</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface GigabitEthernet0/1</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Vlan10</span><br><span class="line"> ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.254</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line">!</span><br><span class="line">interface Vlan20</span><br><span class="line"> ip <span class="selector-tag">address</span> 172<span class="selector-class">.16</span><span class="selector-class">.1</span><span class="selector-class">.254</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br></pre></td></tr></table></figure><h3 id="S1配置"><a href="#S1配置" class="headerlink" title="S1配置"></a>S1配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">S1(config)<span class="selector-id">#vlan</span> 10,20</span><br><span class="line">！</span><br><span class="line">interface Ethernet0/0</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">！</span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">！</span><br><span class="line">spanning-tree mst configuration</span><br><span class="line"> name cisco  <span class="selector-id">#--</span>&gt;域名（同一域必须相同）</span><br><span class="line"> revision 1  <span class="selector-id">#--</span>&gt;修订号</span><br><span class="line"> instance 1 vlan 10  <span class="selector-id">#--</span>&gt;实例1关联vlan10</span><br><span class="line"> instance 2 vlan 20  <span class="selector-id">#--</span>&gt;实例2关联vlan20</span><br><span class="line">!</span><br><span class="line">spanning-tree mst 1 priority 4096 <span class="selector-id">#--</span>&gt;设置实例1优先级为4096</span><br><span class="line">spanning-tree mst 2 priority 8192 <span class="selector-id">#--</span>&gt;设置实例2优先级为8192</span><br></pre></td></tr></table></figure><h3 id="S2配置"><a href="#S2配置" class="headerlink" title="S2配置"></a>S2配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">S2(config)<span class="selector-id">#vlan</span> 10,20</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">！</span><br><span class="line">spanning-tree mst configuration</span><br><span class="line"> name cisco</span><br><span class="line"> revision 1</span><br><span class="line"> instance 1 vlan 10</span><br><span class="line"> instance 2 vlan 20</span><br><span class="line">!</span><br><span class="line">spanning-tree mst 1 priority 8192</span><br><span class="line">spanning-tree mst 2 priority 4096</span><br></pre></td></tr></table></figure><h3 id="S3配置"><a href="#S3配置" class="headerlink" title="S3配置"></a>S3配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">S3(config)<span class="selector-id">#vlan</span> 10,20</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line"> switchport access vlan 10</span><br><span class="line"> switchport mode access</span><br><span class="line"> spanning-tree portfast edge     <span class="selector-id">#--</span>开启边缘端口</span><br><span class="line"> spanning-tree bpduguard enable  <span class="selector-id">#--</span>&gt;开启BPDU保护</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/3</span><br><span class="line"> switchport access vlan 20</span><br><span class="line"> switchport mode access</span><br><span class="line"> spanning-tree portfast edge</span><br><span class="line"> spanning-tree bpduguard enable</span><br><span class="line">！</span><br><span class="line">spanning-tree mst configuration</span><br><span class="line"> name cisco</span><br><span class="line"> revision 1</span><br><span class="line"> instance 1 vlan 10</span><br><span class="line"> instance 2 vlan 20</span><br></pre></td></tr></table></figure><h2 id="使用show查看配置"><a href="#使用show查看配置" class="headerlink" title="使用show查看配置"></a>使用show查看配置</h2><h3 id="S1配置：实例1关联VLAN10"><a href="#S1配置：实例1关联VLAN10" class="headerlink" title="S1配置：实例1关联VLAN10"></a>S1配置：实例1关联VLAN10</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117131142.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117131153.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117131204.png"></p><h3 id="S2：实例2关联VLAN20"><a href="#S2：实例2关联VLAN20" class="headerlink" title="S2：实例2关联VLAN20"></a>S2：实例2关联VLAN20</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117131220.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117131233.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117131241.png"></p><h3 id="S3：实例1关联着VLAN10，所以E0-1接口是AP口，实例2关联着VLAN20，所以E0-0接口是AP口"><a href="#S3：实例1关联着VLAN10，所以E0-1接口是AP口，实例2关联着VLAN20，所以E0-0接口是AP口" class="headerlink" title="S3：实例1关联着VLAN10，所以E0/1接口是AP口，实例2关联着VLAN20，所以E0/0接口是AP口."></a>S3：实例1关联着VLAN10，所以E0/1接口是AP口，实例2关联着VLAN20，所以E0/0接口是AP口.</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117131302.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117131332.png"></p><h2 id="实验2"><a href="#实验2" class="headerlink" title="实验2"></a>实验2</h2><p><strong>如图所示：某小型办公区域网络由四台电脑，需要将办公区域内的计算机划分成四个区域，分别是vlan10，vlan20，vlan30和vlan40，接入层交换机每个vlan连接一台计算机，要求VLAN10、VLAN20数据流经过S1-1转发，VLAN30、VLAN40数据流经过S1-2转发，S1-1，S1-2其中一台宕机时均可无缝切换至另一台进行转发。所配置的参数要求如下</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">region-name为cisco；</span><br><span class="line">revision版本为1；</span><br><span class="line">实例1，包含VLAN10，VLAN20;</span><br><span class="line">实例2，包含VLAN40，VLAN50;</span><br><span class="line">S1-1作为实例0、1中的主根，S1-2作为实例0、1的从根；</span><br><span class="line">S1-1作为实例2中的主根，S1-2作为实例2的从根；</span><br><span class="line">主根优先级为4096，从根优先级为8192；</span><br><span class="line">地址和网关：</span><br><span class="line">vlan10-192.168.1.1/28，192.168.1.14</span><br><span class="line">vlan20-192.168.1.17/28 ，192.168.1.30</span><br><span class="line">vlan30-172.16.1.1/28，172.16.1.14</span><br><span class="line">vlan40-172.16.1.17/28，172.16.1.30 </span><br></pre></td></tr></table></figure><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117131424.png"></p><h3 id="配置主机地址-1"><a href="#配置主机地址-1" class="headerlink" title="配置主机地址"></a>配置主机地址</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PC1：VPCS&gt; ip 192.168.1.1/28 192.168.1.14</span><br><span class="line">PC2：VPCS&gt; ip 192.168.1.17/28 192.168.1.30</span><br><span class="line">PC3：VPCS&gt; ip 172.16.1.1/28 172.16.1.14</span><br><span class="line">PC3：VPCS&gt; ip 172.16.1.17/28 172.16.1.30</span><br></pre></td></tr></table></figure><h3 id="Switch配置-1"><a href="#Switch配置-1" class="headerlink" title="Switch配置"></a>Switch配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">interface GigabitEthernet0/0</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface GigabitEthernet0/1</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">! </span><br><span class="line">interface Vlan10</span><br><span class="line">ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.14</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.240</span></span><br><span class="line">!</span><br><span class="line">interface Vlan20</span><br><span class="line">ip <span class="selector-tag">address</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.240</span></span><br><span class="line">!</span><br><span class="line">interface Vlan30</span><br><span class="line">ip <span class="selector-tag">address</span> 172<span class="selector-class">.16</span><span class="selector-class">.1</span><span class="selector-class">.14</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.240</span></span><br><span class="line">!</span><br><span class="line">interface Vlan40</span><br><span class="line">ip <span class="selector-tag">address</span> 172<span class="selector-class">.16</span><span class="selector-class">.1</span><span class="selector-class">.30</span> 255<span class="selector-class">.255</span><span class="selector-class">.255</span><span class="selector-class">.240</span></span><br></pre></td></tr></table></figure><h3 id="S1-1配置"><a href="#S1-1配置" class="headerlink" title="S1-1配置"></a>S1-1配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">interface Ethernet0/0</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/3</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">！</span><br><span class="line">spanning-tree mst configuration</span><br><span class="line">name cisco</span><br><span class="line">revision 1</span><br><span class="line">instance 1 vlan 10, 20</span><br><span class="line">instance 2 vlan 30, 40</span><br><span class="line">!</span><br><span class="line">spanning-tree mst 0-1 priority 4096</span><br><span class="line">spanning-tree mst 2 priority 8192</span><br></pre></td></tr></table></figure><h3 id="S1-2配置"><a href="#S1-2配置" class="headerlink" title="S1-2配置"></a>S1-2配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">interface Ethernet0/0</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/3</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">！</span><br><span class="line">spanning-tree mst configuration</span><br><span class="line">name cisco</span><br><span class="line">revision 1</span><br><span class="line">instance 1 vlan 10, 20</span><br><span class="line">instance 2 vlan 30, 40</span><br><span class="line">!</span><br><span class="line">spanning-tree mst 0-1 priority 8192</span><br><span class="line">spanning-tree mst 2 priority 4096</span><br></pre></td></tr></table></figure><h3 id="S1-3配置"><a href="#S1-3配置" class="headerlink" title="S1-3配置"></a>S1-3配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">interface Ethernet0/1</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">！</span><br><span class="line">interface Ethernet0/0</span><br><span class="line">switchport access vlan 10</span><br><span class="line">switchport mode access</span><br><span class="line">spanning-tree portfast edge <span class="selector-id">#--</span>开启边缘端口</span><br><span class="line">spanning-tree bpduguard enable #--&gt;开启BPDU保护&#x27;</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/3</span><br><span class="line">switchport access vlan 20</span><br><span class="line">switchport mode access</span><br><span class="line">spanning-tree portfast edge <span class="selector-id">#--</span>开启边缘端口</span><br><span class="line">spanning-tree bpduguard enable <span class="selector-id">#--</span>&gt;开启BPDU保护</span><br><span class="line">!</span><br><span class="line">spanning-tree mst configuration</span><br><span class="line">name cisco</span><br><span class="line">revision 1</span><br><span class="line">instance 1 vlan 10, 20</span><br><span class="line">instance 2 vlan 30, 40</span><br></pre></td></tr></table></figure><h3 id="S1-4配置"><a href="#S1-4配置" class="headerlink" title="S1-4配置"></a>S1-4配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">interface Ethernet0/1</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">！</span><br><span class="line">interface Ethernet0/0</span><br><span class="line">switchport access vlan 20</span><br><span class="line">switchport mode access</span><br><span class="line">spanning-tree portfast edge <span class="selector-id">#--</span>开启边缘端口</span><br><span class="line">spanning-tree bpduguard enable <span class="selector-id">#--</span>&gt;开启BPDU保护</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/3</span><br><span class="line">switchport access vlan 10</span><br><span class="line">switchport mode access</span><br><span class="line">spanning-tree portfast edge <span class="selector-id">#--</span>开启边缘端口</span><br><span class="line">spanning-tree bpduguard enable <span class="selector-id">#--</span>&gt;开启BPDU保护</span><br><span class="line">!</span><br><span class="line">spanning-tree mst configuration</span><br><span class="line">name cisco</span><br><span class="line">revision 1</span><br><span class="line">instance 1 vlan 10, 20</span><br><span class="line">instance 2 vlan 30, 40</span><br></pre></td></tr></table></figure><h3 id="主机互ping测试"><a href="#主机互ping测试" class="headerlink" title="主机互ping测试"></a>主机互ping测试</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117131554.png"></p>]]></content>
      
      
      <categories>
          
          <category> 路由交换 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> STP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RSTP</title>
      <link href="2021/01/17/RSTP/"/>
      <url>2021/01/17/RSTP/</url>
      
        <content type="html"><![CDATA[<h1 id="RSTP"><a href="#RSTP" class="headerlink" title="RSTP"></a>RSTP</h1><h2 id="RSTP对STP的改进"><a href="#RSTP对STP的改进" class="headerlink" title="RSTP对STP的改进"></a>RSTP对STP的改进</h2><p><strong>端口角色发生变化</strong></p><blockquote><ol><li><p>新增 AP（预备端口）和 BP（备份端口）</p><ul><li><p>AP（预备端口）：</p><p>a. 当交换机的RP端口down掉时，AP端口会立刻成为AP端口，并且立刻进入forwarding状态。</p></li><li><p>BP（备份端口）：</p><p>a. 当交换机从一个接口收到一份BPDU报文，包含的发送者桥ID为本身交换机的桥ID同时BPDU比本地接口的BPDU优时，则接口会被选为BP端口。</p><p>b. 当DP端口down掉时，BP端口需要等待18s的时间才会成为DP端口。</p></li></ul></li><li><p>新增边缘端口：</p><ul><li><p>边缘端口（EP）：由网络管理员手工配置，配置在交换机链接终端设备（电脑，AP，服务器等）</p></li><li><p>特性：</p><p>a. 一旦端口被设置为边缘端口，端口立刻进入forwarding状态。</p><p>b. 边缘端口UP/down不会引起RSTP的网络拓扑变化。</p><p>c. RSTP的网络拓扑不会影响边缘端口的通信。</p></li></ul></li></ol></blockquote><p><strong>RSTP增加的快速机制：</strong></p><blockquote><ol><li>RSTP快速收敛机制一：当交换机的RP端口down掉时，AP端口会立刻成为AP端口，并且立刻进入forwarding状态。</li><li>RSTP快速收敛机制二：当端口设置为边缘端口，会立刻进入forwarding状态</li></ol></blockquote><h2 id="边缘端口的机制："><a href="#边缘端口的机制：" class="headerlink" title="边缘端口的机制："></a>边缘端口的机制：</h2><blockquote><ol><li>边缘端口会每2s向外泛洪BPDU。</li><li>当边缘端口收到BPDU时，会丧失边缘端口的特性，成为普通的RSTP端口执行计算。</li></ol></blockquote><h2 id="开启BPDU保护功能："><a href="#开启BPDU保护功能：" class="headerlink" title="开启BPDU保护功能："></a>开启BPDU保护功能：</h2><blockquote><ol><li>在接口视图下：spanning-tree bpduguard enable</li><li>在全局试图下：spanning-tree portfast edge bpduguard default<ul><li>只针对边缘端口生效，边缘端口收到BPDU报文时直接进入error-down的状态。同时产生一份告警日志通知网络管理员。</li><li>error-down的接口需要网络管理员手动开启，从新开启边缘端口，断电之后在接口模式下no shutdown</li></ul></li></ol></blockquote><h2 id="RSTP端口状态："><a href="#RSTP端口状态：" class="headerlink" title="RSTP端口状态："></a>RSTP端口状态：</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117113730.png"></p><h2 id="针对问题一：P-A机制（1）"><a href="#针对问题一：P-A机制（1）" class="headerlink" title="针对问题一：P/A机制（1）"></a>针对问题一：P/A机制（1）</h2><p><strong><code>P/A（proposa/Agreement）提议/同意</code></strong></p><p><strong>P/A机制的基本原理</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117113837.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114100.png"></p><h2 id="针对问题一：P-A机制（2）"><a href="#针对问题一：P-A机制（2）" class="headerlink" title="针对问题一：P/A机制（2）"></a>针对问题一：P/A机制（2）</h2><p><strong>RSTP选举原理和STP本质上相同：选举根交换机-选举非根交换机上的根端口-选举指定端口-选举预备端口和备份端口</strong></p><blockquote><p>但是RSTP在选举的过程中加入了“发起请求-回复同意”（P/A机制）这种确认机制由于每个步骤有确认就不需要依赖计时器来保证网络拓扑无环才去转发只需要考虑BPDU发送报文并计算无环拓扑的时间（一般都是秒级）。</p></blockquote><h2 id="针对问题二：根端口快速切换机制"><a href="#针对问题二：根端口快速切换机制" class="headerlink" title="针对问题二：根端口快速切换机制"></a>针对问题二：根端口快速切换机制</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114321.png"></p><h2 id="针对问题三：次等BPDU处理机制"><a href="#针对问题三：次等BPDU处理机制" class="headerlink" title="针对问题三：次等BPDU处理机制"></a>针对问题三：次等BPDU处理机制</h2><p><strong>S2与S1的直连链路down掉，SWC的AP端口切换成DP端口并进入转发状态秒级时间内完成.</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114341.png"></p><h2 id="针对问题四：边缘端口的引入"><a href="#针对问题四：边缘端口的引入" class="headerlink" title="针对问题四：边缘端口的引入"></a>针对问题四：边缘端口的引入</h2><p><strong>在RSTP中，交换机连接终端的链路可立即进入转发状态</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114404.png"></p><h2 id="RSTP-BDPU保护"><a href="#RSTP-BDPU保护" class="headerlink" title="RSTP-BDPU保护"></a>RSTP-BDPU保护</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114544.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114558.png"></p><h2 id="RSTP-根保护"><a href="#RSTP-根保护" class="headerlink" title="RSTP-根保护"></a>RSTP-根保护</h2><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114616.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114625.png"></p><h2 id="实验1"><a href="#实验1" class="headerlink" title="实验1"></a>实验1</h2><p><strong>如图所示，S1，S2和S3组成一个环型的交换网络，为了消除环路对网络的影响，交换机都运行了RSTP，最终将环形网络结构修剪成无环路的树形网络结构.</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114714.png"></p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PC4：VPCS&gt; ip 192.168.1.1/24</span><br><span class="line">PC5：VPCS&gt; ip 192.168.1.2/24</span><br><span class="line"></span><br><span class="line">S1：</span><br><span class="line">S1(config)<span class="selector-id">#spanning-tree</span> mo rapid-pvst <span class="selector-id">#--</span>&gt;开启快速生成树</span><br><span class="line"></span><br><span class="line">S2：</span><br><span class="line">S2(config)<span class="selector-id">#spanning-tree</span> mo rapid-pvst <span class="selector-id">#--</span>&gt;开启快速生成树</span><br><span class="line">！</span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> spanning-tree portfast edge     <span class="selector-id">#--</span>&gt;开启边缘端口</span><br><span class="line"> spanning-tree bpduguard enable  <span class="selector-id">#--</span>&gt;开启BPDU保护</span><br><span class="line"></span><br><span class="line">S3：</span><br><span class="line">S3(config)<span class="selector-id">#spanning-tree</span> mode rapid-pvst  <span class="selector-id">#--</span>&gt;开启快速生成树</span><br><span class="line">！</span><br><span class="line">interface Ethernet0/2</span><br><span class="line"> spanning-tree portfast edge      <span class="selector-id">#--</span>&gt;开启边缘端口</span><br><span class="line"> spanning-tree bpduguard enable   <span class="selector-id">#--</span>&gt;开启BPDU保护</span><br></pre></td></tr></table></figure><p><strong><code>思科</code>全局下开启BPDU保护（不建议）</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S2(config)<span class="selector-id">#spanning-tree</span> portfast edge bpduguard default</span><br></pre></td></tr></table></figure><h3 id="使用show查看配置"><a href="#使用show查看配置" class="headerlink" title="使用show查看配置"></a>使用show查看配置</h3><p><strong>在相同优先级情况下，比较MAC地址，S1-MAC地址是三台交换机中最小的，所以S1为根桥，而S3地址最大，它的e0/0接口会成为AP接口</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114837.png"></p><h3 id="S1"><a href="#S1" class="headerlink" title="S1"></a>S1</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114904.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114913.png"></p><h3 id="S2"><a href="#S2" class="headerlink" title="S2"></a>S2</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114938.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114928.png"></p><h3 id="S3"><a href="#S3" class="headerlink" title="S3"></a>S3</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114951.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117114959.png"></p><p><strong>当S3关闭e0/1接口，RSTP很快就切换了e0/0端口，PC2:长ping：VPCS&gt; ping 192.168.1.1 -tS3关闭e0/1接口，RSTP很快就切换了e0/0端口，PC2:长ping：VPCS&gt; ping  192.168.1.1 -t</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117115022.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117115030.png"></p><h2 id="实验2"><a href="#实验2" class="headerlink" title="实验2"></a>实验2</h2><p><strong>如图所示，S-A，S-B，S-C，S-D组成一个环型的交换网络，为了消除环路对网络的影响，交换机都运行了RSTP，最终将环形网络结构修剪成无环路的树形网络结构</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117115053.png"></p><p><strong>用快速生成树协议实现负载均衡：通过修改桥优先级，控制交换机S-A是人事部的根桥，S-B是人事部的次根桥；控制交换机S-A是研发部的次根桥，S-B是研发部的根桥.</strong></p><p><strong>vlan10-vlan20通过e1/0链路，vlan30-vlan40通过e1/1链路.用快速生成树协议实现负载均衡：通过修改桥优先级，控制交换机S-A是人事部的根桥，S-B是人事部的次根桥；控制交换机S-A是研发部的次根桥，S-B是研发部的根桥，vlan10-vlan20通过e1/0链路，vlan30-vlan40通过e1/1链路.</strong></p><h3 id="开启快速生成树"><a href="#开启快速生成树" class="headerlink" title="开启快速生成树"></a>开启快速生成树</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">S-<span class="selector-tag">A</span>(config)<span class="selector-id">#spanning-tree</span> mode rapid-pvst <span class="selector-id">#--</span>&gt;配置快速生成树</span><br><span class="line">S-<span class="selector-tag">B</span>(config)<span class="selector-id">#spanning-tree</span> mode rapid-pvst </span><br><span class="line">S-C(config)<span class="selector-id">#spanning-tree</span> mode rapid-pvst </span><br><span class="line">S-D(config)<span class="selector-id">#spanning-tree</span> mode rapid-pvst </span><br></pre></td></tr></table></figure><h3 id="S-A"><a href="#S-A" class="headerlink" title="S-A"></a>S-A</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">S-<span class="selector-tag">A</span>(config)<span class="selector-id">#vlan</span> 10,20,30,40   </span><br><span class="line">S-<span class="selector-tag">A</span>(config)<span class="selector-id">#vtp</span> mode server     <span class="selector-id">#--</span>&gt;开启VTP模式为服务器，思科私有</span><br><span class="line">S-<span class="selector-tag">A</span>(config)<span class="selector-id">#vtp</span> domain 123456   <span class="selector-id">#--</span>&gt;配置一个名字</span><br><span class="line">！</span><br><span class="line">spanning-tree vlan 10,20 priority 4096 </span><br><span class="line">spanning-tree vlan 30,40 priority 8192</span><br><span class="line">！</span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">！</span><br><span class="line">interface Ethernet1/0</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet1/1</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br></pre></td></tr></table></figure><h3 id="S-B"><a href="#S-B" class="headerlink" title="S-B"></a>S-B</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">S-<span class="selector-tag">B</span>(config)<span class="selector-id">#vtp</span> mode client          <span class="selector-id">#--</span>&gt;开启VTP模式为客户端</span><br><span class="line">S-<span class="selector-tag">B</span>(config)<span class="selector-id">#vtp</span> domain 123456</span><br><span class="line">！</span><br><span class="line">spanning-tree vlan 10,20 priority 8192</span><br><span class="line">spanning-tree vlan 30,40 priority 4096</span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!         </span><br><span class="line">interface Ethernet1/0</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet1/1</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line"> spanning-tree vlan 30,40 port-priority 64</span><br></pre></td></tr></table></figure><h3 id="S-C"><a href="#S-C" class="headerlink" title="S-C"></a>S-C</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">S-C(config)<span class="selector-id">#vtp</span> mode client <span class="selector-id">#--</span>&gt;开启VTP模式为客户端</span><br><span class="line">S-C(config)<span class="selector-id">#vtp</span> domain 123456</span><br><span class="line">！</span><br><span class="line">interface Ethernet0/1</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">！ </span><br><span class="line">interface Ethernet0/0</span><br><span class="line">spanning-tree portfast edge <span class="selector-id">#--</span>&gt;开启边缘端口 </span><br><span class="line">spanning-tree bpduguard enable <span class="selector-id">#--</span>&gt;开启BPDU保护</span><br></pre></td></tr></table></figure><h3 id="S-D"><a href="#S-D" class="headerlink" title="S-D"></a>S-D</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">S-D(config)<span class="selector-id">#vtp</span> mode client <span class="selector-id">#--</span>&gt;开启VTP模式为客户端</span><br><span class="line">S-D(config)<span class="selector-id">#vtp</span> domain 123456</span><br><span class="line">！</span><br><span class="line">interface Ethernet0/0</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line">switchport trunk encapsulation dot1q</span><br><span class="line">switchport mode trunk</span><br><span class="line">！ </span><br><span class="line">interface Ethernet0/0</span><br><span class="line">spanning-tree portfast edge    <span class="selector-id">#--</span>&gt;开启边缘端口 </span><br><span class="line">spanning-tree bpduguard enable <span class="selector-id">#--</span>&gt;开启BPDU保护</span><br></pre></td></tr></table></figure><h2 id="使用show查看配置-1"><a href="#使用show查看配置-1" class="headerlink" title="使用show查看配置"></a>使用show查看配置</h2><h3 id="S-A-1"><a href="#S-A-1" class="headerlink" title="S-A"></a>S-A</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117115336.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117115348.png"></p><h3 id="S-B-1"><a href="#S-B-1" class="headerlink" title="S-B"></a>S-B</h3><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117115422.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117115431.png"></p>]]></content>
      
      
      <categories>
          
          <category> 路由交换 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> STP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>STP</title>
      <link href="2021/01/17/STP/"/>
      <url>2021/01/17/STP/</url>
      
        <content type="html"><![CDATA[<h1 id="STP"><a href="#STP" class="headerlink" title="STP"></a>STP</h1><h2 id="二层环路的影响"><a href="#二层环路的影响" class="headerlink" title="二层环路的影响"></a>二层环路的影响</h2><p>1）广播风暴：数据帧不断的循环发送，导致需要耗费大量的CPU处理<br>2）MAC地址表的震荡：由于交换机的接口不断地收到同一个数据帧导致MAC地址表项不断被覆盖，交换机需要耗费大量的开销维护MAC地址表</p><blockquote><p>总结：如果不解决环路会大量消耗交换机的设备开销带宽资源，当CPU使用率过高很可能导致交换机开启过热保护，导致交换机断点，业务中断</p></blockquote><h2 id="为什么需要生成树"><a href="#为什么需要生成树" class="headerlink" title="为什么需要生成树"></a>为什么需要生成树</h2><p>1）生成树的出现不是真的需要，而是间接的需要<br>2）二层环境中需要备份和冗余</p><p><strong>在这种环境中没有环路，但是缺少了备份</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117111155.png"></p><p><strong>在这种环境中解决了备份，但是不做处理会导致环路，这时STP就有发挥它的作用了</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117111306.png"></p><h2 id="STP作用"><a href="#STP作用" class="headerlink" title="STP作用"></a>STP作用</h2><p><strong>STP在保证网络的冗余性的同时，保证交换机网络中不会出现二层环路</strong></p><blockquote><p>原理：通过在逻辑上阻塞某一些端口，使交换机成为树形网络，破除环路在链路上或设备发生故障时，又重新启动阻塞端口，使网络恢复数据转发.</p></blockquote><h2 id="STP如何计算阻塞端口"><a href="#STP如何计算阻塞端口" class="headerlink" title="STP如何计算阻塞端口"></a>STP如何计算阻塞端口</h2><p><strong>STP选举根桥与端口角色的过程都是由交换机自主完成的，交换机选举中都会发送一种包，这种数据包叫做BPDU(Bridge Protocol Data Unit)网桥协议数据单元</strong></p><blockquote><ol><li><p>通过选举根桥</p><ul><li> 根桥是整个交换网络中心的数据转发</li><li>根桥选举通过桥ID+MAC地址<br> 选举规则：先比较优先级，优先级默认为32768.（可以调整，必须是4096的倍数，数值越小的越优先）如果优先级相同，则比较MAC地址的大小，数值小的优先，从左往右比.</li><li>端口ID：端口的优先级+端口号<br> 选举规则：先比较端口的优先级，默认为128，可调整（只能是16的倍数，数值小的优先）如果优先级相同，则才比较端口编号，数值小的优先</li></ul></li><li><p>每个非根选取一个根端口</p><ul><li> 根端口（RP）：在每一个非根桥交换机上都有，且只有一个，接收最优的BPDU，用于转发数据</li><li>通过根路径开销（cost）：以非根桥交换机的端口为出发点，沿途经过链路去访问根桥交换机的开销值进行累加，其中总开销最小的为根路径开销，则被选择成RP端口.<br> 选举规则：非根桥与根桥交换机相连的接口都为RP端口.</li></ul></li><li><p>选举指定端口</p><ul><li>指定端口（DP）：在这段链路上，转发BPDU包给其他接口的叫做指定端口<br>  选举规则：与根桥ID的比较规则完全一致</li></ul></li><li><p>阻塞非指定端口</p><ul><li>用于逻辑上阻塞数据，不转发数据从而破坏环路.<br>  选举规则：一个端口既不是指定端口也不是根端口，则被选为AP端口</li></ul></li></ol></blockquote><h2 id="STP的端口状态"><a href="#STP的端口状态" class="headerlink" title="STP的端口状态"></a>STP的端口状态</h2><blockquote><ol><li>disable：未启用STP的状态，不接收、不发送、不处理、BPDU报文。</li><li>blocking：阻塞状态，在选择根桥交换机时或者当端口被选为AP端口时停留的状态。发送、接受处理BPDU，不传发数据。</li><li>listeningL：侦听状态，选举端口角色。发送、接收、处理BPDU，不转发数据</li><li>learning：学习状态，学习mac地址表。发送、接收、处理BPDU，不转发数据。</li><li>forwarding：转发状态，学习mac地址表，转发数据，发送、接收、处理BPDU。</li></ol></blockquote><h2 id="STP的计时器"><a href="#STP的计时器" class="headerlink" title="STP的计时器"></a>STP的计时器</h2><blockquote><ol><li>hello：更新计时器，更新计时器默认为２S，DP端口会每２S向外泛洪BPDU报文，实时地监控网络的变化情况。</li><li>max age :最大老化时间20S，端口存放BPDU的时间。当端口在20S内未收到对应的BPDU时，会将端口存放的BPDU丢弃，此时STP也认为网络拓扑发生变化。</li><li>message age:信息延时，规定了网络的直径。<br>端口存放BPDU的时间为：maxage - message age 20s -延时</li><li>forward delay：转发延时，默认的时间为15S，作用是为了防止临时环路。<br>意思：交换机抢占了新的根桥。</li></ol></blockquote><h2 id="STP的不足问题"><a href="#STP的不足问题" class="headerlink" title="STP的不足问题"></a>STP的不足问题</h2><p><strong>问题1：初始化状态需要30秒的时间才能收敛</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117111900.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117111921.png"></p><p><strong>S3与S1的直连链路down掉，AP端口切换成RP端口并进入转发状态至少需要经过30S</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117111940.png"></p><p><strong>问题3：S1与S2直连链路down掉，则S3的AP端口切换成DP端口并进入发状态大约需要50s：</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117112009.png"></p><p><strong>问题4：交换机连接终端的链路进入转发需要经过30s</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117112031.png"></p><p><strong>问题5：STP的拓扑变更机制</strong></p><blockquote><p>TC（Topology change）拓扑改变:先由变更点朝根桥方向发送TCN消息收到该消息的上游交换机就会回复TCA消息进行确认；最后TCN消息到达根桥后，再由根桥发送TC消息通知设备删除桥MAC地址表项，机制复杂，效率低下。</p></blockquote><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117112111.png"></p><p><strong>问题6：STP的其他不足之处–端口状态</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117112130.png"></p>]]></content>
      
      
      <categories>
          
          <category> 路由交换 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> STP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EVE-NG搭建</title>
      <link href="2021/01/16/EVE-NG%E6%90%AD%E5%BB%BA/"/>
      <url>2021/01/16/EVE-NG%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1 id="EVE模拟器及镜像介绍"><a href="#EVE模拟器及镜像介绍" class="headerlink" title="EVE模拟器及镜像介绍"></a>EVE模拟器及镜像介绍</h1><p>EVE所需的连接工具及镜像.<br><a href="https://pan.baidu.com/s/1KaqNo644ulijjuR4ZWGhFQ">https://pan.baidu.com/s/1KaqNo644ulijjuR4ZWGhFQ</a> 提取码：5571</p><h2 id="EVE-NG介绍"><a href="#EVE-NG介绍" class="headerlink" title="EVE-NG介绍"></a>EVE-NG介绍</h2><p>EVE模拟器跟流行的PacketTracert、GNS3、eNSP安装即可使用的软件不同。EVE本身就是一个系统，和我们日常用的Windows、Mac以及Linux是一个层级的产品，底层使用的是Ubuntu系统，默认账户root，密码eve。默认账户登录进去后，系统开始提示修改密码等，建议密码继续保持eve，其他操作都选默认，有修改需求的后期再改</p><h2 id="镜像简介绍"><a href="#镜像简介绍" class="headerlink" title="镜像简介绍"></a>镜像简介绍</h2><h3 id="Dynamic"><a href="#Dynamic" class="headerlink" title="Dynamic"></a>Dynamic</h3><p>Dynamic用于模拟思科（Cisco）的路由器，基于它演变的模拟器有小凡、工大瑞普、GNS3等。它可以运行标准的IOS镜像，虽然此模拟器比较陈旧，但仍然有很多网工愿意使用。EVE-NG支持Cisco IOS 1710、3725与7206.</p><h3 id="IOL"><a href="#IOL" class="headerlink" title="IOL"></a>IOL</h3><p>IOL为IOS on Linux的简写，IOL是指将思科的路由器、交换机ios系统运行在Linux操作系统之上，二层交换机特性支持丰富，基于它演变的模拟器有WEB-IOU。IOL可以运行在基于x86平台的任意Linux发行版系统上，支持交换机高级特性，占用资源更少，启动快等优点。运行IOL需要两个文件，一个是以bin为后缀的镜像，一个是以iourc为名的license文件，iourc是通过名为CiscoIOUKeygen.py的工具自动生成的</p><h3 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h3><p>QEMU（Quick Emulator）是一套开源产品，可以帮助EVE-NG运行更多的虚拟设备，完成复杂实验，越来越多的设备商开始开发并释放出适配KVM环境的系统，EVE-NG可以协助qcow2镜像运行更多设备，提高可玩性。EVE-NG需要QEMU镜像的后缀名为qcow2，该文件本质是一个操作系统的虚拟硬盘文件，正因如此，可以通过自己手动制作镜像几乎可以模拟任何硬件设备</p><h2 id="VM虚拟机的安装"><a href="#VM虚拟机的安装" class="headerlink" title="VM虚拟机的安装"></a>VM虚拟机的安装</h2><p><strong>搭建EVE-NG使用的是VMware虚拟机，本章不会讲解，请自行上网查询安装VMware</strong></p><h2 id="搭建EVE-NG"><a href="#搭建EVE-NG" class="headerlink" title="搭建EVE-NG"></a>搭建EVE-NG</h2><p><strong>右键EVE压缩包，选择打开方式，选择VMware Workstation</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zsjmal2316/typora-image/img/image-20210116214054316.png"></p><p><strong>选择存储虚拟机的路径，尽量不要安装在C盘，虚拟机名称默认即可，接着选择导入</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zsjmal2316/typora-image/img/image-20210116214320101.png"></p><p><strong>等待导入进度</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zsjmal2316/typora-image/img/image-20210116214320101.png"></p><p><strong>选中EVE，右键选择设置</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zsjmal2316/typora-image/img/image-20210116214354554.png"></p><p><strong>选择内存——按自己的内存情况，8G内存的可以选择4-6G使用，16G可以选择8-12G或更高使用</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zsjmal2316/typora-image/img/image-20210116214438470.png"></p><p><strong>接着选择处理器——勾选处理器数量（P）:4,每个处理器的内核数量（C）:1–&gt;确保是“虚拟化Intel VT -x/EPT 或 AMD-V/RVI(V)”</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zsjmal2316/typora-image/img/image-20210116214506948.png"></p><p><strong>设置完成，开启虚拟机</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zsjmal2316/typora-image/img/image-20210116214525123.png"></p><p><strong>开启虚拟机来到第一个页面</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zsjmal2316/typora-image/img/image-20210116214542480.png"></p><p><strong>第二个页面输入用户root，密码eve</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zsjmal2316/typora-image/img/image-20210116214614717.png"></p><p><strong>第三–四个页面，虚拟机会让你重新设置密码，保持密码还是eve即可，回车</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zsjmal2316/typora-image/img/image-20210116214710186.png"></p><p><strong>第五页面直到最后都选择默认，按下回车即可</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zsjmal2316/typora-image/img/image-20210116214731206.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117103116.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117103131.png"></p><p><strong>接着虚拟机会重新启动，等待虚拟器重启完成，再次输入root用户和之前设置的密码就搭建完成</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117103407.png"></p><p><strong>重启的完后页面会多出了一个IP地址，这个IP地址我们可以使用浏览器进行浏览，建议使用firefox及Google浏览器访问. 推荐firefox访问</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117103431.png"></p><p><strong>输入IP地址，默认用户admin，密码eve，选择html5 conlose（web方式）登录即可以使用，但是并不推荐，因为web方式站不支持对网络设备进行抓包。在这推荐使用Native console（本地登录）但是必须得安装EVE-NG的客户端。安装的客户端已在上面发的网盘连接中，需自行安装，这里不演示，只需要都下一步即可安装</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117103455.png"></p><p><strong>登录之后，可以看一些设置，管理，系统，信息.简单说一下</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117103518.png"></p><p><strong><code>管理</code>：用户管理，创建用户，一般都不怎么需要创建</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117104324.png"></p><p><strong><code>系统</code>：可以查看系统日志和系统状态，状态有CPU，内存，swap和磁盘的使用情况，还有自己运行的多少个节点</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117104523.png"></p><p><strong><code>信息</code>：关于和论坛，可以让你了解更多的东西</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117104530.png"></p><p><strong><code>主页</code>—&gt;新建一个标签标签并保存</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117104611.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117104630.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117104716.png"></p><p><strong>如果没有右键看不到节点选项为蓝色，说明没有该镜像，需要拉去，下述有讲解传输拉去的方法和软件</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117104728.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117104738.png"></p><h2 id="安装EVE-NG客户端与使用工具导入镜像"><a href="#安装EVE-NG客户端与使用工具导入镜像" class="headerlink" title="安装EVE-NG客户端与使用工具导入镜像"></a>安装EVE-NG客户端与使用工具导入镜像</h2><p>官方提供了一个自带的客户端安装包集，里面内置了Putty、UltraVNC、Wireshark，导入镜像使用WinSCP工具导入会更简单. 两个工具安装时候选择默认安装即可</p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117104805.png"></p><h3 id="什么是-WinSCP"><a href="#什么是-WinSCP" class="headerlink" title="什么是 WinSCP"></a>什么是 WinSCP</h3><p>WinSCP 是一个 Windows 环境下使用的 SSH 的开源化 SFTP 客户端。同时支持 SCP 协议。它的主要功能是在本地与远程计算机间安全地复制文件，并且可以直接编辑文件</p><h3 id="传输镜像和修改权限"><a href="#传输镜像和修改权限" class="headerlink" title="传输镜像和修改权限"></a>传输镜像和修改权限</h3><p>安装完EVE客户端和winSCP之后，打开winSCPU新建一个站点，输入虚拟机EVE的IP地址，账号和密码，点击登录</p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117104927.png"></p><p><strong>选择是，连接成功</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117104950.png"></p><p><strong>找到放置EVE-NG放置镜像的目录</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117105013.png"></p><p><strong>在Windows文件下找到IOL镜像，拖动至EVE-NG文件下的<code>/opt/unetlab/addone/iol/bin</code></strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117105056.png"></p><p><strong>L2表示是2层交换机，L3表示三层，L2L3都有很多种，其实都差不多，选择一个即可，重要的是圈起来的两个文件CiscoIOUKeygen.py和iourc，必须得一起放置，否者会导致交换机和路由器开不了机</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117105119.png"></p><p><strong>这里选择IOL，原因是因为它不需要耗费太多的内存和CPU，开机速度比一般的镜像要快，普通实验已经够用了</strong></p><p><strong>接着设置IOL镜像所有文件的权限，右键属性，将所有权限勾选，避免搭建时候出现问题</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117105155.png"></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117105218.png"></p><h2 id="通过Native-console登录和使用xshell连接"><a href="#通过Native-console登录和使用xshell连接" class="headerlink" title="通过Native console登录和使用xshell连接"></a>通过Native console登录和使用xshell连接</h2><p><strong>有了EVE-NG客户端，在登录时可以使用Native console模式进行登录，返回登录页面，选择Native console模式</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117105325.png"></p><p><strong>可以选择默认的vpcs连接，点击几下交换机就会出现，这是安装了EVE-NG客户端自带的</strong></p><blockquote><p>提示：如果你有安装xshell或SecureCRT软件，此时用firefor浏览会在上方弹出一个选择使用什么连接，这时你可以选择你的xshell或SecureCRT软件就可以连接到交换机了</p></blockquote><p><strong>这里连接EVE-NG模拟器使用的客户端是xshell，点击几下交换机连接到xshell，连接到的名称是ip+端口，可以右键修改自己想要的名称</strong></p><p><img src="https://my-oss-image.oss-cn-guangzhou.aliyuncs.com/img/20210117105408.png"></p><p><strong>如果使用SecureCRT连接，就不需改名，它会自动修改</strong></p><blockquote><p>注意：这里使用的是firefor做演示，使用firefor的好处是可以弹出直接使用xshell连接，Google的需要自己寻找xshell的位置，各有各的好处。希望能帮到大家</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 路由交换 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> EVE-NG </tag>
            
            <tag> 模拟器 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
